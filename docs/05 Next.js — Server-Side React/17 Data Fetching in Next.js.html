<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17 Data Fetching in Next.js</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-17-data-fetching-in-nextjs">Chapter 17: Data Fetching in Next.js</h1>
<h2 id="server-components-fetch-directly">Server Components: fetch directly</h2>
<h2 id="the-problem-client-side-data-fetching-waterfalls">The Problem: Client-Side Data Fetching Waterfalls</h2>
<p>Let's continue with our <strong>E-commerce Product Catalog</strong> from Chapter 16. We have a product listing page that needs to display products, categories, and featured items. In a traditional React app, we'd fetch all this data on the client.</p>
<p>Here's what that looks like‚Äîand why it's problematic.</p>
<p><strong>Project Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code>src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx          ‚Üê Product listing page
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ProductGrid.tsx       ‚Üê Displays products
‚îÇ   ‚îú‚îÄ‚îÄ CategoryFilter.tsx    ‚Üê Category sidebar
‚îÇ   ‚îî‚îÄ‚îÄ FeaturedBanner.tsx    ‚Üê Featured products
‚îî‚îÄ‚îÄ lib/
    ‚îî‚îÄ‚îÄ api.ts                ‚Üê API client functions
</code></pre></div>

<h3 id="iteration-0-the-client-side-waterfall-the-failure">Iteration 0: The Client-Side Waterfall (The Failure)</h3>
<p>Let's build this the "React way"‚Äîfetching everything on the client with <code>useEffect</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Category</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Simulated API calls (in production, these would be real endpoints)</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">800</span><span class="p">));</span><span class="w"> </span><span class="c1">// Simulate network delay</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Laptop Pro&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">1299</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/laptop.jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Wireless Mouse&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">29</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/mouse.jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Desk Chair&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">399</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;furniture&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/chair.jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// ... more products</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Category</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">600</span><span class="p">));</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">45</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;furniture&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Furniture&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">23</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;clothing&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Clothing&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">67</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">700</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">featured</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Client-side approach (PROBLEMATIC)</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">,</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">Product</span><span class="p">,</span><span class="w"> </span><span class="nx">Category</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">setProducts</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">setCategories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Category</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">featured</span><span class="p">,</span><span class="w"> </span><span class="nx">setFeatured</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Sequential fetching - each waits for the previous</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">productsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setProducts</span><span class="p">(</span><span class="nx">productsData</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoriesData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setCategories</span><span class="p">(</span><span class="nx">categoriesData</span><span class="p">);</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">featuredData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setFeatured</span><span class="p">(</span><span class="nx">featuredData</span><span class="p">);</span>

<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">fetchData</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">products</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* Category sidebar */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">{</span><span class="cm">/* Main content */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="cm">/* Featured banner */</span><span class="p">}</span>
<span class="w">          </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8 p-6 bg-blue-50 rounded-lg&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Featured</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                  </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-center&quot;</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-32 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 font-medium&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-blue-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">))}</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">)}</span>

<span class="w">          </span><span class="p">{</span><span class="cm">/* Product grid */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">category</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 text-lg font-bold&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-waterfall-failure">Diagnostic Analysis: Reading the Waterfall Failure</h3>
<p>Let's run this in the browser and observe what happens.</p>
<p><strong>Browser Behavior</strong>:
- User navigates to <code>/products</code>
- Sees blank page with "Loading products..." for 2+ seconds
- Then entire page appears at once
- No progressive loading‚Äîeverything or nothing</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[No errors, but let&#39;s add timing logs]
</code></pre></div>

<p>Let's add console.log statements to see the timing:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Modified useEffect with timing logs</span>
<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[0ms] Starting data fetch...&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">productsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="si">}</span><span class="sb">ms] Products loaded (took </span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start1</span><span class="p">)</span><span class="si">}</span><span class="sb">ms)`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setProducts</span><span class="p">(</span><span class="nx">productsData</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">categoriesData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="si">}</span><span class="sb">ms] Categories loaded (took </span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start2</span><span class="p">)</span><span class="si">}</span><span class="sb">ms)`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setCategories</span><span class="p">(</span><span class="nx">categoriesData</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">featuredData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="si">}</span><span class="sb">ms] Featured loaded (took </span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start3</span><span class="p">)</span><span class="si">}</span><span class="sb">ms)`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setFeatured</span><span class="p">(</span><span class="nx">featuredData</span><span class="p">);</span>

<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="si">}</span><span class="sb">ms] All data loaded, rendering page`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">fetchData</span><span class="p">();</span>
<span class="p">},</span><span class="w"> </span><span class="p">[]);</span>
</code></pre></div>

<p><strong>Browser Console Output</strong> (actual timing):</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="mi">0</span><span class="n">ms</span><span class="p">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">fetch</span><span class="o">...</span>
<span class="p">[</span><span class="mi">823</span><span class="n">ms</span><span class="p">]</span><span class="w"> </span><span class="n">Products</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="p">(</span><span class="n">took</span><span class="w"> </span><span class="mi">823</span><span class="n">ms</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1456</span><span class="n">ms</span><span class="p">]</span><span class="w"> </span><span class="n">Categories</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="p">(</span><span class="n">took</span><span class="w"> </span><span class="mi">633</span><span class="n">ms</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2189</span><span class="n">ms</span><span class="p">]</span><span class="w"> </span><span class="n">Featured</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="p">(</span><span class="n">took</span><span class="w"> </span><span class="mi">733</span><span class="n">ms</span><span class="p">)</span>
<span class="p">[</span><span class="mi">2189</span><span class="n">ms</span><span class="p">]</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">loaded</span><span class="p">,</span><span class="w"> </span><span class="n">rendering</span><span class="w"> </span><span class="n">page</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- Filter: Fetch/XHR
- Observation: Three requests fire <strong>sequentially</strong>, not in parallel
- Timeline:
  - 0-800ms: <code>/api/products</code> (waiting)
  - 800-1400ms: <code>/api/categories</code> (waiting)
  - 1400-2100ms: <code>/api/featured</code> (waiting)
- Pattern: Classic waterfall‚Äîeach request waits for the previous to complete
- Total time: 2.2 seconds
- Wasted time: ~1.4 seconds (requests could have run in parallel)</p>
<p><strong>React DevTools Evidence</strong>:
- <code>ProductsPage</code> component selected
- State: <code>{ products: [], categories: [], featured: [], isLoading: true }</code>
- After 2.2 seconds: State updates three times sequentially
- Render count: 4 renders (initial + 3 state updates)</p>
<p><strong>Performance Metrics</strong>:
- <strong>Time to First Byte (TTFB)</strong>: 50ms (HTML arrives quickly)
- <strong>First Contentful Paint (FCP)</strong>: 100ms (shows "Loading products...")
- <strong>Largest Contentful Paint (LCP)</strong>: 2300ms ‚ö†Ô∏è (waits for all data)
- <strong>Time to Interactive (TTI)</strong>: 2400ms ‚ö†Ô∏è
- <strong>Total Blocking Time (TBT)</strong>: 150ms (React hydration + rendering)</p>
<h3 id="lets-parse-this-evidence">Let's Parse This Evidence</h3>
<ol>
<li><strong>What the user experiences</strong>:</li>
<li>Expected: See the page structure immediately, with content loading progressively</li>
<li>
<p>Actual: Stare at a loading spinner for 2+ seconds, then everything appears at once</p>
</li>
<li>
<p><strong>What the console reveals</strong>:</p>
</li>
<li>Key indicator: Sequential timing‚Äîeach fetch waits for the previous</li>
<li>
<p>Error location: Not an error, but a design flaw in the data fetching strategy</p>
</li>
<li>
<p><strong>What the Network tab shows</strong>:</p>
</li>
<li>Technical evidence: Waterfall pattern‚Äîrequests are serialized</li>
<li>Root cause: <code>await</code> statements create sequential dependencies</li>
<li>
<p>Wasted opportunity: These three requests are independent and could run in parallel</p>
</li>
<li>
<p><strong>Root cause identified</strong>: 
   Sequential async/await creates an artificial dependency chain. The categories fetch doesn't need to wait for products, and featured doesn't need to wait for categories.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>:
   Even if we parallelize the fetches with <code>Promise.all()</code>, we still have fundamental problems:</p>
</li>
<li>All data fetching happens <strong>after</strong> the JavaScript bundle loads and executes</li>
<li>The server already has access to the database‚Äîwhy send it to the client first?</li>
<li>The HTML sent to the browser is empty‚Äîterrible for SEO and perceived performance</li>
<li>
<p>Users on slow connections wait even longer</p>
</li>
<li>
<p><strong>What we need</strong>:
   A way to fetch data <strong>on the server</strong> before sending HTML to the client, so users see content immediately instead of spinners.</p>
</li>
</ol>
<h3 id="the-fundamental-problem-client-side-fetching-in-a-server-capable-framework">The Fundamental Problem: Client-Side Fetching in a Server-Capable Framework</h3>
<p>This approach has multiple issues:</p>
<ol>
<li><strong>Waterfall by default</strong>: Sequential fetches waste time</li>
<li><strong>Empty HTML</strong>: View source shows no content‚Äîbad for SEO</li>
<li><strong>JavaScript required</strong>: Page is blank until JS loads and executes</li>
<li><strong>Wasted server capability</strong>: Next.js can fetch on the server, but we're not using it</li>
<li><strong>Poor perceived performance</strong>: Users see loading states instead of content</li>
</ol>
<p><strong>What we need</strong>: Fetch data on the server, render HTML with content, send that to the client. This is what Server Components enable.</p>
<h2 id="server-components-fetching-where-the-data-lives">Server Components: Fetching Where the Data Lives</h2>
<p>Next.js App Router introduces <strong>Server Components</strong>‚Äîcomponents that run only on the server, never in the browser. They can fetch data directly, access databases, read environment variables, and render HTML that's sent to the client.</p>
<h3 id="the-mental-model-shift">The Mental Model Shift</h3>
<p><strong>Client Component</strong> (traditional React):</p>
<div class="codehilite"><pre><span></span><code><span class="n">Browser</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="n">JS</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Fetch</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Render</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Show</span><span class="w"> </span><span class="n">content</span>
<span class="w">         </span><span class="p">[</span><span class="n">Empty</span><span class="w"> </span><span class="n">HTML</span><span class="p">]</span><span class="w">  </span><span class="p">[</span><span class="n">Spinner</span><span class="w"> </span><span class="n">shown</span><span class="p">]</span><span class="w">   </span><span class="p">[</span><span class="n">Network</span><span class="p">]</span><span class="w">   </span><span class="p">[</span><span class="n">Finally</span><span class="o">!</span><span class="p">]</span>
</code></pre></div>

<p><strong>Server Component</strong> (Next.js App Router):</p>
<div class="codehilite"><pre><span></span><code><span class="n">Server</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Fetch</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Render</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">HTML</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Browser</span><span class="w"> </span><span class="n">displays</span>
<span class="w">        </span><span class="p">[</span><span class="n">Fast</span><span class="o">!</span><span class="p">]</span><span class="w">       </span><span class="p">[</span><span class="n">On</span><span class="w"> </span><span class="n">server</span><span class="p">]</span><span class="w">        </span><span class="p">[</span><span class="n">Content</span><span class="o">!</span><span class="p">]</span><span class="w">   </span><span class="p">[</span><span class="n">Immediately</span><span class="o">!</span><span class="p">]</span>
</code></pre></div>

<h3 id="key-characteristics-of-server-components">Key Characteristics of Server Components</h3>
<ol>
<li><strong>Run on the server</strong>: Code executes during the build (static) or on each request (dynamic)</li>
<li><strong>Can fetch directly</strong>: No need for API routes‚Äîjust call your database or external APIs</li>
<li><strong>Zero JavaScript to client</strong>: The component code never ships to the browser</li>
<li><strong>Can use server-only code</strong>: Access environment variables, file system, databases directly</li>
<li><strong>Cannot use hooks</strong>: No <code>useState</code>, <code>useEffect</code>, or event handlers (those require client interactivity)</li>
</ol>
<h3 id="iteration-1-server-component-data-fetching">Iteration 1: Server Component Data Fetching</h3>
<p>Let's refactor our product page to use Server Components. By default, all components in the App Router are Server Components unless marked with <code>'use client'</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Server Component approach</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">,</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="c1">// This is a Server Component by default (no &#39;use client&#39; directive)</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Fetch data directly in the component - this runs on the server</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">featured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* Category sidebar */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">{</span><span class="cm">/* Main content */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="cm">/* Featured banner */</span><span class="p">}</span>
<span class="w">          </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8 p-6 bg-blue-50 rounded-lg&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Featured</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                  </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-center&quot;</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-32 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 font-medium&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-blue-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">))}</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">)}</span>

<span class="w">          </span><span class="p">{</span><span class="cm">/* Product grid */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">category</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 text-lg font-bold&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="what-changed">What Changed?</h3>
<p><strong>Before</strong> (Client Component):</p>
<div class="codehilite"><pre><span></span><code><span class="s1">&#39;use client&#39;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">setProducts</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* fetch */</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>
</code></pre></div>

<p><strong>After</strong> (Server Component):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// No &#39;use client&#39; directive</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// ‚Üê Component is async</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span><span class="w">  </span><span class="c1">// ‚Üê Direct fetch</span>
<span class="w">  </span><span class="c1">// No useState, no useEffect, no loading state</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-does-this-actually-work">Verification: Does This Actually Work?</h3>
<p>Let's run this and observe the difference.</p>
<p><strong>Browser Behavior</strong>:
- User navigates to <code>/products</code>
- Page appears <strong>immediately</strong> with all content visible
- No loading spinner‚Äîcontent is already in the HTML</p>
<p><strong>View Source</strong> (Right-click ‚Üí View Page Source):</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span>Our Products<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">aside</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span>Categories<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Electronics (45)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Furniture (23)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Clothing (67)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">main</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
        <span class="cm">&lt;!-- Full product HTML is here! --&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/laptop.jpg&quot;</span> <span class="na">alt</span><span class="o">=</span><span class="s">&quot;Laptop Pro&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h3</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mt-4 font-semibold&quot;</span><span class="p">&gt;</span>Laptop Pro<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span>electronics<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mt-2 text-lg font-bold&quot;</span><span class="p">&gt;</span>$1299<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="cm">&lt;!-- More products... --&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- Filter: Doc (HTML document)
- Observation: Single request to <code>/products</code>
- Timeline:
  - 0-2200ms: Server fetching data and rendering HTML
  - 2200ms: HTML with full content arrives
- Pattern: No client-side fetch requests‚Äîall data is in the HTML
- Total time to content: 2.2 seconds (same as before, but...)</p>
<p><strong>Performance Metrics</strong>:
- <strong>Time to First Byte (TTFB)</strong>: 2250ms (server does the work)
- <strong>First Contentful Paint (FCP)</strong>: 2300ms (content in first paint!)
- <strong>Largest Contentful Paint (LCP)</strong>: 2350ms ‚úÖ (50ms after FCP)
- <strong>Time to Interactive (TTI)</strong>: 2400ms
- <strong>Total Blocking Time (TBT)</strong>: 20ms (minimal hydration)</p>
<h3 id="expected-vs-actual-improvement">Expected vs. Actual Improvement</h3>
<p><strong>Before</strong> (Client Component):
- User sees: Loading spinner ‚Üí Wait 2.2s ‚Üí Content appears
- HTML: Empty <code>&lt;div id="root"&gt;&lt;/div&gt;</code>
- JavaScript: 150KB bundle with React + component code
- SEO: Search engines see empty page</p>
<p><strong>After</strong> (Server Component):
- User sees: Content appears immediately (after server processing)
- HTML: Full content in the initial response
- JavaScript: 45KB bundle (no data fetching code, no component code)
- SEO: Search engines see full content</p>
<p><strong>Key insight</strong>: The total time is similar (2.2s), but the <strong>user experience</strong> is dramatically different. Instead of staring at a spinner, users see content immediately. The work moved from the client to the server.</p>
<h3 id="but-waitwe-still-have-a-waterfall">But Wait‚ÄîWe Still Have a Waterfall!</h3>
<p>Look at our server-side code again:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span><span class="w">      </span><span class="c1">// 800ms</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span><span class="w">  </span><span class="c1">// 600ms (waits for products)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">featured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">();</span><span class="w"> </span><span class="c1">// 700ms (waits for categories)</span>
<span class="c1">// Total: 2100ms</span>
</code></pre></div>

<p>These fetches are still sequential! We're just doing the waterfall on the server instead of the client. Let's fix that.</p>
<h3 id="iteration-2-parallel-server-side-fetching">Iteration 2: Parallel Server-Side Fetching</h3>
<p>We can use <code>Promise.all()</code> to fetch all data in parallel:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Parallel fetching</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">,</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Fetch all data in parallel</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getFeaturedProducts</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8 p-6 bg-blue-50 rounded-lg&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Featured</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">featured</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                  </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-center&quot;</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-32 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 font-medium&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-blue-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">))}</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">)}</span>

<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">category</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 text-lg font-bold&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-parallel-fetching-performance">Verification: Parallel Fetching Performance</h3>
<p><strong>Server Logs</strong> (add timing to see the difference):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add this to your page component temporarily</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[Server] Starting parallel fetch...&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">  </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getFeaturedProducts</span><span class="p">(),</span>
<span class="p">]);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[Server] All data loaded in </span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
</code></pre></div>

<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Starting<span class="w"> </span>parallel<span class="w"> </span>fetch...
<span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>All<span class="w"> </span>data<span class="w"> </span>loaded<span class="w"> </span><span class="k">in</span><span class="w"> </span>823ms
</code></pre></div>

<p><strong>Performance Metrics</strong>:
- <strong>Before</strong> (sequential): 2100ms server processing
- <strong>After</strong> (parallel): 823ms server processing (61% faster!)
- <strong>Time to First Byte (TTFB)</strong>: 873ms (down from 2250ms)
- <strong>First Contentful Paint (FCP)</strong>: 923ms (down from 2300ms)
- <strong>Largest Contentful Paint (LCP)</strong>: 973ms ‚úÖ (down from 2350ms)</p>
<h3 id="expected-vs-actual-improvement_1">Expected vs. Actual Improvement</h3>
<p><strong>Sequential fetching</strong>:
- Server processing: 2100ms
- User sees content: After 2.2s</p>
<p><strong>Parallel fetching</strong>:
- Server processing: 823ms (fastest request determines total time)
- User sees content: After 0.9s
- Improvement: <strong>59% faster time to content</strong></p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Faster time to first byte (TTFB)
- Better user experience (content appears sooner)
- Reduced server processing time
- Better SEO (faster page loads)</p>
<p><strong>What it sacrifices</strong>:
- Slightly more complex code (but minimal)
- All requests must complete before any content is shown</p>
<p><strong>When to choose this approach</strong>:
- Multiple independent data sources
- Data fetching is the bottleneck
- All data is needed to render the page
- SEO is important</p>
<p><strong>When to avoid this approach</strong>:
- Data sources have dependencies (one needs results from another)
- Some data is much slower than others (see Section 17.3 for Streaming)
- You want to show partial content while other data loads</p>
<h3 id="limitation-preview">Limitation Preview</h3>
<p>This solves the waterfall problem, but we still have an issue: the <strong>entire page</strong> waits for the <strong>slowest request</strong> to complete. If one API call takes 5 seconds, the user sees nothing for 5 seconds.</p>
<p>What if we could show the fast content immediately and stream in the slow content as it arrives? That's what Streaming and Suspense enable (Section 17.3).</p>
<h2 id="real-world-server-component-patterns">Real-World Server Component Patterns</h2>
<p>Let's look at more realistic data fetching scenarios.</p>
<h3 id="pattern-1-database-queries">Pattern 1: Database Queries</h3>
<p>In production, you'd fetch from a database, not mock APIs:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/db.ts - Example with Prisma</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">prisma</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./prisma&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">prisma</span><span class="p">.</span><span class="nx">category</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">_count</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">select</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Using database queries</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Same JSX as before */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="pattern-2-external-api-calls">Pattern 2: External API Calls</h3>
<p>Fetching from third-party APIs:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/external-api.ts</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getWeatherData</span><span class="p">(</span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span>
<span class="w">    </span><span class="sb">`https://api.weather.com/v1/current?location=</span><span class="si">${</span><span class="nx">location</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">WEATHER_API_KEY</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch weather data&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/dashboard/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getWeatherData</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/external-api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DashboardPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">weather</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getWeatherData</span><span class="p">(</span><span class="s1">&#39;San Francisco&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Dashboard</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;weather-widget&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Current</span><span class="w"> </span><span class="nx">temperature</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">weather</span><span class="p">.</span><span class="nx">temperature</span><span class="p">}</span><span class="err">¬∞</span><span class="nx">F</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Conditions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">weather</span><span class="p">.</span><span class="nx">conditions</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="pattern-3-reading-environment-variables-safely">Pattern 3: Reading Environment Variables Safely</h3>
<p>Server Components can access environment variables that should never be exposed to the client:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/config.ts - Server-only configuration</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">serverConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">databaseUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.DATABASE_URL</span><span class="o">!</span><span class="p">,</span>
<span class="w">  </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.SECRET_API_KEY</span><span class="o">!</span><span class="p">,</span>
<span class="w">  </span><span class="nx">stripeSecretKey</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.STRIPE_SECRET_KEY</span><span class="o">!</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// This code never ships to the client</span>
<span class="c1">// If you try to import this in a Client Component, you&#39;ll get a build error</span>
</code></pre></div>

<h3 id="pattern-4-nested-server-components">Pattern 4: Nested Server Components</h3>
<p>Server Components can render other Server Components, each fetching its own data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductGrid.tsx - Server Component</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductGrid</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">category</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 text-lg font-bold&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">))}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/CategorySidebar.tsx - Server Component</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CategorySidebar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Composing Server Components</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ProductGrid</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductGrid&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">CategorySidebar</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/CategorySidebar&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Each component fetches its own data in parallel</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">CategorySidebar</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductGrid</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Key insight</strong>: When you compose Server Components like this, Next.js automatically parallelizes their data fetching. You don't need <code>Promise.all()</code>‚Äîthe framework handles it.</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-youre-importing-a-component-that-needs-x-that-only-works-in-a-client-component">Symptom: "You're importing a component that needs X. That only works in a Client Component..."</h4>
<p><strong>Browser behavior</strong>:
Build fails, page doesn't load</p>
<p><strong>Terminal output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Error:<span class="w"> </span>You<span class="s1">&#39;re importing a component that needs useState. That only works in a Client Component but none of its parents are marked with &quot;use client&quot;, so they&#39;</span>re<span class="w"> </span>Server<span class="w"> </span>Components<span class="w"> </span>by<span class="w"> </span>default.

<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>import<span class="w"> </span><span class="o">{</span><span class="w"> </span>useState<span class="w"> </span><span class="o">}</span><span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="p">|</span><span class="w">          </span>^^^^^^^^
</code></pre></div>

<p><strong>Root cause</strong>: Trying to use client-only features (hooks, event handlers) in a Server Component</p>
<p><strong>Solution</strong>: Add <code>'use client'</code> directive at the top of the file, or move the interactive logic to a separate Client Component</p>
<h4 id="symptom-error-fetch-failed-or-database-connection-errors">Symptom: "Error: fetch failed" or database connection errors</h4>
<p><strong>Browser behavior</strong>:
500 error page or error boundary</p>
<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code>Error:<span class="w"> </span>connect<span class="w"> </span>ECONNREFUSED<span class="w"> </span><span class="m">127</span>.0.0.1:5432
<span class="w">    </span>at<span class="w"> </span>TCPConnectWrap.afterConnect<span class="w"> </span><span class="o">[</span>as<span class="w"> </span>oncomplete<span class="o">]</span>
</code></pre></div>

<p><strong>Root cause</strong>: Database or API not accessible from the server environment</p>
<p><strong>Solution</strong>: 
- Check environment variables are set correctly
- Verify database is running and accessible
- Check network/firewall rules in production</p>
<h4 id="symptom-stale-data-shown-on-page">Symptom: Stale data shown on page</h4>
<p><strong>Browser behavior</strong>:
Page shows old data even after database updates</p>
<p><strong>Root cause</strong>: Page is statically generated at build time, not regenerated on each request</p>
<p><strong>Solution</strong>: Use dynamic rendering (see Section 17.4) or revalidation (see Section 17.5)</p>
<h3 id="when-to-use-server-components">When to Use Server Components</h3>
<p><strong>Use Server Components when</strong>:
- Fetching data from databases or APIs
- Accessing server-only resources (file system, environment variables)
- Performing expensive computations
- Rendering static content
- SEO is important</p>
<p><strong>Don't use Server Components when</strong>:
- You need interactivity (event handlers, state)
- You need browser APIs (localStorage, window, document)
- You need React hooks (useState, useEffect, useContext)
- You need real-time updates without page refresh</p>
<p>For those cases, you need Client Components‚Äîwhich we'll cover in the next section.</p>
<h2 id="client-components-use-react-query">Client Components: use React Query</h2>
<h2 id="when-server-components-arent-enough">When Server Components Aren't Enough</h2>
<p>Server Components are excellent for initial page loads, but they have a fundamental limitation: <strong>they can't be interactive</strong>. No event handlers, no state, no hooks.</p>
<p>Consider these scenarios in our product catalog:</p>
<ol>
<li><strong>Search filtering</strong>: User types in a search box, products filter in real-time</li>
<li><strong>Add to cart</strong>: User clicks "Add to Cart", cart count updates without page reload</li>
<li><strong>Infinite scroll</strong>: User scrolls down, more products load automatically</li>
<li><strong>Real-time updates</strong>: Product availability changes while user is browsing</li>
</ol>
<p>All of these require <strong>Client Components</strong>‚Äîcomponents that run in the browser and can respond to user interactions.</p>
<h3 id="the-problem-client-side-data-fetching-again">The Problem: Client-Side Data Fetching (Again)</h3>
<p>Let's add a search feature to our product catalog. Users should be able to search products without a full page reload.</p>
<h3 id="iteration-3-naive-client-side-fetching-the-failure">Iteration 3: Naive Client-Side Fetching (The Failure)</h3>
<p>First, let's see what happens if we use <code>useEffect</code> for client-side data fetching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductSearch.tsx - Naive approach (PROBLEMATIC)</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductSearch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="nx">setQuery</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">setResults</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setResults</span><span class="p">([]);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setResults</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Search failed:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">        </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
<span class="w">        </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">query</span><span class="p">}</span>
<span class="w">        </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setQuery</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">        </span><span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Search products...&quot;</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full px-4 py-2 border rounded-lg&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span><span class="p">&gt;</span><span class="nx">Searching</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-client-side-fetching-failure">Diagnostic Analysis: Reading the Client-Side Fetching Failure</h3>
<p>Let's type "laptop" into the search box and observe what happens.</p>
<p><strong>Browser Behavior</strong>:
- User types "l" ‚Üí Request fires
- User types "la" ‚Üí Another request fires
- User types "lap" ‚Üí Another request fires
- User types "lapt" ‚Üí Another request fires
- User types "lapto" ‚Üí Another request fires
- User types "laptop" ‚Üí Another request fires
- Result: 6 requests for a single search term</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[No errors, but let&#39;s add logging]
</code></pre></div>

<p>Let's add console.log to see the request pattern:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setResults</span><span class="p">([]);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb">] Fetching results for: &quot;</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb">] Received </span><span class="si">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> results for: &quot;</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setResults</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">]);</span>
</code></pre></div>

<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">123</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;l&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">234</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;la&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">345</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lap&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">456</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lapt&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">567</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lapto&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">678</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;laptop&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">823</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;l&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">934</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;la&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">045</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lap&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">156</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lapt&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">267</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;lapto&quot;</span>
[<span class="mi">2024</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span><span class="nv">T10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">378</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;laptop&quot;</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- Filter: Fetch/XHR
- Observation: 6 requests to <code>/api/products/search</code> in rapid succession
- Timeline: Requests fire every ~100ms as user types
- Pattern: No debouncing‚Äîevery keystroke triggers a request
- Total requests: 6 for a 6-character search term
- Wasted bandwidth: First 5 requests are obsolete by the time they complete</p>
<p><strong>React DevTools Evidence</strong>:
- <code>ProductSearch</code> component selected
- State updates: <code>query</code> changes 6 times in 0.5 seconds
- Effect runs: 6 times (once per state change)
- Render count: 12+ renders (state changes + loading states)</p>
<h3 id="lets-parse-this-evidence_1">Let's Parse This Evidence</h3>
<ol>
<li><strong>What the user experiences</strong>:</li>
<li>Expected: Smooth search experience with results appearing as they type</li>
<li>
<p>Actual: Flickering loading states, results changing rapidly, wasted network requests</p>
</li>
<li>
<p><strong>What the console reveals</strong>:</p>
</li>
<li>Key indicator: Requests fire on every keystroke</li>
<li>Pattern: No debouncing or request cancellation</li>
<li>
<p>Problem: Intermediate queries ("l", "la", "lap") are useless</p>
</li>
<li>
<p><strong>What the Network tab shows</strong>:</p>
</li>
<li>Technical evidence: Request waterfall with overlapping requests</li>
<li>Wasted work: Server processes 6 queries when only the last one matters</li>
<li>
<p>Performance impact: Unnecessary server load and bandwidth usage</p>
</li>
<li>
<p><strong>Root cause identified</strong>: 
   No debouncing mechanism‚Äîevery state change triggers a new fetch, even for incomplete search terms.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>:
   Even if we add debouncing, we still have problems:</p>
</li>
<li>Manual loading state management</li>
<li>No error handling</li>
<li>No request cancellation (old requests can return after new ones)</li>
<li>No caching (same search twice = two requests)</li>
<li>No retry logic for failed requests</li>
<li>
<p>No background refetching for stale data</p>
</li>
<li>
<p><strong>What we need</strong>:
   A library that handles all these concerns automatically: debouncing, caching, error handling, request cancellation, background updates, and more.</p>
</li>
</ol>
<h3 id="additional-problems-with-naive-client-fetching">Additional Problems with Naive Client Fetching</h3>
<p>Let's explore more failure modes:</p>
<h4 id="problem-1-race-conditions">Problem 1: Race Conditions</h4>
<p>User types "laptop" quickly, then deletes and types "mouse". If the "laptop" request is slow and the "mouse" request is fast, the "laptop" results might arrive last and overwrite the "mouse" results.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Simulating race condition</span>
<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">  </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Simulate variable network latency</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2000</span><span class="p">;</span>

<span class="w">  </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// This might set results for an old query!</span>
<span class="w">        </span><span class="nx">setResults</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="nx">delay</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">]);</span>
</code></pre></div>

<p><strong>Browser Console Output</strong> (race condition):</p>
<div class="codehilite"><pre><span></span><code>[<span class="mi">10</span>:<span class="mi">23</span>:<span class="mi">45</span>.<span class="mi">123</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;laptop&quot;</span>
[<span class="mi">10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">234</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Fetching</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;mouse&quot;</span><span class="w">  </span>‚Üê<span class="w"> </span><span class="nv">User</span><span class="w"> </span><span class="nv">changed</span><span class="w"> </span><span class="nv">their</span><span class="w"> </span><span class="nv">mind</span>
[<span class="mi">10</span>:<span class="mi">23</span>:<span class="mi">46</span>.<span class="mi">456</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;mouse&quot;</span><span class="w"> </span>‚Üê<span class="w"> </span><span class="nv">Fast</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="nv">returns</span><span class="w"> </span><span class="nv">first</span>
[<span class="mi">10</span>:<span class="mi">23</span>:<span class="mi">47</span>.<span class="mi">789</span><span class="nv">Z</span>]<span class="w"> </span><span class="nv">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">results</span><span class="w"> </span><span class="k">for</span>:<span class="w"> </span><span class="s2">&quot;laptop&quot;</span><span class="w"> </span>‚Üê<span class="w"> </span><span class="nv">Slow</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="nv">returns</span><span class="w"> </span><span class="nv">last</span>
</code></pre></div>

<p><strong>Result</strong>: User sees "mouse" results briefly, then they're replaced by "laptop" results‚Äîeven though the user searched for "mouse"!</p>
<h4 id="problem-2-no-caching">Problem 2: No Caching</h4>
<p>User searches for "laptop", sees results, searches for "mouse", then searches for "laptop" again. The second "laptop" search makes another network request, even though we already have that data.</p>
<h4 id="problem-3-no-error-recovery">Problem 3: No Error Recovery</h4>
<p>Network request fails‚Äînow what? Show an error message? Retry automatically? How many times? With exponential backoff?</p>
<p>All of this is complex to implement correctly. This is where <strong>React Query</strong> (TanStack Query) comes in.</p>
<h2 id="react-query-professional-client-side-data-fetching">React Query: Professional Client-Side Data Fetching</h2>
<p>React Query is a library that solves all the problems we just identified:</p>
<ul>
<li>‚úÖ Automatic caching</li>
<li>‚úÖ Background refetching</li>
<li>‚úÖ Request deduplication</li>
<li>‚úÖ Automatic retries with exponential backoff</li>
<li>‚úÖ Loading and error states</li>
<li>‚úÖ Optimistic updates</li>
<li>‚úÖ Pagination and infinite scroll</li>
<li>‚úÖ Request cancellation</li>
<li>‚úÖ DevTools for debugging</li>
</ul>
<h3 id="installation">Installation</h3>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>@tanstack/react-query
</code></pre></div>

<h3 id="setup-query-client-provider">Setup: Query Client Provider</h3>
<p>React Query requires a provider at the root of your app:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/providers.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">QueryClient</span><span class="p">,</span><span class="w"> </span><span class="nx">QueryClientProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ReactQueryDevtools</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query-devtools&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Providers</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Create a client instance</span>
<span class="w">  </span><span class="c1">// Use useState to ensure it&#39;s only created once per component mount</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">queryClient</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">QueryClient</span><span class="p">({</span>
<span class="w">    </span><span class="nx">defaultOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">queries</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">staleTime</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">// Data is fresh for 1 minute</span>
<span class="w">        </span><span class="nx">refetchOnWindowFocus</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// Don&#39;t refetch when user returns to tab</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">}));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">QueryClientProvider</span><span class="w"> </span><span class="na">client</span><span class="o">=</span><span class="p">{</span><span class="nx">queryClient</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ReactQueryDevtools</span><span class="w"> </span><span class="na">initialIsOpen</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">QueryClientProvider</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Providers</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./providers&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">Providers</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Providers</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-4-search-with-react-query">Iteration 4: Search with React Query</h3>
<p>Now let's rebuild our search component using React Query:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductSearch.tsx - React Query approach</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useQuery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useDebounce</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/hooks/useDebounce&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">searchProducts</span><span class="p">(</span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Search failed&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductSearch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="nx">setQuery</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Debounce the query to avoid excessive requests</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">debouncedQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useDebounce</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="mf">300</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// React Query handles caching, loading states, errors, and more</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;search&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">debouncedQuery</span><span class="p">],</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">searchProducts</span><span class="p">(</span><span class="nx">debouncedQuery</span><span class="p">),</span>
<span class="w">    </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">debouncedQuery.length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// Only run query if there&#39;s a search term</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">        </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
<span class="w">        </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">query</span><span class="p">}</span>
<span class="w">        </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setQuery</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">        </span><span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Search products...&quot;</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full px-4 py-2 border rounded-lg&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">Searching</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 text-red-600&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Search</span><span class="w"> </span><span class="nx">failed</span><span class="p">.</span><span class="w"> </span><span class="nx">Please</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="nx">again</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">debouncedQuery</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">No</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="nx">found</span><span class="p">.&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/hooks/useDebounce.ts - Debounce hook</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useDebounce</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">T</span><span class="p">,</span><span class="w"> </span><span class="nx">delay</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">debouncedValue</span><span class="p">,</span><span class="w"> </span><span class="nx">setDebouncedValue</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setDebouncedValue</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="nx">delay</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">delay</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">debouncedValue</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="what-changed_1">What Changed?</h3>
<p><strong>Before</strong> (manual useEffect):</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">setResults</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Product</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/search?q=</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setResults</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">query</span><span class="p">]);</span>
</code></pre></div>

<p><strong>After</strong> (React Query):</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;search&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">debouncedQuery</span><span class="p">],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">searchProducts</span><span class="p">(</span><span class="nx">debouncedQuery</span><span class="p">),</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">debouncedQuery.length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="verification-react-query-in-action">Verification: React Query in Action</h3>
<p>Let's type "laptop" again and observe the difference.</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.123</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;l&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.234</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;la&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.345</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lap&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.456</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lapt&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.567</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lapto&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.678</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">typed</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;laptop&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">45.978</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">Debounce</span><span class="w"> </span><span class="nx">complete</span><span class="p">,</span><span class="w"> </span><span class="nx">fetching</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="k">for</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;laptop&quot;</span>
<span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="m m-Double">46.189</span><span class="nx">Z</span><span class="p">]</span><span class="w"> </span><span class="nx">Received</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="k">for</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;laptop&quot;</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- Filter: Fetch/XHR
- Observation: <strong>Only 1 request</strong> to <code>/api/products/search?q=laptop</code>
- Timeline: Request fires 300ms after user stops typing
- Pattern: Debouncing works‚Äîintermediate keystrokes don't trigger requests
- Total requests: 1 (down from 6!)</p>
<p><strong>React Query DevTools</strong> (open the floating icon in bottom-right):
- Query key: <code>['products', 'search', 'laptop']</code>
- Status: <code>success</code>
- Data: Array of 3 products
- Last updated: 2 seconds ago
- Stale in: 58 seconds (based on our <code>staleTime</code> config)</p>
<h3 id="expected-vs-actual-improvement_2">Expected vs. Actual Improvement</h3>
<p><strong>Before</strong> (manual useEffect):
- Requests: 6 (one per keystroke)
- Caching: None (same search twice = two requests)
- Error handling: Manual try/catch
- Loading states: Manual state management
- Race conditions: Possible
- Code complexity: High</p>
<p><strong>After</strong> (React Query):
- Requests: 1 (debounced)
- Caching: Automatic (same search twice = instant from cache)
- Error handling: Built-in with <code>error</code> state
- Loading states: Built-in with <code>isLoading</code> state
- Race conditions: Impossible (React Query cancels old requests)
- Code complexity: Low</p>
<h3 id="demonstrating-the-cache">Demonstrating the Cache</h3>
<p>Let's prove the caching works:</p>
<ol>
<li>Search for "laptop" ‚Üí Request fires, results appear</li>
<li>Clear the search box</li>
<li>Search for "laptop" again ‚Üí <strong>No request fires</strong>, results appear instantly from cache</li>
</ol>
<p><strong>React Query DevTools</strong> shows:
- Query status: <code>success</code> (from cache)
- Data age: 5 seconds
- No network request in Network tab</p>
<h3 id="react-query-core-concepts">React Query Core Concepts</h3>
<h4 id="1-query-keys">1. Query Keys</h4>
<p>Query keys uniquely identify queries for caching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Simple key</span>
<span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="kt">getProducts</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// Key with parameters</span>
<span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;search&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="p">],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">searchProducts</span><span class="p">(</span><span class="nx">query</span><span class="p">),</span>
<span class="p">});</span>

<span class="c1">// Key with multiple parameters</span>
<span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;price&#39;</span><span class="w"> </span><span class="p">}],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">({</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">sort</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;price&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>Rule</strong>: If the query key changes, React Query treats it as a different query and fetches new data.</p>
<h4 id="2-query-functions">2. Query Functions</h4>
<p>The function that actually fetches the data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Simple fetch</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">queryFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="c1">// With parameters from query key</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">queryFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">queryKey</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">_key</span><span class="p">,</span><span class="w"> </span><span class="nx">_search</span><span class="p">,</span><span class="w"> </span><span class="nx">query</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">queryKey</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">searchProducts</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// Async function</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">queryFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="3-query-options">3. Query Options</h4>
<p>Configure query behavior:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="kt">getProducts</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Only run query if condition is true</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">isLoggedIn</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// How long data stays fresh (no refetch during this time)</span>
<span class="w">  </span><span class="nx">staleTime</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 5 minutes</span>

<span class="w">  </span><span class="c1">// How long unused data stays in cache</span>
<span class="w">  </span><span class="nx">cacheTime</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">,</span><span class="w"> </span><span class="c1">// 10 minutes</span>

<span class="w">  </span><span class="c1">// Retry failed requests</span>
<span class="w">  </span><span class="nx">retry</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Exponential backoff between retries</span>
<span class="w">  </span><span class="nx">retryDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">attemptIndex</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="nx">attemptIndex</span><span class="p">,</span><span class="w"> </span><span class="mf">30000</span><span class="p">),</span>

<span class="w">  </span><span class="c1">// Refetch on window focus</span>
<span class="w">  </span><span class="nx">refetchOnWindowFocus</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Refetch on network reconnect</span>
<span class="w">  </span><span class="nx">refetchOnReconnect</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="real-world-react-query-patterns">Real-World React Query Patterns</h3>
<h4 id="pattern-1-dependent-queries">Pattern 1: Dependent Queries</h4>
<p>One query depends on the result of another:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductDetails.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useQuery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductDetails</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// First query: Get product details</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">productId</span><span class="p">],</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">productId</span><span class="p">),</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Second query: Get related products (depends on first query)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">relatedProducts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;related&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">product</span><span class="o">?</span><span class="p">.</span><span class="nx">category</span><span class="p">],</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getRelatedProducts</span><span class="p">(</span><span class="nx">product</span><span class="o">!</span><span class="p">.</span><span class="nx">category</span><span class="p">),</span>
<span class="w">    </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="o">!!</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="c1">// Only run when product is loaded</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">relatedProducts</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span><span class="nx">Related</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">relatedProducts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="pattern-2-pagination">Pattern 2: Pagination</h4>
<p>Fetching paginated data:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductList.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useQuery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">setPage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">isPlaceholderData</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">page</span><span class="p">],</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">placeholderData</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">previousData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">previousData</span><span class="p">,</span><span class="w"> </span><span class="c1">// Keep old data while fetching new</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 flex gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">          </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setPage</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))}</span>
<span class="w">          </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">page</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Previous</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span><span class="nx">Page</span><span class="w"> </span><span class="p">{</span><span class="nx">page</span><span class="p">}&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">          </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setPage</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)}</span>
<span class="w">          </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isPlaceholderData</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">hasMore</span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Next</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="pattern-3-infinite-scroll">Pattern 3: Infinite Scroll</h4>
<p>Loading more data as user scrolls:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/InfiniteProductList.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useInfiniteQuery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">InfiniteProductList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">data</span><span class="p">,</span>
<span class="w">    </span><span class="nx">fetchNextPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">hasNextPage</span><span class="p">,</span>
<span class="w">    </span><span class="nx">isFetchingNextPage</span><span class="p">,</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useInfiniteQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;infinite&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">pageParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">({</span><span class="w"> </span><span class="nx">page</span><span class="o">:</span><span class="w"> </span><span class="kt">pageParam</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="o">:</span><span class="w"> </span><span class="kt">20</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">getNextPageParam</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">lastPage</span><span class="p">,</span><span class="w"> </span><span class="nx">pages</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">lastPage</span><span class="p">.</span><span class="nx">hasMore</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">pages</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">initialPageParam</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Intersection Observer for infinite scroll</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">loadMoreRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLDivElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">loadMoreRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">observer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">IntersectionObserver</span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="nx">entries</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">isIntersecting</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">hasNextPage</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isFetchingNextPage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">fetchNextPage</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">threshold</span><span class="o">:</span><span class="w"> </span><span class="kt">1.0</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">loadMoreRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">observer</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">hasNextPage</span><span class="p">,</span><span class="w"> </span><span class="nx">isFetchingNextPage</span><span class="p">,</span><span class="w"> </span><span class="nx">fetchNextPage</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">pages</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">page</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">i</span><span class="p">}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">page</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">loadMoreRef</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-20 flex items-center justify-center&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isFetchingNextPage</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">more</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="pattern-4-mutations-creatingupdating-data">Pattern 4: Mutations (Creating/Updating Data)</h4>
<p>React Query also handles mutations (POST, PUT, DELETE):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/AddToCartButton.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useMutation</span><span class="p">,</span><span class="w"> </span><span class="nx">useQueryClient</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addToCart</span><span class="p">(</span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/cart&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}),</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to add to cart&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">AddToCartButton</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQueryClient</span><span class="p">();</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mutation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMutation</span><span class="p">({</span>
<span class="w">    </span><span class="nx">mutationFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">addToCart</span><span class="p">(</span><span class="nx">productId</span><span class="p">),</span>
<span class="w">    </span><span class="nx">onSuccess</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Invalidate cart query to refetch</span>
<span class="w">      </span><span class="nx">queryClient</span><span class="p">.</span><span class="nx">invalidateQueries</span><span class="p">({</span><span class="w"> </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">      </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">mutation</span><span class="p">.</span><span class="nx">mutate</span><span class="p">()}</span>
<span class="w">      </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isPending</span><span class="p">}</span>
<span class="w">      </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 bg-blue-600 text-white rounded&quot;</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isPending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Adding...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Add to Cart&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_1">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-no-queryclient-set-use-queryclientprovider-to-set-one">Symptom: "No QueryClient set, use QueryClientProvider to set one"</h4>
<p><strong>Browser behavior</strong>:
Error boundary or blank page</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">QueryClient</span><span class="w"> </span><span class="kd">set</span><span class="o">,</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">QueryClientProvider</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kd">set</span><span class="w"> </span><span class="n">one</span>
<span class="w">    </span><span class="n">at</span><span class="w"> </span><span class="n">useQueryClient</span><span class="w"> </span><span class="o">(</span><span class="n">react</span><span class="o">-</span><span class="n">query</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">123</span><span class="o">)</span>
</code></pre></div>

<p><strong>Root cause</strong>: Forgot to wrap app in <code>QueryClientProvider</code></p>
<p><strong>Solution</strong>: Add provider in root layout (see setup section above)</p>
<h4 id="symptom-query-refetches-on-every-render">Symptom: Query refetches on every render</h4>
<p><strong>Browser behavior</strong>:
Excessive network requests, poor performance</p>
<p><strong>React Query DevTools</strong>:
- Query status constantly switching between <code>fetching</code> and <code>success</code>
- Fetch count incrementing rapidly</p>
<p><strong>Root cause</strong>: Query key includes unstable reference (object/array created inline)</p>
<p><strong>Solution</strong>: Memoize query key or use primitive values</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: Object created on every render</span>
<span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="w"> </span><span class="p">}],</span><span class="w"> </span><span class="c1">// New object each time!</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="kt">getProducts</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// ‚úÖ Good: Stable primitive values</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">;</span>
<span class="nx">useQuery</span><span class="p">({</span>
<span class="w">  </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="p">],</span>
<span class="w">  </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">({</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="p">}),</span>
<span class="p">});</span>
</code></pre></div>

<h4 id="symptom-stale-data-shown-after-mutation">Symptom: Stale data shown after mutation</h4>
<p><strong>Browser behavior</strong>:
User adds item to cart, but cart count doesn't update</p>
<p><strong>Root cause</strong>: Forgot to invalidate related queries after mutation</p>
<p><strong>Solution</strong>: Use <code>queryClient.invalidateQueries()</code> in mutation's <code>onSuccess</code></p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">mutation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMutation</span><span class="p">({</span>
<span class="w">  </span><span class="nx">mutationFn</span><span class="o">:</span><span class="w"> </span><span class="kt">addToCart</span><span class="p">,</span>
<span class="w">  </span><span class="nx">onSuccess</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Invalidate all queries that start with [&#39;cart&#39;]</span>
<span class="w">    </span><span class="nx">queryClient</span><span class="p">.</span><span class="nx">invalidateQueries</span><span class="p">({</span><span class="w"> </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;cart&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="when-to-apply-this-solution_1">When to Apply This Solution</h3>
<p><strong>What React Query optimizes for</strong>:
- Automatic caching and background updates
- Simplified loading and error states
- Request deduplication and cancellation
- Optimistic updates
- Developer experience (less boilerplate)</p>
<p><strong>What it sacrifices</strong>:
- Additional bundle size (~13KB gzipped)
- Learning curve for advanced features
- Another dependency to maintain</p>
<p><strong>When to choose React Query</strong>:
- Complex client-side data fetching requirements
- Need caching, background updates, or optimistic updates
- Multiple components fetching the same data
- Pagination or infinite scroll
- Real-time data that needs periodic refetching</p>
<p><strong>When to avoid React Query</strong>:
- Simple one-time fetches (use Server Components instead)
- All data can be fetched on the server
- Bundle size is critical and you can't afford 13KB
- Team is unfamiliar and timeline is tight</p>
<p><strong>Code characteristics</strong>:
- Setup: Medium (provider + configuration)
- Maintenance: Low (library handles complexity)
- Performance: Excellent (automatic optimizations)</p>
<h3 id="limitation-preview_1">Limitation Preview</h3>
<p>React Query solves client-side data fetching, but we still have a problem: the <strong>entire page</strong> waits for the <strong>slowest Server Component</strong> to finish rendering before any HTML is sent to the client.</p>
<p>What if we could send the fast parts of the page immediately and stream in the slow parts as they become ready? That's what Streaming and Suspense enable (next section).</p>
<h2 id="streaming-and-suspense">Streaming and Suspense</h2>
<h2 id="the-problem-slow-components-block-the-entire-page">The Problem: Slow Components Block the Entire Page</h2>
<p>Let's return to our product catalog. We have three data sources with different speeds:</p>
<ol>
<li><strong>Categories</strong> (fast): 100ms - cached in Redis</li>
<li><strong>Products</strong> (medium): 500ms - database query</li>
<li><strong>Recommendations</strong> (slow): 3000ms - ML model inference</li>
</ol>
<p>With our current Server Component approach, the page waits for <strong>all three</strong> to complete before sending any HTML to the client.</p>
<h3 id="iteration-5-the-all-or-nothing-problem-the-failure">Iteration 5: The All-or-Nothing Problem (The Failure)</h3>
<p>Let's add a recommendations section that's intentionally slow:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Add slow recommendations</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRecommendations</span><span class="p">(</span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Simulate ML model inference - very slow</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">3000</span><span class="p">));</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;10&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Recommended Item 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">199</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/rec1.jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;11&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Recommended Item 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">299</span><span class="p">,</span><span class="w"> </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;electronics&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/rec2.jpg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - With slow recommendations</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">,</span><span class="w"> </span><span class="nx">getRecommendations</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// All fetches run in parallel, but page waits for slowest</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span><span class="w">      </span><span class="c1">// 500ms</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span><span class="w">    </span><span class="c1">// 100ms</span>
<span class="w">    </span><span class="nx">getRecommendations</span><span class="p">(</span><span class="s1">&#39;user-123&#39;</span><span class="p">),</span><span class="w"> </span><span class="c1">// 3000ms ‚Üê Blocks everything!</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* Categories - ready in 100ms, but waits 3000ms to show */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="cm">/* Products - ready in 500ms, but waits 3000ms to show */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">          </span><span class="p">{</span><span class="cm">/* Recommendations - takes 3000ms */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Recommended</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">You</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">{</span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">))}</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-blocking-failure">Diagnostic Analysis: Reading the Blocking Failure</h3>
<p>Let's navigate to <code>/products</code> and observe what happens.</p>
<p><strong>Browser Behavior</strong>:
- User navigates to <code>/products</code>
- Browser shows loading indicator for 3+ seconds
- Then entire page appears at once
- No progressive loading‚Äîeverything or nothing</p>
<p><strong>Network Tab Analysis</strong>:
- Filter: Doc (HTML document)
- Observation: Single request to <code>/products</code>
- Timeline:
  - 0-3000ms: Waiting for server response (TTFB)
  - 3000ms: HTML arrives with all content
- Pattern: Server holds the response until all data is ready
- Total time to content: 3+ seconds</p>
<p><strong>Server Logs</strong> (add timing):</p>
<div class="codehilite"><pre><span></span><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[Server] Starting data fetch...&#39;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">  </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getRecommendations</span><span class="p">(</span><span class="s1">&#39;user-123&#39;</span><span class="p">),</span>
<span class="p">]);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[Server] Data ready in </span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[Server] Rendering HTML...`</span><span class="p">);</span>
</code></pre></div>

<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Starting<span class="w"> </span>data<span class="w"> </span>fetch...
<span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Data<span class="w"> </span>ready<span class="w"> </span><span class="k">in</span><span class="w"> </span>3012ms
<span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Rendering<span class="w"> </span>HTML...
</code></pre></div>

<p><strong>Performance Metrics</strong>:
- <strong>Time to First Byte (TTFB)</strong>: 3050ms ‚ö†Ô∏è (terrible!)
- <strong>First Contentful Paint (FCP)</strong>: 3100ms ‚ö†Ô∏è
- <strong>Largest Contentful Paint (LCP)</strong>: 3150ms ‚ö†Ô∏è
- <strong>Time to Interactive (TTI)</strong>: 3200ms ‚ö†Ô∏è</p>
<h3 id="lets-parse-this-evidence_2">Let's Parse This Evidence</h3>
<ol>
<li><strong>What the user experiences</strong>:</li>
<li>Expected: See fast content (categories, products) immediately, recommendations load later</li>
<li>
<p>Actual: Stare at blank page for 3 seconds, then everything appears at once</p>
</li>
<li>
<p><strong>What the Network tab shows</strong>:</p>
</li>
<li>Key indicator: TTFB is 3 seconds‚Äîserver is holding the response</li>
<li>Pattern: All-or-nothing‚Äîno progressive rendering</li>
<li>
<p>Wasted opportunity: Categories and products are ready in 500ms, but user doesn't see them</p>
</li>
<li>
<p><strong>What the server logs reveal</strong>:</p>
</li>
<li>Technical evidence: <code>Promise.all()</code> waits for slowest promise (3000ms)</li>
<li>
<p>Root cause: Synchronous rendering‚Äîpage can't be sent until all data is ready</p>
</li>
<li>
<p><strong>Root cause identified</strong>: 
   Server Components render synchronously. The page waits for all async operations to complete before sending any HTML to the client.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>:
   Even if we optimize the recommendations query, we'll always have this problem:</p>
</li>
<li>Any slow component blocks the entire page</li>
<li>Users see nothing while waiting for slow data</li>
<li>Fast content is held hostage by slow content</li>
<li>
<p>No way to show partial results</p>
</li>
<li>
<p><strong>What we need</strong>:
   A way to send the fast parts of the page immediately and stream in the slow parts as they become ready. This is what <strong>Streaming</strong> and <strong>Suspense</strong> enable.</p>
</li>
</ol>
<h3 id="the-fundamental-problem-synchronous-rendering">The Fundamental Problem: Synchronous Rendering</h3>
<p>Traditional server rendering is all-or-nothing:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Server</span><span class="o">:</span><span class="w"> </span><span class="n">Fetch</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Render</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">HTML</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">complete</span><span class="w"> </span><span class="n">response</span>
<span class="n">Client</span><span class="o">:</span><span class="w"> </span><span class="n">Wait</span><span class="o">...</span><span class="w"> </span><span class="n">wait</span><span class="o">...</span><span class="w"> </span><span class="n">wait</span><span class="o">...</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">everything</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">once</span>
</code></pre></div>

<p>What we want:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Fetch</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">partial</span><span class="w"> </span><span class="n">HTML</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Continue</span><span class="w"> </span><span class="n">fetching</span><span class="w"> </span><span class="n">slow</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">HTML</span>
<span class="n">Client</span><span class="p">:</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">fast</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Show</span><span class="w"> </span><span class="n">loading</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="err">‚Üí</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">slow</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">ready</span>
</code></pre></div>

<p>This is <strong>streaming</strong>‚Äîsending HTML in chunks as it becomes ready.</p>
<h2 id="streaming-with-suspense">Streaming with Suspense</h2>
<p>React 18 introduced <strong>Suspense</strong> for Server Components, enabling streaming. Here's how it works:</p>
<ol>
<li>Wrap slow components in <code>&lt;Suspense&gt;</code> with a fallback</li>
<li>Next.js sends the fast parts of the page immediately</li>
<li>Slow components show the fallback (loading state)</li>
<li>When slow data is ready, Next.js streams the real content</li>
<li>React replaces the fallback with the real content (no page reload)</li>
</ol>
<h3 id="iteration-6-streaming-with-suspense">Iteration 6: Streaming with Suspense</h3>
<p>Let's refactor our page to stream the slow recommendations:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/RecommendationsSection.tsx - Slow component extracted</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getRecommendations</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RecommendationsSection</span><span class="p">({</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// This is slow (3000ms), but won&#39;t block the page</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">recommendations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getRecommendations</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Recommended</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">You</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">recommendations</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - With Suspense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">RecommendationsSection</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RecommendationsSection&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Only fetch fast data here</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span><span class="w">    </span><span class="c1">// 500ms</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span><span class="w">  </span><span class="c1">// 100ms</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* Categories - shows immediately */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="cm">/* Products - shows immediately */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">          </span><span class="p">{</span><span class="cm">/* Recommendations - streams in later */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">RecommendationsLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">RecommendationsSection</span><span class="w"> </span><span class="na">userId</span><span class="o">=</span><span class="s">&quot;user-123&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">RecommendationsLoading</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Recommended</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">You</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">i</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4 animate-pulse&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-4 bg-gray-200 rounded w-3/4 mb-2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-4 bg-gray-200 rounded w-1/2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="what-changed_2">What Changed?</h3>
<p><strong>Before</strong> (blocking):</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">recommendations</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">  </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getRecommendations</span><span class="p">(</span><span class="s1">&#39;user-123&#39;</span><span class="p">),</span><span class="w"> </span><span class="c1">// Blocks everything!</span>
<span class="p">]);</span>

<span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">{</span><span class="cm">/* All content rendered together */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Categories</span><span class="w"> </span><span class="na">data</span><span class="o">=</span><span class="p">{</span><span class="nx">categories</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Products</span><span class="w"> </span><span class="na">data</span><span class="o">=</span><span class="p">{</span><span class="nx">products</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Recommendations</span><span class="w"> </span><span class="na">data</span><span class="o">=</span><span class="p">{</span><span class="nx">recommendations</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div>

<p><strong>After</strong> (streaming):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Only fetch fast data</span>
<span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">  </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="p">]);</span>

<span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">{</span><span class="cm">/* Fast content rendered immediately */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Categories</span><span class="w"> </span><span class="na">data</span><span class="o">=</span><span class="p">{</span><span class="nx">categories</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Products</span><span class="w"> </span><span class="na">data</span><span class="o">=</span><span class="p">{</span><span class="nx">products</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">    </span><span class="p">{</span><span class="cm">/* Slow content wrapped in Suspense */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Loading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">RecommendationsSection</span><span class="w"> </span><span class="na">userId</span><span class="o">=</span><span class="s">&quot;user-123&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="verification-streaming-in-action">Verification: Streaming in Action</h3>
<p>Let's navigate to <code>/products</code> and observe the streaming behavior.</p>
<p><strong>Browser Behavior</strong> (watch carefully):
1. Page appears immediately with categories and products (500ms)
2. Recommendations section shows loading skeleton
3. After 3 seconds, loading skeleton is replaced with real recommendations
4. No page reload‚Äîcontent streams in seamlessly</p>
<p><strong>Network Tab Analysis</strong>:
- Filter: Doc (HTML document)
- Observation: Single request to <code>/products</code>, but response arrives in <strong>chunks</strong>
- Timeline:
  - 0-500ms: Waiting for fast data
  - 500ms: First chunk arrives (HTML with categories, products, and loading fallback)
  - 500-3500ms: Connection stays open
  - 3500ms: Second chunk arrives (HTML with recommendations)
- Pattern: <strong>Streaming response</strong>‚ÄîHTML sent in multiple chunks
- Total time to first content: 500ms (down from 3000ms!)
- Total time to complete: 3500ms (same as before, but user sees content sooner)</p>
<p><strong>Performance Metrics</strong>:
- <strong>Time to First Byte (TTFB)</strong>: 550ms ‚úÖ (down from 3050ms!)
- <strong>First Contentful Paint (FCP)</strong>: 600ms ‚úÖ (down from 3100ms!)
- <strong>Largest Contentful Paint (LCP)</strong>: 650ms ‚úÖ (down from 3150ms!)
- <strong>Time to Interactive (TTI)</strong>: 700ms ‚úÖ (down from 3200ms!)</p>
<h3 id="expected-vs-actual-improvement_3">Expected vs. Actual Improvement</h3>
<p><strong>Before</strong> (blocking):
- User sees: Nothing ‚Üí Wait 3s ‚Üí Everything appears
- TTFB: 3050ms
- FCP: 3100ms
- User perception: "This site is slow"</p>
<p><strong>After</strong> (streaming):
- User sees: Categories + Products (500ms) ‚Üí Loading skeleton ‚Üí Recommendations (3500ms)
- TTFB: 550ms (82% faster!)
- FCP: 600ms (81% faster!)
- User perception: "This site is fast, recommendations are loading"</p>
<p><strong>Key insight</strong>: The total time to complete is similar, but the <strong>perceived performance</strong> is dramatically better. Users see content immediately instead of staring at a blank page.</p>
<h3 id="how-streaming-works-under-the-hood">How Streaming Works Under the Hood</h3>
<p>Let's look at the actual HTML that gets streamed:</p>
<p><strong>First Chunk</strong> (arrives at 500ms):</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Our Products<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

    <span class="cm">&lt;!-- Categories and products are here --&gt;</span>
    <span class="p">&lt;</span><span class="nt">aside</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Categories<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Electronics (45)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>Furniture (23)<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;grid&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Laptop Pro - $1299<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="cm">&lt;!-- More products... --&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

      <span class="cm">&lt;!-- Suspense fallback --&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;recommendations-fallback&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Recommended for You<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;animate-pulse&quot;</span><span class="p">&gt;</span>Loading...<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="cm">&lt;!-- Script to handle streaming --&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="cm">/* React streaming runtime */</span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><strong>Second Chunk</strong> (arrives at 3500ms):</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- Streamed content --&gt;</span>
<span class="p">&lt;</span><span class="nt">template</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;recommendations-content&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mt-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Recommended for You<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;grid&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Recommended Item 1 - $199<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Recommended Item 2 - $299<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">  </span><span class="c1">// React replaces fallback with real content</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">fallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;recommendations-fallback&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;recommendations-content&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">fallback</span><span class="p">.</span><span class="nx">replaceWith</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>React handles all this automatically‚Äîyou just wrap slow components in <code>&lt;Suspense&gt;</code>.</p>
<h2 id="advanced-streaming-patterns">Advanced Streaming Patterns</h2>
<h3 id="pattern-1-multiple-suspense-boundaries">Pattern 1: Multiple Suspense Boundaries</h3>
<p>You can have multiple independent streaming sections:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/dashboard/page.tsx - Multiple streaming sections</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DashboardPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-2 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Left column - fast */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span><span class="nx">Quick</span><span class="w"> </span><span class="nx">Stats</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">QuickStats</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Right column - multiple slow sections */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ChartLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">RevenueChart</span><span class="w"> </span><span class="p">/&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* 2 seconds */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">TableLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">RecentOrders</span><span class="w"> </span><span class="p">/&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* 1 second */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ListLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">TopProducts</span><span class="w"> </span><span class="p">/&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* 3 seconds */</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Streaming timeline</strong>:
- 0ms: Page structure and QuickStats appear
- 1000ms: RecentOrders streams in
- 2000ms: RevenueChart streams in
- 3000ms: TopProducts streams in</p>
<p>Each section streams independently‚Äîfast sections don't wait for slow ones.</p>
<h3 id="pattern-2-nested-suspense">Pattern 2: Nested Suspense</h3>
<p>Suspense boundaries can be nested for fine-grained control:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/product/[id]/page.tsx - Nested Suspense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Outer Suspense - entire product section */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ProductPageLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ProductDetails</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="cm">/* Inner Suspense - just reviews */</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ReviewsLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ProductDetails</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Streaming timeline</strong>:
- 0ms: Page structure appears with outer loading state
- 500ms: Product details stream in, reviews show loading state
- 2000ms: Reviews stream in</p>
<h3 id="pattern-3-conditional-suspense">Pattern 3: Conditional Suspense</h3>
<p>Only wrap in Suspense if the component is actually slow:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Conditional Suspense</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">({</span>
<span class="w">  </span><span class="nx">searchParams</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">searchParams</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">premium?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isPremiumUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">premium</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductGrid</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Only show recommendations for premium users */</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">isPremiumUser</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">RecommendationsLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">PersonalizedRecommendations</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="pattern-4-preloading-data">Pattern 4: Preloading Data</h3>
<p>Start fetching data before it's needed:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/preload.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="c1">// Cache ensures the same data isn&#39;t fetched twice</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">getProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">preloadProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Start fetching, but don&#39;t await</span>
<span class="w">  </span><span class="ow">void</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Preload on hover</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">preloadProduct</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/preload&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductCard</span><span class="p">({</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">Link</span>
<span class="w">      </span><span class="na">href</span><span class="o">=</span><span class="p">{</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span>
<span class="w">      </span><span class="na">onMouseEnter</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">preloadProduct</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures_2">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-suspense-boundary-never-resolves">Symptom: Suspense boundary never resolves</h4>
<p><strong>Browser behavior</strong>:
Loading fallback shows forever, content never appears</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Warning</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">suspended</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">responding</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">synchronous</span><span class="w"> </span><span class="n">input</span><span class="o">.</span>
<span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">UI</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">replaced</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">loading</span><span class="w"> </span><span class="n">indicator</span><span class="o">.</span>
</code></pre></div>

<p><strong>Root cause</strong>: Component inside Suspense is throwing an error, not suspending properly</p>
<p><strong>Solution</strong>: Check server logs for errors, ensure async component is actually awaiting promises</p>
<h4 id="symptom-content-flashes-fallback-content-fallback-content">Symptom: Content flashes (fallback ‚Üí content ‚Üí fallback ‚Üí content)</h4>
<p><strong>Browser behavior</strong>:
Loading state appears briefly, then content, then loading again</p>
<p><strong>Root cause</strong>: Component is re-fetching data on every render (no caching)</p>
<p><strong>Solution</strong>: Use React's <code>cache()</code> function to deduplicate requests</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: Fetches on every render</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductDetails</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
<span class="p">}</span>

<span class="c1">// ‚úÖ Good: Cached, only fetches once</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">getProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cache</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductDetails</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/div&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="symptom-entire-page-waits-for-suspense-boundary">Symptom: Entire page waits for Suspense boundary</h4>
<p><strong>Browser behavior</strong>:
No streaming‚Äîpage behaves like before (all-or-nothing)</p>
<p><strong>Root cause</strong>: Page is statically generated at build time, not dynamically rendered</p>
<p><strong>Solution</strong>: Force dynamic rendering (see next section)</p>
<h3 id="when-to-apply-this-solution_2">When to Apply This Solution</h3>
<p><strong>What Suspense optimizes for</strong>:
- Perceived performance (fast content shows immediately)
- Progressive rendering (show what you have, load the rest)
- Better user experience (no blank page staring)
- Flexibility (independent loading states)</p>
<p><strong>What it sacrifices</strong>:
- Slightly more complex component structure
- Need to design good loading states
- Debugging can be harder (multiple render passes)</p>
<p><strong>When to choose Suspense</strong>:
- Page has mix of fast and slow data sources
- Some content is much slower than others
- User experience is critical
- You want to show partial results</p>
<p><strong>When to avoid Suspense</strong>:
- All data is equally fast
- Page is simple and loads quickly
- Loading states would be distracting
- You need all data before showing anything (e.g., checkout page)</p>
<p><strong>Code characteristics</strong>:
- Setup: Low (just wrap in <code>&lt;Suspense&gt;</code>)
- Maintenance: Low (React handles streaming)
- Performance: Excellent (progressive rendering)</p>
<h3 id="limitation-preview_2">Limitation Preview</h3>
<p>Suspense solves progressive rendering, but we still have a question: should this page be <strong>statically generated</strong> at build time or <strong>dynamically rendered</strong> on each request?</p>
<p>The answer depends on how often the data changes and whether it's personalized. That's what we'll explore in the next section.</p>
<h2 id="static-vs-dynamic-rendering">Static vs. dynamic rendering</h2>
<h2 id="the-question-build-time-or-request-time">The Question: Build Time or Request Time?</h2>
<p>Next.js can render pages in two fundamentally different ways:</p>
<ol>
<li><strong>Static Rendering</strong> (SSG): Generate HTML at build time, serve the same HTML to all users</li>
<li><strong>Dynamic Rendering</strong> (SSR): Generate HTML on each request, personalized for each user</li>
</ol>
<p>The choice dramatically affects performance, scalability, and user experience.</p>
<h3 id="the-mental-model">The Mental Model</h3>
<p><strong>Static Rendering</strong>:</p>
<div class="codehilite"><pre><span></span><code>Build time: Fetch data ‚Üí Render HTML ‚Üí Save to disk
Request time: Serve pre-built HTML (instant!)
</code></pre></div>

<p><strong>Dynamic Rendering</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Build</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Nothing</span>
<span class="nv">Request</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Fetch</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Render</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="k">Send</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="ss">(</span><span class="nv">slower</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">fresh</span><span class="ss">)</span>
</code></pre></div>

<h3 id="iteration-7-understanding-the-default-behavior">Iteration 7: Understanding the Default Behavior</h3>
<p>By default, Next.js tries to statically render everything. Let's see what that means for our product catalog:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Default behavior</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="build-this-page">Build This Page</h3>
<p>Let's build the app and see what Next.js does:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
‚îå<span class="w"> </span>‚óã<span class="w"> </span>/<span class="w">                                    </span><span class="m">5</span>.2<span class="w"> </span>kB<span class="w">         </span><span class="m">87</span>.3<span class="w"> </span>kB
‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products<span class="w">                            </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span>.5<span class="w"> </span>kB
‚îî<span class="w"> </span>‚óã<span class="w"> </span>/about<span class="w">                               </span><span class="m">3</span>.1<span class="w"> </span>kB<span class="w">         </span><span class="m">85</span>.2<span class="w"> </span>kB

‚óã<span class="w">  </span><span class="o">(</span>Static<span class="o">)</span><span class="w">  </span>prerendered<span class="w"> </span>as<span class="w"> </span>static<span class="w"> </span>content
</code></pre></div>

<p><strong>Key indicator</strong>: The <code>‚óã</code> symbol means the page is <strong>statically rendered</strong>. Next.js fetched the data and generated HTML at build time.</p>
<h3 id="verification-static-rendering-in-production">Verification: Static Rendering in Production</h3>
<p>Let's start the production server and observe the behavior:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>start
</code></pre></div>

<p>Navigate to <code>/products</code> and check the Network tab:</p>
<p><strong>Network Tab Analysis</strong>:
- Filter: Doc (HTML document)
- Observation: Request to <code>/products</code>
- Timeline:
  - 0-5ms: Server reads pre-built HTML from disk
  - 5ms: HTML arrives (instant!)
- Pattern: No data fetching‚ÄîHTML was pre-built
- <strong>Time to First Byte (TTFB)</strong>: 5ms ‚úÖ (incredibly fast!)</p>
<p><strong>View Source</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Our Products<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="cm">&lt;!-- Full product HTML is here, generated at build time --&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;grid&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Laptop Pro - $1299<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Wireless Mouse - $29<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="cm">&lt;!-- All products from build time --&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><strong>Performance Metrics</strong>:
- <strong>TTFB</strong>: 5ms ‚úÖ (no data fetching!)
- <strong>FCP</strong>: 50ms ‚úÖ
- <strong>LCP</strong>: 100ms ‚úÖ
- <strong>TTI</strong>: 150ms ‚úÖ</p>
<p>This is <strong>incredibly fast</strong> because the HTML is pre-built. But there's a problem...</p>
<h3 id="the-problem-stale-data">The Problem: Stale Data</h3>
<p>Let's add a new product to the database and refresh the page:</p>
<ol>
<li>Add product "New Laptop" to database</li>
<li>Refresh <code>/products</code> page</li>
<li>"New Laptop" doesn't appear!</li>
</ol>
<p><strong>Why?</strong> The HTML was generated at build time. The page shows the data from when you ran <code>npm run build</code>, not the current data.</p>
<h3 id="diagnostic-analysis-reading-the-stale-data-failure">Diagnostic Analysis: Reading the Stale Data Failure</h3>
<p><strong>Browser Behavior</strong>:
- User adds new product via admin panel
- User refreshes product listing page
- New product doesn't appear
- Old products still shown</p>
<p><strong>Network Tab Analysis</strong>:
- Request to <code>/products</code> returns instantly (5ms)
- HTML contains old data from build time
- No data fetching happens‚Äîserver just serves pre-built HTML</p>
<p><strong>Server Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>No<span class="w"> </span>logs<span class="w"> </span>-<span class="w"> </span>no<span class="w"> </span>data<span class="w"> </span>fetching<span class="w"> </span>happens<span class="w"> </span>on<span class="w"> </span>request<span class="o">]</span>
</code></pre></div>

<h3 id="lets-parse-this-evidence_3">Let's Parse This Evidence</h3>
<ol>
<li><strong>What the user experiences</strong>:</li>
<li>Expected: See new product after adding it</li>
<li>
<p>Actual: New product doesn't appear, even after refresh</p>
</li>
<li>
<p><strong>What the Network tab shows</strong>:</p>
</li>
<li>Key indicator: TTFB is 5ms‚Äîtoo fast to be fetching data</li>
<li>
<p>Pattern: Server is serving pre-built HTML, not generating it on request</p>
</li>
<li>
<p><strong>Root cause identified</strong>: 
   Page is statically rendered at build time. Data changes after build time aren't reflected until you rebuild.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>:
   Static rendering is fundamentally incompatible with frequently changing data. You can't rebuild your entire site every time a product is added.</p>
</li>
<li>
<p><strong>What we need</strong>:
   A way to tell Next.js to render this page dynamically on each request, so it always shows fresh data.</p>
</li>
</ol>
<h2 id="forcing-dynamic-rendering">Forcing Dynamic Rendering</h2>
<p>Next.js provides several ways to opt into dynamic rendering:</p>
<h3 id="method-1-use-dynamic-functions">Method 1: Use Dynamic Functions</h3>
<p>Certain functions automatically make a page dynamic:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Using cookies (dynamic function)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/headers&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Reading cookies makes this page dynamic</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cookieStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookies</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userPreference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;view-mode&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Same JSX as before */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Dynamic functions</strong> that force dynamic rendering:
- <code>cookies()</code> - Read request cookies
- <code>headers()</code> - Read request headers
- <code>searchParams</code> - Read URL query parameters (in page components)
- <code>fetch()</code> with <code>cache: 'no-store'</code> - Opt out of caching</p>
<h3 id="method-2-explicit-dynamic-configuration">Method 2: Explicit Dynamic Configuration</h3>
<p>You can explicitly tell Next.js to render dynamically:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Explicit dynamic rendering</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="c1">// Force dynamic rendering</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">dynamic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;force-dynamic&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Same JSX as before */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="method-3-uncached-fetch">Method 3: Uncached Fetch</h3>
<p>Use <code>fetch()</code> with <code>cache: 'no-store'</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Uncached fetch</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Don&#39;t cache, always fetch fresh</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-dynamic-rendering-in-production">Verification: Dynamic Rendering in Production</h3>
<p>Let's rebuild with <code>dynamic = 'force-dynamic'</code> and observe the difference:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
‚îå<span class="w"> </span>‚óã<span class="w"> </span>/<span class="w">                                    </span><span class="m">5</span>.2<span class="w"> </span>kB<span class="w">         </span><span class="m">87</span>.3<span class="w"> </span>kB
‚îú<span class="w"> </span>∆í<span class="w"> </span>/products<span class="w">                            </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span>.5<span class="w"> </span>kB
‚îî<span class="w"> </span>‚óã<span class="w"> </span>/about<span class="w">                               </span><span class="m">3</span>.1<span class="w"> </span>kB<span class="w">         </span><span class="m">85</span>.2<span class="w"> </span>kB

‚óã<span class="w">  </span><span class="o">(</span>Static<span class="o">)</span><span class="w">   </span>prerendered<span class="w"> </span>as<span class="w"> </span>static<span class="w"> </span>content
∆í<span class="w">  </span><span class="o">(</span>Dynamic<span class="o">)</span><span class="w">  </span>server-rendered<span class="w"> </span>on<span class="w"> </span>demand
</code></pre></div>

<p><strong>Key indicator</strong>: The <code>∆í</code> symbol means the page is <strong>dynamically rendered</strong>. Next.js will fetch data and generate HTML on each request.</p>
<p>Now let's test:</p>
<ol>
<li>Start production server: <code>npm run start</code></li>
<li>Add new product to database</li>
<li>Refresh <code>/products</code> page</li>
<li>New product appears! ‚úÖ</li>
</ol>
<p><strong>Network Tab Analysis</strong>:
- Request to <code>/products</code>
- Timeline:
  - 0-500ms: Server fetching data and rendering HTML
  - 500ms: HTML arrives with fresh data
- Pattern: Data fetching happens on each request
- <strong>TTFB</strong>: 500ms (slower than static, but data is fresh)</p>
<p><strong>Server Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Fetching<span class="w"> </span>products...
<span class="o">[</span>Server<span class="o">]</span><span class="w"> </span>Rendering<span class="w"> </span>page...
</code></pre></div>

<h3 id="expected-vs-actual-improvement_4">Expected vs. Actual Improvement</h3>
<p><strong>Static Rendering</strong>:
- TTFB: 5ms ‚úÖ (incredibly fast)
- Data freshness: Stale ‚ùå (only updated on rebuild)
- Scalability: Excellent ‚úÖ (serve from CDN)
- Use case: Content that rarely changes</p>
<p><strong>Dynamic Rendering</strong>:
- TTFB: 500ms ‚ö†Ô∏è (slower, but acceptable)
- Data freshness: Always fresh ‚úÖ
- Scalability: Good ‚ö†Ô∏è (server must render each request)
- Use case: Frequently changing or personalized content</p>
<h2 id="the-spectrum-static-dynamic-and-hybrid">The Spectrum: Static, Dynamic, and Hybrid</h2>
<p>Most real applications need a mix of both:</p>
<h3 id="pattern-1-static-marketing-pages-dynamic-app-pages">Pattern 1: Static Marketing Pages, Dynamic App Pages</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/page.tsx - Static homepage</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">HomePage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// No dynamic functions, no uncached fetches</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Welcome</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Our</span><span class="w"> </span><span class="nx">Store</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
<span class="w">      </span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Browse</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="nx">amazing</span><span class="w"> </span><span class="nx">products</span><span class="o">!&lt;</span><span class="err">/p&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="err">/div&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Result: Static (‚óã)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/dashboard/page.tsx - Dynamic dashboard</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/headers&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DashboardPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cookieStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookies</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookieStore</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;user-id&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Fetch user-specific data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserData</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Welcome</span><span class="w"> </span><span class="nx">back</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">userData</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">!</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Personalized content */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Result: Dynamic (∆í)</span>
</code></pre></div>

<h3 id="pattern-2-static-product-pages-with-dynamic-cart">Pattern 2: Static Product Pages with Dynamic Cart</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx - Static product details</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span>
<span class="w">  </span><span class="nx">params</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Client Component for interactivity */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">AddToCartButton</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Generate static pages for all products at build time</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">generateStaticParams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">product.id</span><span class="p">,</span>
<span class="w">  </span><span class="p">}));</span>
<span class="p">}</span>
<span class="c1">// Result: Static (‚óã) with dynamic cart functionality</span>
</code></pre></div>

<h3 id="pattern-3-hybrid-with-partial-prerendering-experimental">Pattern 3: Hybrid with Partial Prerendering (Experimental)</h3>
<p>Next.js 14+ introduces <strong>Partial Prerendering</strong> (PPR)‚Äîstatic shell with dynamic holes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Partial Prerendering</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">experimental_ppr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Static parts</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Static: Categories sidebar */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">aside</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Dynamic: Product grid (personalized) */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ProductsLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">PersonalizedProducts</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>: Static shell (categories) served instantly from CDN, dynamic content (personalized products) streamed in.</p>
<h2 id="how-nextjs-decides-static-or-dynamic">How Next.js Decides: Static or Dynamic?</h2>
<p>Next.js uses this decision tree:</p>
<ol>
<li><strong>Does the page use dynamic functions?</strong> (<code>cookies()</code>, <code>headers()</code>, <code>searchParams</code>)</li>
<li>Yes ‚Üí Dynamic (∆í)</li>
<li>
<p>No ‚Üí Continue</p>
</li>
<li>
<p><strong>Does the page use uncached fetches?</strong> (<code>cache: 'no-store'</code> or <code>revalidate: 0</code>)</p>
</li>
<li>Yes ‚Üí Dynamic (∆í)</li>
<li>
<p>No ‚Üí Continue</p>
</li>
<li>
<p><strong>Is <code>dynamic = 'force-dynamic'</code> set?</strong></p>
</li>
<li>Yes ‚Üí Dynamic (∆í)</li>
<li>
<p>No ‚Üí Continue</p>
</li>
<li>
<p><strong>Default</strong>: Static (‚óã)</p>
</li>
</ol>
<h3 id="debugging-why-is-my-page-dynamic">Debugging: Why Is My Page Dynamic?</h3>
<p>If a page is unexpectedly dynamic, check the build output:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<p><strong>Terminal Output</strong> (with explanation):</p>
<div class="codehilite"><pre><span></span><code>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
‚îú<span class="w"> </span>∆í<span class="w"> </span>/products<span class="w">                            </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span>.5<span class="w"> </span>kB

Dynamic<span class="w"> </span>because:
<span class="w">  </span>-<span class="w"> </span>uses<span class="w"> </span>cookies<span class="o">()</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>page.tsx:12
<span class="w">  </span>-<span class="w"> </span>uses<span class="w"> </span>fetch<span class="w"> </span>with<span class="w"> </span>cache:<span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>api.ts:45
</code></pre></div>

<p>Next.js tells you exactly why a page is dynamic.</p>
<h3 id="common-failure-modes-and-their-signatures_3">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-page-is-dynamic-when-it-should-be-static">Symptom: Page is dynamic when it should be static</h4>
<p><strong>Build output</strong>:</p>
<div class="codehilite"><pre><span></span><code>‚îú<span class="w"> </span>∆í<span class="w"> </span>/products<span class="w">                            </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span>.5<span class="w"> </span>kB
</code></pre></div>

<p><strong>Root cause</strong>: Accidentally using dynamic functions or uncached fetches</p>
<p><strong>Solution</strong>: Remove dynamic functions, or use <code>cache: 'force-cache'</code> for fetches</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: Makes page dynamic</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Page</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cookieStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cookies</span><span class="p">();</span><span class="w"> </span><span class="c1">// Dynamic function!</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// ‚úÖ Good: Keep page static</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Page</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Don&#39;t read cookies unless you need to</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="symptom-page-is-static-when-it-should-be-dynamic">Symptom: Page is static when it should be dynamic</h4>
<p><strong>Browser behavior</strong>:
Stale data shown, changes don't appear</p>
<p><strong>Build output</strong>:</p>
<div class="codehilite"><pre><span></span><code>‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products<span class="w">                            </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span>.5<span class="w"> </span>kB
</code></pre></div>

<p><strong>Root cause</strong>: Page doesn't use any dynamic functions, so Next.js assumes it's static</p>
<p><strong>Solution</strong>: Add <code>export const dynamic = 'force-dynamic'</code> or use a dynamic function</p>
<h4 id="symptom-build-fails-with-page-x-used-y-but-did-not-export-dynamic-force-dynamic">Symptom: Build fails with "Page X used Y but did not export dynamic = 'force-dynamic'"</h4>
<p><strong>Terminal output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Error:<span class="w"> </span>Route<span class="w"> </span>/products<span class="w"> </span>used<span class="w"> </span>cookies<span class="o">()</span><span class="w"> </span>but<span class="w"> </span>did<span class="w"> </span>not<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">dynamic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;force-dynamic&#39;</span>
</code></pre></div>

<p><strong>Root cause</strong>: Using dynamic functions in a page that's configured as static</p>
<p><strong>Solution</strong>: Either remove the dynamic function or add <code>export const dynamic = 'force-dynamic'</code></p>
<h3 id="when-to-apply-this-solution_3">When to Apply This Solution</h3>
<p><strong>Use Static Rendering when</strong>:
- Content rarely changes (marketing pages, docs, blog posts)
- Same content for all users (no personalization)
- Performance is critical (need sub-100ms TTFB)
- High traffic (want to serve from CDN)</p>
<p><strong>Use Dynamic Rendering when</strong>:
- Content changes frequently (product inventory, user dashboards)
- Personalized content (recommendations, user-specific data)
- Real-time data (stock prices, live scores)
- User-specific state (shopping cart, preferences)</p>
<p><strong>Use Hybrid (Static + Dynamic) when</strong>:
- Page has both static and dynamic parts
- Want fast initial load with personalized content
- Can use Suspense to stream dynamic parts</p>
<p><strong>Decision Framework</strong>:</p>
<table>
<thead>
<tr>
<th>Content Type</th>
<th>Frequency of Change</th>
<th>Personalized?</th>
<th>Recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Marketing pages</td>
<td>Rarely</td>
<td>No</td>
<td>Static</td>
</tr>
<tr>
<td>Blog posts</td>
<td>Occasionally</td>
<td>No</td>
<td>Static</td>
</tr>
<tr>
<td>Product catalog</td>
<td>Daily</td>
<td>No</td>
<td>Static + Revalidation</td>
</tr>
<tr>
<td>Product details</td>
<td>Hourly</td>
<td>No</td>
<td>Static + Revalidation</td>
</tr>
<tr>
<td>User dashboard</td>
<td>Real-time</td>
<td>Yes</td>
<td>Dynamic</td>
</tr>
<tr>
<td>Shopping cart</td>
<td>Real-time</td>
<td>Yes</td>
<td>Dynamic</td>
</tr>
<tr>
<td>Search results</td>
<td>Real-time</td>
<td>Maybe</td>
<td>Dynamic</td>
</tr>
<tr>
<td>Recommendations</td>
<td>Real-time</td>
<td>Yes</td>
<td>Dynamic (Suspense)</td>
</tr>
</tbody>
</table>
<h3 id="limitation-preview_3">Limitation Preview</h3>
<p>We've learned to choose between static and dynamic rendering, but there's a middle ground: <strong>Incremental Static Regeneration (ISR)</strong>‚Äîstatic pages that automatically update in the background.</p>
<p>What if we could get the performance of static rendering with the freshness of dynamic rendering? That's what revalidation strategies enable (next section).</p>
<h2 id="revalidation-strategies">Revalidation strategies</h2>
<h2 id="the-best-of-both-worlds-static-performance-with-fresh-data">The Best of Both Worlds: Static Performance with Fresh Data</h2>
<p>We've seen two extremes:</p>
<ul>
<li><strong>Static Rendering</strong>: Fast (5ms TTFB) but stale data</li>
<li><strong>Dynamic Rendering</strong>: Fresh data but slower (500ms TTFB)</li>
</ul>
<p>What if we could have both? <strong>Incremental Static Regeneration (ISR)</strong> gives us static performance with automatic background updates.</p>
<h3 id="the-mental-model_1">The Mental Model</h3>
<p><strong>Traditional Static</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Build</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Generate</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Save</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span>
<span class="nv">Request</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Serve</span><span class="w"> </span><span class="nv">stale</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span><span class="nv">forever</span><span class="w"> </span><span class="ss">(</span><span class="k">until</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="nv">build</span><span class="ss">)</span>
</code></pre></div>

<p><strong>ISR (Incremental Static Regeneration)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Build</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Generate</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Save</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">disk</span>
<span class="nv">Request</span><span class="w"> </span><span class="nv">time</span>:<span class="w"> </span><span class="nv">Serve</span><span class="w"> </span><span class="nv">cached</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span><span class="ss">(</span><span class="nv">fast</span><span class="o">!</span><span class="ss">)</span>
<span class="nv">Background</span>:<span class="w"> </span><span class="nv">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">stale</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Regenerate</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">needed</span><span class="w"> </span>‚Üí<span class="w"> </span><span class="nv">Update</span><span class="w"> </span><span class="nv">cache</span>
<span class="k">Next</span><span class="w"> </span><span class="nv">request</span>:<span class="w"> </span><span class="nv">Serve</span><span class="w"> </span><span class="nv">fresh</span><span class="w"> </span><span class="nv">HTML</span><span class="w"> </span><span class="ss">(</span><span class="nv">still</span><span class="w"> </span><span class="nv">fast</span><span class="o">!</span><span class="ss">)</span>
</code></pre></div>

<h3 id="iteration-8-time-based-revalidation">Iteration 8: Time-Based Revalidation</h3>
<p>Let's make our product catalog update automatically every 60 seconds:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Time-based revalidation</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">,</span><span class="w"> </span><span class="nx">getCategories</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/api&#39;</span><span class="p">;</span>

<span class="c1">// Revalidate this page every 60 seconds</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-12 gap-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">aside</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-3&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Categories</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ul</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">categories</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">cat</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">cat</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="p">({</span><span class="nx">cat</span><span class="p">.</span><span class="nx">count</span><span class="p">})&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">aside</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;col-span-9&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="what-changed_3">What Changed?</h3>
<p><strong>Before</strong> (static):</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// No revalidation config</span>
<span class="w">  </span><span class="c1">// Page is static forever</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong> (ISR):</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span><span class="w"> </span><span class="c1">// Revalidate every 60 seconds</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Same code, but now it updates automatically</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="how-isr-works-the-timeline">How ISR Works: The Timeline</h3>
<p>Let's trace what happens over time:</p>
<p><strong>Build time (t=0)</strong>:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<ul>
<li>Next.js generates HTML with current product data</li>
<li>HTML saved to <code>.next/server/app/products.html</code></li>
<li>Page is marked as "revalidate every 60 seconds"</li>
</ul>
<p><strong>First request (t=5s)</strong>:
- User visits <code>/products</code>
- Next.js serves pre-built HTML (5ms TTFB) ‚úÖ
- HTML shows products from build time
- No background work yet</p>
<p><strong>Second request (t=65s)</strong> - After revalidation period:
- User visits <code>/products</code>
- Next.js serves cached HTML (5ms TTFB) ‚úÖ (still fast!)
- <strong>Background</strong>: Next.js triggers revalidation
  - Fetches fresh product data
  - Renders new HTML
  - Updates cache
- User sees old data (but it's instant)</p>
<p><strong>Third request (t=70s)</strong> - After revalidation completes:
- User visits <code>/products</code>
- Next.js serves <strong>new</strong> HTML (5ms TTFB) ‚úÖ
- HTML shows fresh products
- User sees updated data (and it's still instant!)</p>
<h3 id="verification-isr-in-action">Verification: ISR in Action</h3>
<p>Let's test this behavior:</p>
<ol>
<li>Build and start production server:</li>
</ol>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
npm<span class="w"> </span>run<span class="w"> </span>start
</code></pre></div>

<ol>
<li>Visit <code>/products</code> ‚Üí See products from build time (instant)</li>
<li>Add new product to database</li>
<li>Refresh <code>/products</code> immediately ‚Üí Still see old products (instant, from cache)</li>
<li>Wait 60 seconds</li>
<li>Refresh <code>/products</code> ‚Üí Still see old products (instant, from cache)</li>
<li>Wait a few seconds for background revalidation</li>
<li>Refresh <code>/products</code> ‚Üí See new product! (instant, from updated cache)</li>
</ol>
<p><strong>Network Tab Analysis</strong> (request at t=65s):
- Request to <code>/products</code>
- Timeline:
  - 0-5ms: Server serves cached HTML
  - 5ms: HTML arrives (old data, but instant!)
- Pattern: Stale-while-revalidate‚Äîserve cached version, update in background
- <strong>TTFB</strong>: 5ms ‚úÖ (static performance!)</p>
<p><strong>Server Logs</strong> (background revalidation):</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="nv">t</span><span class="o">=</span>65s<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span>to<span class="w"> </span>/products
<span class="o">[</span><span class="nv">t</span><span class="o">=</span>65s<span class="o">]</span><span class="w"> </span>Serving<span class="w"> </span>cached<span class="w"> </span>HTML<span class="w"> </span><span class="o">(</span>age:<span class="w"> </span>60s<span class="o">)</span>
<span class="o">[</span><span class="nv">t</span><span class="o">=</span>65s<span class="o">]</span><span class="w"> </span>Background:<span class="w"> </span>Revalidation<span class="w"> </span>triggered
<span class="o">[</span><span class="nv">t</span><span class="o">=</span>65s<span class="o">]</span><span class="w"> </span>Background:<span class="w"> </span>Fetching<span class="w"> </span>fresh<span class="w"> </span>data...
<span class="o">[</span><span class="nv">t</span><span class="o">=</span><span class="m">65</span>.5s<span class="o">]</span><span class="w"> </span>Background:<span class="w"> </span>Rendering<span class="w"> </span>new<span class="w"> </span>HTML...
<span class="o">[</span><span class="nv">t</span><span class="o">=</span><span class="m">65</span>.6s<span class="o">]</span><span class="w"> </span>Background:<span class="w"> </span>Cache<span class="w"> </span>updated
</code></pre></div>

<h3 id="expected-vs-actual-improvement_5">Expected vs. Actual Improvement</h3>
<p><strong>Static (no revalidation)</strong>:
- TTFB: 5ms ‚úÖ
- Data freshness: Stale until rebuild ‚ùå
- User experience: Fast but outdated</p>
<p><strong>Dynamic (always fresh)</strong>:
- TTFB: 500ms ‚ö†Ô∏è
- Data freshness: Always fresh ‚úÖ
- User experience: Slow but current</p>
<p><strong>ISR (best of both)</strong>:
- TTFB: 5ms ‚úÖ (static performance!)
- Data freshness: Updates every 60s ‚úÖ
- User experience: Fast and reasonably fresh ‚úÖ</p>
<p><strong>Key insight</strong>: ISR gives you static performance with automatic updates. Users always get instant responses, and data stays reasonably fresh.</p>
<h2 id="revalidation-strategies_1">Revalidation Strategies</h2>
<p>Next.js provides multiple ways to revalidate cached pages:</p>
<h3 id="strategy-1-time-based-revalidation">Strategy 1: Time-Based Revalidation</h3>
<p>Revalidate after a fixed time period:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Revalidate every 60 seconds</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Page regenerates in background every 60 seconds</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use when</strong>:
- Data changes predictably (e.g., every hour)
- Acceptable to show slightly stale data
- High traffic (want to minimize server load)</p>
<p><strong>Examples</strong>:
- Product catalog (revalidate every 5 minutes)
- Blog posts (revalidate every hour)
- Stock prices (revalidate every 30 seconds)</p>
<h3 id="strategy-2-on-demand-revalidation">Strategy 2: On-Demand Revalidation</h3>
<p>Revalidate immediately when data changes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/revalidate/route.ts - API route for on-demand revalidation</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Verify secret to prevent unauthorized revalidation</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">secret</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REVALIDATION_SECRET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid secret&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Revalidate the specified path</span>
<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">revalidated</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error revalidating&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/admin.ts - Trigger revalidation after data change</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addProduct</span><span class="p">(</span><span class="nx">product</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Add product to database</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">product</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Trigger revalidation</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://yoursite.com/api/revalidate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/products&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.REVALIDATION_SECRET</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use when</strong>:
- Data changes unpredictably
- Need immediate updates (e.g., after admin action)
- Can trigger revalidation from your backend</p>
<p><strong>Examples</strong>:
- Product added/updated by admin ‚Üí Revalidate <code>/products</code>
- Blog post published ‚Üí Revalidate <code>/blog</code>
- Inventory updated ‚Üí Revalidate <code>/products/[id]</code></p>
<h3 id="strategy-3-tag-based-revalidation">Strategy 3: Tag-Based Revalidation</h3>
<p>Revalidate multiple related pages at once:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Tag fetches for revalidation</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Tag this fetch</span>
<span class="w">      </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`https://api.example.com/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`product-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">],</span><span class="w"> </span><span class="c1">// Multiple tags</span>
<span class="w">      </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/revalidate/route.ts - Revalidate by tag</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidateTag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">tag</span><span class="p">,</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">secret</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REVALIDATION_SECRET</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid secret&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Revalidate all fetches with this tag</span>
<span class="w">    </span><span class="nx">revalidateTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">revalidated</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error revalidating&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/admin.ts - Revalidate all product pages</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">updates</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Product</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">updates</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Revalidate all pages that use product data</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://yoursite.com/api/revalidate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">tag</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Revalidates /products, /products/[id], etc.</span>
<span class="w">      </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.REVALIDATION_SECRET</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use when</strong>:
- Multiple pages depend on the same data
- Want to revalidate related pages together
- Complex data dependencies</p>
<p><strong>Examples</strong>:
- Update product ‚Üí Revalidate product list, product detail, category pages
- Update user profile ‚Üí Revalidate dashboard, settings, profile pages</p>
<h3 id="strategy-4-fetch-level-revalidation">Strategy 4: Fetch-Level Revalidation</h3>
<p>Different revalidation times for different data sources:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Per-fetch revalidation</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">300</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 5 minutes</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getCategories</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/categories&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">3600</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 1 hour (changes rarely)</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getFeaturedProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/featured&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 1 minute (changes frequently)</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Mixed revalidation times</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Each fetch has its own revalidation time</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">categories</span><span class="p">,</span><span class="w"> </span><span class="nx">featured</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">getProducts</span><span class="p">(),</span><span class="w">      </span><span class="c1">// Revalidates every 5 minutes</span>
<span class="w">    </span><span class="nx">getCategories</span><span class="p">(),</span><span class="w">    </span><span class="c1">// Revalidates every hour</span>
<span class="w">    </span><span class="nx">getFeaturedProducts</span><span class="p">(),</span><span class="w"> </span><span class="c1">// Revalidates every minute</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Categories update hourly */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">CategorySidebar</span><span class="w"> </span><span class="na">categories</span><span class="o">=</span><span class="p">{</span><span class="nx">categories</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Products update every 5 minutes */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductGrid</span><span class="w"> </span><span class="na">products</span><span class="o">=</span><span class="p">{</span><span class="nx">products</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Featured updates every minute */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">FeaturedBanner</span><span class="w"> </span><span class="na">products</span><span class="o">=</span><span class="p">{</span><span class="nx">featured</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use when</strong>:
- Different data sources have different update frequencies
- Want fine-grained control over caching
- Optimizing for both performance and freshness</p>
<h3 id="strategy-5-no-revalidation-cache-forever">Strategy 5: No Revalidation (Cache Forever)</h3>
<p>Some data never changes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Cache forever</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getCountries</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/countries&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Cache forever</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Use when</strong>:
- Data is truly static (country list, currency codes)
- Content is versioned (e.g., <code>/blog/post-v1</code>, <code>/blog/post-v2</code>)</p>
<h2 id="real-world-revalidation-patterns">Real-World Revalidation Patterns</h2>
<h3 id="pattern-1-e-commerce-product-catalog">Pattern 1: E-commerce Product Catalog</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/page.tsx - Product listing</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300</span><span class="p">;</span><span class="w"> </span><span class="c1">// 5 minutes</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">ProductGrid</span><span class="w"> </span><span class="na">products</span><span class="o">=</span><span class="p">{</span><span class="nx">products</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx - Product details</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span>
<span class="w">  </span><span class="nx">params</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">ProductDetails</span><span class="w"> </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>

<span class="c1">// Generate static pages for all products at build time</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">generateStaticParams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">product.id</span><span class="w"> </span><span class="p">}));</span>
<span class="p">}</span>

<span class="c1">// Revalidate individual product pages every 5 minutes</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300</span><span class="p">;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/admin.ts - Admin updates trigger revalidation</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateProductInventory</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">quantity</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Immediately revalidate this product page</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://yoursite.com/api/revalidate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.REVALIDATION_SECRET</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>:
- Product pages are static (fast!)
- Update every 5 minutes automatically
- Admin changes trigger immediate updates
- Best of all worlds: fast, fresh, and responsive to changes</p>
<h3 id="pattern-2-blog-with-instant-publishing">Pattern 2: Blog with Instant Publishing</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/blog/page.tsx - Blog listing</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3600</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1 hour</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">BlogPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">posts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getPosts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">PostList</span><span class="w"> </span><span class="na">posts</span><span class="o">=</span><span class="p">{</span><span class="nx">posts</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/blog/[slug]/page.tsx - Blog post</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">PostPage</span><span class="p">({</span>
<span class="w">  </span><span class="nx">params</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">slug</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getPost</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">slug</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">PostContent</span><span class="w"> </span><span class="na">post</span><span class="o">=</span><span class="p">{</span><span class="nx">post</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">generateStaticParams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">posts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getPosts</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">post</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">slug</span><span class="o">:</span><span class="w"> </span><span class="kt">post.slug</span><span class="w"> </span><span class="p">}));</span>
<span class="p">}</span>

<span class="c1">// Posts rarely change after publishing</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Cache forever</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/cms.ts - CMS webhook triggers revalidation</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handlePublishWebhook</span><span class="p">(</span><span class="nx">postSlug</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Revalidate the new post and the blog listing</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://yoursite.com/api/revalidate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="sb">`/blog/</span><span class="si">${</span><span class="nx">postSlug</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.REVALIDATION_SECRET</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://yoursite.com/api/revalidate&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/blog&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">secret</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.REVALIDATION_SECRET</span><span class="p">,</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>:
- Blog posts are static (instant loading)
- Cached forever (they don't change)
- Publishing triggers immediate revalidation
- Blog listing updates hourly</p>
<h3 id="pattern-3-dashboard-with-mixed-freshness">Pattern 3: Dashboard with Mixed Freshness</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/dashboard/page.tsx - Dashboard with mixed data</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DashboardPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Fast, cached data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getStats</span><span class="p">();</span><span class="w"> </span><span class="c1">// Revalidates every 5 minutes</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Static stats */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">StatsCards</span><span class="w"> </span><span class="na">stats</span><span class="o">=</span><span class="p">{</span><span class="nx">stats</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Real-time data (dynamic) */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ActivityLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">RecentActivity</span><span class="w"> </span><span class="p">/&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* Always fresh, no caching */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Cached data */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">ChartLoading</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">RevenueChart</span><span class="w"> </span><span class="p">/&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* Revalidates every hour */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/api.ts - Different revalidation for different data</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getStats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/stats&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">300</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 5 minutes</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRecentActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/activity&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Always fresh, no caching</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRevenueData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/revenue&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">3600</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 1 hour</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>:
- Stats update every 5 minutes (good enough for most users)
- Recent activity is always fresh (real-time)
- Revenue chart updates hourly (expensive query, cached longer)
- Page loads fast with progressive enhancement</p>
<h2 id="common-failure-modes-and-their-signatures_4">Common Failure Modes and Their Signatures</h2>
<h3 id="symptom-revalidation-not-working-data-stays-stale">Symptom: Revalidation not working (data stays stale)</h3>
<p><strong>Browser behavior</strong>:
Data doesn't update even after revalidation period</p>
<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>No<span class="w"> </span>revalidation<span class="w"> </span>logs<span class="w"> </span>-<span class="w"> </span>revalidation<span class="w"> </span>not<span class="w"> </span>triggering<span class="o">]</span>
</code></pre></div>

<p><strong>Root cause</strong>: Page is using <code>dynamic = 'force-dynamic'</code> or dynamic functions, which disables ISR</p>
<p><strong>Solution</strong>: Remove dynamic functions or use fetch-level revalidation instead</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: Dynamic page can&#39;t use ISR</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">dynamic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;force-dynamic&#39;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span><span class="w"> </span><span class="c1">// This is ignored!</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Page</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getData</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;{</span><span class="nx">data</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="c1">// ‚úÖ Good: Static page with ISR</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Page</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getData</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;{</span><span class="nx">data</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="symptom-on-demand-revalidation-returns-401-unauthorized">Symptom: On-demand revalidation returns 401 Unauthorized</h3>
<p><strong>API response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid secret&quot;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p><strong>Root cause</strong>: Revalidation secret doesn't match</p>
<p><strong>Solution</strong>: Check environment variable is set correctly</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env.local</span>
<span class="nv">REVALIDATION_SECRET</span><span class="o">=</span>your-secret-key-here
</code></pre></div>

<h3 id="symptom-revalidation-triggers-too-frequently-high-server-load">Symptom: Revalidation triggers too frequently (high server load)</h3>
<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">10</span>:00:00<span class="o">]</span><span class="w"> </span>Revalidating<span class="w"> </span>/products
<span class="o">[</span><span class="m">10</span>:00:05<span class="o">]</span><span class="w"> </span>Revalidating<span class="w"> </span>/products
<span class="o">[</span><span class="m">10</span>:00:10<span class="o">]</span><span class="w"> </span>Revalidating<span class="w"> </span>/products
<span class="o">[</span><span class="m">10</span>:00:15<span class="o">]</span><span class="w"> </span>Revalidating<span class="w"> </span>/products
</code></pre></div>

<p><strong>Root cause</strong>: Revalidation period is too short for high-traffic pages</p>
<p><strong>Solution</strong>: Increase revalidation time or use on-demand revalidation</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: Revalidates every 5 seconds (too frequent!)</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>

<span class="c1">// ‚úÖ Good: Revalidates every 5 minutes</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300</span><span class="p">;</span>

<span class="c1">// ‚úÖ Better: Use on-demand revalidation for immediate updates</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">revalidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3600</span><span class="p">;</span><span class="w"> </span><span class="c1">// 1 hour baseline</span>
<span class="c1">// Trigger revalidation manually when data changes</span>
</code></pre></div>

<h3 id="symptom-some-users-see-old-data-others-see-new-data">Symptom: Some users see old data, others see new data</h3>
<p><strong>Browser behavior</strong>:
Inconsistent data across users</p>
<p><strong>Root cause</strong>: CDN caching‚Äîdifferent edge locations have different cache states</p>
<p><strong>Solution</strong>: This is expected behavior with ISR. Use shorter revalidation times or on-demand revalidation for critical updates.</p>
<h2 id="the-complete-data-fetching-journey">The Complete Data Fetching Journey</h2>
<p>Let's trace our product catalog through all the iterations:</p>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Approach</th>
<th>TTFB</th>
<th>Data Freshness</th>
<th>Complexity</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Client-side fetch</td>
<td>2200ms</td>
<td>Real-time</td>
<td>High</td>
<td>‚ùå Don't use</td>
</tr>
<tr>
<td>1</td>
<td>Server Component (sequential)</td>
<td>2250ms</td>
<td>Real-time</td>
<td>Low</td>
<td>Rarely needed</td>
</tr>
<tr>
<td>2</td>
<td>Server Component (parallel)</td>
<td>873ms</td>
<td>Real-time</td>
<td>Low</td>
<td>Dynamic pages</td>
</tr>
<tr>
<td>3</td>
<td>Client Component + React Query</td>
<td>100ms (cached)</td>
<td>Real-time</td>
<td>Medium</td>
<td>Interactive features</td>
</tr>
<tr>
<td>4</td>
<td>Streaming with Suspense</td>
<td>600ms (fast parts)</td>
<td>Real-time</td>
<td>Medium</td>
<td>Mixed fast/slow data</td>
</tr>
<tr>
<td>5</td>
<td>Static rendering</td>
<td>5ms</td>
<td>Stale</td>
<td>Low</td>
<td>Marketing pages</td>
</tr>
<tr>
<td>6</td>
<td>Dynamic rendering</td>
<td>873ms</td>
<td>Real-time</td>
<td>Low</td>
<td>User dashboards</td>
</tr>
<tr>
<td>7</td>
<td>ISR (time-based)</td>
<td>5ms</td>
<td>Updates every 60s</td>
<td>Low</td>
<td>Product catalogs</td>
</tr>
<tr>
<td>8</td>
<td>ISR (on-demand)</td>
<td>5ms</td>
<td>Updates on change</td>
<td>Medium</td>
<td>Admin-managed content</td>
</tr>
</tbody>
</table>
<h3 id="decision-framework-which-approach-when">Decision Framework: Which Approach When?</h3>
<p><strong>Use Server Components when</strong>:
- Initial page load data
- SEO is important
- Data is not user-specific
- Can tolerate some staleness</p>
<p><strong>Use Client Components + React Query when</strong>:
- Interactive features (search, filters)
- Real-time updates
- User-triggered actions
- Need caching and optimistic updates</p>
<p><strong>Use Streaming when</strong>:
- Page has mix of fast and slow data
- Want to show partial content quickly
- User experience is critical</p>
<p><strong>Use Static Rendering when</strong>:
- Content rarely changes
- Same for all users
- Performance is critical
- High traffic</p>
<p><strong>Use Dynamic Rendering when</strong>:
- Content changes frequently
- Personalized for each user
- Real-time data required
- Low to medium traffic</p>
<p><strong>Use ISR when</strong>:
- Content changes periodically
- Can tolerate slight staleness
- Want static performance
- High traffic</p>
<h3 id="the-professional-react-developers-mental-model">The Professional React Developer's Mental Model</h3>
<p>When approaching data fetching in Next.js, ask these questions:</p>
<ol>
<li><strong>Who needs this data?</strong></li>
<li>All users ‚Üí Consider static/ISR</li>
<li>
<p>Specific user ‚Üí Consider dynamic</p>
</li>
<li>
<p><strong>How often does it change?</strong></p>
</li>
<li>Never ‚Üí Static</li>
<li>Rarely ‚Üí ISR (long revalidation)</li>
<li>Hourly ‚Üí ISR (short revalidation)</li>
<li>
<p>Real-time ‚Üí Dynamic or Client Component</p>
</li>
<li>
<p><strong>How fast must it load?</strong></p>
</li>
<li>Critical (&lt; 100ms) ‚Üí Static or ISR</li>
<li>Important (&lt; 500ms) ‚Üí Server Component or ISR</li>
<li>
<p>Acceptable (&lt; 2s) ‚Üí Dynamic or Streaming</p>
</li>
<li>
<p><strong>Is it interactive?</strong></p>
</li>
<li>Yes ‚Üí Client Component</li>
<li>
<p>No ‚Üí Server Component</p>
</li>
<li>
<p><strong>Does it need to be fresh?</strong></p>
</li>
<li>Always ‚Üí Dynamic or Client Component</li>
<li>Eventually ‚Üí ISR</li>
<li>Doesn't matter ‚Üí Static</li>
</ol>
<p><strong>The golden rule</strong>: Start with Server Components and ISR. Only reach for dynamic rendering or client-side fetching when you have a specific reason.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 12:33:28 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>