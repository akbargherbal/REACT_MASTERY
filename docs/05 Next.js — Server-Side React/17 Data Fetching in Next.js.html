<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>17 Data Fetching in Next.js</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-17-data-fetching-in-nextjs">Chapter 17: Data Fetching in Next.js</h1>
<h2 id="server-components-fetch-directly">Server Components: fetch directly</h2>
<h2 id="the-modern-baseline-direct-fetching-in-server-components">The Modern Baseline: Direct Fetching in Server Components</h2>
<p>In the Next.js App Router, the default way to build components is with React Server Components (RSCs). This is a fundamental shift from the old model where every component was a client-side component by default. The single biggest advantage of RSCs is their ability to perform data fetching and other server-side operations <em>directly within the component itself</em>.</p>
<p>This eliminates the need for traditional data fetching hooks like <code>useEffect</code> for initial page loads, simplifying code and improving performance by moving data fetching logic to the server, closer to your data source.</p>
<h3 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h3>
<p>We will build a <strong>Product Details Page</strong> for an e-commerce site. This page will be our anchor example, and we will progressively enhance it throughout this chapter to explore different data fetching patterns.</p>
<p>Our goal is to fetch data for a specific product and display its name, description, and price.</p>
<p><strong>Project Structure</strong>:</p>
<p>First, let's set up our project. We need a dynamic route to handle different product IDs and a mock API endpoint to serve the data.</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">  </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">mock</span><span class="w"> </span><span class="n">API</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">      </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">implementation</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">types</span><span class="p">.</span><span class="n">ts</span><span class="w">              </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Shared</span><span class="w"> </span><span class="n">TypeScript</span><span class="w"> </span><span class="n">types</span>
</code></pre></div>

<p><strong>Step 1: Create the Mock API</strong></p>
<p>Let's create a simple API that returns product data. This simulates fetching from a database.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/types.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/products/[id]/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/types&#39;</span><span class="p">;</span>

<span class="c1">// Mock database</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quantum Keyboard&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A keyboard that types in all states at once.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">199.99</span><span class="p">,</span><span class="w"> </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Singularity Mouse&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A mouse with a single, infinitely precise point.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">89.50</span><span class="p">,</span><span class="w"> </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hyperthread Monitor&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;See your code and its compiled output simultaneously.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">499.00</span><span class="p">,</span><span class="w"> </span><span class="nx">stock</span><span class="o">:</span><span class="w"> </span><span class="kt">15</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n[API SERVER] Request for product ID: </span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Simulate database latency</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">));</span><span class="w"> </span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">(</span><span class="s1">&#39;Product not found&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[API SERVER] Found product: </span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Create the Product Page (Reference Implementation)</strong></p>
<p>Now, let's create the page component. Since this is a Server Component (the default in the App Router), we can make it <code>async</code> and use <code>await</code> with <code>fetch</code> directly inside it.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/types&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// We use the absolute URL here because this fetch runs on the server.</span>
<span class="w">  </span><span class="c1">// In a real app, this would be an environment variable.</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// This will be caught by the error page and handled appropriately.</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Fetching data for product ID: </span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Data received for: </span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl text-gray-700 mb-2&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-lg mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">In</span><span class="w"> </span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-success">Diagnostic Analysis: Reading the Success</h3>
<p>Let's run this and see what happens when we navigate to <code>http://localhost:3000/products/1</code>.</p>
<p><strong>Browser Behavior</strong>:
The page loads. After a brief pause (our simulated 500ms latency), the product details for the "Quantum Keyboard" appear. The entire page content arrives at once.</p>
<p><strong>Browser Console Output</strong>:
The browser console is completely empty. There are no <code>console.log</code> messages.</p>
<p><strong>Network Tab Analysis</strong>:
The Network tab shows a single request for the document <code>/products/1</code>. There are <strong>no</strong> client-side <code>fetch</code> requests to <code>/api/products/1</code>. The data is already embedded in the initial HTML.</p>
<p><strong>Terminal Output</strong>:
This is where the magic is revealed. Your Next.js development server terminal shows the logs.</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Fetching<span class="w"> </span>data<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>

<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span>product:<span class="w"> </span>Quantum<span class="w"> </span>Keyboard
<span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Data<span class="w"> </span>received<span class="w"> </span><span class="k">for</span>:<span class="w"> </span>Quantum<span class="w"> </span>Keyboard
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li><strong>What the user experiences</strong>: A simple, server-rendered page. The data is present on the initial load.</li>
<li><strong>What the console reveals</strong>: The browser console is silent because all the data fetching logic ran on the server. No JavaScript related to fetching was sent to the client.</li>
<li><strong>What the terminal shows</strong>: The logs confirm the sequence of events:<ul>
<li>The <code>ProductPage</code> Server Component started rendering.</li>
<li>It called <code>fetch</code> to our API route.</li>
<li>The API route ran, found the data, and returned it.</li>
<li>The <code>ProductPage</code> component received the data and completed its render, generating the final HTML.</li>
</ul>
</li>
<li><strong>Root cause identified</strong>: This is the default, highly optimized behavior of Next.js. Data fetching for Server Components happens entirely on the server during the rendering process.</li>
<li><strong>Why this approach is powerful</strong>:<ul>
<li><strong>Performance</strong>: The data is fetched close to the database, reducing latency. The client receives a fully-formed HTML page, which is great for SEO and perceived performance (First Contentful Paint).</li>
<li><strong>Security</strong>: API keys, database credentials, and other secrets never leave the server.</li>
<li><strong>Simplicity</strong>: No need for <code>useEffect</code>, <code>useState</code> for loading/error states, or complex client-side state management libraries for the initial data load. The code is linear and easy to read.</li>
</ul>
</li>
</ol>
<h3 id="limitation-preview">Limitation Preview</h3>
<p>This is perfect for data that's needed for the initial render. But what happens when we need to fetch data based on user interaction? For example, what if we want to add a "Reviews" section where users can post a new review and see it appear without a full page reload? A Server Component can't handle that because it has no state and can't re-render on the client. This limitation will lead us to our next section on Client Components.</p>
<h2 id="client-components-use-react-query">Client Components: use React Query</h2>
<h2 id="iteration-1-handling-client-side-interactivity">Iteration 1: Handling Client-Side Interactivity</h2>
<p>Our <code>ProductPage</code> is great for displaying static information, but modern web apps are interactive. Let's add a "Reviews" section. Users should be able to view existing reviews and submit their own. This requires client-side state and data fetching.</p>
<p><strong>Current limitation</strong>: Server Components cannot use hooks like <code>useState</code> or <code>useEffect</code> and cannot respond to user events like button clicks. They render once on the server and are done.</p>
<p><strong>New scenario introduction</strong>: We need to add a component that can:
1.  Fetch a list of reviews for the current product.
2.  Display a loading state while fetching.
3.  Handle potential fetching errors.
4.  Allow a user to submit a new review, which should then appear in the list.</p>
<h3 id="the-wrong-way-useeffect-and-usestate">The "Wrong" Way: <code>useEffect</code> and <code>useState</code></h3>
<p>To demonstrate the problem this new scenario creates, let's first try to solve it using the traditional React approach with <code>useEffect</code> and <code>useState</code>. This will highlight the pain points that modern data-fetching libraries solve.</p>
<p><strong>Step 1: Create a Reviews API</strong></p>
<p>First, we need an API endpoint for reviews.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/products/[id]/reviews/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// In-memory store for reviews (simulates a database)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">reviews</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Changed my life!&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DevA&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;A bit pricey, but worth it.&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;DevB&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="c1">// GET handler to fetch reviews</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">800</span><span class="p">));</span><span class="w"> </span><span class="c1">// Simulate latency</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">productReviews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">productId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">productReviews</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// POST handler to add a review</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">newReview</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">reviews.length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">    </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">params.id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">text</span><span class="p">,</span>
<span class="w">    </span><span class="nx">author</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newReview</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newReview</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">201</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Create the Client Component</strong></p>
<p>Now, let's build the <code>ProductReviews</code> component. Because it uses hooks and handles user events, it <strong>must</strong> be a Client Component, designated by the <code>"use client"</code> directive at the top of the file.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductReviews_Naive.tsx</span>
<span class="s2">&quot;use client&quot;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">FormEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductReviews_Naive</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">reviews</span><span class="p">,</span><span class="w"> </span><span class="nx">setReviews</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Review</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">newReviewText</span><span class="p">,</span><span class="w"> </span><span class="nx">setNewReviewText</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">/reviews`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Failed to fetch reviews&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setReviews</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setError</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">finally</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">productId</span><span class="p">]);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// In a real app, you&#39;d handle form state, submission state, etc.</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">/reviews`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">newReviewText</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CurrentUser&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newReview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setReviews</span><span class="p">(</span><span class="nx">prevReviews</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">prevReviews</span><span class="p">,</span><span class="w"> </span><span class="nx">newReview</span><span class="p">]);</span>
<span class="w">    </span><span class="nx">setNewReviewText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 pt-8 border-t&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-bold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Reviews</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">reviews</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-red-500&quot;</span><span class="p">&gt;</span><span class="ne">Error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">error</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">{</span><span class="o">!</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">review</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">review</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-2 border-b pb-2&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">review</span><span class="p">.</span><span class="nx">author</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">review</span><span class="p">.</span><span class="nx">text</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">newReviewText</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setNewReviewText</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full p-2 border rounded&quot;</span>
<span class="w">          </span><span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Write your review...&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Submit</span><span class="w"> </span><span class="nx">Review</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 3: Add it to the Page</strong></p>
<p>Now we integrate our new Client Component into the main <code>ProductPage</code> Server Component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (Updated)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductReviews_Naive</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductReviews_Naive&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Import the new component</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ... (getProduct function is unchanged)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl text-gray-700 mb-2&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-lg mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">In</span><span class="w"> </span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Add the client component here */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews_Naive</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="failure-demonstration">Failure Demonstration</h3>
<p>Let's run this and navigate to <code>/products/1</code>.</p>
<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>Browser Behavior</strong>:
The main product details appear instantly (after the initial 500ms server fetch). Then, the reviews section shows "Loading reviews..." for about 800ms before the reviews pop in. If you navigate away from the page and come back, the reviews have to load all over again. If you have two <code>ProductReviews_Naive</code> components on the page, they will both fetch the same data independently.</p>
<p><strong>Browser Console Output</strong>:
The console is clean, but the user experience has issues.</p>
<p><strong>Network Tab Analysis</strong>:
1.  Request 1: A <code>document</code> request for <code>/products/1</code>. This contains the server-rendered HTML for the product details.
2.  Request 2: A <code>fetch</code> request to <code>/api/products/1/reviews</code>. This is a client-side request initiated by the <code>useEffect</code> hook. It creates a request waterfall: the page must load before the reviews can even start fetching.</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li><strong>What the user experiences</strong>: A loading spinner for a piece of the UI, and data that is not cached between page navigations.</li>
<li><strong>What the Network tab reveals</strong>: A clear waterfall where the client-side fetch can only begin after the initial page load is complete. This is less efficient than fetching everything on the server if possible.</li>
<li><strong>What the code shows</strong>: We've written a lot of boilerplate code:<ul>
<li>Three <code>useState</code> calls to manage data, loading, and error states.</li>
<li>A <code>useEffect</code> hook with careful dependency management.</li>
<li>Manual <code>.then().catch().finally()</code> logic.</li>
<li>Manual state updates after the POST request.
This complexity grows with every new data requirement.</li>
</ul>
</li>
<li><strong>Root cause identified</strong>: We are manually managing server state on the client. Server state (data from our API) is different from UI state. It's asynchronous, can become stale, and needs to be cached. <code>useState</code> and <code>useEffect</code> are low-level primitives not designed for this complex task.</li>
<li><strong>Why the current approach can't solve this</strong>: This approach has no concept of caching, revalidation, or background updates. If the user's browser tab is inactive and then they return, the review data could be stale. We'd have to write even more complex code to handle this.</li>
<li><strong>What we need</strong>: A specialized library for managing server state on the client. It should handle caching, loading/error states, and mutations (POST/PUT/DELETE requests) for us, abstracting away the boilerplate.</li>
</ol>
<h3 id="the-solution-tanstack-query-react-query">The Solution: TanStack Query (React Query)</h3>
<p>TanStack Query is the industry standard for managing server state in React applications. It provides hooks that simplify fetching, caching, synchronizing, and updating server data.</p>
<p><strong>Step 1: Installation and Setup</strong></p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>@tanstack/react-query
</code></pre></div>

<p>We need to provide a <code>QueryClient</code> to our application. This is done in a new provider component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/query-provider.tsx</span>
<span class="s2">&quot;use client&quot;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">QueryClient</span><span class="p">,</span><span class="w"> </span><span class="nx">QueryClientProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ReactQueryDevtools</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query-devtools&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">QueryProvider</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">queryClient</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">QueryClient</span><span class="p">());</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">QueryClientProvider</span><span class="w"> </span><span class="na">client</span><span class="o">=</span><span class="p">{</span><span class="nx">queryClient</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ReactQueryDevtools</span><span class="w"> </span><span class="na">initialIsOpen</span><span class="o">=</span><span class="p">{</span><span class="kc">false</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">QueryClientProvider</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Now, we wrap our root layout with this provider.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Metadata</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;next&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Inter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;next/font/google&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s2">&quot;./globals.css&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">QueryProvider</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;@/lib/query-provider&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Import the provider</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">inter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Inter</span><span class="p">({</span><span class="w"> </span><span class="nx">subsets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;latin&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">Metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Create Next App&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Generated by create next app&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">}</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">inter</span><span class="p">.</span><span class="nx">className</span><span class="p">}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">QueryProvider</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">QueryProvider</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span><span class="cm">/* Wrap the app */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Refactor <code>ProductReviews</code> to use <code>useQuery</code> and <code>useMutation</code></strong></p>
<p>Let's create a new component, <code>ProductReviews.tsx</code>, that uses React Query.</p>
<p><strong>Before</strong> (<code>ProductReviews_Naive.tsx</code>):
- 3 <code>useState</code> hooks
- 1 <code>useEffect</code> hook
- Manual <code>fetch</code> calls with <code>.then/.catch</code>
- Manual state updates</p>
<p><strong>After</strong> (<code>ProductReviews.tsx</code>):
- 1 <code>useQuery</code> hook for data fetching.
- 1 <code>useMutation</code> hook for submitting data.
- React Query handles loading, error, and data states automatically.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ProductReviews.tsx</span>
<span class="s2">&quot;use client&quot;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">,</span><span class="w"> </span><span class="nx">useMutation</span><span class="p">,</span><span class="w"> </span><span class="nx">useQueryClient</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tanstack/react-query&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">FormEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Fetch function for useQuery</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getReviews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Review</span><span class="err">[]</span><span class="p">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">/reviews`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Network response was not ok&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">// Mutation function for useMutation</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">postReview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">/reviews`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="w"> </span><span class="p">}),</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to post review&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">queryClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQueryClient</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">newReviewText</span><span class="p">,</span><span class="w"> </span><span class="nx">setNewReviewText</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// useQuery handles fetching, caching, loading and error states</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">reviews</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">isLoading</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useQuery</span><span class="p">({</span>
<span class="w">    </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;reviews&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">productId</span><span class="p">],</span><span class="w"> </span><span class="c1">// A unique key for this query</span>
<span class="w">    </span><span class="nx">queryFn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">getReviews</span><span class="p">(</span><span class="nx">productId</span><span class="p">),</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// useMutation handles the POST request and updating the UI</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">mutation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMutation</span><span class="p">({</span>
<span class="w">    </span><span class="nx">mutationFn</span><span class="o">:</span><span class="w"> </span><span class="kt">postReview</span><span class="p">,</span>
<span class="w">    </span><span class="nx">onSuccess</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Invalidate the query to refetch the latest reviews</span>
<span class="w">      </span><span class="nx">queryClient</span><span class="p">.</span><span class="nx">invalidateQueries</span><span class="p">({</span><span class="w"> </span><span class="nx">queryKey</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;reviews&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">productId</span><span class="p">]</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">mutation</span><span class="p">.</span><span class="nx">mutate</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="kt">newReviewText</span><span class="p">,</span><span class="w"> </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;CurrentUser&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">setNewReviewText</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 pt-8 border-t&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-bold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Reviews</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">reviews</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-red-500&quot;</span><span class="p">&gt;</span><span class="ne">Error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">reviews</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">review</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">review</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-2 border-b pb-2&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">review</span><span class="p">.</span><span class="nx">author</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">review</span><span class="p">.</span><span class="nx">text</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">newReviewText</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setNewReviewText</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full p-2 border rounded&quot;</span>
<span class="w">          </span><span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Write your review...&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span>
<span class="w">          </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isPending</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span>
<span class="w">          </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400&quot;</span>
<span class="w">          </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isPending</span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isPending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">isError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-red-500&quot;</span><span class="p">&gt;{</span><span class="nx">mutation</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Finally, update <code>ProductPage</code> to use the new, improved component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (Final Update)</span>
<span class="c1">// ... imports</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductReviews&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Use the React Query version</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... product details */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification">Verification</h3>
<p>Now, when you navigate to <code>/products/1</code>, the behavior is much better.</p>
<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Caching</strong>: Navigate away from the page and back. The reviews appear instantly from the cache. React Query refetches in the background to ensure data is fresh, but the user sees the cached data first.
- <strong>Code Simplicity</strong>: The component logic is declarative. We tell <code>useQuery</code> <em>what</em> to fetch, not <em>how</em> or <em>when</em>. All the complex state management is gone.
- <strong>DevTools</strong>: Open the React Query Devtools. You can see the query for <code>['reviews', '1']</code>, its status (fresh, fetching, stale), and the cached data. This is invaluable for debugging.
- <strong>Mutation UI</strong>: When you submit a review, the button correctly disables and shows "Submitting...". The <code>onSuccess</code> callback ensures the review list is automatically updated.</p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<ul>
<li><strong>What it optimizes for</strong>: Developer experience, robust caching, and eliminating boilerplate for client-side data fetching. It handles complex scenarios like background refetching, polling, and optimistic updates gracefully.</li>
<li><strong>What it sacrifices</strong>: A small bundle size increase for the library itself. For very simple, one-off client fetches, it might be overkill, but for any real application, the benefits far outweigh the cost.</li>
<li><strong>When to choose this approach</strong>: Whenever you need to fetch, cache, or update data from a Client Component in response to user interaction or other client-side events.</li>
<li><strong>When to avoid this approach</strong>: For data needed on the initial page load that doesn't need to be interactive. Use Server Components for that, as we did for the main product details.</li>
</ul>
<h3 id="limitation-preview_1">Limitation Preview</h3>
<p>Our page is now much more robust. The main product data loads on the server, and the interactive reviews section loads on the client. However, we still have a performance issue. What if another part of our page, like a "Related Products" section, also needs to be fetched on the server but is very slow? Right now, the entire page would be blocked until that slow data is ready. This leads us to our next topic: Streaming and Suspense.</p>
<h2 id="streaming-and-suspense">Streaming and Suspense</h2>
<h2 id="iteration-2-handling-slow-data-dependencies">Iteration 2: Handling Slow Data Dependencies</h2>
<p>Our product page is composed of two parts: the main product details (fast) and the reviews (fetched on the client). Let's introduce a third part: a "Related Products" section. This data should also be fetched on the server, but let's imagine the API for it is notoriously slow.</p>
<p><strong>Current state recap</strong>: Our page fetches primary data in a Server Component (<code>ProductPage</code>) and interactive data in a Client Component (<code>ProductReviews</code>).</p>
<p><strong>Current limitation</strong>: When a Server Component uses <code>await</code> to fetch data, it blocks the rendering of the entire component tree below it. If one data fetch is slow, the user sees nothing until <em>all</em> server-side data fetches for that route are complete.</p>
<p><strong>New scenario introduction</strong>: We need to add a <code>RelatedProducts</code> component to our page. The API for this component takes 3 seconds to respond. We don't want the main product details to be delayed by 3 seconds just because the related products are slow to load.</p>
<h3 id="failure-demonstration_1">Failure Demonstration</h3>
<p><strong>Step 1: Update the API</strong></p>
<p>Let's add a new endpoint to our mock API that is intentionally slow.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/products/[id]/related/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">relatedProducts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">related</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Singularity Mouse&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hyperthread Monitor&#39;</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">related</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quantum Keyboard&#39;</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">related</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Quantum Keyboard&#39;</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">},</span>
<span class="p">];</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n[API SERVER] Request for related products for ID: </span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Simulate a very slow database query</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">3000</span><span class="p">));</span><span class="w"> </span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">relatedProducts</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">([]);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[API SERVER] Found related products for ID: </span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">related</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Create the Slow <code>RelatedProducts</code> Component</strong></p>
<p>This will be a simple <code>async</code> Server Component, just like our main page component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/RelatedProducts_Naive.tsx</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">RelatedProduct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRelatedProducts</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">RelatedProduct</span><span class="err">[]</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Fetching related products for ID: </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">/related`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch related products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Received related products for ID: </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RelatedProducts_Naive</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getRelatedProducts</span><span class="p">(</span><span class="nx">productId</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 pt-8 border-t&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-bold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Related</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 3: Add it to the Page</strong></p>
<p>Now, let's add this component to our <code>ProductPage</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (Updated with slow component)</span>
<span class="c1">// ... imports</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductReviews&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">RelatedProducts_Naive</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RelatedProducts_Naive&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Import the slow component</span>

<span class="c1">// ... getProduct function</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Data fetching for the main product</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl text-gray-700 mb-2&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-lg mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">In</span><span class="w"> </span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* This component will block the entire page render */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">RelatedProducts_Naive</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-failure_1">Diagnostic Analysis: Reading the Failure</h3>
<p>Refresh the page at <code>http://localhost:3000/products/1</code>.</p>
<p><strong>Browser Behavior</strong>:
The browser shows a loading spinner for over 3 seconds. The entire page is blank. Then, suddenly, the main product details, the reviews section (in its loading state), and the related products all appear at once.</p>
<p><strong>Network Tab Analysis</strong>:
- A single <code>document</code> request to <code>/products/1</code> is shown as "pending" for over 3 seconds.
- The Time to First Byte (TTFB) is very high (~3.5 seconds).
- Once the document loads, the client-side fetch for reviews begins.</p>
<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Fetching<span class="w"> </span>data<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span>product:<span class="w"> </span>Quantum<span class="w"> </span>Keyboard
<span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Data<span class="w"> </span>received<span class="w"> </span><span class="k">for</span>:<span class="w"> </span>Quantum<span class="w"> </span>Keyboard

<span class="c1"># ... a 3 second pause happens here ...</span>

<span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Fetching<span class="w"> </span>related<span class="w"> </span>products<span class="w"> </span><span class="k">for</span><span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span><span class="k">for</span><span class="w"> </span>related<span class="w"> </span>products<span class="w"> </span><span class="k">for</span><span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Found<span class="w"> </span>related<span class="w"> </span>products<span class="w"> </span><span class="k">for</span><span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Received<span class="w"> </span>related<span class="w"> </span>products<span class="w"> </span><span class="k">for</span><span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li><strong>What the user experiences</strong>: A terrible user experience. The fast, essential content is held hostage by the slow, non-essential content.</li>
<li><strong>What the terminal reveals</strong>: The logs show that <code>getProduct</code> completes quickly. However, the render process then hits <code>RelatedProducts_Naive</code> and pauses for 3 seconds on its <code>await fetch(...)</code> call. The server cannot send <em>any</em> HTML to the browser until all awaited promises in the component tree have resolved.</li>
<li><strong>Root cause identified</strong>: We have created a server-side rendering waterfall. The rendering is blocked sequentially by each <code>await</code>.</li>
<li><strong>Why the current approach can't solve this</strong>: Without a mechanism to de-prioritize slow data, the entire page's performance is dictated by its slowest part.</li>
<li><strong>What we need</strong>: A way to tell React, "Render the main page content immediately, and stream the HTML for this slow part when it's ready."</li>
</ol>
<h3 id="the-solution-streaming-with-suspense">The Solution: Streaming with <code>Suspense</code></h3>
<p>React <code>Suspense</code> allows us to declaratively specify loading fallbacks for parts of our UI that are not yet ready to be displayed. In Next.js, when you wrap an <code>async</code> Server Component in <code>Suspense</code>, Next.js will:
1.  Immediately send the HTML for the main page content and the <code>Suspense</code> fallback UI.
2.  Keep the HTTP connection open.
3.  When the <code>async</code> component finishes its data fetching, Next.js will stream the rendered HTML for that component down the same connection, and React will seamlessly swap the fallback with the real content on the client.</p>
<p><strong>Step 1: Create a Loading UI</strong></p>
<p>Next.js has a file-based convention for this. We can create a <code>loading.tsx</code> file that acts as a <code>Suspense</code> boundary for an entire route. However, for more granular control, we can use <code>Suspense</code> directly in our page. Let's create a simple loading component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/RelatedProductsSkeleton.tsx</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RelatedProductsSkeleton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 pt-8 border-t animate-pulse&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-8 bg-gray-300 rounded w-1/3 mb-4&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-6 bg-gray-300 rounded w-1/2 mb-2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;h-6 bg-gray-300 rounded w-1/2 mb-2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Wrap the Slow Component in <code>Suspense</code></strong></p>
<p>Now, we'll modify <code>ProductPage</code> to use the real <code>RelatedProducts</code> component (which is the same code as <code>_Naive</code>) and wrap it.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/RelatedProducts.tsx</span>
<span class="c1">// (This file has the exact same code as RelatedProducts_Naive.tsx)</span>
<span class="c1">// We just rename it for clarity.</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">RelatedProduct</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRelatedProducts</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">RelatedProduct</span><span class="err">[]</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Fetching related products for ID: </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">/related`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch related products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[SERVER COMPONENT] Received related products for ID: </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RelatedProducts</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getRelatedProducts</span><span class="p">(</span><span class="nx">productId</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 pt-8 border-t&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-bold mb-4&quot;</span><span class="p">&gt;</span><span class="nx">Related</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">li</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">li</span><span class="p">&gt;)}&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (With Suspense)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Import Suspense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductReviews&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">RelatedProducts</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RelatedProducts&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// The real component</span>
<span class="k">import</span><span class="w"> </span><span class="nx">RelatedProductsSkeleton</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RelatedProductsSkeleton&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// The fallback UI</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ... getProduct function is unchanged</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl text-gray-700 mb-2&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-lg mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">In</span><span class="w"> </span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">RelatedProductsSkeleton</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">RelatedProducts</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification_1">Verification</h3>
<p>Refresh the page at <code>http://localhost:3000/products/1</code>.</p>
<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Instant UI</strong>: The main product details and the reviews section (with its own loading state) appear almost instantly. The <code>RelatedProductsSkeleton</code> UI is shown in place of the related products.
- <strong>Streaming Content</strong>: After 3 seconds, the skeleton UI is seamlessly replaced by the actual list of related products. The rest of the page does not reload or flicker.
- <strong>Network Tab</strong>: The <code>document</code> request for <code>/products/1</code> now has a very fast TTFB. If you inspect the response, you'll see the initial HTML chunk, followed by later chunks containing the streamed content.
- <strong>Terminal Logs</strong>: The logs now show that the data fetching for the main product and related products can happen in parallel.</p>
<p>This is a massive improvement in user experience. The user gets meaningful content immediately and sees a clear loading state for the slower parts of the page, which then stream in as they become available. This is the power of React Suspense combined with the Next.js App Router architecture.</p>
<h2 id="static-vs-dynamic-rendering">Static vs. dynamic rendering</h2>
<h2 id="iteration-3-optimizing-for-performance-with-caching">Iteration 3: Optimizing for Performance with Caching</h2>
<p>Our page is now interactive and handles slow data gracefully. But we have a new problem: performance and cost. Every time a user visits <code>/products/1</code>, we are fetching data from our API, which in a real app would mean hitting a database. For a popular product whose details rarely change, this is incredibly wasteful.</p>
<p><strong>Current state recap</strong>: Our page fetches data on the server, streams slow sections, and handles client-side interactions.</p>
<p><strong>Current limitation</strong>: By default, our data fetching is dynamic. Every request results in a new fetch. This leads to unnecessary server load and slower response times than necessary.</p>
<p><strong>New scenario introduction</strong>: We want to cache the result of our server-side data fetches. For products that don't change often, we should be able to serve a pre-rendered, static page instantly without hitting our database on every visit.</p>
<h3 id="understanding-nextjs-caching">Understanding Next.js Caching</h3>
<p>Next.js aggressively caches everything possible to maximize performance. The key to this system is the <code>fetch</code> API. When you use <code>fetch</code> in a Server Component, Next.js automatically extends it with a powerful caching mechanism.</p>
<ul>
<li><strong>Default Behavior</strong>: By default, <code>fetch</code> requests are cached indefinitely (<code>force-cache</code>). The first time a page like <code>/products/1</code> is requested, Next.js fetches the data, renders the page, and stores both the data result and the rendered HTML in its cache. Subsequent requests for the same page will be served instantly from the cache without re-fetching or re-rendering. This is <strong>Static Site Generation (SSG)</strong> on the fly.</li>
</ul>
<h3 id="failure-demonstration-proving-its-dynamic">Failure Demonstration: Proving it's Dynamic</h3>
<p>Wait, if the default is static, why is our page dynamic? Because we've been running in development mode (<code>npm run dev</code>). In development, to ensure you always see your latest changes, Next.js disables caching and renders every page dynamically.</p>
<p>To see the production behavior, we need to build and run our app.</p>
<p><strong>Step 1: Build and Start the Production Server</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Stop your dev server (Ctrl+C)</span>
npm<span class="w"> </span>run<span class="w"> </span>build
npm<span class="w"> </span>start
</code></pre></div>

<p><strong>Step 2: Observe the Caching Behavior</strong></p>
<p>Now, visit <code>http://localhost:3000/products/1</code>.</p>
<h3 id="diagnostic-analysis-reading-the-production-behavior">Diagnostic Analysis: Reading the Production Behavior</h3>
<p><strong>Browser Behavior</strong>:
The first visit might feel similar to development. But if you refresh the page, it loads <em>instantly</em>.</p>
<p><strong>Terminal Output</strong>:
When you first visit <code>/products/1</code>, you'll see the server logs:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>SERVER<span class="w"> </span>COMPONENT<span class="o">]</span><span class="w"> </span>Fetching<span class="w"> </span>data<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
<span class="o">[</span>API<span class="w"> </span>SERVER<span class="o">]</span><span class="w"> </span>Request<span class="w"> </span><span class="k">for</span><span class="w"> </span>product<span class="w"> </span>ID:<span class="w"> </span><span class="m">1</span>
...<span class="w"> </span>etc
</code></pre></div>

<p>But on the <strong>second, third, and all subsequent refreshes</strong>, your terminal will be <strong>completely silent</strong>. No logs will be printed.</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li><strong>What the user experiences</strong>: An incredibly fast page load after the first visit.</li>
<li><strong>What the terminal reveals</strong>: The absence of logs proves that our Server Component code is not re-running. The <code>fetch</code> call is not being made. Next.js is serving the page from its cache.</li>
<li><strong>Root cause identified</strong>: This is the default production behavior of <code>fetch</code> in Next.js. It automatically caches results, turning our page into a static asset.</li>
</ol>
<h3 id="forcing-dynamic-rendering">Forcing Dynamic Rendering</h3>
<p>This static behavior is fantastic for performance, but what if our data <em>is</em> dynamic? What if the product's stock level can change frequently? We need a way to opt out of the cache and force a dynamic render on every request.</p>
<p>Next.js determines whether a route is static or dynamic by inspecting what functions you use during rendering. Using any of the following will force a route into dynamic rendering mode:
- <code>cookies()</code> or <code>headers()</code> from <code>next/headers</code>.
- The <code>searchParams</code> prop in a page component.
- Using <code>fetch</code> with the option <code>{ cache: 'no-store' }</code>.</p>
<p>Let's force our <code>getProduct</code> function to be dynamic.</p>
<p><strong>Before</strong> (Default, static caching):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In getProduct function</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://...`</span><span class="p">);</span><span class="w"> </span><span class="c1">// Defaults to cache: &#39;force-cache&#39;</span>
</code></pre></div>

<p><strong>After</strong> (Forced dynamic):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In getProduct function</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://...`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="w"> </span><span class="p">});</span>
</code></pre></div>

<p>Let's apply this change.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (Updated for dynamic rendering)</span>

<span class="c1">// ... imports and other components are the same</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no-store&#39;</span><span class="w"> </span><span class="c1">// Opt out of caching for this specific fetch</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ... rest of the page component</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p>Now, rebuild and restart the production server.</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
npm<span class="w"> </span>start
</code></pre></div>

<h3 id="verification_2">Verification</h3>
<p>Visit <code>http://localhost:3000/products/1</code> and refresh the page several times.</p>
<p><strong>Expected vs. Actual Improvement (or change)</strong>:
- <strong>Behavior</strong>: The page is no longer instant on refresh. There's a slight delay each time.
- <strong>Terminal Logs</strong>: With every single refresh, you will now see the full set of server logs.
  <code>bash
  [SERVER COMPONENT] Fetching data for product ID: 1
  [API SERVER] Request for product ID: 1
  ...</code>
This proves that adding <code>{ cache: 'no-store' }</code> successfully opted this route out of static caching and forced it into dynamic, server-side rendering (SSR) on every request.</p>
<h3 id="decision-framework-static-vs-dynamic">Decision Framework: Static vs. Dynamic</h3>
<table>
<thead>
<tr>
<th>Rendering Mode</th>
<th>When to Use</th>
<th>How to Trigger</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Static</strong></td>
<td>Content that is the same for all users and changes infrequently. (Blogs, marketing pages, product info)</td>
<td>Default <code>fetch</code> behavior. No dynamic functions used.</td>
<td>Extremely fast (served from CDN), reliable, low server cost.</td>
<td>Content can become stale. Requires a rebuild or revalidation to update.</td>
</tr>
<tr>
<td><strong>Dynamic</strong></td>
<td>Content that is personalized, real-time, or changes often. (Dashboards, shopping carts, stock prices)</td>
<td>Use <code>cookies()</code>, <code>headers()</code>, or <code>fetch</code> with <code>{ cache: 'no-store' }</code>.</td>
<td>Always serves fresh data. Can be personalized for each user.</td>
<td>Slower (requires server computation), higher server cost.</td>
</tr>
</tbody>
</table>
<h3 id="limitation-preview_2">Limitation Preview</h3>
<p>We now have two extremes: cache forever (static) or never cache (dynamic). Neither is perfect. Caching forever means our product price or stock level could be stale for days. Never caching means we lose all the performance benefits. What we really need is a middle ground: a way to cache data for a reasonable amount of time and a way to update the cache when we know the data has changed. This is called <strong>revalidation</strong>, and it's our final topic.</p>
<h2 id="revalidation-strategies">Revalidation strategies</h2>
<h2 id="iteration-4-keeping-cached-data-fresh">Iteration 4: Keeping Cached Data Fresh</h2>
<p>We've established that static rendering is incredibly fast but can serve stale data. Dynamic rendering is always fresh but slower. The ideal solution is to cache data but have strategies to update it when it changes. This process is called revalidation.</p>
<p>Next.js offers two primary revalidation strategies:
1.  <strong>Time-based Revalidation</strong>: Automatically re-fetch data after a certain amount of time has passed. This is also known as Incremental Static Regeneration (ISR).
2.  <strong>On-demand Revalidation</strong>: Manually trigger a re-fetch of data, typically in response to an external event like a CMS update or a database change.</p>
<p><strong>Current state recap</strong>: Our page can be either fully static (cached forever) or fully dynamic (never cached).</p>
<p><strong>Current limitation</strong>: We have no way to update our statically generated product page if the product's price or stock changes in the database. Users will see outdated information until we manually rebuild and redeploy the entire site.</p>
<p><strong>New scenario introduction</strong>:
1.  The price of our "Quantum Keyboard" can change. We want the page to show the updated price, but we're okay if it's up to 60 seconds out of date to maintain good performance.
2.  An admin updates the product description via a CMS. We want to trigger an immediate update of the product page without waiting for the time-based revalidation.</p>
<h3 id="strategy-1-time-based-revalidation">Strategy 1: Time-based Revalidation</h3>
<p>This is the simplest way to balance freshness and performance. We can specify a <code>revalidate</code> time in seconds for any <code>fetch</code> request.</p>
<ul>
<li>The first request will fetch the data and cache it.</li>
<li>Any requests within the next 60 seconds will be served the cached version instantly.</li>
<li>The first request <em>after</em> the 60-second window has passed will still be served the cached (stale) version instantly. However, in the background, Next.js will trigger a re-fetch.</li>
<li>Once the re-fetch is complete, the cache is updated with the new data. Subsequent visitors will now get the fresh version.</li>
</ul>
<p><strong>Step 1: Update the API to be dynamic</strong></p>
<p>To demonstrate this, let's make our API return a slightly different price each time it's called.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/products/[id]/route.ts (Updated)</span>
<span class="c1">// ... imports and products array</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n[API SERVER] Request for product ID: </span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">));</span><span class="w"> </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">(</span><span class="s1">&#39;Product not found&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Simulate a price that changes over time</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">dynamicPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getSeconds</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">productWithDynamicPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">dynamicPrice</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[API SERVER] Found product: </span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">, Price: </span><span class="si">${</span><span class="nx">dynamicPrice</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">productWithDynamicPrice</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 2: Implement Time-based Revalidation</strong></p>
<p>We modify the <code>fetch</code> call in our <code>getProduct</code> function to include the <code>next.revalidate</code> option. We'll set it to 10 seconds for easier testing.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (With time-based revalidation)</span>

<span class="c1">// ... imports</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// We remove cache: &#39;no-store&#39; and add revalidation</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">revalidate</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="c1">// Revalidate every 10 seconds</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ... rest of the page component</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 3: Build and Test</strong></p>
<p>Rebuild and start the production server.</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
npm<span class="w"> </span>start
</code></pre></div>

<h3 id="verification_3">Verification</h3>
<ol>
<li>Open <code>http://localhost:3000/products/1</code>. Note the price (e.g., $199.99). The terminal shows the fetch logs.</li>
<li>Refresh the page repeatedly within the next 10 seconds. The page loads instantly, the price does not change, and the terminal is silent. You are being served from the cache.</li>
<li>Wait for 10 seconds to pass.</li>
<li>Refresh the page again. You will <em>instantly</em> see the old price, but in the terminal, you will see the fetch logs appear. Next.js is revalidating in the background.</li>
<li>Refresh one more time. Now you will see the new, updated price.</li>
</ol>
<p>This demonstrates ISR perfectly. The user experience is always fast, and the data is kept reasonably fresh.</p>
<h3 id="strategy-2-on-demand-revalidation">Strategy 2: On-demand Revalidation</h3>
<p>Time-based revalidation is great, but sometimes you need to update content immediately. This is where on-demand revalidation comes in. We can use <code>revalidatePath</code> or <code>revalidateTag</code> to purge the Next.js cache for a specific page or a specific piece of data.</p>
<p>This is typically done via a secure API endpoint that might be triggered by a webhook from your CMS or e-commerce backend.</p>
<p><strong>Step 1: Tag the Data Fetch</strong></p>
<p>First, we need to "tag" our <code>fetch</code> request. This gives us a way to target this specific piece of data for revalidation later.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (With tags)</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`product:</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="w"> </span><span class="c1">// Add tags</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="c1">// Note: time-based revalidation can be used alongside tags.</span>
<span class="w">  </span><span class="c1">// For this demo, we rely on the default infinite cache.</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// ... rest of the page component</span>
</code></pre></div>

<p><strong>Step 2: Create a Revalidation API Route</strong></p>
<p>This is a secure endpoint that will call <code>revalidateTag</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/revalidate/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidateTag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In a real app, you&#39;d protect this route with a secret token</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">tag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Tag is required&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\n[REVALIDATE API] Revalidating tag: </span><span class="si">${</span><span class="nx">tag</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">revalidateTag</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">revalidated</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">now</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Step 3: Build and Test</strong></p>
<p>Rebuild and start the production server.</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>build
npm<span class="w"> </span>start
</code></pre></div>

<h3 id="verification_4">Verification</h3>
<ol>
<li>Open <code>http://localhost:3000/products/1</code>. Note the price. The terminal shows the fetch logs.</li>
<li>Refresh the page. It's instant, the price is the same, and the terminal is silent. The page is cached.</li>
<li>Now, simulate an admin action by sending a POST request to our revalidation endpoint. You can use a tool like <code>curl</code> or Postman.</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># In a new terminal window</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
-d<span class="w"> </span><span class="s1">&#39;{&quot;tag&quot;: &quot;product:1&quot;}&#39;</span><span class="w"> </span>http://localhost:3000/api/revalidate
</code></pre></div>

<p>You should see a response like <code>{"revalidated":true,...}</code>. In your Next.js server terminal, you'll see the log <code>[REVALIDATE API] Revalidating tag: product:1</code>.</p>
<ol>
<li>Go back to your browser and refresh <code>http://localhost:3000/products/1</code>.</li>
<li>The page will take a moment to load, and you will see a <strong>new price</strong>. The server logs will show that the data was fetched again. The cache was successfully purged.</li>
</ol>
<p>This powerful combination of default static caching, time-based revalidation, and on-demand revalidation gives you complete control over your data fetching strategy, allowing you to optimize for both performance and data freshness.</p>
<h3 id="the-journey-from-problem-to-solution">The Journey: From Problem to Solution</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Failure Mode</th>
<th>Technique Applied</th>
<th>Result</th>
<th>Performance Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Initial requirement: Display product data.</td>
<td><code>async</code> Server Component with <code>fetch</code></td>
<td>Simple, performant server-side data fetching.</td>
<td>Baseline: Fast on server, no client JS for fetching.</td>
</tr>
<tr>
<td>1</td>
<td>Need for client interactivity (reviews).</td>
<td>Client Component with React Query</td>
<td>Robust client-side state management with caching.</td>
<td>Adds client-side JS bundle, but improves UX for interactive data.</td>
</tr>
<tr>
<td>2</td>
<td>Slow server-side data (<code>RelatedProducts</code>) blocks page render.</td>
<td><code>Suspense</code> with a fallback UI</td>
<td>Main content renders instantly, slow content streams in.</td>
<td>Dramatically improves Time to First Byte (TTFB) and perceived performance.</td>
</tr>
<tr>
<td>3</td>
<td>Unnecessary database hits on every request for static content.</td>
<td>Next.js <code>fetch</code> Caching (Static Rendering)</td>
<td>Page is rendered once and served from cache on subsequent requests.</td>
<td>Sub-second loads, minimal server cost after first visit.</td>
</tr>
<tr>
<td>4</td>
<td>Statically cached data becomes stale when the source changes.</td>
<td>Time-based &amp; On-demand Revalidation</td>
<td>Cached data is updated periodically or on-demand.</td>
<td>The perfect balance: fast loads of cached content with guaranteed freshness.</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here is the final, production-ready <code>ProductPage</code> that incorporates all our improvements.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/page.tsx (Final Version)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Suspense</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductReviews&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">RelatedProducts</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RelatedProducts&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">RelatedProductsSkeleton</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/RelatedProductsSkeleton&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="p">&lt;</span><span class="nt">Product</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`http://localhost:3000/api/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">next</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Use tags for on-demand revalidation.</span>
<span class="w">      </span><span class="c1">// Can also add time-based revalidation here: revalidate: 60</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;products&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`product:</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">],</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to fetch product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProduct</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-8 max-w-4xl mx-auto&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Main Product Info (Fast, Statically Cached with Revalidation) */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mb-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl text-gray-700 mb-2&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-lg mb-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">In</span><span class="w"> </span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">stock</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Interactive Reviews (Client-side Fetching) */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Slow Related Products (Server-side Streaming) */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Suspense</span><span class="w"> </span><span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">RelatedProductsSkeleton</span><span class="w"> </span><span class="p">/&gt;}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">RelatedProducts</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="lessons-learned">Lessons Learned</h3>
<p>Data fetching in Next.js is a layered system designed for optimal performance by default.
- <strong>Start with Server Components</strong>: Fetch static or initial data directly in <code>async</code> Server Components. This is the simplest and most performant approach.
- <strong>Use Client Components for Interactivity</strong>: When data fetching is triggered by user actions, use a Client Component with a library like React Query to handle caching and server state.
- <strong>Embrace Streaming</strong>: Wrap slow or non-critical server-side data fetches in <code>&lt;Suspense&gt;</code> to avoid blocking the initial page render.
- <strong>Leverage Caching</strong>: Understand that <code>fetch</code> is automatically cached in production. This is your biggest performance lever.
- <strong>Revalidate Intelligently</strong>: Don't disable caching entirely with <code>no-store</code> unless absolutely necessary. Prefer time-based or on-demand revalidation to keep cached content fresh without sacrificing performance.</p>
        </div>
        <div class="footer">
            Generated on 2025-11-25 13:41:00 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>