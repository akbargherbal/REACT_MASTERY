<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>21 Deployment and Performance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-21-deployment-and-performance">Chapter 21: Deployment and Performance</h1>
<h2 id="deploying-to-vercel-the-path-of-least-resistance">Deploying to Vercel (the path of least resistance)</h2>
<h2 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h2>
<p>You've built a Next.js application. It works perfectly on <code>localhost:3000</code>. Now you need to deploy it to production so real users can access it. This is where many developers encounter their first production failure: <strong>the build that works locally fails in production</strong>.</p>
<p>We'll use a realistic e-commerce product catalog as our reference implementation‚Äîthe same one we've been building through Chapters 16-20. It has:</p>
<ul>
<li>Server Components fetching product data</li>
<li>Client Components for interactive cart</li>
<li>API routes for checkout</li>
<li>Authentication with NextAuth.js</li>
<li>Image optimization</li>
<li>Environment variables for API keys</li>
</ul>
<p>Let's see what happens when we try to deploy this to production for the first time.</p>
<h3 id="the-reference-implementation-product-catalog">The Reference Implementation: Product Catalog</h3>
<p>Our application structure:</p>
<p><strong>Project Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">product</span><span class="o">-</span><span class="k">catalog</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="n">list</span><span class="p">)</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">      </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">(</span><span class="n">product</span><span class="w"> </span><span class="n">detail</span><span class="p">)</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">cart</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">(</span><span class="n">shopping</span><span class="w"> </span><span class="n">cart</span><span class="p">)</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">checkout</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">      </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">route</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">auth</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">...nextauth</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">  </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">NextAuth</span><span class="p">.</span><span class="n">js</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="n">tsx</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">components</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">ProductCard</span><span class="p">.</span><span class="n">tsx</span><span class="w">       </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Component</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">AddToCartButton</span><span class="p">.</span><span class="n">tsx</span><span class="w">   </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="n">Component</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">ts</span><span class="w">                 </span><span class="err">‚Üê</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">client</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">stripe</span><span class="p">.</span><span class="n">ts</span><span class="w">             </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Stripe</span><span class="w"> </span><span class="n">client</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="k">public</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">images</span><span class="o">/</span><span class="w">               </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">images</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="k">local</span><span class="w">                </span><span class="err">‚Üê</span><span class="w"> </span><span class="k">Local</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="k">next</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">js</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">package</span><span class="p">.</span><span class="n">json</span>
</code></pre></div>

<p>Here's our product listing page that works perfectly locally:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductCard</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductCard&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Server Component - fetch directly</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-1 md:grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductCard</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// components/ProductCard.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/image&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useCart</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/hooks/useCart&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">product</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductCard</span><span class="p">({</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addItem</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useCart</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">        </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">        </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">        </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mt-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">addItem</span><span class="p">(</span><span class="nx">product</span><span class="p">)}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="nx">Add</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Cart</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// lib/db.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PrismaClient</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@prisma/client&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">globalForPrisma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">global</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">prisma</span><span class="o">:</span><span class="w"> </span><span class="kt">PrismaClient</span><span class="w"> </span><span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">globalForPrisma</span><span class="p">.</span><span class="nx">prisma</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PrismaClient</span><span class="p">();</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">globalForPrisma</span><span class="p">.</span><span class="nx">prisma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">;</span>
</code></pre></div>

<p>Our <code>.env.local</code> file contains all our secrets:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env.local</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;postgresql://user:password@localhost:5432/products&quot;</span>
<span class="nv">NEXTAUTH_SECRET</span><span class="o">=</span><span class="s2">&quot;super-secret-key-for-local-dev&quot;</span>
<span class="nv">NEXTAUTH_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:3000&quot;</span>
<span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;sk_test_...&quot;</span>
<span class="nv">STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span><span class="s2">&quot;pk_test_...&quot;</span>
</code></pre></div>

<p>Locally, everything works:
- Products load instantly
- Images display correctly
- Cart functionality works
- Checkout processes payments</p>
<p>Now let's deploy to production.</p>
<h2 id="the-first-deployment-when-everything-breaks">The First Deployment: When Everything Breaks</h2>
<h2 id="phase-2-diagnostic-analysis-the-production-build-failure">Phase 2: Diagnostic Analysis - The Production Build Failure</h2>
<h3 id="iteration-0-the-naive-first-deployment">Iteration 0: The Naive First Deployment</h3>
<p>You push your code to GitHub, connect it to Vercel, and click "Deploy". Here's what happens:</p>
<p><strong>Terminal Output (Vercel Build Log)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">12</span>:34:56.789<span class="o">]</span><span class="w"> </span>Running<span class="w"> </span>build<span class="w"> </span><span class="k">in</span><span class="w"> </span>Washington,<span class="w"> </span>D.C.,<span class="w"> </span>USA<span class="w"> </span><span class="o">(</span>East<span class="o">)</span><span class="w"> </span>‚Äì<span class="w"> </span>iad1
<span class="o">[</span><span class="m">12</span>:34:57.123<span class="o">]</span><span class="w"> </span>Cloning<span class="w"> </span>github.com/yourname/product-catalog<span class="w"> </span><span class="o">(</span>Branch:<span class="w"> </span>main,<span class="w"> </span>Commit:<span class="w"> </span>abc123<span class="o">)</span>
<span class="o">[</span><span class="m">12</span>:34:58.456<span class="o">]</span><span class="w"> </span>Installing<span class="w"> </span>dependencies...
<span class="o">[</span><span class="m">12</span>:35:12.789<span class="o">]</span><span class="w"> </span>Dependencies<span class="w"> </span>installed
<span class="o">[</span><span class="m">12</span>:35:13.123<span class="o">]</span><span class="w"> </span>Running<span class="w"> </span><span class="s2">&quot;npm run build&quot;</span>
<span class="o">[</span><span class="m">12</span>:35:15.456<span class="o">]</span><span class="w"> </span>&gt;<span class="w"> </span>product-catalog@0.1.0<span class="w"> </span>build
<span class="o">[</span><span class="m">12</span>:35:15.456<span class="o">]</span><span class="w"> </span>&gt;<span class="w"> </span>next<span class="w"> </span>build
<span class="o">[</span><span class="m">12</span>:35:16.789<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:16.789<span class="o">]</span><span class="w">    </span>‚ñ≤<span class="w"> </span>Next.js<span class="w"> </span><span class="m">14</span>.0.0
<span class="o">[</span><span class="m">12</span>:35:16.789<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:18.123<span class="o">]</span><span class="w">    </span>Creating<span class="w"> </span>an<span class="w"> </span>optimized<span class="w"> </span>production<span class="w"> </span>build<span class="w"> </span>...
<span class="o">[</span><span class="m">12</span>:35:25.456<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Compiled<span class="w"> </span>successfully
<span class="o">[</span><span class="m">12</span>:35:26.789<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:26.789<span class="o">]</span><span class="w">    </span>Linting<span class="w"> </span>and<span class="w"> </span>checking<span class="w"> </span>validity<span class="w"> </span>of<span class="w"> </span>types<span class="w"> </span>...
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>compile.
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>./app/products/page.tsx:8:23
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>Type<span class="w"> </span>error:<span class="w"> </span>Property<span class="w"> </span><span class="s1">&#39;product&#39;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist<span class="w"> </span>on<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s1">&#39;PrismaClient&#39;</span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">   </span><span class="m">6</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span>default<span class="w"> </span>async<span class="w"> </span><span class="k">function</span><span class="w"> </span>ProductsPage<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">   </span><span class="m">7</span><span class="w"> </span><span class="p">|</span><span class="w">   </span>const<span class="w"> </span><span class="nv">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>await<span class="w"> </span>db.product.findMany<span class="o">({</span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>&gt;<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>where:<span class="w"> </span><span class="o">{</span><span class="w"> </span>published:<span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">}</span>,
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">     </span><span class="p">|</span><span class="w">                       </span>^
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">   </span><span class="m">9</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>orderBy:<span class="w"> </span><span class="o">{</span><span class="w"> </span>createdAt:<span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="o">}</span>,
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">  </span><span class="m">10</span><span class="w"> </span><span class="p">|</span><span class="w">   </span><span class="o">})</span><span class="p">;</span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w">  </span><span class="m">11</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:28.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:35:28.456<span class="o">]</span><span class="w"> </span>Error:<span class="w"> </span>Command<span class="w"> </span><span class="s2">&quot;npm run build&quot;</span><span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span><span class="m">1</span>
<span class="o">[</span><span class="m">12</span>:35:28.789<span class="o">]</span><span class="w"> </span>BUILD<span class="w"> </span>FAILED
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-build-failure">Diagnostic Analysis: Reading the Build Failure</h3>
<p><strong>Build Behavior</strong>:
The build process starts successfully, installs dependencies, begins compilation, but fails during type checking.</p>
<p><strong>Terminal Evidence</strong>:
- Build reaches "Linting and checking validity of types"
- TypeScript error: <code>Property 'product' does not exist on type 'PrismaClient'</code>
- Error location: <code>app/products/page.tsx:8:23</code>
- Build exits with code 1 (failure)</p>
<p><strong>What Happened Locally vs. Production</strong>:
- <strong>Locally</strong>: Prisma Client was generated with <code>npx prisma generate</code>, types exist
- <strong>Production</strong>: Prisma Client was never generated, types don't exist</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the build process experiences</strong>: TypeScript can't find the Prisma types because the Prisma Client hasn't been generated yet.</p>
</li>
<li>
<p><strong>What the error reveals</strong>: The build process doesn't know about your database schema. Prisma generates TypeScript types from your schema, but that generation step never ran.</p>
</li>
<li>
<p><strong>Root cause identified</strong>: Missing build step‚ÄîPrisma Client generation must happen before Next.js build.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>: Simply pushing code isn't enough. Production builds need explicit instructions for multi-step build processes.</p>
</li>
<li>
<p><strong>What we need</strong>: A <code>postinstall</code> script to generate Prisma Client after dependencies are installed but before Next.js builds.</p>
</li>
</ol>
<h3 id="iteration-1-adding-the-prisma-generation-step">Iteration 1: Adding the Prisma Generation Step</h3>
<p><strong>Before</strong> (package.json):</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;product-catalog&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next dev&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next start&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@prisma/client&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;next&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;14.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;prisma&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.3.0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Problem</strong>: No instruction to generate Prisma Client during build.</p>
<p><strong>After</strong> (package.json):</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;product-catalog&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next dev&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;postinstall&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prisma generate&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@prisma/client&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;next&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;14.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;prisma&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.3.0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Improvement</strong>: <code>postinstall</code> script runs automatically after <code>npm install</code>, generating Prisma Client before the build.</p>
<p>Push this change and redeploy:</p>
<p><strong>Terminal Output (Second Deployment)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">12</span>:45:12.123<span class="o">]</span><span class="w"> </span>Installing<span class="w"> </span>dependencies...
<span class="o">[</span><span class="m">12</span>:45:25.456<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:25.456<span class="o">]</span><span class="w"> </span>&gt;<span class="w"> </span>product-catalog@0.1.0<span class="w"> </span>postinstall
<span class="o">[</span><span class="m">12</span>:45:25.456<span class="o">]</span><span class="w"> </span>&gt;<span class="w"> </span>prisma<span class="w"> </span>generate
<span class="o">[</span><span class="m">12</span>:45:26.789<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:26.789<span class="o">]</span><span class="w"> </span>Prisma<span class="w"> </span>schema<span class="w"> </span>loaded<span class="w"> </span>from<span class="w"> </span>prisma/schema.prisma
<span class="o">[</span><span class="m">12</span>:45:28.123<span class="o">]</span><span class="w"> </span>‚úî<span class="w"> </span>Generated<span class="w"> </span>Prisma<span class="w"> </span>Client<span class="w"> </span><span class="o">(</span><span class="m">5</span>.7.0<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>./node_modules/@prisma/client
<span class="o">[</span><span class="m">12</span>:45:28.456<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:28.789<span class="o">]</span><span class="w"> </span>Dependencies<span class="w"> </span>installed
<span class="o">[</span><span class="m">12</span>:45:29.123<span class="o">]</span><span class="w"> </span>Running<span class="w"> </span><span class="s2">&quot;npm run build&quot;</span>
<span class="o">[</span><span class="m">12</span>:45:35.456<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Compiled<span class="w"> </span>successfully
<span class="o">[</span><span class="m">12</span>:45:36.789<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Linting<span class="w"> </span>and<span class="w"> </span>checking<span class="w"> </span>validity<span class="w"> </span>of<span class="w"> </span>types
<span class="o">[</span><span class="m">12</span>:45:38.123<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Collecting<span class="w"> </span>page<span class="w"> </span>data
<span class="o">[</span><span class="m">12</span>:45:42.456<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Generating<span class="w"> </span>static<span class="w"> </span>pages<span class="w"> </span><span class="o">(</span><span class="m">5</span>/5<span class="o">)</span>
<span class="o">[</span><span class="m">12</span>:45:43.789<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Collecting<span class="w"> </span>build<span class="w"> </span>traces
<span class="o">[</span><span class="m">12</span>:45:44.123<span class="o">]</span><span class="w"> </span>‚úì<span class="w"> </span>Finalizing<span class="w"> </span>page<span class="w"> </span>optimization
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>‚îå<span class="w"> </span>‚óã<span class="w"> </span>/<span class="w">                                    </span><span class="m">142</span><span class="w"> </span>B<span class="w">          </span><span class="m">87</span>.2<span class="w"> </span>kB
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products<span class="w">                            </span><span class="m">1</span>.2<span class="w"> </span>kB<span class="w">         </span><span class="m">88</span>.3<span class="w"> </span>kB
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>‚îî<span class="w"> </span>‚óã<span class="w"> </span>/products/<span class="o">[</span>id<span class="o">]</span><span class="w">                       </span><span class="m">890</span><span class="w"> </span>B<span class="w">          </span><span class="m">87</span>.9<span class="w"> </span>kB
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>‚óã<span class="w">  </span><span class="o">(</span>Static<span class="o">)</span><span class="w">  </span>prerendered<span class="w"> </span>as<span class="w"> </span>static<span class="w"> </span>content
<span class="o">[</span><span class="m">12</span>:45:44.456<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:45:44.789<span class="o">]</span><span class="w"> </span>BUILD<span class="w"> </span>SUCCESSFUL
<span class="o">[</span><span class="m">12</span>:45:45.123<span class="o">]</span><span class="w"> </span>Deploying...
<span class="o">[</span><span class="m">12</span>:45:48.456<span class="o">]</span><span class="w"> </span>Deployment<span class="w"> </span>ready:<span class="w"> </span>https://product-catalog-abc123.vercel.app
</code></pre></div>

<p><strong>Success!</strong> The build completes. But when you visit the deployed URL...</p>
<p><strong>Browser Behavior</strong>:
- Page loads with layout and header
- Product grid shows loading state
- After 10 seconds: "500 Internal Server Error"</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">load</span><span class="w"> </span><span class="n">resource</span><span class="p">:</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">responded</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mi">500</span><span class="w"> </span><span class="p">()</span>
<span class="n">GET</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">product</span><span class="o">-</span><span class="n">catalog</span><span class="o">-</span><span class="n">abc123</span><span class="o">.</span><span class="n">vercel</span><span class="o">.</span><span class="n">app</span><span class="o">/</span><span class="n">products</span><span class="w"> </span><span class="mi">500</span>
</code></pre></div>

<p><strong>Vercel Function Logs</strong> (in Vercel Dashboard):</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">ERROR</span><span class="o">]</span><span class="w"> </span><span class="nl">PrismaClientInitializationError</span><span class="p">:</span><span class="w"> </span>
<span class="n">Can</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">reach</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="err">`</span><span class="nl">localhost</span><span class="p">:</span><span class="mi">5432</span><span class="err">`</span>

<span class="n">Please</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="err">`</span><span class="nl">localhost</span><span class="p">:</span><span class="mi">5432</span><span class="err">`</span><span class="p">.</span>

<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">PrismaClient</span><span class="p">.</span><span class="k">connect</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="p">.</span><span class="k">next</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">chunks</span><span class="o">/</span><span class="mf">123.</span><span class="nl">js</span><span class="p">:</span><span class="mi">45678</span><span class="err">:</span><span class="mi">23</span><span class="p">)</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">ProductsPage</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="p">.</span><span class="k">next</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">page</span><span class="p">.</span><span class="nl">js</span><span class="p">:</span><span class="mi">12</span><span class="err">:</span><span class="mi">34</span><span class="p">)</span>
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-runtime-failure">Diagnostic Analysis: Reading the Runtime Failure</h3>
<p><strong>Browser Behavior</strong>:
Page structure loads (layout, navigation), but product data never appears. After timeout, shows 500 error.</p>
<p><strong>Browser Console Output</strong>:
HTTP 500 status from <code>/products</code> route‚Äîserver-side error, not client-side.</p>
<p><strong>Vercel Function Logs Evidence</strong>:
- Error type: <code>PrismaClientInitializationError</code>
- Specific issue: "Can't reach database server at <code>localhost:5432</code>"
- Error location: During Prisma connection attempt in Server Component</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the user experiences</strong>: Page loads partially, then fails. No products display.</p>
</li>
<li>
<p><strong>What the console reveals</strong>: 500 error means server-side failure. The problem isn't in the browser‚Äîit's in the serverless function.</p>
</li>
<li>
<p><strong>What the logs show</strong>: Prisma is trying to connect to <code>localhost:5432</code>. In production, there is no localhost database. The production environment doesn't have access to your local PostgreSQL.</p>
</li>
<li>
<p><strong>Root cause identified</strong>: Environment variables from <code>.env.local</code> don't exist in production. The <code>DATABASE_URL</code> is still pointing to localhost.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>: <code>.env.local</code> files are never committed to Git (and shouldn't be‚Äîthey contain secrets). Production needs its own environment variables.</p>
</li>
<li>
<p><strong>What we need</strong>: Configure environment variables in Vercel's dashboard, pointing to a production database.</p>
</li>
</ol>
<h3 id="iteration-2-configuring-production-environment-variables">Iteration 2: Configuring Production Environment Variables</h3>
<p>First, we need a production database. For this example, we'll use a hosted PostgreSQL database (Vercel Postgres, Supabase, Railway, or any provider).</p>
<p><strong>Step 1: Create Production Database</strong></p>
<p>Let's say you've created a Vercel Postgres database. Vercel provides these credentials:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Production database credentials (from Vercel Postgres)</span>
<span class="nv">POSTGRES_URL</span><span class="o">=</span><span class="s2">&quot;postgres://default:abc123@ep-cool-name-123456.us-east-1.postgres.vercel-storage.com:5432/verceldb&quot;</span>
<span class="nv">POSTGRES_PRISMA_URL</span><span class="o">=</span><span class="s2">&quot;postgres://default:abc123@ep-cool-name-123456.us-east-1.postgres.vercel-storage.com:5432/verceldb?pgbouncer=true&amp;connect_timeout=15&quot;</span>
<span class="nv">POSTGRES_URL_NON_POOLING</span><span class="o">=</span><span class="s2">&quot;postgres://default:abc123@ep-cool-name-123456.us-east-1.postgres.vercel-storage.com:5432/verceldb&quot;</span>
</code></pre></div>

<p><strong>Step 2: Add Environment Variables in Vercel Dashboard</strong></p>
<p>Navigate to your project in Vercel:
1. Go to Project Settings ‚Üí Environment Variables
2. Add each variable:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
<th>Environment</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DATABASE_URL</code></td>
<td><code>postgres://default:abc123@ep-cool-name...</code></td>
<td>Production, Preview, Development</td>
</tr>
<tr>
<td><code>NEXTAUTH_SECRET</code></td>
<td><code>[generate new secret for production]</code></td>
<td>Production</td>
</tr>
<tr>
<td><code>NEXTAUTH_URL</code></td>
<td><code>https://product-catalog-abc123.vercel.app</code></td>
<td>Production</td>
</tr>
<tr>
<td><code>STRIPE_SECRET_KEY</code></td>
<td><code>sk_live_...</code></td>
<td>Production</td>
</tr>
<tr>
<td><code>STRIPE_PUBLISHABLE_KEY</code></td>
<td><code>pk_live_...</code></td>
<td>Production, Preview, Development</td>
</tr>
</tbody>
</table>
<p><strong>Critical</strong>: Use different secrets for production vs. development. Never use test API keys in production.</p>
<p><strong>Step 3: Run Database Migrations</strong></p>
<p>Your production database is empty. You need to apply your Prisma schema:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Set production database URL temporarily</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">&quot;postgres://default:abc123@ep-cool-name...&quot;</span>

<span class="c1"># Run migrations against production database</span>
npx<span class="w"> </span>prisma<span class="w"> </span>migrate<span class="w"> </span>deploy

<span class="c1"># Seed initial data (if you have a seed script)</span>
npx<span class="w"> </span>prisma<span class="w"> </span>db<span class="w"> </span>seed
</code></pre></div>

<p><strong>Step 4: Redeploy</strong></p>
<p>Vercel automatically redeploys when you add environment variables. Or trigger manually:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Trigger redeployment</span>
git<span class="w"> </span>commit<span class="w"> </span>--allow-empty<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Trigger redeploy with env vars&quot;</span>
git<span class="w"> </span>push
</code></pre></div>

<p><strong>Terminal Output (Third Deployment)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">13</span>:15:44.456<span class="o">]</span><span class="w"> </span>BUILD<span class="w"> </span>SUCCESSFUL
<span class="o">[</span><span class="m">13</span>:15:45.123<span class="o">]</span><span class="w"> </span>Deploying...
<span class="o">[</span><span class="m">13</span>:15:48.456<span class="o">]</span><span class="w"> </span>Deployment<span class="w"> </span>ready:<span class="w"> </span>https://product-catalog-abc123.vercel.app
</code></pre></div>

<p>Now visit the deployed URL:</p>
<p><strong>Browser Behavior</strong>:
- Page loads
- Products appear!
- Images... are broken (404 errors)
- Cart button works
- Clicking "Add to Cart" ‚Üí 500 error</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET https://product-catalog-abc123.vercel.app/images/product-1.jpg 404 (Not Found)
GET https://product-catalog-abc123.vercel.app/images/product-2.jpg 404 (Not Found)
GET https://product-catalog-abc123.vercel.app/images/product-3.jpg 404 (Not Found)

POST https://product-catalog-abc123.vercel.app/api/cart/add 500 (Internal Server Error)
</code></pre></div>

<p><strong>Vercel Function Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">ERROR</span><span class="o">]</span><span class="w"> </span><span class="nl">Error</span><span class="p">:</span><span class="w"> </span><span class="n">NEXTAUTH_SECRET</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">set</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="p">.</span><span class="k">next</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">chunks</span><span class="o">/</span><span class="mf">456.</span><span class="nl">js</span><span class="p">:</span><span class="mi">12345</span><span class="err">:</span><span class="mi">67</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="p">.</span><span class="k">next</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">cart</span><span class="o">/</span><span class="k">add</span><span class="o">/</span><span class="n">route</span><span class="p">.</span><span class="nl">js</span><span class="p">:</span><span class="mi">23</span><span class="err">:</span><span class="mi">45</span><span class="p">)</span>
</code></pre></div>

<h3 id="diagnostic-analysis-multiple-remaining-issues">Diagnostic Analysis: Multiple Remaining Issues</h3>
<p>We have two separate problems:</p>
<p><strong>Problem 1: Missing Images</strong>
- <strong>Browser behavior</strong>: 404 errors for all product images
- <strong>Console evidence</strong>: Requests to <code>/images/product-X.jpg</code> return 404
- <strong>Root cause</strong>: Images in <code>public/images/</code> weren't committed to Git (likely in <code>.gitignore</code>), or they're stored locally and not in the repository</p>
<p><strong>Problem 2: API Route Failure</strong>
- <strong>Browser behavior</strong>: Cart operations fail with 500 error
- <strong>Function logs</strong>: <code>NEXTAUTH_SECRET is not set</code>
- <strong>Root cause</strong>: The API route uses NextAuth.js session verification, but we only set <code>NEXTAUTH_SECRET</code> for "Production" environment, not "Preview"</p>
<p>Let's fix both issues.</p>
<h3 id="iteration-3-fixing-images-and-environment-variable-scope">Iteration 3: Fixing Images and Environment Variable Scope</h3>
<p><strong>Fix 1: Ensure Images Are Committed</strong></p>
<p>Check your <code>.gitignore</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .gitignore</span>
node_modules/
.next/
.env*.local
.vercel

<span class="c1"># Make sure this line is NOT present:</span>
<span class="c1"># public/images/</span>
</code></pre></div>

<p>If images were ignored, remove that line and commit them:</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>public/images/
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Add product images&quot;</span>
git<span class="w"> </span>push
</code></pre></div>

<p><strong>Fix 2: Set Environment Variables for All Environments</strong></p>
<p>In Vercel Dashboard, edit each environment variable to include all environments:
- Production ‚úì
- Preview ‚úì
- Development ‚úì</p>
<p>This ensures preview deployments (from pull requests) also have access to necessary secrets.</p>
<p><strong>Alternative</strong>: Use different values per environment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Production</span>
<span class="nv">NEXTAUTH_SECRET</span><span class="o">=</span><span class="s2">&quot;production-secret-very-long-and-random&quot;</span>
<span class="nv">NEXTAUTH_URL</span><span class="o">=</span><span class="s2">&quot;https://product-catalog.vercel.app&quot;</span>

<span class="c1"># Preview</span>
<span class="nv">NEXTAUTH_SECRET</span><span class="o">=</span><span class="s2">&quot;preview-secret-different-from-prod&quot;</span>
<span class="nv">NEXTAUTH_URL</span><span class="o">=</span><span class="s2">&quot;https://product-catalog-git-main-yourname.vercel.app&quot;</span>

<span class="c1"># Development</span>
<span class="nv">NEXTAUTH_SECRET</span><span class="o">=</span><span class="s2">&quot;development-secret-for-local&quot;</span>
<span class="nv">NEXTAUTH_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:3000&quot;</span>
</code></pre></div>

<p><strong>Terminal Output (Fourth Deployment)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">13</span>:45:44.456<span class="o">]</span><span class="w"> </span>BUILD<span class="w"> </span>SUCCESSFUL
<span class="o">[</span><span class="m">13</span>:45:45.123<span class="o">]</span><span class="w"> </span>Deploying...
<span class="o">[</span><span class="m">13</span>:45:48.456<span class="o">]</span><span class="w"> </span>Deployment<span class="w"> </span>ready:<span class="w"> </span>https://product-catalog-abc123.vercel.app
</code></pre></div>

<p>Visit the deployed URL again:</p>
<p><strong>Browser Behavior</strong>:
- Page loads ‚úì
- Products appear ‚úì
- Images display ‚úì
- Cart button works ‚úì
- Add to cart succeeds ‚úì
- Checkout... takes 30 seconds and times out</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST https://product-catalog-abc123.vercel.app/api/checkout 504 (Gateway Timeout)
</code></pre></div>

<p><strong>Vercel Function Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">ERROR</span><span class="o">]</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">timed</span><span class="w"> </span><span class="k">out</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="mf">10.00</span><span class="w"> </span><span class="n">seconds</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">task</span><span class="o">/</span><span class="p">.</span><span class="k">next</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">checkout</span><span class="o">/</span><span class="n">route</span><span class="p">.</span><span class="nl">js</span><span class="p">:</span><span class="mi">34</span><span class="err">:</span><span class="mi">56</span><span class="p">)</span>
</code></pre></div>

<h3 id="diagnostic-analysis-serverless-function-timeout">Diagnostic Analysis: Serverless Function Timeout</h3>
<p><strong>Browser Behavior</strong>:
Checkout request hangs, eventually times out with 504 Gateway Timeout.</p>
<p><strong>Function Logs Evidence</strong>:
- Error: "Task timed out after 10.00 seconds"
- Location: Checkout API route</p>
<p><strong>What's Happening</strong>:
Vercel's free tier has a 10-second timeout for serverless functions. Your checkout process (which might involve Stripe payment processing, database writes, email sending) takes longer than 10 seconds.</p>
<p><strong>Root cause identified</strong>: Serverless functions have execution time limits. Long-running operations need to be optimized or moved to background jobs.</p>
<p><strong>Solutions</strong>:
1. <strong>Optimize the checkout flow</strong>: Make it faster (parallel operations, reduce database queries)
2. <strong>Upgrade Vercel plan</strong>: Pro plan has 60-second timeout, Enterprise has 900 seconds
3. <strong>Use background jobs</strong>: Offload non-critical operations (email sending) to a queue
4. <strong>Stream responses</strong>: Use streaming to keep connection alive while processing</p>
<p>For now, let's optimize the checkout flow:</p>
<h3 id="iteration-4-optimizing-the-checkout-api-route">Iteration 4: Optimizing the Checkout API Route</h3>
<p><strong>Before</strong> (slow, sequential operations):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/checkout/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerSession</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/stripe&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sendOrderConfirmationEmail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/email&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerSession</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="o">?</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Sequential operations - SLOW</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">session.user.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">items</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">paymentIntents</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">    </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">calculateTotal</span><span class="p">(</span><span class="nx">items</span><span class="p">),</span>
<span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">orderId</span><span class="o">:</span><span class="w"> </span><span class="kt">order.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">order.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripePaymentIntentId</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// This can take 3-5 seconds</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">sendOrderConfirmationEmail</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">clientSecret</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.client_secret</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Problem</strong>: Each <code>await</code> blocks the next operation. Total time: 2s (DB) + 1s (Stripe) + 1s (DB update) + 4s (email) = 8+ seconds.</p>
<p><strong>After</strong> (parallel operations, deferred email):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/checkout/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerSession</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/stripe&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerSession</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="o">?</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Parallel operations - FAST</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">order</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">session.user.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">items</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">paymentIntents</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">calculateTotal</span><span class="p">(</span><span class="nx">items</span><span class="p">),</span>
<span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">session.user.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="c1">// Update order with payment intent ID</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">order.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripePaymentIntentId</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Defer email to webhook handler (runs after payment succeeds)</span>
<span class="w">  </span><span class="c1">// No need to wait for email in the checkout request</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">clientSecret</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.client_secret</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/webhooks/stripe/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/stripe&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sendOrderConfirmationEmail</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/email&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;stripe-signature&#39;</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">event</span><span class="p">;</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">webhooks</span><span class="p">.</span><span class="nx">constructEvent</span><span class="p">(</span>
<span class="w">      </span><span class="nx">body</span><span class="p">,</span>
<span class="w">      </span><span class="nx">signature</span><span class="p">,</span>
<span class="w">      </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRIPE_WEBHOOK_SECRET</span><span class="o">!</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid signature&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;payment_intent.succeeded&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">object</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Update order status</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">      </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripePaymentIntentId</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;paid&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">include</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Send email asynchronously (webhook has 30s timeout)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">sendOrderConfirmationEmail</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">order</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">received</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Improvement</strong>: 
- Checkout API route: 2s (parallel DB + Stripe) + 1s (update) = 3 seconds total
- Email sending moved to webhook (runs after payment succeeds, not blocking checkout)
- User gets immediate response, email arrives shortly after</p>
<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Before</strong>: 8+ seconds, often timing out
- <strong>After</strong>: 3 seconds, well within 10-second limit
- <strong>User experience</strong>: Checkout completes instantly, confirmation email arrives within 30 seconds</p>
<p><strong>Verification</strong>: Deploy and test checkout flow. Monitor Vercel function logs:</p>
<p><strong>Vercel Function Logs (After Optimization)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">checkout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="p">(</span><span class="mi">2847</span><span class="n">ms</span><span class="p">)</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">webhooks</span><span class="o">/</span><span class="n">stripe</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="p">(</span><span class="mi">4123</span><span class="n">ms</span><span class="p">)</span>
</code></pre></div>

<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Fast API response times
- Staying within serverless function limits
- Better user experience (no waiting for emails)</p>
<p><strong>What it sacrifices</strong>:
- Immediate email delivery (now asynchronous)
- Slightly more complex architecture (webhook handler required)</p>
<p><strong>When to choose this approach</strong>:
- Any operation that takes &gt;5 seconds
- Non-critical operations (emails, analytics, notifications)
- When using serverless functions with time limits</p>
<p><strong>When to avoid this approach</strong>:
- Operations that must complete before responding (payment authorization)
- When you need guaranteed synchronous execution
- Simple applications where complexity isn't worth it</p>
<p><strong>Limitation preview</strong>: This solves timeout issues, but we still haven't addressed image optimization and bundle size. Next, we'll tackle performance.</p>
<h2 id="image-optimization-with-nextimage">Image optimization with next/image</h2>
<h2 id="phase-3-image-optimization-the-performance-killer">Phase 3: Image Optimization - The Performance Killer</h2>
<p>Our application is deployed and functional. But let's check the performance:</p>
<p><strong>Lighthouse Report (Initial)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Performance</span><span class="o">:</span><span class="w"> </span><span class="mi">42</span><span class="o">/</span><span class="mi">100</span>
<span class="o">-</span><span class="w"> </span><span class="n">First</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">:</span><span class="w"> </span><span class="mf">3.2</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Largest</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">:</span><span class="w"> </span><span class="mf">8.4</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Cumulative</span><span class="w"> </span><span class="n">Layout</span><span class="w"> </span><span class="n">Shift</span><span class="o">:</span><span class="w"> </span><span class="mf">0.45</span>
<span class="o">-</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Blocking</span><span class="w"> </span><span class="n">Time</span><span class="o">:</span><span class="w"> </span><span class="mi">890</span><span class="n">ms</span>

<span class="n">Opportunities</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Properly</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">images</span><span class="o">:</span><span class="w"> </span><span class="n">Potential</span><span class="w"> </span><span class="n">savings</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mf">2.4</span><span class="w"> </span><span class="n">MB</span>
<span class="o">-</span><span class="w"> </span><span class="n">Serve</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">next</span><span class="o">-</span><span class="n">gen</span><span class="w"> </span><span class="n">formats</span><span class="o">:</span><span class="w"> </span><span class="n">Potential</span><span class="w"> </span><span class="n">savings</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="mf">1.8</span><span class="w"> </span><span class="n">MB</span>
<span class="o">-</span><span class="w"> </span><span class="n">Eliminate</span><span class="w"> </span><span class="n">render</span><span class="o">-</span><span class="n">blocking</span><span class="w"> </span><span class="n">resources</span><span class="o">:</span><span class="w"> </span><span class="mi">450</span><span class="n">ms</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:</p>
<div class="codehilite"><pre><span></span><code>Total resources: 45 requests
Total size: 4.2 MB
Images: 3.8 MB (90% of total)

product-1.jpg: 1.2 MB (3000x3000px, displayed at 300x300px)
product-2.jpg: 1.4 MB (3500x3500px, displayed at 300x300px)
product-3.jpg: 1.2 MB (3200x3200px, displayed at 300x300px)
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-performance-failure">Diagnostic Analysis: Reading the Performance Failure</h3>
<p><strong>Browser Behavior</strong>:
- Page loads slowly
- Images pop in one by one
- Layout shifts as images load (content jumps around)
- Mobile users on slow connections wait 10+ seconds</p>
<p><strong>Lighthouse Evidence</strong>:
- LCP (Largest Contentful Paint) of 8.4s is terrible (should be &lt;2.5s)
- CLS (Cumulative Layout Shift) of 0.45 is poor (should be &lt;0.1)
- Images are the primary bottleneck</p>
<p><strong>Network Tab Analysis</strong>:
- Images are 90% of page weight
- Serving full-resolution images (3000x3000px) when only displaying 300x300px
- Using JPEG format (not optimized WebP/AVIF)
- No lazy loading (all images load immediately)</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the user experiences</strong>: Slow page load, janky layout shifts, wasted bandwidth.</p>
</li>
<li>
<p><strong>What Lighthouse reveals</strong>: Images are the performance killer. We're serving 10x more pixels than needed.</p>
</li>
<li>
<p><strong>What the Network tab shows</strong>: Each image is 1+ MB. On a 3G connection, that's 4+ seconds per image.</p>
</li>
<li>
<p><strong>Root cause identified</strong>: Using standard <code>&lt;img&gt;</code> tags (or unoptimized <code>&lt;Image&gt;</code> usage) without proper sizing, format optimization, or lazy loading.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>: Manual image optimization is tedious and error-prone. You'd need to create multiple sizes, convert formats, implement lazy loading‚Äîall by hand.</p>
</li>
<li>
<p><strong>What we need</strong>: Next.js <code>&lt;Image&gt;</code> component with proper configuration to automatically optimize images.</p>
</li>
</ol>
<h3 id="iteration-5-implementing-proper-image-optimization">Iteration 5: Implementing Proper Image Optimization</h3>
<p>Let's look at our current image usage:</p>
<p><strong>Before</strong> (unoptimized):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// components/ProductCard.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/image&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductCard</span><span class="p">({</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">        </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">        </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">        </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... rest of component */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Problem</strong>: We're using <code>next/image</code>, but not optimally:
- No <code>sizes</code> attribute (Next.js doesn't know how large the image will be)
- No <code>priority</code> for above-the-fold images
- No <code>quality</code> setting
- Images might be external URLs (not optimized by Next.js)</p>
<p><strong>After</strong> (optimized):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// components/ProductCard.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/image&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">product</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">priority?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// For above-the-fold images</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductCard</span><span class="p">({</span><span class="w"> </span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">        </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">        </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">        </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">sizes</span><span class="o">=</span><span class="s">&quot;(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw&quot;</span>
<span class="w">        </span><span class="na">priority</span><span class="o">=</span><span class="p">{</span><span class="nx">priority</span><span class="p">}</span>
<span class="w">        </span><span class="na">quality</span><span class="o">=</span><span class="p">{</span><span class="mf">75</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... rest of component */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Improvements</strong>:
1. <strong><code>sizes</code> attribute</strong>: Tells Next.js the image will be:
   - 100% viewport width on mobile (&lt;768px)
   - 50% viewport width on tablet (768-1200px)
   - 33% viewport width on desktop (&gt;1200px)
   - Next.js generates appropriately sized images for each breakpoint</p>
<ol>
<li>
<p><strong><code>priority</code> prop</strong>: First 3 images load immediately (above the fold), rest lazy load</p>
</li>
<li>
<p><strong><code>quality={75}</code></strong>: Reduces file size by 30-40% with minimal visual difference</p>
</li>
</ol>
<p>Now update the page to mark first images as priority:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductCard</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductCard&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-1 md:grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductCard</span>
<span class="w">            </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
<span class="w">            </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
<span class="w">            </span><span class="na">priority</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="na">First</span><span class="w"> </span><span class="na">3</span><span class="w"> </span><span class="na">images</span><span class="w"> </span><span class="na">load</span><span class="w"> </span><span class="na">immediately</span>
<span class="w">          </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="configuring-nextjs-image-optimization">Configuring Next.js Image Optimization</h3>
<p>If your images are hosted externally (e.g., on a CDN or cloud storage), you need to configure allowed domains:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// next.config.js</span>
<span class="cm">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">remotePatterns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">protocol</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hostname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your-cdn.com&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">port</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/images/**&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">protocol</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hostname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;storage.googleapis.com&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/your-bucket/**&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">formats</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;image/avif&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;image/webp&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">deviceSizes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">640</span><span class="p">,</span><span class="w"> </span><span class="mf">750</span><span class="p">,</span><span class="w"> </span><span class="mf">828</span><span class="p">,</span><span class="w"> </span><span class="mf">1080</span><span class="p">,</span><span class="w"> </span><span class="mf">1200</span><span class="p">,</span><span class="w"> </span><span class="mf">1920</span><span class="p">,</span><span class="w"> </span><span class="mf">2048</span><span class="p">,</span><span class="w"> </span><span class="mf">3840</span><span class="p">],</span>
<span class="w">    </span><span class="nx">imageSizes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">16</span><span class="p">,</span><span class="w"> </span><span class="mf">32</span><span class="p">,</span><span class="w"> </span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="mf">64</span><span class="p">,</span><span class="w"> </span><span class="mf">96</span><span class="p">,</span><span class="w"> </span><span class="mf">128</span><span class="p">,</span><span class="w"> </span><span class="mf">256</span><span class="p">,</span><span class="w"> </span><span class="mf">384</span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextConfig</span><span class="p">;</span>
</code></pre></div>

<p><strong>Configuration explained</strong>:
- <strong><code>remotePatterns</code></strong>: Whitelist external image domains (security feature)
- <strong><code>formats</code></strong>: Serve AVIF (best compression) with WebP fallback
- <strong><code>deviceSizes</code></strong>: Breakpoints for responsive images
- <strong><code>imageSizes</code></strong>: Sizes for smaller images (icons, thumbnails)</p>
<p>Deploy and test:</p>
<p><strong>Lighthouse Report (After Optimization)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Performance</span><span class="o">:</span><span class="w"> </span><span class="mi">89</span><span class="o">/</span><span class="mi">100</span><span class="w"> </span><span class="err">‚¨ÜÔ∏è</span><span class="w"> </span><span class="o">+</span><span class="mi">47</span><span class="w"> </span><span class="n">points</span>
<span class="o">-</span><span class="w"> </span><span class="n">First</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">:</span><span class="w"> </span><span class="mf">1.1</span><span class="n">s</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">2.1</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Largest</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">:</span><span class="w"> </span><span class="mf">1.8</span><span class="n">s</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">6.6</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Cumulative</span><span class="w"> </span><span class="n">Layout</span><span class="w"> </span><span class="n">Shift</span><span class="o">:</span><span class="w"> </span><span class="mf">0.02</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">0.43</span>
<span class="o">-</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Blocking</span><span class="w"> </span><span class="n">Time</span><span class="o">:</span><span class="w"> </span><span class="mi">120</span><span class="n">ms</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mi">770</span><span class="n">ms</span>

<span class="n">Opportunities</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="o">(</span><span class="n">No</span><span class="w"> </span><span class="n">major</span><span class="w"> </span><span class="n">opportunities</span><span class="w"> </span><span class="n">remaining</span><span class="o">)</span>
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Total</span><span class="w"> </span><span class="nv">resources</span>:<span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="nv">requests</span>
<span class="nv">Total</span><span class="w"> </span><span class="nv">size</span>:<span class="w"> </span><span class="mi">420</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span>‚¨áÔ∏è<span class="w"> </span><span class="o">-</span><span class="mi">3</span>.<span class="mi">78</span><span class="w"> </span><span class="nv">MB</span><span class="w"> </span><span class="ss">(</span><span class="mi">90</span><span class="o">%</span><span class="w"> </span><span class="nv">reduction</span><span class="ss">)</span>

<span class="nv">Images</span>:
<span class="nv">product</span><span class="o">-</span><span class="mi">1</span>.<span class="nv">webp</span>:<span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span><span class="ss">(</span><span class="mi">300</span><span class="nv">x300px</span>,<span class="w"> </span><span class="nv">AVIF</span><span class="w"> </span><span class="nv">format</span><span class="ss">)</span>
<span class="nv">product</span><span class="o">-</span><span class="mi">2</span>.<span class="nv">webp</span>:<span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span><span class="ss">(</span><span class="mi">300</span><span class="nv">x300px</span>,<span class="w"> </span><span class="nv">AVIF</span><span class="w"> </span><span class="nv">format</span><span class="ss">)</span>
<span class="nv">product</span><span class="o">-</span><span class="mi">3</span>.<span class="nv">webp</span>:<span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span><span class="ss">(</span><span class="mi">300</span><span class="nv">x300px</span>,<span class="w"> </span><span class="nv">AVIF</span><span class="w"> </span><span class="nv">format</span><span class="ss">)</span>

<span class="nv">Additional</span><span class="w"> </span><span class="nv">sizes</span><span class="w"> </span><span class="nv">generated</span>:
<span class="nv">product</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">640</span><span class="nv">w</span>.<span class="nv">webp</span>:<span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">mobile</span><span class="ss">)</span>
<span class="nv">product</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1080</span><span class="nv">w</span>.<span class="nv">webp</span>:<span class="w"> </span><span class="mi">65</span><span class="w"> </span><span class="nv">KB</span><span class="w"> </span><span class="ss">(</span><span class="k">for</span><span class="w"> </span><span class="nv">tablet</span><span class="ss">)</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Bundle size</strong>: 4.2 MB ‚Üí 420 KB (90% reduction)
- <strong>LCP</strong>: 8.4s ‚Üí 1.8s (79% faster)
- <strong>CLS</strong>: 0.45 ‚Üí 0.02 (96% improvement)
- <strong>User experience</strong>: Page loads instantly, no layout shifts</p>
<h3 id="the-failure-images-cause-cls-cumulative-layout-shift">The Failure: Images Cause CLS (Cumulative Layout Shift)</h3>
<p>Even with optimized images, you might still see layout shifts if you don't reserve space:</p>
<p><strong>Browser Behavior</strong>:
- Page loads
- Text and layout appear
- Images pop in, pushing content down
- User tries to click a button, but it moves as image loads</p>
<p><strong>Lighthouse Evidence</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Cumulative</span><span class="w"> </span><span class="n">Layout</span><span class="w"> </span><span class="n">Shift</span><span class="p">:</span><span class="w"> </span><span class="mf">0.28</span>
<span class="o">-</span><span class="w"> </span><span class="n">Largest</span><span class="w"> </span><span class="n">shift</span><span class="p">:</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="p">(</span><span class="n">caused</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">loading</span><span class="p">)</span>
</code></pre></div>

<p><strong>React DevTools - Profiler</strong>:
- Component re-renders when image loads
- Layout recalculation triggered</p>
<h3 id="diagnostic-analysis-reading-the-layout-shift">Diagnostic Analysis: Reading the Layout Shift</h3>
<p><strong>What the user experiences</strong>: Content jumps around as images load. Frustrating, especially when trying to interact with the page.</p>
<p><strong>What Lighthouse reveals</strong>: CLS score above 0.1 is poor. Images without reserved space cause layout shifts.</p>
<p><strong>Root cause identified</strong>: Not providing explicit dimensions or aspect ratio for images.</p>
<p><strong>Solution</strong>: Always provide <code>width</code> and <code>height</code> props to <code>&lt;Image&gt;</code>, or use aspect ratio CSS.</p>
<p><strong>Before</strong> (causes CLS):</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">  </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">  </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">  </span><span class="na">fill</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">‚ùå</span><span class="w"> </span><span class="na">No</span><span class="w"> </span><span class="na">dimensions</span><span class="err">,</span><span class="w"> </span><span class="na">causes</span><span class="w"> </span><span class="na">layout</span><span class="w"> </span><span class="na">shift</span>
<span class="w">  </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;object-cover rounded&quot;</span>
<span class="p">/&gt;</span>
</code></pre></div>

<p><strong>After</strong> (prevents CLS):</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">  </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">  </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">  </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">  </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">‚úÖ</span><span class="w"> </span><span class="na">Explicit</span><span class="w"> </span><span class="na">dimensions</span><span class="w"> </span><span class="na">reserve</span><span class="w"> </span><span class="na">space</span>
<span class="w">  </span><span class="na">sizes</span><span class="o">=</span><span class="s">&quot;(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw&quot;</span>
<span class="w">  </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span>
<span class="p">/&gt;</span>
</code></pre></div>

<p><strong>Or use aspect ratio</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;relative aspect-square&quot;</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">    </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">    </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">    </span><span class="na">fill</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">‚úÖ</span><span class="w"> </span><span class="na">OK</span><span class="w"> </span><span class="na">when</span><span class="w"> </span><span class="na">parent</span><span class="w"> </span><span class="na">has</span><span class="w"> </span><span class="na">aspect</span><span class="w"> </span><span class="na">ratio</span>
<span class="w">    </span><span class="na">sizes</span><span class="o">=</span><span class="s">&quot;(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw&quot;</span>
<span class="w">    </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;object-cover rounded&quot;</span>
<span class="w">  </span><span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="when-to-apply-image-optimization">When to Apply Image Optimization</h3>
<p><strong>What it optimizes for</strong>:
- Page load speed (smaller file sizes)
- Core Web Vitals (LCP, CLS)
- Bandwidth savings (especially mobile)
- Automatic format selection (AVIF/WebP)</p>
<p><strong>What it sacrifices</strong>:
- Build time (image optimization during build)
- Server resources (on-demand optimization for dynamic images)
- Complexity (configuration required for external images)</p>
<p><strong>When to choose this approach</strong>:
- Always, for any Next.js application with images
- Especially for image-heavy sites (e-commerce, portfolios, blogs)
- When Core Web Vitals matter (SEO, user experience)</p>
<p><strong>When to avoid this approach</strong>:
- Never. There's no good reason to skip image optimization in Next.js.
- If you must use external image CDN with its own optimization, you can disable Next.js optimization:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// next.config.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">unoptimized</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="c1">// Disable Next.js image optimization</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Limitation preview</strong>: Images are optimized, but we still haven't analyzed our JavaScript bundle size. Next, we'll use bundle analysis to identify bloat.</p>
<h2 id="bundle-analysis-and-core-web-vitals">Bundle analysis and Core Web Vitals</h2>
<h2 id="phase-4-bundle-analysis-finding-the-javascript-bloat">Phase 4: Bundle Analysis - Finding the JavaScript Bloat</h2>
<p>Images are optimized, but let's check our JavaScript bundle size:</p>
<p><strong>Build Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
‚îå<span class="w"> </span>‚óã<span class="w"> </span>/<span class="w">                                    </span><span class="m">142</span><span class="w"> </span>B<span class="w">          </span><span class="m">287</span><span class="w"> </span>kB
‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products<span class="w">                            </span><span class="m">12</span><span class="w"> </span>kB<span class="w">          </span><span class="m">299</span><span class="w"> </span>kB
‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products/<span class="o">[</span>id<span class="o">]</span><span class="w">                       </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">295</span><span class="w"> </span>kB
‚îî<span class="w"> </span>‚óã<span class="w"> </span>/cart<span class="w">                                </span><span class="m">45</span><span class="w"> </span>kB<span class="w">          </span><span class="m">332</span><span class="w"> </span>kB

‚óã<span class="w">  </span><span class="o">(</span>Static<span class="o">)</span><span class="w">  </span>prerendered<span class="w"> </span>as<span class="w"> </span>static<span class="w"> </span>content

First<span class="w"> </span>Load<span class="w"> </span>JS<span class="w"> </span>shared<span class="w"> </span>by<span class="w"> </span>all<span class="w">              </span><span class="m">287</span><span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/framework-abc123.js<span class="w">           </span><span class="m">45</span><span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/main-def456.js<span class="w">                </span><span class="m">32</span><span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/page-ghi789.js<span class="w">                </span><span class="m">210</span><span class="w"> </span>kB<span class="w">  </span>‚ö†Ô∏è<span class="w"> </span>Large!
<span class="w">  </span>‚îî<span class="w"> </span>other<span class="w"> </span>shared<span class="w"> </span>chunks<span class="w"> </span><span class="o">(</span>total<span class="o">)</span><span class="w">          </span><span class="m">0</span><span class="w"> </span>B
</code></pre></div>

<h3 id="diagnostic-analysis-reading-the-bundle-size-warning">Diagnostic Analysis: Reading the Bundle Size Warning</h3>
<p><strong>Build Output Evidence</strong>:
- First Load JS: 287 kB (should be &lt;100 kB for good performance)
- <code>page-ghi789.js</code>: 210 kB (73% of total bundle)
- Cart page: 332 kB total (45 kB page-specific + 287 kB shared)</p>
<p><strong>What This Means</strong>:
- Every page loads 287 kB of JavaScript before it can become interactive
- The shared bundle is bloated‚Äîsomething large is being included on every page
- Cart page is especially heavy (332 kB total)</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the user experiences</strong>: Slow Time to Interactive (TTI). Page looks loaded but buttons don't work yet.</p>
</li>
<li>
<p><strong>What the build output reveals</strong>: Shared bundle is too large. Something is being included globally that shouldn't be.</p>
</li>
<li>
<p><strong>Root cause identified</strong>: Likely a large library imported in a layout or root component, forcing it into the shared bundle.</p>
</li>
<li>
<p><strong>What we need</strong>: Bundle analysis to identify the culprit, then code splitting to load it only where needed.</p>
</li>
</ol>
<h3 id="iteration-6-installing-bundle-analyzer">Iteration 6: Installing Bundle Analyzer</h3>
<p>Install the Next.js bundle analyzer:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>@next/bundle-analyzer
</code></pre></div>

<p>Configure it:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// next.config.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">withBundleAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@next/bundle-analyzer&#39;</span><span class="p">)({</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ANALYZE</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="p">});</span>

<span class="cm">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">remotePatterns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">protocol</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hostname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your-cdn.com&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/images/**&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">formats</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;image/avif&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;image/webp&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">withBundleAnalyzer</span><span class="p">(</span><span class="nx">nextConfig</span><span class="p">);</span>
</code></pre></div>

<p>Run the analyzer:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">ANALYZE</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<p>This opens an interactive visualization in your browser showing your bundle composition:</p>
<p><strong>Bundle Analyzer Output</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Client</span><span class="w"> </span><span class="nv">Bundle</span><span class="w"> </span><span class="nv">Analysis</span>:

<span class="nv">Total</span>:<span class="w"> </span><span class="mi">287</span><span class="w"> </span><span class="nv">kB</span>

<span class="nv">Breakdown</span>:
<span class="o">-</span><span class="w"> </span><span class="nv">react</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">react</span><span class="o">-</span><span class="nv">dom</span>:<span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">16</span><span class="o">%</span><span class="ss">)</span>
<span class="o">-</span><span class="w"> </span><span class="k">next</span><span class="o">/</span><span class="nv">dist</span><span class="o">/</span><span class="nv">client</span>:<span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">11</span><span class="o">%</span><span class="ss">)</span>
<span class="o">-</span><span class="w"> </span><span class="nv">date</span><span class="o">-</span><span class="nv">fns</span>:<span class="w"> </span><span class="mi">78</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">27</span><span class="o">%</span><span class="ss">)</span><span class="w"> </span>‚ö†Ô∏è<span class="w"> </span><span class="nv">Large</span><span class="o">!</span>
<span class="o">-</span><span class="w"> </span><span class="nv">lodash</span>:<span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">25</span><span class="o">%</span><span class="ss">)</span><span class="w"> </span>‚ö†Ô∏è<span class="w"> </span><span class="nv">Large</span><span class="o">!</span>
<span class="o">-</span><span class="w"> </span><span class="nv">framer</span><span class="o">-</span><span class="nv">motion</span>:<span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">16</span><span class="o">%</span><span class="ss">)</span>
<span class="o">-</span><span class="w"> </span><span class="nv">other</span>:<span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nv">kB</span><span class="w"> </span><span class="ss">(</span><span class="mi">5</span><span class="o">%</span><span class="ss">)</span>
</code></pre></div>

<h3 id="diagnostic-analysis-identifying-bundle-bloat">Diagnostic Analysis: Identifying Bundle Bloat</h3>
<p><strong>Bundle Analyzer Evidence</strong>:
- <code>date-fns</code>: 78 kB (entire library imported)
- <code>lodash</code>: 72 kB (entire library imported)
- Together: 150 kB (52% of bundle)</p>
<p><strong>Investigation</strong>: Where are these imported?</p>
<p>Search your codebase:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Find date-fns imports</span>
grep<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;from &#39;date-fns&#39;&quot;</span><span class="w"> </span>app/

<span class="c1"># Output:</span>
<span class="c1"># app/layout.tsx:import { format } from &#39;date-fns&#39;;</span>
<span class="c1"># app/products/[id]/page.tsx:import { formatDistance } from &#39;date-fns&#39;;</span>
</code></pre></div>

<p><strong>Root cause identified</strong>: 
1. <code>date-fns</code> imported in <code>layout.tsx</code> (root layout) ‚Üí included in shared bundle
2. Only using 2 functions (<code>format</code>, <code>formatDistance</code>) but importing entire library
3. Same issue with <code>lodash</code></p>
<p><strong>Solution</strong>: Use tree-shakeable imports and move imports to page level.</p>
<h3 id="iteration-7-optimizing-imports">Iteration 7: Optimizing Imports</h3>
<p><strong>Before</strong> (imports entire library):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;date-fns&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// ‚ùå Imports entire date-fns library</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentYear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">format</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;yyyy&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">footer</span><span class="p">&gt;</span><span class="err">¬©</span><span class="w"> </span><span class="p">{</span><span class="nx">currentYear</span><span class="p">}</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">Catalog</span><span class="p">&lt;/</span><span class="nt">footer</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong> (tree-shakeable import):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/layout.tsx</span>
<span class="c1">// ‚úÖ Import only what you need</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">format</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;date-fns/format&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentYear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">format</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;yyyy&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">footer</span><span class="p">&gt;</span><span class="err">¬©</span><span class="w"> </span><span class="p">{</span><span class="nx">currentYear</span><span class="p">}</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">Catalog</span><span class="p">&lt;/</span><span class="nt">footer</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Even better</strong> (avoid library for simple cases):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/layout.tsx</span>
<span class="c1">// ‚úÖ No library needed for simple date formatting</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentYear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">footer</span><span class="p">&gt;</span><span class="err">¬©</span><span class="w"> </span><span class="p">{</span><span class="nx">currentYear</span><span class="p">}</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="nx">Catalog</span><span class="p">&lt;/</span><span class="nt">footer</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Fix lodash imports</strong>:</p>
<p><strong>Before</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/utils.ts</span>
<span class="k">import</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;lodash&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// ‚ùå Imports entire lodash library (72 kB)</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">groupProductsByCategory</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;category&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">uniqueCategories</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">category</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/utils.ts</span>
<span class="c1">// ‚úÖ Import only specific functions</span>
<span class="k">import</span><span class="w"> </span><span class="nx">groupBy</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;lodash/groupBy&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">uniq</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;lodash/uniq&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">groupProductsByCategory</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">groupBy</span><span class="p">(</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;category&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">uniqueCategories</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">uniq</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">category</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Or use native JavaScript</strong> (best):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/utils.ts</span>
<span class="c1">// ‚úÖ No library needed - use native JavaScript</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">groupProductsByCategory</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">products</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">product</span><span class="p">.</span><span class="nx">category</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">acc</span><span class="p">[</span><span class="nx">category</span><span class="p">])</span><span class="w"> </span><span class="nx">acc</span><span class="p">[</span><span class="nx">category</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="nx">acc</span><span class="p">[</span><span class="nx">category</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">product</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">acc</span><span class="p">;</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">uniqueCategories</span><span class="p">(</span><span class="nx">products</span><span class="o">:</span><span class="w"> </span><span class="kt">Product</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[...</span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">category</span><span class="p">))];</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="moving-heavy-imports-to-client-components">Moving Heavy Imports to Client Components</h3>
<p>If you must use a large library, load it only in Client Components where needed:</p>
<p><strong>Before</strong> (in Server Component):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/[id]/page.tsx - Server Component</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">formatDistance</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;date-fns&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">params.id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Added</span><span class="w"> </span><span class="p">{</span><span class="nx">formatDistance</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addSuffix</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">})}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong> (in Client Component):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/[id]/page.tsx - Server Component</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">params.id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductTimestamp</span><span class="w"> </span><span class="na">createdAt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// components/ProductTimestamp.tsx - Client Component</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">formatDistance</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;date-fns/formatDistance&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductTimestamp</span><span class="p">({</span><span class="w"> </span><span class="nx">createdAt</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="nx">Added</span><span class="w"> </span><span class="p">{</span><span class="nx">formatDistance</span><span class="p">(</span><span class="nx">createdAt</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addSuffix</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">})}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Improvement</strong>: <code>date-fns</code> is now only loaded on pages that use <code>ProductTimestamp</code>, not in the shared bundle.</p>
<h3 id="dynamic-imports-for-heavy-components">Dynamic Imports for Heavy Components</h3>
<p>For very large components or libraries, use dynamic imports:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/[id]/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">dynamic</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/dynamic&#39;</span><span class="p">;</span>

<span class="c1">// Dynamically import heavy component</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">ProductReviews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dynamic</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">import</span><span class="p">(</span><span class="s1">&#39;@/components/ProductReviews&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">loading</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">reviews</span><span class="p">...&lt;/</span><span class="nt">p</span><span class="p">&gt;,</span>
<span class="w">  </span><span class="nx">ssr</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// Don&#39;t render on server (if not needed for SEO)</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">product</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">params.id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Reviews component loads separately */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">ProductReviews</span><span class="w"> </span><span class="na">productId</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>: <code>ProductReviews</code> and its dependencies load in a separate chunk, only when this page is visited.</p>
<h3 id="rebuild-and-analyze">Rebuild and Analyze</h3>
<p>After optimizations:</p>
<div class="codehilite"><pre><span></span><code><span class="nv">ANALYZE</span><span class="o">=</span><span class="nb">true</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build
</code></pre></div>

<p><strong>Build Output (After Optimization)</strong>:</p>
<div class="codehilite"><pre><span></span><code>Route<span class="w"> </span><span class="o">(</span>app<span class="o">)</span><span class="w">                              </span>Size<span class="w">     </span>First<span class="w"> </span>Load<span class="w"> </span>JS
‚îå<span class="w"> </span>‚óã<span class="w"> </span>/<span class="w">                                    </span><span class="m">142</span><span class="w"> </span>B<span class="w">          </span><span class="m">87</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB
‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products<span class="w">                            </span><span class="m">12</span><span class="w"> </span>kB<span class="w">          </span><span class="m">99</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB
‚îú<span class="w"> </span>‚óã<span class="w"> </span>/products/<span class="o">[</span>id<span class="o">]</span><span class="w">                       </span><span class="m">8</span>.4<span class="w"> </span>kB<span class="w">         </span><span class="m">95</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB
‚îî<span class="w"> </span>‚óã<span class="w"> </span>/cart<span class="w">                                </span><span class="m">45</span><span class="w"> </span>kB<span class="w">          </span><span class="m">132</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB

First<span class="w"> </span>Load<span class="w"> </span>JS<span class="w"> </span>shared<span class="w"> </span>by<span class="w"> </span>all<span class="w">              </span><span class="m">87</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/framework-abc123.js<span class="w">           </span><span class="m">45</span><span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/main-def456.js<span class="w">                </span><span class="m">32</span><span class="w"> </span>kB
<span class="w">  </span>‚îú<span class="w"> </span>chunks/page-ghi789.js<span class="w">                </span><span class="m">10</span><span class="w"> </span>kB<span class="w"> </span>‚¨áÔ∏è<span class="w"> </span>-200<span class="w"> </span>kB
<span class="w">  </span>‚îî<span class="w"> </span>other<span class="w"> </span>shared<span class="w"> </span>chunks<span class="w"> </span><span class="o">(</span>total<span class="o">)</span><span class="w">          </span><span class="m">0</span><span class="w"> </span>B
</code></pre></div>

<p><strong>Bundle Analyzer Output (After)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Total</span><span class="o">:</span><span class="w"> </span><span class="mi">87</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mi">200</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">(</span><span class="mi">70</span><span class="o">%</span><span class="w"> </span><span class="n">reduction</span><span class="o">)</span>

<span class="n">Breakdown</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">react</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">react</span><span class="o">-</span><span class="n">dom</span><span class="o">:</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">(</span><span class="mi">52</span><span class="o">%)</span>
<span class="o">-</span><span class="w"> </span><span class="n">next</span><span class="sr">/dist/</span><span class="n">client</span><span class="o">:</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">(</span><span class="mi">37</span><span class="o">%)</span>
<span class="o">-</span><span class="w"> </span><span class="n">other</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">(</span><span class="mi">11</span><span class="o">%)</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Shared bundle</strong>: 287 kB ‚Üí 87 kB (70% reduction)
- <strong>First Load JS</strong>: 287 kB ‚Üí 87 kB (all pages improved)
- <strong>Time to Interactive</strong>: 2.8s ‚Üí 1.2s (57% faster)</p>
<h3 id="core-web-vitals-the-complete-picture">Core Web Vitals: The Complete Picture</h3>
<p>Now let's measure the full impact on Core Web Vitals:</p>
<p><strong>Lighthouse Report (Final)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Performance</span><span class="o">:</span><span class="w"> </span><span class="mi">96</span><span class="o">/</span><span class="mi">100</span><span class="w"> </span><span class="err">‚¨ÜÔ∏è</span><span class="w"> </span><span class="o">+</span><span class="mi">7</span><span class="w"> </span><span class="n">points</span>

<span class="n">Core</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">Vitals</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">LCP</span><span class="w"> </span><span class="o">(</span><span class="n">Largest</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">):</span><span class="w"> </span><span class="mf">1.2</span><span class="n">s</span><span class="w"> </span><span class="err">‚úÖ</span><span class="w"> </span><span class="o">(</span><span class="n">Good</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">2.5</span><span class="n">s</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">FID</span><span class="w"> </span><span class="o">(</span><span class="n">First</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">Delay</span><span class="o">):</span><span class="w"> </span><span class="mi">45</span><span class="n">ms</span><span class="w"> </span><span class="err">‚úÖ</span><span class="w"> </span><span class="o">(</span><span class="n">Good</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">100</span><span class="n">ms</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">CLS</span><span class="w"> </span><span class="o">(</span><span class="n">Cumulative</span><span class="w"> </span><span class="n">Layout</span><span class="w"> </span><span class="n">Shift</span><span class="o">):</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="err">‚úÖ</span><span class="w"> </span><span class="o">(</span><span class="n">Good</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.1</span><span class="o">)</span>

<span class="n">Additional</span><span class="w"> </span><span class="n">Metrics</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">First</span><span class="w"> </span><span class="n">Contentful</span><span class="w"> </span><span class="n">Paint</span><span class="o">:</span><span class="w"> </span><span class="mf">0.8</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Interactive</span><span class="o">:</span><span class="w"> </span><span class="mf">1.2</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Speed</span><span class="w"> </span><span class="n">Index</span><span class="o">:</span><span class="w"> </span><span class="mf">1.4</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">Blocking</span><span class="w"> </span><span class="n">Time</span><span class="o">:</span><span class="w"> </span><span class="mi">80</span><span class="n">ms</span>

<span class="n">Passed</span><span class="w"> </span><span class="n">Audits</span><span class="o">:</span>
<span class="err">‚úÖ</span><span class="w"> </span><span class="n">Properly</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">images</span>
<span class="err">‚úÖ</span><span class="w"> </span><span class="n">Serve</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">next</span><span class="o">-</span><span class="n">gen</span><span class="w"> </span><span class="n">formats</span>
<span class="err">‚úÖ</span><span class="w"> </span><span class="n">Eliminate</span><span class="w"> </span><span class="n">render</span><span class="o">-</span><span class="n">blocking</span><span class="w"> </span><span class="n">resources</span>
<span class="err">‚úÖ</span><span class="w"> </span><span class="n">Minimize</span><span class="w"> </span><span class="n">main</span><span class="o">-</span><span class="n">thread</span><span class="w"> </span><span class="n">work</span>
<span class="err">‚úÖ</span><span class="w"> </span><span class="n">Reduce</span><span class="w"> </span><span class="n">JavaScript</span><span class="w"> </span><span class="n">execution</span><span class="w"> </span><span class="n">time</span>
</code></pre></div>

<p><strong>Real User Monitoring (RUM) Data</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="mf">75</span><span class="n">th</span><span class="w"> </span><span class="n">Percentile</span><span class="w"> </span><span class="p">(</span><span class="n">Real</span><span class="w"> </span><span class="n">Users</span><span class="p">):</span>
<span class="o">-</span><span class="w"> </span><span class="n">LCP</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="kr">Go</span><span class="n">od</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">FID</span><span class="p">:</span><span class="w"> </span><span class="mf">65</span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="kr">Go</span><span class="n">od</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">CLS</span><span class="p">:</span><span class="w"> </span><span class="mf">0.03</span><span class="w"> </span><span class="p">(</span><span class="kr">Go</span><span class="n">od</span><span class="p">)</span>

<span class="n">Device</span><span class="w"> </span><span class="n">Breakdown</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">Desktop</span><span class="p">:</span><span class="w"> </span><span class="n">LCP</span><span class="w"> </span><span class="mf">1.2</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">FID</span><span class="w"> </span><span class="mf">35</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">CLS</span><span class="w"> </span><span class="mf">0.02</span>
<span class="o">-</span><span class="w"> </span><span class="n">Mobile</span><span class="w"> </span><span class="p">(</span><span class="mf">4</span><span class="n">G</span><span class="p">):</span><span class="w"> </span><span class="n">LCP</span><span class="w"> </span><span class="mf">2.1</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">FID</span><span class="w"> </span><span class="mf">85</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">CLS</span><span class="w"> </span><span class="mf">0.04</span>
<span class="o">-</span><span class="w"> </span><span class="n">Mobile</span><span class="w"> </span><span class="p">(</span><span class="mf">3</span><span class="n">G</span><span class="p">):</span><span class="w"> </span><span class="n">LCP</span><span class="w"> </span><span class="mf">3.8</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">FID</span><span class="w"> </span><span class="mf">120</span><span class="n">ms</span><span class="p">,</span><span class="w"> </span><span class="n">CLS</span><span class="w"> </span><span class="mf">0.05</span>
</code></pre></div>

<h3 id="when-to-apply-bundle-optimization">When to Apply Bundle Optimization</h3>
<p><strong>What it optimizes for</strong>:
- Time to Interactive (TTI)
- First Input Delay (FID)
- JavaScript execution time
- Mobile performance</p>
<p><strong>What it sacrifices</strong>:
- Development time (analyzing and optimizing)
- Code organization (sometimes need to split components)
- Convenience (can't just <code>import _ from 'lodash'</code>)</p>
<p><strong>When to choose this approach</strong>:
- When First Load JS exceeds 100 kB
- When Lighthouse shows "Reduce JavaScript execution time"
- When Time to Interactive is &gt;3 seconds
- Before launching to production</p>
<p><strong>When to avoid this approach</strong>:
- During early development (premature optimization)
- When bundle size is already &lt;100 kB
- When the library is truly needed everywhere (e.g., React itself)</p>
<p><strong>Code characteristics</strong>:
- Setup: Medium (install analyzer, configure)
- Maintenance: Low (once optimized, stays optimized)
- Performance impact: High (70% bundle reduction in our case)</p>
<p><strong>Limitation preview</strong>: Bundle is optimized, but we haven't discussed runtime choice. Next, we'll explore Edge vs. Node.js runtime.</p>
<h2 id="edge-runtime-vs-nodejs-runtime">Edge runtime vs. Node.js runtime</h2>
<h2 id="phase-5-runtime-choice-edge-vs-nodejs">Phase 5: Runtime Choice - Edge vs. Node.js</h2>
<p>Next.js supports two runtime environments:
1. <strong>Node.js runtime</strong> (default): Full Node.js API, runs on Vercel's regional servers
2. <strong>Edge runtime</strong>: Lightweight, runs on Vercel's global edge network</p>
<p>Let's understand when to use each.</p>
<h3 id="the-default-nodejs-runtime">The Default: Node.js Runtime</h3>
<p>Our application currently uses Node.js runtime (the default). Let's see what that means:</p>
<p><strong>Current Deployment Architecture</strong>:</p>
<div class="codehilite"><pre><span></span><code>User Request (Tokyo)
    ‚Üì
Vercel Edge Network (Tokyo) - CDN only
    ‚Üì
Vercel Regional Server (US East) - Node.js runtime
    ‚Üì (200ms latency)
Database (US East)
    ‚Üì
Response travels back to Tokyo (200ms)
    ‚Üì
Total: ~400ms + processing time
</code></pre></div>

<p><strong>Vercel Function Logs (Node.js Runtime)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="n">products</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nl">Region</span><span class="p">:</span><span class="w"> </span><span class="n">iad1</span><span class="w"> </span><span class="p">(</span><span class="n">US</span><span class="w"> </span><span class="n">East</span><span class="p">)</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Cold</span><span class="w"> </span><span class="k">start</span><span class="err">:</span><span class="w"> </span><span class="mi">450</span><span class="n">ms</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="nl">query</span><span class="p">:</span><span class="w"> </span><span class="mi">120</span><span class="n">ms</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">570</span><span class="n">ms</span>
</code></pre></div>

<p><strong>User in Tokyo</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Request</span><span class="w"> </span><span class="n">timing</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">DNS</span><span class="w"> </span><span class="n">lookup</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="n">ms</span>
<span class="o">-</span><span class="w"> </span><span class="n">Connection</span><span class="p">:</span><span class="w"> </span><span class="mi">180</span><span class="n">ms</span>
<span class="o">-</span><span class="w"> </span><span class="n">Waiting</span><span class="w"> </span><span class="p">(</span><span class="n">TTFB</span><span class="p">):</span><span class="w"> </span><span class="mi">570</span><span class="n">ms</span><span class="w"> </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">processing</span>
<span class="o">-</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="n">download</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="n">ms</span>
<span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">820</span><span class="n">ms</span>
</code></pre></div>

<h3 id="the-alternative-edge-runtime">The Alternative: Edge Runtime</h3>
<p>Edge runtime runs your code on Vercel's global edge network‚Äîcloser to users. But it has limitations.</p>
<h3 id="iteration-8-converting-to-edge-runtime">Iteration 8: Converting to Edge Runtime</h3>
<p>Let's try converting our product listing page to Edge runtime:</p>
<p><strong>Before</strong> (Node.js runtime):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-1 md:grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductCard</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong> (attempting Edge runtime):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;edge&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// ‚Üê Enable Edge runtime</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-1 md:grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductCard</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Deploy and observe:</p>
<p><strong>Terminal Output (Build Failure)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="m">12</span>:34:56.789<span class="o">]</span><span class="w"> </span>Running<span class="w"> </span>build...
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>Error:<span class="w"> </span>The<span class="w"> </span>Edge<span class="w"> </span>Runtime<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>support<span class="w"> </span>Node.js<span class="w"> </span><span class="s1">&#39;crypto&#39;</span><span class="w"> </span>module.
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>Import<span class="w"> </span>trace<span class="w"> </span><span class="k">for</span><span class="w"> </span>requested<span class="w"> </span>module:
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>./node_modules/@prisma/client/runtime/library.js
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>./node_modules/@prisma/client/default.js
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>./lib/db.ts
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>./app/products/page.tsx
<span class="o">[</span><span class="m">12</span>:34:58.123<span class="o">]</span><span class="w"> </span>
<span class="o">[</span><span class="m">12</span>:34:58.456<span class="o">]</span><span class="w"> </span>BUILD<span class="w"> </span>FAILED
</code></pre></div>

<h3 id="diagnostic-analysis-edge-runtime-limitations">Diagnostic Analysis: Edge Runtime Limitations</h3>
<p><strong>Build Failure Evidence</strong>:
- Error: "The Edge Runtime does not support Node.js 'crypto' module"
- Import trace shows Prisma Client uses Node.js APIs
- Build fails before deployment</p>
<p><strong>What Happened</strong>:
Edge runtime is a lightweight JavaScript runtime (based on V8, like browsers). It doesn't include full Node.js APIs. Prisma Client uses Node.js-specific modules (<code>crypto</code>, <code>fs</code>, <code>net</code>) that aren't available in Edge runtime.</p>
<p><strong>Root cause identified</strong>: Not all libraries work in Edge runtime. Prisma, most ORMs, and many Node.js libraries require the full Node.js runtime.</p>
<p><strong>What works in Edge runtime</strong>:
- Fetch API
- Web Crypto API
- Lightweight libraries (no Node.js dependencies)
- Simple data transformations</p>
<p><strong>What doesn't work in Edge runtime</strong>:
- Prisma (uses Node.js crypto, fs)
- Most database drivers (use Node.js net)
- File system operations
- Node.js built-in modules</p>
<h3 id="when-to-use-edge-runtime">When to Use Edge Runtime</h3>
<p>Edge runtime is best for:
1. <strong>API routes that don't need database access</strong>
2. <strong>Middleware</strong> (authentication checks, redirects)
3. <strong>Static content with dynamic headers</strong>
4. <strong>Geolocation-based responses</strong></p>
<p>Let's see a valid use case:</p>
<h3 id="iteration-9-edge-runtime-for-geolocation-api">Iteration 9: Edge Runtime for Geolocation API</h3>
<p>Create a geolocation API route that benefits from Edge runtime:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/geo/route.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;edge&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// ‚úÖ Perfect for Edge runtime</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Access geolocation from request headers (provided by Vercel Edge)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-vercel-ip-country&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-vercel-ip-city&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-vercel-ip-country-region&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">Response</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">country</span><span class="p">,</span>
<span class="w">    </span><span class="nx">city</span><span class="p">,</span>
<span class="w">    </span><span class="nx">region</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Hello from </span><span class="si">${</span><span class="nx">city</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">country</span><span class="si">}</span><span class="sb">!`</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Deployment Architecture (Edge Runtime)</strong>:</p>
<div class="codehilite"><pre><span></span><code>User Request (Tokyo)
    ‚Üì
Vercel Edge Network (Tokyo) - Edge runtime executes here
    ‚Üì (5ms latency)
Response immediately
    ‚Üì
Total: ~5ms + processing time
</code></pre></div>

<p><strong>Vercel Function Logs (Edge Runtime)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">GET</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">geo</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nl">Region</span><span class="p">:</span><span class="w"> </span><span class="n">nrt1</span><span class="w"> </span><span class="p">(</span><span class="n">Tokyo</span><span class="p">)</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Cold</span><span class="w"> </span><span class="k">start</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">Edge</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="n">warm</span><span class="p">)</span>
<span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="nl">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="n">ms</span>
</code></pre></div>

<p><strong>User in Tokyo</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Request</span><span class="w"> </span><span class="n">timing</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="n">DNS</span><span class="w"> </span><span class="n">lookup</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="n">ms</span>
<span class="o">-</span><span class="w"> </span><span class="n">Connection</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="n">ms</span>
<span class="o">-</span><span class="w"> </span><span class="n">Waiting</span><span class="w"> </span><span class="p">(</span><span class="n">TTFB</span><span class="p">):</span><span class="w"> </span><span class="mi">5</span><span class="n">ms</span><span class="w"> </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Edge</span><span class="w"> </span><span class="n">runtime</span>
<span class="o">-</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="n">download</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="n">ms</span>
<span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">vs</span><span class="o">.</span><span class="w"> </span><span class="mi">820</span><span class="n">ms</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">Node</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="n">runtime</span><span class="p">)</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- <strong>Latency</strong>: 820ms ‚Üí 35ms (96% reduction)
- <strong>Cold start</strong>: 450ms ‚Üí 0ms (Edge is always warm)
- <strong>Global performance</strong>: Consistent low latency worldwide</p>
<h3 id="edge-runtime-for-middleware">Edge Runtime for Middleware</h3>
<p>Middleware is the perfect use case for Edge runtime:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="c1">// Middleware automatically runs on Edge runtime</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">middleware</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Check authentication</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;auth-token&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Redirect to login</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Add custom headers</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;x-custom-header&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;value&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/dashboard/:path*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/api/:path*&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Why Edge runtime is perfect for middleware</strong>:
- Runs before every request (needs to be fast)
- No database access needed (just checking cookies/headers)
- Benefits from global distribution
- Minimal cold start time</p>
<h3 id="hybrid-approach-edge-nodejs">Hybrid Approach: Edge + Node.js</h3>
<p>The best architecture uses both runtimes strategically:</p>
<p><strong>Optimal Architecture</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="err">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="n">Edge</span><span class="w"> </span><span class="n">Runtime</span><span class="w"> </span><span class="p">(</span><span class="n">Global</span><span class="p">)</span><span class="w">                                       </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Middleware</span><span class="w"> </span><span class="p">(</span><span class="n">auth</span><span class="w"> </span><span class="n">checks</span><span class="p">,</span><span class="w"> </span><span class="n">redirects</span><span class="p">)</span><span class="w">                       </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Geolocation</span><span class="w"> </span><span class="n">API</span><span class="w">                                           </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Static</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">dynamic</span><span class="w"> </span><span class="n">headers</span><span class="w">                       </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">A</span><span class="o">/</span><span class="n">B</span><span class="w"> </span><span class="n">testing</span><span class="w"> </span><span class="n">logic</span><span class="w">                                         </span><span class="err">‚îÇ</span>
<span class="err">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
<span class="w">                            </span><span class="err">‚Üì</span>
<span class="err">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="n">Node</span><span class="o">.</span><span class="n">js</span><span class="w"> </span><span class="n">Runtime</span><span class="w"> </span><span class="p">(</span><span class="n">Regional</span><span class="p">)</span><span class="w">                                  </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">queries</span><span class="w"> </span><span class="p">(</span><span class="n">Prisma</span><span class="p">)</span><span class="w">                                 </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Complex</span><span class="w"> </span><span class="n">business</span><span class="w"> </span><span class="n">logic</span><span class="w">                                    </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">uploads</span><span class="w">                                              </span><span class="err">‚îÇ</span>
<span class="err">‚îÇ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Third</span><span class="o">-</span><span class="n">party</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">calls</span><span class="w">                                     </span><span class="err">‚îÇ</span>
<span class="err">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span>
</code></pre></div>

<h3 id="example-hybrid-product-listing">Example: Hybrid Product Listing</h3>
<p>Keep database queries in Node.js runtime, but add Edge middleware for caching:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts (Edge runtime)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">middleware</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Check if we have cached products</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cached</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;products-cache&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cached</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Return cached response immediately from Edge</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">(</span><span class="nx">cached</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;X-Cache&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;HIT&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// No cache, continue to Node.js runtime</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/products&#39;</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/products/route.ts (Node.js runtime - default)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Set cache cookie for Edge middleware</span>
<span class="w">  </span><span class="nx">response</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;products-cache&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">products</span><span class="p">),</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">maxAge</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1 minute cache</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Result</strong>:
- First request: Edge ‚Üí Node.js ‚Üí Database (570ms)
- Subsequent requests (within 1 minute): Edge only (5ms)
- 99% of requests served from Edge with 5ms latency</p>
<h3 id="when-to-apply-edge-runtime">When to Apply Edge Runtime</h3>
<p><strong>What it optimizes for</strong>:
- Global latency (consistent performance worldwide)
- Cold start time (Edge is always warm)
- Simple, fast operations</p>
<p><strong>What it sacrifices</strong>:
- Node.js API access (no Prisma, no fs, no crypto)
- Library compatibility (many npm packages won't work)
- Debugging complexity (different runtime environment)</p>
<p><strong>When to choose Edge runtime</strong>:
- Middleware (always)
- Geolocation-based responses
- Simple API routes without database access
- A/B testing logic
- Authentication checks (token validation, not database queries)</p>
<p><strong>When to avoid Edge runtime</strong>:
- Database queries (use Node.js runtime)
- File uploads
- Complex business logic with Node.js dependencies
- Third-party libraries that use Node.js APIs</p>
<p><strong>Code characteristics</strong>:
- Setup: Easy (add <code>export const runtime = 'edge'</code>)
- Maintenance: Low (once working, stays working)
- Performance impact: High (96% latency reduction for suitable use cases)
- Compatibility: Limited (many libraries won't work)</p>
<p><strong>Decision Framework</strong>:</p>
<table>
<thead>
<tr>
<th>Use Case</th>
<th>Runtime</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database queries</td>
<td>Node.js</td>
<td>Prisma requires Node.js</td>
</tr>
<tr>
<td>Middleware</td>
<td>Edge</td>
<td>Fast, global, no DB needed</td>
</tr>
<tr>
<td>File uploads</td>
<td>Node.js</td>
<td>Requires fs module</td>
</tr>
<tr>
<td>Geolocation API</td>
<td>Edge</td>
<td>Benefits from global distribution</td>
</tr>
<tr>
<td>Payment processing</td>
<td>Node.js</td>
<td>Complex logic, third-party SDKs</td>
</tr>
<tr>
<td>A/B testing</td>
<td>Edge</td>
<td>Fast decision, no DB needed</td>
</tr>
<tr>
<td>Email sending</td>
<td>Node.js</td>
<td>SMTP libraries need Node.js</td>
</tr>
<tr>
<td>JWT validation</td>
<td>Edge</td>
<td>Fast, no DB needed</td>
</tr>
</tbody>
</table>
<h2 id="the-complete-journey-deployment-to-production">The Complete Journey - Deployment to Production</h2>
<h2 id="phase-6-synthesis-the-deployment-journey">Phase 6: Synthesis - The Deployment Journey</h2>
<p>Let's review the complete evolution of our production deployment:</p>
<h3 id="the-journey-from-broken-build-to-optimized-production">The Journey: From Broken Build to Optimized Production</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Failure Mode</th>
<th>Technique Applied</th>
<th>Result</th>
<th>Performance Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Build fails (Prisma types missing)</td>
<td>Add <code>postinstall</code> script</td>
<td>Build succeeds</td>
<td>N/A</td>
</tr>
<tr>
<td>1</td>
<td>Runtime error (can't connect to localhost DB)</td>
<td>Configure production env vars</td>
<td>App loads</td>
<td>N/A</td>
</tr>
<tr>
<td>2</td>
<td>Images 404, API routes fail</td>
<td>Commit images, set env vars for all environments</td>
<td>Fully functional</td>
<td>N/A</td>
</tr>
<tr>
<td>3</td>
<td>Checkout times out (10s limit)</td>
<td>Optimize API route, use webhooks</td>
<td>Fast checkout</td>
<td>8s ‚Üí 3s</td>
</tr>
<tr>
<td>4</td>
<td>Poor performance (LCP 8.4s)</td>
<td>Optimize images with next/image</td>
<td>Fast page loads</td>
<td>LCP 8.4s ‚Üí 1.8s</td>
</tr>
<tr>
<td>5</td>
<td>Large bundle (287 kB)</td>
<td>Bundle analysis, tree-shaking, dynamic imports</td>
<td>Small bundle</td>
<td>287 kB ‚Üí 87 kB</td>
</tr>
<tr>
<td>6</td>
<td>High latency for global users</td>
<td>Edge runtime for middleware/geo API</td>
<td>Low latency</td>
<td>820ms ‚Üí 35ms</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation-production-ready-deployment">Final Implementation: Production-Ready Deployment</h3>
<p>Here's our complete, optimized production setup:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// package.json</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;product-catalog&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next dev&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;postinstall&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prisma generate&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@prisma/client&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;next&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;14.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;next-auth&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^4.24.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;react&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^18.2.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stripe&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^14.0.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;devDependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;@next/bundle-analyzer&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^14.0.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prisma&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.7.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typescript&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;^5.3.0&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// next.config.js</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">withBundleAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@next/bundle-analyzer&#39;</span><span class="p">)({</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ANALYZE</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="p">});</span>

<span class="cm">/** @type {import(&#39;next&#39;).NextConfig} */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">nextConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">remotePatterns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">protocol</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">hostname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;your-cdn.com&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">pathname</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/images/**&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">formats</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;image/avif&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;image/webp&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">deviceSizes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">640</span><span class="p">,</span><span class="w"> </span><span class="mf">750</span><span class="p">,</span><span class="w"> </span><span class="mf">828</span><span class="p">,</span><span class="w"> </span><span class="mf">1080</span><span class="p">,</span><span class="w"> </span><span class="mf">1200</span><span class="p">,</span><span class="w"> </span><span class="mf">1920</span><span class="p">,</span><span class="w"> </span><span class="mf">2048</span><span class="p">,</span><span class="w"> </span><span class="mf">3840</span><span class="p">],</span>
<span class="w">    </span><span class="nx">imageSizes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mf">16</span><span class="p">,</span><span class="w"> </span><span class="mf">32</span><span class="p">,</span><span class="w"> </span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="mf">64</span><span class="p">,</span><span class="w"> </span><span class="mf">96</span><span class="p">,</span><span class="w"> </span><span class="mf">128</span><span class="p">,</span><span class="w"> </span><span class="mf">256</span><span class="p">,</span><span class="w"> </span><span class="mf">384</span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">withBundleAnalyzer</span><span class="p">(</span><span class="nx">nextConfig</span><span class="p">);</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts (Edge runtime)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">middleware</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Authentication check</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;auth-token&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/dashboard/:path*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/api/dashboard/:path*&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/products/page.tsx (Node.js runtime - default)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ProductCard</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ProductCard&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">orderBy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto px-4 py-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-8&quot;</span><span class="p">&gt;</span><span class="nx">Our</span><span class="w"> </span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid grid-cols-1 md:grid-cols-3 gap-6&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">ProductCard</span>
<span class="w">            </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
<span class="w">            </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
<span class="w">            </span><span class="na">priority</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span>
<span class="w">          </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// components/ProductCard.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/image&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">product</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">imageUrl</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">priority?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductCard</span><span class="p">({</span><span class="w"> </span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="nx">ProductCardProps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">        </span><span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">}</span>
<span class="w">        </span><span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">        </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">300</span><span class="p">}</span>
<span class="w">        </span><span class="na">sizes</span><span class="o">=</span><span class="s">&quot;(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw&quot;</span>
<span class="w">        </span><span class="na">priority</span><span class="o">=</span><span class="p">{</span><span class="nx">priority</span><span class="p">}</span>
<span class="w">        </span><span class="na">quality</span><span class="o">=</span><span class="p">{</span><span class="mf">75</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full h-48 object-cover rounded&quot;</span>
<span class="w">      </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold mt-4&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/checkout/route.ts (Node.js runtime - default)</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerSession</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/stripe&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getServerSession</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="o">?</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Parallel operations</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">order</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">session.user.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">items</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">paymentIntents</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">calculateTotal</span><span class="p">(</span><span class="nx">items</span><span class="p">),</span>
<span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">session.user.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">]);</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">order.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stripePaymentIntentId</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">clientSecret</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.client_secret</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">calculateTotal</span><span class="p">(</span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">sum</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/geo/route.ts (Edge runtime)</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">runtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;edge&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-vercel-ip-country&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">city</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-vercel-ip-city&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">Response</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">country</span><span class="p">,</span>
<span class="w">    </span><span class="nx">city</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Hello from </span><span class="si">${</span><span class="nx">city</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">country</span><span class="si">}</span><span class="sb">!`</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="environment-variables-configuration">Environment Variables Configuration</h3>
<p><strong>Vercel Dashboard ‚Üí Project Settings ‚Üí Environment Variables</strong>:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Production</th>
<th>Preview</th>
<th>Development</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DATABASE_URL</code></td>
<td><code>postgres://prod...</code></td>
<td><code>postgres://preview...</code></td>
<td><code>postgres://localhost...</code></td>
</tr>
<tr>
<td><code>NEXTAUTH_SECRET</code></td>
<td><code>[prod-secret]</code></td>
<td><code>[preview-secret]</code></td>
<td><code>[dev-secret]</code></td>
</tr>
<tr>
<td><code>NEXTAUTH_URL</code></td>
<td><code>https://app.com</code></td>
<td><code>https://preview.vercel.app</code></td>
<td><code>http://localhost:3000</code></td>
</tr>
<tr>
<td><code>STRIPE_SECRET_KEY</code></td>
<td><code>sk_live_...</code></td>
<td><code>sk_test_...</code></td>
<td><code>sk_test_...</code></td>
</tr>
<tr>
<td><code>STRIPE_PUBLISHABLE_KEY</code></td>
<td><code>pk_live_...</code></td>
<td><code>pk_test_...</code></td>
<td><code>pk_test_...</code></td>
</tr>
<tr>
<td><code>STRIPE_WEBHOOK_SECRET</code></td>
<td><code>whsec_prod...</code></td>
<td><code>whsec_preview...</code></td>
<td><code>whsec_local...</code></td>
</tr>
</tbody>
</table>
<h3 id="performance-metrics-before-vs-after">Performance Metrics: Before vs. After</h3>
<p><strong>Initial Deployment (Iteration 0-3)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Performance</span><span class="o">:</span><span class="w"> </span><span class="mi">42</span><span class="o">/</span><span class="mi">100</span>
<span class="o">-</span><span class="w"> </span><span class="n">LCP</span><span class="o">:</span><span class="w"> </span><span class="mf">8.4</span><span class="n">s</span>
<span class="o">-</span><span class="w"> </span><span class="n">FID</span><span class="o">:</span><span class="w"> </span><span class="mi">450</span><span class="n">ms</span>
<span class="o">-</span><span class="w"> </span><span class="n">CLS</span><span class="o">:</span><span class="w"> </span><span class="mf">0.45</span>
<span class="o">-</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="mi">287</span><span class="w"> </span><span class="n">kB</span>
<span class="o">-</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="mf">3.8</span><span class="w"> </span><span class="n">MB</span>
<span class="o">-</span><span class="w"> </span><span class="n">TTFB</span><span class="w"> </span><span class="o">(</span><span class="n">Tokyo</span><span class="o">):</span><span class="w"> </span><span class="mi">820</span><span class="n">ms</span>
</code></pre></div>

<p><strong>Optimized Production (Iteration 4-6)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Performance</span><span class="o">:</span><span class="w"> </span><span class="mi">96</span><span class="o">/</span><span class="mi">100</span><span class="w"> </span><span class="err">‚¨ÜÔ∏è</span><span class="w"> </span><span class="o">+</span><span class="mi">54</span><span class="w"> </span><span class="n">points</span>
<span class="o">-</span><span class="w"> </span><span class="n">LCP</span><span class="o">:</span><span class="w"> </span><span class="mf">1.2</span><span class="n">s</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">7.2</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="mi">86</span><span class="o">%</span><span class="w"> </span><span class="n">improvement</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">FID</span><span class="o">:</span><span class="w"> </span><span class="mi">45</span><span class="n">ms</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mi">405</span><span class="n">ms</span><span class="w"> </span><span class="o">(</span><span class="mi">90</span><span class="o">%</span><span class="w"> </span><span class="n">improvement</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">CLS</span><span class="o">:</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">0.44</span><span class="w"> </span><span class="o">(</span><span class="mi">98</span><span class="o">%</span><span class="w"> </span><span class="n">improvement</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">Bundle</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="mi">87</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mi">200</span><span class="w"> </span><span class="n">kB</span><span class="w"> </span><span class="o">(</span><span class="mi">70</span><span class="o">%</span><span class="w"> </span><span class="n">reduction</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">Image</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="mi">420</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mf">3.38</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="o">(</span><span class="mi">89</span><span class="o">%</span><span class="w"> </span><span class="n">reduction</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">TTFB</span><span class="w"> </span><span class="o">(</span><span class="n">Tokyo</span><span class="o">):</span><span class="w"> </span><span class="mi">35</span><span class="n">ms</span><span class="w"> </span><span class="err">‚¨áÔ∏è</span><span class="w"> </span><span class="o">-</span><span class="mi">785</span><span class="n">ms</span><span class="w"> </span><span class="o">(</span><span class="mi">96</span><span class="o">%</span><span class="w"> </span><span class="n">improvement</span><span class="o">)</span>
</code></pre></div>

<h3 id="decision-framework-deployment-checklist">Decision Framework: Deployment Checklist</h3>
<p>Before deploying to production, verify:</p>
<p><strong>Build Configuration</strong>:
- [ ] <code>postinstall</code> script for Prisma generation
- [ ] Bundle analyzer configured
- [ ] Image optimization configured
- [ ] TypeScript strict mode enabled</p>
<p><strong>Environment Variables</strong>:
- [ ] All secrets set in Vercel dashboard
- [ ] Different values for Production/Preview/Development
- [ ] Database URL points to production database
- [ ] API keys are production keys (not test keys)</p>
<p><strong>Performance</strong>:
- [ ] Lighthouse score &gt;90
- [ ] LCP &lt;2.5s
- [ ] FID &lt;100ms
- [ ] CLS &lt;0.1
- [ ] First Load JS &lt;100 kB
- [ ] Images optimized with next/image</p>
<p><strong>Runtime</strong>:
- [ ] Middleware uses Edge runtime
- [ ] Database queries use Node.js runtime
- [ ] API routes optimized for &lt;10s execution
- [ ] Long operations moved to webhooks/background jobs</p>
<p><strong>Security</strong>:
- [ ] Environment variables not committed to Git
- [ ] <code>.env.local</code> in <code>.gitignore</code>
- [ ] Production secrets different from development
- [ ] API routes have authentication checks</p>
<p><strong>Monitoring</strong>:
- [ ] Error tracking configured (Sentry, etc.)
- [ ] Analytics configured
- [ ] Core Web Vitals monitoring enabled
- [ ] Vercel function logs reviewed</p>
<h3 id="common-production-failures-and-their-signatures">Common Production Failures and Their Signatures</h3>
<p><strong>Symptom: Build fails with "Property does not exist on type"</strong></p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">Type</span><span class="w"> </span><span class="nx">error</span><span class="p">:</span><span class="w"> </span><span class="nx">Property</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">product</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">exist</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">PrismaClient</span><span class="err">&#39;</span>
</code></pre></div>

<p><strong>Root cause</strong>: Prisma Client not generated
<strong>Solution</strong>: Add <code>postinstall</code> script</p>
<hr />
<p><strong>Symptom: Runtime error "Can't reach database server"</strong></p>
<p><strong>Function logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">PrismaClientInitializationError</span><span class="o">:</span><span class="w"> </span><span class="n">Can</span><span class="err">&#39;</span><span class="n">t</span><span class="w"> </span><span class="n">reach</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="err">`</span><span class="n">localhost</span><span class="o">:</span><span class="mi">5432</span><span class="err">`</span>
</code></pre></div>

<p><strong>Root cause</strong>: Missing or incorrect <code>DATABASE_URL</code> environment variable
<strong>Solution</strong>: Set production database URL in Vercel dashboard</p>
<hr />
<p><strong>Symptom: API route times out (504 Gateway Timeout)</strong></p>
<p><strong>Function logs</strong>:</p>
<div class="codehilite"><pre><span></span><code>Task timed out after 10.00 seconds
</code></pre></div>

<p><strong>Root cause</strong>: Operation takes longer than serverless function limit
<strong>Solution</strong>: Optimize with parallel operations, move to webhooks, or upgrade plan</p>
<hr />
<p><strong>Symptom: Images return 404</strong></p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET /images/product-1.jpg 404 (Not Found)
</code></pre></div>

<p><strong>Root cause</strong>: Images not committed to Git or in <code>.gitignore</code>
<strong>Solution</strong>: Remove images from <code>.gitignore</code>, commit and push</p>
<hr />
<p><strong>Symptom: Poor performance, high LCP</strong></p>
<p><strong>Lighthouse evidence</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">LCP</span><span class="o">:</span><span class="w"> </span><span class="mf">8.4</span><span class="n">s</span>
<span class="n">Opportunities</span><span class="o">:</span><span class="w"> </span><span class="n">Properly</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="o">(</span><span class="mf">2.4</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="n">savings</span><span class="o">)</span>
</code></pre></div>

<p><strong>Root cause</strong>: Unoptimized images
<strong>Solution</strong>: Use <code>next/image</code> with proper configuration</p>
<hr />
<p><strong>Symptom: Large bundle size, slow TTI</strong></p>
<p><strong>Build output</strong>:</p>
<div class="codehilite"><pre><span></span><code>First Load JS: 287 kB
chunks/page-ghi789.js: 210 kB
</code></pre></div>

<p><strong>Root cause</strong>: Large libraries in shared bundle
<strong>Solution</strong>: Bundle analysis, tree-shaking, dynamic imports</p>
<hr />
<p><strong>Symptom: High latency for global users</strong></p>
<p><strong>Function logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Region</span><span class="o">:</span><span class="w"> </span><span class="n">iad1</span><span class="w"> </span><span class="o">(</span><span class="n">US</span><span class="w"> </span><span class="n">East</span><span class="o">)</span>
<span class="n">Total</span><span class="o">:</span><span class="w"> </span><span class="mi">570</span><span class="n">ms</span>
</code></pre></div>

<p><strong>Root cause</strong>: All requests go to single region
<strong>Solution</strong>: Use Edge runtime for suitable routes</p>
<h3 id="lessons-learned">Lessons Learned</h3>
<p><strong>1. Environment Variables Are Not Magic</strong>
- <code>.env.local</code> files don't deploy automatically
- Each environment (Production/Preview/Development) needs separate configuration
- Always use different secrets for production vs. development</p>
<p><strong>2. Serverless Has Limits</strong>
- 10-second timeout on free tier
- Optimize for fast execution
- Move long operations to webhooks or background jobs</p>
<p><strong>3. Images Are Usually the Bottleneck</strong>
- Unoptimized images can be 90% of page weight
- <code>next/image</code> is not optional‚Äîit's essential
- Always provide dimensions to prevent CLS</p>
<p><strong>4. Bundle Size Matters</strong>
- Every kilobyte of JavaScript delays interactivity
- Tree-shaking and dynamic imports are your friends
- Analyze before optimizing (don't guess)</p>
<p><strong>5. Runtime Choice Is Strategic</strong>
- Edge runtime: Fast, global, limited
- Node.js runtime: Full-featured, regional
- Use both strategically for optimal performance</p>
<p><strong>6. Deployment Is Iterative</strong>
- First deployment will likely fail
- Each failure teaches you something
- Build ‚Üí Deploy ‚Üí Measure ‚Üí Optimize ‚Üí Repeat</p>
<p><strong>7. Performance Is a Feature</strong>
- Core Web Vitals affect SEO and user experience
- Lighthouse scores correlate with conversion rates
- Optimize before launch, not after</p>
<p>The journey from broken build to optimized production is not linear. Each failure reveals a new layer of complexity. But by systematically diagnosing each issue, applying the right technique, and measuring the impact, you build a production-ready application that performs well for users worldwide.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 12:33:31 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>