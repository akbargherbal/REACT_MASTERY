<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19 Authentication and Authorization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-19-authentication-and-authorization">Chapter 19: Authentication and Authorization</h1>
<h2 id="nextauthjs-authjs-setup">NextAuth.js (Auth.js) setup</h2>
<h2 id="the-failure-insecure-client-only-auth-checks">The Failure: Insecure Client-Only Auth Checks</h2>
<p>Let's start with what most developers build first‚Äîand why it's fundamentally broken.</p>
<h3 id="reference-implementation-e-commerce-admin-dashboard">Reference Implementation: E-commerce Admin Dashboard</h3>
<p>We're building an admin dashboard for our e-commerce product catalog. Admins need to:</p>
<ul>
<li>View all products (including unpublished ones)</li>
<li>Edit product details</li>
<li>Manage inventory</li>
<li>View customer orders</li>
</ul>
<p>Here's the naive approach that seems to work:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">AdminDashboard</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isAuthenticated</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsAuthenticated</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">products</span><span class="p">,</span><span class="w"> </span><span class="nx">setProducts</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRouter</span><span class="p">();</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Check if user is logged in</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">setIsAuthenticated</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Fetch admin data</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/admin/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setProducts</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">router</span><span class="p">]);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isAuthenticated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Checking</span><span class="w"> </span><span class="nx">authentication</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Admin</span><span class="w"> </span><span class="nx">Dashboard</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Price</span><span class="o">:</span><span class="w"> </span><span class="kt">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">inventory</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span><span class="nx">Edit</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>This code runs. It redirects unauthenticated users. It fetches admin data. Ship it, right?</p>
<p><strong>Wrong. This is security theater, not security.</strong></p>
<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p>Let's see what an attacker sees when they open DevTools:</p>
<p><strong>Browser Behavior</strong>:
1. Page loads and shows "Checking authentication..." for a split second
2. Then redirects to <code>/login</code>
3. But if you're fast enough (or disable JavaScript), you can see the admin UI</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET /api/admin/products 401 Unauthorized
</code></pre></div>

<p><strong>React DevTools Evidence</strong>:
- Component tree shows: <code>AdminDashboard</code> ‚Üí rendered
- State: <code>isAuthenticated: false</code>, <code>products: []</code>
- The component fully mounts before the redirect happens</p>
<p><strong>Network Tab Analysis</strong>:
- Request to <code>/api/admin/products</code> fires immediately
- Response: 401 Unauthorized
- But the request was made‚Äîthe API endpoint was discovered</p>
<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the user experiences</strong>: Brief flash of admin UI, then redirect</p>
</li>
<li>
<p><strong>What the console reveals</strong>: The API endpoint <code>/api/admin/products</code> is exposed in the client-side code</p>
</li>
<li>
<p><strong>What DevTools shows</strong>: </p>
</li>
<li>The entire admin component renders before auth check completes</li>
<li>All product data structure is visible in the component code</li>
<li>
<p>localStorage token is visible in Application tab</p>
</li>
<li>
<p><strong>Root cause identified</strong>: Authentication happens in the browser, after the page loads</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>: Client-side code is public code. Any "protection" that happens in the browser can be bypassed by:</p>
</li>
<li>Disabling JavaScript</li>
<li>Modifying localStorage</li>
<li>Editing the component code in DevTools</li>
<li>
<p>Directly calling API endpoints with tools like curl</p>
</li>
<li>
<p><strong>What we need</strong>: Authentication that happens on the server, before any protected content is sent to the browser</p>
</li>
</ol>
<h3 id="the-fundamental-problem-client-side-auth-is-not-auth">The Fundamental Problem: Client-Side Auth is Not Auth</h3>
<p>Here's what an attacker can do with 30 seconds and DevTools:</p>
<p><strong>Attack 1: Disable JavaScript</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># In Chrome DevTools: Settings ‚Üí Debugger ‚Üí Disable JavaScript</span>
<span class="c1"># Now visit /admin</span>
<span class="c1"># Result: Full admin UI renders (no redirect happens)</span>
</code></pre></div>

<p><strong>Attack 2: Modify localStorage</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In browser console:</span>
<span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;authToken&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fake-token-12345&#39;</span><span class="p">);</span>
<span class="c1">// Refresh page</span>
<span class="c1">// Result: Passes client-side check, makes API request</span>
</code></pre></div>

<p><strong>Attack 3: Direct API Access</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># The API endpoint is visible in the source code</span>
curl<span class="w"> </span>https://yoursite.com/api/admin/products<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer fake-token&quot;</span>

<span class="c1"># If the API doesn&#39;t validate properly, you get data</span>
</code></pre></div>

<p><strong>Attack 4: View Source</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- View page source --&gt;</span>
<span class="cm">&lt;!-- All component code is visible, including: --&gt;</span>
<span class="cm">&lt;!-- - API endpoints --&gt;</span>
<span class="cm">&lt;!-- - Data structures --&gt;</span>
<span class="cm">&lt;!-- - Business logic --&gt;</span>
</code></pre></div>

<h3 id="what-we-actually-need">What We Actually Need</h3>
<p>Authentication must happen in three places, in this order:</p>
<ol>
<li><strong>Server-side route protection</strong>: Check auth before rendering the page</li>
<li><strong>API route protection</strong>: Validate tokens on every API request</li>
<li><strong>Client-side UX</strong>: Show appropriate UI based on auth state (but never rely on it for security)</li>
</ol>
<p>Client-side checks are for user experience, not security. They prevent confusion, not attacks.</p>
<h2 id="nextauthjs-server-side-auth-for-nextjs">NextAuth.js: Server-Side Auth for Next.js</h2>
<p>NextAuth.js (now called Auth.js) solves this by:</p>
<ol>
<li>Managing sessions on the server</li>
<li>Providing middleware to protect routes before they render</li>
<li>Handling OAuth providers (Google, GitHub, etc.)</li>
<li>Encrypting session tokens</li>
<li>Giving you hooks to check auth state in components</li>
</ol>
<h3 id="installation-and-setup">Installation and Setup</h3>
<p>First, install the dependencies:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>next-auth@beta
</code></pre></div>

<p><strong>Note</strong>: We're using <code>next-auth@beta</code> because it's the version compatible with Next.js 13+ App Router. The stable version only works with Pages Router.</p>
<h3 id="project-structure">Project Structure</h3>
<p>Here's how we'll organize our auth setup:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">auth</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">...nextauth</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">routes</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="k">admin</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">                  </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Protected</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">page</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Protected</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="n">editor</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">login</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">                  </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Login</span><span class="w"> </span><span class="n">page</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">layout</span><span class="p">.</span><span class="n">tsx</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">auth</span><span class="p">.</span><span class="n">ts</span><span class="w">                       </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="n">configuration</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">middleware</span><span class="p">.</span><span class="n">ts</span><span class="w">                     </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Route</span><span class="w"> </span><span class="n">protection</span>
</code></pre></div>

<h3 id="core-auth-configuration">Core Auth Configuration</h3>
<p>Create the auth configuration file:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/auth.ts</span>
<span class="k">import</span><span class="w"> </span><span class="nx">NextAuth</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">CredentialsProvider</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/providers/credentials&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">compare</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;bcryptjs&#39;</span><span class="p">;</span>

<span class="c1">// This would come from your database</span>
<span class="c1">// For now, we&#39;ll use a mock</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUserFromDatabase</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In production, this queries your database</span>
<span class="w">  </span><span class="c1">// Example: await db.user.findUnique({ where: { email } })</span>

<span class="w">  </span><span class="c1">// Mock user for demonstration</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">email</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Admin User&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// This is bcrypt hash of &#39;password123&#39;</span>
<span class="w">      </span><span class="nx">passwordHash</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$2a$10$rXQvvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXvXv&#39;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">handlers</span><span class="p">,</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">signIn</span><span class="p">,</span><span class="w"> </span><span class="nx">signOut</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NextAuth</span><span class="p">({</span>
<span class="w">  </span><span class="nx">providers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="nx">CredentialsProvider</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Credentials&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Email&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;email&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Password&quot;</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;password&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="k">async</span><span class="w"> </span><span class="nx">authorize</span><span class="p">(</span><span class="nx">credentials</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">credentials</span><span class="o">?</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">credentials</span><span class="o">?</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserFromDatabase</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isValidPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">compare</span><span class="p">(</span>
<span class="w">          </span><span class="nx">credentials</span><span class="p">.</span><span class="nx">password</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">          </span><span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isValidPassword</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Return user object (without password)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<span class="w">          </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">user.email</span><span class="p">,</span>
<span class="w">          </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">user.name</span><span class="p">,</span>
<span class="w">          </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="kt">user.role</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">callbacks</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">jwt</span><span class="p">({</span><span class="w"> </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Add user info to JWT token</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">        </span><span class="nx">token</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">token</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">session</span><span class="p">({</span><span class="w"> </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Add user info to session</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">        </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">session</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">pages</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">signIn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/login&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jwt&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="understanding-the-configuration">Understanding the Configuration</h3>
<p>Let's break down what each part does:</p>
<p><strong>Providers</strong>: Define how users authenticate
- <code>CredentialsProvider</code>: Username/password login
- Could also use <code>GoogleProvider</code>, <code>GitHubProvider</code>, etc.</p>
<p><strong>authorize function</strong>: Validates credentials
- Queries database for user
- Compares password hash
- Returns user object if valid, null if not</p>
<p><strong>Callbacks</strong>: Customize JWT and session data
- <code>jwt</code>: Runs when JWT is created/updated‚Äîadd custom data here
- <code>session</code>: Runs when session is accessed‚Äîshape the session object</p>
<p><strong>pages</strong>: Custom auth pages
- <code>signIn</code>: Where to redirect for login</p>
<p><strong>session.strategy</strong>: How sessions are stored
- <code>jwt</code>: Stateless, encrypted token in cookie (recommended)
- <code>database</code>: Store sessions in database (more control, more complexity)</p>
<h3 id="api-route-handler">API Route Handler</h3>
<p>Create the catch-all route for NextAuth:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/auth/[...nextauth]/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">handlers</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GET</span><span class="p">,</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">handlers</span><span class="p">;</span>
</code></pre></div>

<p>This single file handles all auth endpoints:
- <code>GET /api/auth/signin</code> - Sign in page
- <code>POST /api/auth/signin</code> - Sign in submission
- <code>GET /api/auth/signout</code> - Sign out
- <code>GET /api/auth/session</code> - Get current session
- And more...</p>
<h3 id="typescript-types">TypeScript Types</h3>
<p>Extend NextAuth types to include our custom fields:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// types/next-auth.d.ts</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>

<span class="kr">declare</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">interface</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">role?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Session</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">declare</span><span class="w"> </span><span class="nx">module</span><span class="w"> </span><span class="s1">&#39;next-auth/jwt&#39;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">interface</span><span class="w"> </span><span class="nx">JWT</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">role?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="login-page">Login Page</h3>
<p>Create a login form that uses NextAuth:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/login/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signIn</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">LoginPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">setEmail</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">setPassword</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRouter</span><span class="p">();</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">signIn</span><span class="p">(</span><span class="s1">&#39;credentials&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">email</span><span class="p">,</span>
<span class="w">        </span><span class="nx">password</span><span class="p">,</span>
<span class="w">        </span><span class="nx">redirect</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">setError</span><span class="p">(</span><span class="s1">&#39;Invalid email or password&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Success - redirect to admin</span>
<span class="w">      </span><span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">router</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span><span class="w"> </span><span class="c1">// Refresh to update server components</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setError</span><span class="p">(</span><span class="s1">&#39;An error occurred. Please try again.&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;min-h-screen flex items-center justify-center bg-gray-50&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold text-center&quot;</span><span class="p">&gt;</span><span class="nx">Admin</span><span class="w"> </span><span class="nx">Login</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-6&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-red-50 text-red-600 p-3 rounded&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">{</span><span class="nx">error</span><span class="p">}</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">)}</span>

<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">Email</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">              </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;email&quot;</span>
<span class="w">              </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;email&quot;</span>
<span class="w">              </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">email</span><span class="p">}</span>
<span class="w">              </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setEmail</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">              </span><span class="na">required</span>
<span class="w">              </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md&quot;</span>
<span class="w">            </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">Password</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">              </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;password&quot;</span>
<span class="w">              </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span>
<span class="w">              </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">password</span><span class="p">}</span>
<span class="w">              </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setPassword</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">              </span><span class="na">required</span>
<span class="w">              </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md&quot;</span>
<span class="w">            </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">          </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">            </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span>
<span class="w">            </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isLoading</span><span class="p">}</span>
<span class="w">            </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50&quot;</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Signing in...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sign In&#39;</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-gray-600 text-center&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Demo</span><span class="w"> </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="kt">admin</span><span class="kd">@example</span><span class="p">.</span><span class="nx">com</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">password123</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="testing-the-setup">Testing the Setup</h3>
<p>Start your dev server and test:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>run<span class="w"> </span>dev
</code></pre></div>

<p><strong>Browser Console Output</strong> (successful login):</p>
<div class="codehilite"><pre><span></span><code>POST /api/auth/callback/credentials 200 OK
GET /api/auth/session 200 OK
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- <code>POST /api/auth/callback/credentials</code>: Login request
  - Request body: <code>{ email, password }</code> (encrypted in transit via HTTPS)
  - Response: Sets <code>next-auth.session-token</code> cookie
- <code>GET /api/auth/session</code>: Fetch session data
  - Response: <code>{ user: { id, email, name, role } }</code></p>
<p><strong>Application Tab</strong> (Chrome DevTools):
- Cookies: <code>next-auth.session-token</code> is set
  - Value: Encrypted JWT (not readable in DevTools)
  - HttpOnly: Yes (JavaScript cannot access it)
  - Secure: Yes (only sent over HTTPS)
  - SameSite: Lax (CSRF protection)</p>
<p>This is already more secure than our localStorage approach:
- Token is HttpOnly (can't be stolen via XSS)
- Token is encrypted (can't be tampered with)
- Token is validated on the server</p>
<p>But we still haven't protected our admin routes. Let's fix that next.</p>
<h2 id="session-management">Session management</h2>
<h2 id="accessing-session-data">Accessing Session Data</h2>
<p>Now that users can log in, we need to access their session data in our components and API routes.</p>
<h3 id="in-server-components">In Server Components</h3>
<p>Server Components can directly access the session:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">AdminDashboard</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Fetch admin data server-side</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3000/api/admin/products&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Pass session info to API</span>
<span class="w">      </span><span class="s1">&#39;Cookie&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`next-auth.session-token=</span><span class="si">${</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Admin</span><span class="w"> </span><span class="nx">Dashboard</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Welcome</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Role</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid gap-4 mt-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border p-4 rounded&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-bold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Price</span><span class="o">:</span><span class="w"> </span><span class="kt">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">inventory</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">a</span><span class="w"> </span>
<span class="w">              </span><span class="na">href</span><span class="o">=</span><span class="p">{</span><span class="sb">`/admin/products/</span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">}</span>
<span class="w">              </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-blue-600 hover:underline&quot;</span>
<span class="w">            </span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">Edit</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>What changed from our broken version</strong>:</p>
<ol>
<li><strong>Server Component</strong>: No <code>'use client'</code> directive‚Äîthis runs on the server</li>
<li><strong>Direct session access</strong>: <code>await auth()</code> gets session server-side</li>
<li><strong>Redirect before render</strong>: If no session, redirect happens on the server</li>
<li><strong>No flash of content</strong>: User never sees the admin UI if not authenticated</li>
</ol>
<p><strong>Browser Behavior</strong>:
- Unauthenticated user visits <code>/admin</code>
- Server checks session, finds none
- Server responds with 307 redirect to <code>/login</code>
- Browser never receives admin HTML</p>
<p><strong>View Source</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- Unauthenticated user sees: --&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;refresh&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;0;url=/login&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>No admin code. No API endpoints. No data structures. Just a redirect.</p>
<h3 id="in-client-components">In Client Components</h3>
<p>For interactive components, use the <code>useSession</code> hook:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/[id]/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useSession</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductEditor</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">session</span><span class="p">,</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useSession</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRouter</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">setProduct</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;unauthenticated&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">router</span><span class="p">]);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;authenticated&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/admin/products/</span><span class="si">${</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setProduct</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;loading&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="w"> </span><span class="nx">product</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">Edit</span><span class="w"> </span><span class="nx">Product</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span><span class="nx">Name</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span>
<span class="w">            </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="w"> </span>
<span class="w">            </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
<span class="w">            </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setProduct</span><span class="p">({</span><span class="w"> </span><span class="p">...</span><span class="nx">product</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">e.target.value</span><span class="w"> </span><span class="p">})}</span>
<span class="w">          </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="cm">/* More form fields */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Session status values</strong>:
- <code>loading</code>: Session is being fetched
- <code>authenticated</code>: User is logged in
- <code>unauthenticated</code>: User is not logged in</p>
<p><strong>Important</strong>: This client-side check is still for UX only. The real protection comes from:
1. Middleware (which we'll add next)
2. API route validation (which we'll implement)</p>
<h3 id="session-provider">Session Provider</h3>
<p>To use <code>useSession</code>, wrap your app in a session provider:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SessionProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">SessionProvider</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">SessionProvider</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="in-api-routes">In API Routes</h3>
<p>Protect API endpoints by checking the session:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/admin/products/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Check role</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Fetch products from database</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">29.99</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">49.99</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Validate and create product</span>
<span class="w">  </span><span class="c1">// In production: await db.product.create({ data: body })</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Testing API Protection</strong>:</p>
<p>Try calling the API without authentication:</p>
<div class="codehilite"><pre><span></span><code>curl<span class="w"> </span>http://localhost:3000/api/admin/products
</code></pre></div>

<p><strong>Response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unauthorized&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Status code</strong>: 401</p>
<p>Now try with a valid session (after logging in through the browser):</p>
<div class="codehilite"><pre><span></span><code>curl<span class="w"> </span>http://localhost:3000/api/admin/products<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Cookie: next-auth.session-token=YOUR_TOKEN_HERE&quot;</span>
</code></pre></div>

<p><strong>Response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Product 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">29.99</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;inventory&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Product 2&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">49.99</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;inventory&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p><strong>Status code</strong>: 200</p>
<h3 id="session-refresh-and-expiration">Session Refresh and Expiration</h3>
<p>By default, NextAuth sessions expire after 30 days. Configure this:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/auth.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">handlers</span><span class="p">,</span><span class="w"> </span><span class="nx">auth</span><span class="p">,</span><span class="w"> </span><span class="nx">signIn</span><span class="p">,</span><span class="w"> </span><span class="nx">signOut</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NextAuth</span><span class="p">({</span>
<span class="w">  </span><span class="c1">// ... other config</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;jwt&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">maxAge</span><span class="o">:</span><span class="w"> </span><span class="kt">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// 30 days</span>
<span class="w">    </span><span class="nx">updateAge</span><span class="o">:</span><span class="w"> </span><span class="kt">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// 24 hours</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>maxAge</strong>: How long until session expires
<strong>updateAge</strong>: How often to refresh the session token</p>
<p>When a session is about to expire, NextAuth automatically refreshes it on the next request.</p>
<h3 id="sign-out">Sign Out</h3>
<p>Implement sign out functionality:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// components/SignOutButton.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signOut</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">SignOutButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">      </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">signOut</span><span class="p">({</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/login&#39;</span><span class="w"> </span><span class="p">})}</span>
<span class="w">      </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700&quot;</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="nx">Sign</span><span class="w"> </span><span class="nx">Out</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Add it to your admin layout:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">SignOutButton</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/SignOutButton&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">AdminLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">header</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-gray-800 text-white p-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto flex justify-between items-center&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-bold&quot;</span><span class="p">&gt;</span><span class="nx">Admin</span><span class="w"> </span><span class="nx">Dashboard</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;{</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">SignOutButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;container mx-auto p-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Browser Console Output</strong> (sign out):</p>
<div class="codehilite"><pre><span></span><code>POST /api/auth/signout 200 OK
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:
- <code>POST /api/auth/signout</code>: Sign out request
  - Response: Clears <code>next-auth.session-token</code> cookie
  - Redirect: 307 to <code>/login</code></p>
<p><strong>Application Tab</strong>:
- Cookies: <code>next-auth.session-token</code> is deleted</p>
<h3 id="the-failure-session-hijacking">The Failure: Session Hijacking</h3>
<p>Even with HttpOnly cookies, sessions can still be stolen if:</p>
<ol>
<li><strong>No HTTPS</strong>: Cookies sent over HTTP can be intercepted</li>
<li><strong>XSS vulnerability</strong>: Malicious script can make authenticated requests</li>
<li><strong>CSRF attack</strong>: Attacker tricks user into making requests</li>
</ol>
<p><strong>Diagnostic Analysis</strong>:</p>
<p><strong>Attack scenario</strong>: User visits malicious site while logged in</p>
<p><strong>Malicious site code</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://yoursite.com/api/admin/products/delete?id=1&quot;</span> <span class="p">/&gt;</span>
</code></pre></div>

<p><strong>Browser behavior</strong>:
- Browser automatically includes cookies with the request
- API endpoint receives authenticated request
- Product gets deleted</p>
<p><strong>Network Tab</strong>:
- <code>GET /api/admin/products/delete?id=1</code> with valid session cookie
- Status: 200 OK
- Result: Product deleted</p>
<p><strong>Root cause</strong>: Browser automatically sends cookies with every request to the domain, even from other sites.</p>
<p><strong>What we need</strong>: CSRF protection to verify requests originate from our site.</p>
<p>NextAuth includes CSRF protection by default:
- Every form submission includes a CSRF token
- API routes validate the token
- Cross-origin requests are rejected</p>
<p>But we still need one more layer: middleware to protect routes before they even render.</p>
<h2 id="protected-routes-and-middleware">Protected routes and middleware</h2>
<h2 id="the-failure-protecting-every-route-manually">The Failure: Protecting Every Route Manually</h2>
<p>Right now, every protected page needs this code:</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Problems with this approach</strong>:</p>
<ol>
<li><strong>Easy to forget</strong>: One missed check = security hole</li>
<li><strong>Repetitive</strong>: Same code in every file</li>
<li><strong>Runs too late</strong>: Page component starts executing before check</li>
<li><strong>Not DRY</strong>: Violates "Don't Repeat Yourself"</li>
</ol>
<p><strong>What we need</strong>: A single place to protect all admin routes.</p>
<h2 id="nextjs-middleware-the-gatekeeper">Next.js Middleware: The Gatekeeper</h2>
<p>Middleware runs before any page renders. It's the perfect place for auth checks.</p>
<p>Create a middleware file at the root of your project:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isLoggedIn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!!</span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isOnAdminPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isOnAdminPage</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isLoggedIn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/admin/:path*&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="understanding-middleware">Understanding Middleware</h3>
<p><strong>How it works</strong>:</p>
<ol>
<li>User requests <code>/admin/products</code></li>
<li>Middleware runs before the page component</li>
<li>Checks if user is authenticated</li>
<li>If not, redirects to <code>/login</code></li>
<li>If yes, allows request to continue</li>
</ol>
<p><strong>matcher</strong>: Defines which routes the middleware applies to
- <code>/admin/:path*</code>: All routes under <code>/admin</code>
- Can use arrays: <code>['/admin/:path*', '/dashboard/:path*']</code>
- Can use regex: <code>/admin/(.*)</code></p>
<p><strong>req.auth</strong>: The session object (provided by NextAuth)
- <code>null</code> if not authenticated
- User object if authenticated</p>
<p><strong>NextResponse.redirect</strong>: Server-side redirect
- Happens before page renders
- User never sees protected content</p>
<h3 id="testing-middleware-protection">Testing Middleware Protection</h3>
<p><strong>Test 1: Unauthenticated access</strong></p>
<p>Visit <code>/admin</code> without logging in:</p>
<p><strong>Browser Behavior</strong>:
- Immediately redirects to <code>/login</code>
- No flash of admin content
- URL changes to <code>/login</code></p>
<p><strong>Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET /admin 307 Temporary Redirect
Location: /login
</code></pre></div>

<p><strong>View Source</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- No admin HTML sent to browser --&gt;</span>
</code></pre></div>

<p><strong>Test 2: Authenticated access</strong></p>
<p>Log in, then visit <code>/admin</code>:</p>
<p><strong>Browser Behavior</strong>:
- Page loads normally
- Admin content displays</p>
<p><strong>Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET /admin 200 OK
</code></pre></div>

<p><strong>Test 3: Direct API access</strong></p>
<p>Try to bypass middleware by calling API directly:</p>
<div class="codehilite"><pre><span></span><code>curl<span class="w"> </span>http://localhost:3000/api/admin/products
</code></pre></div>

<p><strong>Response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unauthorized&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Why</strong>: API routes still check session independently. Middleware protects pages, API routes protect themselves.</p>
<h3 id="advanced-middleware-patterns">Advanced Middleware Patterns</h3>
<h4 id="pattern-1-role-based-route-protection">Pattern 1: Role-Based Route Protection</h4>
<p>Protect different routes for different roles:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Public routes - allow everyone</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Protected routes - require authentication</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Admin routes - require admin role</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Manager routes - require manager or admin role</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/manager&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>matcher explanation</strong>:
- <code>(?!api|_next/static|_next/image|favicon.ico)</code>: Negative lookahead‚Äîexclude these paths
- <code>.*</code>: Match everything else
- Result: Middleware runs on all pages except API routes and static files</p>
<h4 id="pattern-2-redirect-after-login">Pattern 2: Redirect After Login</h4>
<p>Remember where user was trying to go:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Save the original URL</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">loginUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="nx">loginUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;callbackUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">loginUrl</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>

<p>Update login page to use callback URL:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/login/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signIn</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth/react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useSearchParams</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">LoginPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useSearchParams</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">callbackUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;callbackUrl&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/admin&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">signIn</span><span class="p">(</span><span class="s1">&#39;credentials&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">email</span><span class="p">,</span>
<span class="w">      </span><span class="nx">password</span><span class="p">,</span>
<span class="w">      </span><span class="nx">callbackUrl</span><span class="p">,</span><span class="w"> </span><span class="c1">// Redirect here after login</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... rest of component</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>User experience</strong>:</p>
<ol>
<li>User visits <code>/admin/products/123</code> (not logged in)</li>
<li>Middleware redirects to <code>/login?callbackUrl=/admin/products/123</code></li>
<li>User logs in</li>
<li>Redirected to <code>/admin/products/123</code> (original destination)</li>
</ol>
<h4 id="pattern-3-api-route-protection-in-middleware">Pattern 3: API Route Protection in Middleware</h4>
<p>Protect API routes too:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Protect admin API routes</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/admin&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Protect admin pages</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/admin/:path*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/api/admin/:path*&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Now both pages and APIs are protected at the middleware level.</strong></p>
<h3 id="the-failure-middleware-doesnt-run-everywhere">The Failure: Middleware Doesn't Run Everywhere</h3>
<p><strong>Problem</strong>: Middleware doesn't run on:
- Static files (<code>/images/logo.png</code>)
- API routes in some configurations
- Server Actions</p>
<p><strong>Diagnostic Analysis</strong>:</p>
<p>Try to access a protected Server Action without middleware:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/actions.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// No auth check!</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="ow">delete</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Attack</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Attacker&#39;s code</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/actions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;deleteProduct&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;product-123&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>Result</strong>: Product deleted without authentication.</p>
<p><strong>Solution</strong>: Always check auth in Server Actions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/actions.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Unauthorized&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="ow">delete</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Rule</strong>: Middleware is the first line of defense, but every protected operation must validate auth independently.</p>
<h3 id="unauthorized-page">Unauthorized Page</h3>
<p>Create a page for unauthorized access:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/unauthorized/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Link</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/link&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">UnauthorizedPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;min-h-screen flex items-center justify-center bg-gray-50&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-center&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold text-gray-900 mb-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="mf">403</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Forbidden</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600 mb-8&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">You</span><span class="w"> </span><span class="nx">don</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">permission</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">Link</span><span class="w"> </span>
<span class="w">          </span><span class="na">href</span><span class="o">=</span><span class="s">&quot;/&quot;</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700&quot;</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Go</span><span class="w"> </span><span class="nx">Home</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="middleware-performance-considerations">Middleware Performance Considerations</h3>
<p>Middleware runs on every request. Keep it fast:</p>
<p><strong>Good</strong>:
- Check session (already in memory)
- Simple role checks
- Path-based routing decisions</p>
<p><strong>Bad</strong>:
- Database queries
- External API calls
- Complex computations</p>
<p><strong>Example of what NOT to do</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå BAD - Don&#39;t do this</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// This runs on EVERY request</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findUnique</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">req.auth?.user.id</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">permission</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span>
<span class="w">    </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// ... complex permission logic</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>Why it's bad</strong>: Database queries on every request kill performance.</p>
<p><strong>Better approach</strong>: Store role in session, check permissions in the actual route:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚úÖ GOOD - Middleware stays fast</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Quick check using session data</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="o">?</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="c1">// ‚úÖ GOOD - Detailed checks in the route</span>
<span class="c1">// app/admin/products/[id]/page.tsx</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductPage</span><span class="p">({</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Now we can do expensive checks</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">hasPermission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">checkProductPermission</span><span class="p">(</span>
<span class="w">    </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ... render page</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="role-based-access-control">Role-based access control</h2>
<h2 id="iteration-4-protected-product-management">Iteration 4: Protected Product Management</h2>
<p>Let's build a complete role-based access control system for our e-commerce admin.</p>
<h3 id="requirements">Requirements</h3>
<p>We need three user roles:</p>
<ol>
<li><strong>Admin</strong>: Full access‚Äîcan create, edit, delete products</li>
<li><strong>Manager</strong>: Can edit products, view orders, but cannot delete</li>
<li><strong>Viewer</strong>: Read-only access to products and orders</li>
</ol>
<h3 id="database-schema">Database Schema</h3>
<p>First, let's define our user and permission structure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// prisma/schema.prisma</span>
<span class="nx">model</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="w">            </span><span class="nb">String</span><span class="w">    </span><span class="kd">@id</span><span class="w"> </span><span class="kd">@default</span><span class="p">(</span><span class="nx">cuid</span><span class="p">())</span>
<span class="w">  </span><span class="nx">email</span><span class="w">         </span><span class="nb">String</span><span class="w">    </span><span class="kd">@unique</span>
<span class="w">  </span><span class="nx">name</span><span class="w">          </span><span class="nb">String</span>
<span class="w">  </span><span class="nx">passwordHash</span><span class="w">  </span><span class="nb">String</span>
<span class="w">  </span><span class="nx">role</span><span class="w">          </span><span class="nx">Role</span><span class="w">      </span><span class="kd">@default</span><span class="p">(</span><span class="nx">VIEWER</span><span class="p">)</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="w">     </span><span class="nx">DateTime</span><span class="w">  </span><span class="kd">@default</span><span class="p">(</span><span class="nx">now</span><span class="p">())</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="w">     </span><span class="nx">DateTime</span><span class="w">  </span><span class="kd">@updatedAt</span>
<span class="p">}</span>

<span class="kd">enum</span><span class="w"> </span><span class="nx">Role</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ADMIN</span>
<span class="w">  </span><span class="nx">MANAGER</span>
<span class="w">  </span><span class="nx">VIEWER</span>
<span class="p">}</span>

<span class="nx">model</span><span class="w"> </span><span class="nx">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="w">          </span><span class="nb">String</span><span class="w">   </span><span class="kd">@id</span><span class="w"> </span><span class="kd">@default</span><span class="p">(</span><span class="nx">cuid</span><span class="p">())</span>
<span class="w">  </span><span class="nx">name</span><span class="w">        </span><span class="nb">String</span>
<span class="w">  </span><span class="nx">description</span><span class="w"> </span><span class="nb">String</span>
<span class="w">  </span><span class="nx">price</span><span class="w">       </span><span class="nx">Float</span>
<span class="w">  </span><span class="nx">inventory</span><span class="w">   </span><span class="nx">Int</span>
<span class="w">  </span><span class="nx">published</span><span class="w">   </span><span class="nb">Boolean</span><span class="w">  </span><span class="kd">@default</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="w">   </span><span class="nx">DateTime</span><span class="w"> </span><span class="kd">@default</span><span class="p">(</span><span class="nx">now</span><span class="p">())</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="w">   </span><span class="nx">DateTime</span><span class="w"> </span><span class="kd">@updatedAt</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="permission-matrix">Permission Matrix</h3>
<p>Define what each role can do:</p>
<table>
<thead>
<tr>
<th>Action</th>
<th>Admin</th>
<th>Manager</th>
<th>Viewer</th>
</tr>
</thead>
<tbody>
<tr>
<td>View products</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Create product</td>
<td>‚úÖ</td>
<td>‚ùå</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Edit product</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Delete product</td>
<td>‚úÖ</td>
<td>‚ùå</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Publish</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚ùå</td>
</tr>
<tr>
<td>View orders</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
<td>‚úÖ</td>
</tr>
<tr>
<td>Manage users</td>
<td>‚úÖ</td>
<td>‚ùå</td>
<td>‚ùå</td>
</tr>
</tbody>
</table>
<h3 id="permission-helper-functions">Permission Helper Functions</h3>
<p>Create reusable permission checks:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/permissions.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Session</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next-auth&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">Permission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;products:view&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;products:create&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;products:publish&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;orders:view&#39;</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;users:manage&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">rolePermissions</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">Permission</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ADMIN</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;products:view&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:create&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:edit&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:delete&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:publish&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;orders:view&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;users:manage&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">MANAGER</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;products:view&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:edit&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;products:publish&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;orders:view&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">VIEWER</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;products:view&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;orders:view&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="kt">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">permission</span><span class="o">:</span><span class="w"> </span><span class="kt">Permission</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">permissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rolePermissions</span><span class="p">[</span><span class="nx">userRole</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">permission</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">requirePermission</span><span class="p">(</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="kt">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">permission</span><span class="o">:</span><span class="w"> </span><span class="kt">Permission</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">permission</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Missing permission: </span><span class="si">${</span><span class="nx">permission</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">hasAnyPermission</span><span class="p">(</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="kt">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">permissions</span><span class="o">:</span><span class="w"> </span><span class="kt">Permission</span><span class="p">[]</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">permissions</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">hasAllPermissions</span><span class="p">(</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="kt">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">permissions</span><span class="o">:</span><span class="w"> </span><span class="kt">Permission</span><span class="p">[]</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">permissions</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="protected-product-list-page">Protected Product List Page</h3>
<p>Show different UI based on permissions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/page.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasPermission</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Link</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/link&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In production: fetch from database</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">29.99</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">49.99</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">19.99</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span><span class="w"> </span><span class="nx">published</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Check if user can view products</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:view&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getProducts</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canCreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:create&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex justify-between items-center mb-8&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold&quot;</span><span class="p">&gt;</span><span class="nx">Products</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">canCreate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">Link</span>
<span class="w">            </span><span class="na">href</span><span class="o">=</span><span class="s">&quot;/admin/products/new&quot;</span>
<span class="w">            </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700&quot;</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="nx">Create</span><span class="w"> </span><span class="nx">Product</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;grid gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">product</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border p-4 rounded flex justify-between items-center&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-bold&quot;</span><span class="p">&gt;{</span><span class="nx">product</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">Price</span><span class="o">:</span><span class="w"> </span><span class="kt">$</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">price</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600&quot;</span><span class="p">&gt;</span><span class="nx">Stock</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">inventory</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`inline-block px-2 py-1 text-xs rounded </span><span class="si">${</span>
<span class="w">                </span><span class="nx">product</span><span class="p">.</span><span class="nx">published</span><span class="w"> </span>
<span class="w">                  </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;bg-green-100 text-green-800&#39;</span><span class="w"> </span>
<span class="w">                  </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bg-gray-100 text-gray-800&#39;</span>
<span class="w">              </span><span class="si">}</span><span class="sb">`</span><span class="p">}&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">published</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Published&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Draft&#39;</span><span class="p">}</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex gap-2&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">{</span><span class="nx">canEdit</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">Link</span>
<span class="w">                  </span><span class="na">href</span><span class="o">=</span><span class="p">{</span><span class="sb">`/admin/products/</span><span class="si">${</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/edit`</span><span class="p">}</span>
<span class="w">                  </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700&quot;</span>
<span class="w">                </span><span class="p">&gt;</span>
<span class="w">                  </span><span class="nx">Edit</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">Link</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">)}</span>
<span class="w">              </span><span class="p">{</span><span class="nx">canDelete</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">                  </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700&quot;</span>
<span class="w">                </span><span class="p">&gt;</span>
<span class="w">                  </span><span class="nx">Delete</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">)}</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>What each role sees</strong>:</p>
<p><strong>Admin</strong>:
- "Create Product" button visible
- "Edit" button on each product
- "Delete" button on each product</p>
<p><strong>Manager</strong>:
- No "Create Product" button
- "Edit" button on each product
- No "Delete" button</p>
<p><strong>Viewer</strong>:
- No "Create Product" button
- No "Edit" button
- No "Delete" button
- Read-only view</p>
<h3 id="protected-server-actions">Protected Server Actions</h3>
<p>Implement role-based Server Actions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/actions.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requirePermission</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createProduct</span><span class="p">(</span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:create&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Validate</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">price</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">inventory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Missing required fields&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// In production: await db.product.create({ data: { name, price, inventory } })</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Creating product:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/admin/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// In production: await db.product.update({ where: { id }, data: { name, price, inventory } })</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Updating product:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">inventory</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/admin/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/admin/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// In production: await db.product.delete({ where: { id } })</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Deleting product:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/admin/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">publishProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:publish&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// In production: await db.product.update({ where: { id }, data: { published: true } })</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Publishing product:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>

<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/admin/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/admin/products/</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-failure-client-side-permission-checks">The Failure: Client-Side Permission Checks</h3>
<p>What if we only check permissions in the UI?</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå BAD - Only hiding the button</span>
<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">canDelete</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">deleteProduct</span><span class="p">(</span><span class="nx">productId</span><span class="p">)}&gt;</span>
<span class="w">          </span><span class="nx">Delete</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Attack</strong>: Manager opens DevTools and runs:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// In browser console</span>
<span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/actions&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
<span class="w">    </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;deleteProduct&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;product-123&#39;</span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">});</span>
</code></pre></div>

<p><strong>If Server Action doesn't check permissions</strong>:</p>
<div class="codehilite"><pre><span></span><code>Product deleted successfully
</code></pre></div>

<p><strong>Diagnostic Analysis</strong>:</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/actions 200 OK
Response: { success: true }
</code></pre></div>

<p><strong>Network Tab</strong>:
- Request to Server Action succeeds
- No permission check on server</p>
<p><strong>Root cause</strong>: UI hides the button, but Server Action is still callable.</p>
<p><strong>Solution</strong>: Always check permissions in Server Actions (as shown above with <code>requirePermission</code>).</p>
<h3 id="protected-api-routes">Protected API Routes</h3>
<p>Protect API endpoints with the same permission system:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/admin/products/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasPermission</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:view&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Fetch products</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Product 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">29.99</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">products</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:create&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Create product</span>
<span class="w">  </span><span class="c1">// await db.product.create({ data: body })</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/admin/products/[id]/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasPermission</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">PATCH</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Update product</span>
<span class="w">  </span><span class="c1">// await db.product.update({ where: { id: params.id }, data: body })</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Delete product</span>
<span class="w">  </span><span class="c1">// await db.product.delete({ where: { id: params.id } })</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="testing-role-based-access">Testing Role-Based Access</h3>
<p>Create test users with different roles:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/auth.ts - Update getUserFromDatabase</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUserFromDatabase</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;admin@example.com&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Admin User&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ADMIN&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">passwordHash</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$2a$10$...&#39;</span><span class="w"> </span><span class="c1">// bcrypt hash of &#39;password123&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s1">&#39;manager@example.com&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;manager@example.com&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Manager User&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;MANAGER&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">passwordHash</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$2a$10$...&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s1">&#39;viewer@example.com&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;viewer@example.com&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Viewer User&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;VIEWER&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">passwordHash</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;$2a$10$...&#39;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">users</span><span class="p">[</span><span class="nx">email</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Test scenarios</strong>:</p>
<p><strong>Test 1: Admin can delete</strong>
1. Log in as admin@example.com
2. Visit <code>/admin/products</code>
3. Click "Delete" on a product
4. <strong>Expected</strong>: Product deleted, success message
5. <strong>Actual</strong>: ‚úÖ Works</p>
<p><strong>Test 2: Manager cannot delete</strong>
1. Log in as manager@example.com
2. Visit <code>/admin/products</code>
3. "Delete" button not visible
4. Try to call Server Action directly in console:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">deleteProduct</span><span class="p">(</span><span class="s1">&#39;product-123&#39;</span><span class="p">);</span>
</code></pre></div>

<ol>
<li><strong>Expected</strong>: Error "Missing permission: products:delete"</li>
<li><strong>Actual</strong>: ‚úÖ Error thrown</li>
</ol>
<p><strong>Test 3: Viewer cannot edit</strong>
1. Log in as viewer@example.com
2. Visit <code>/admin/products</code>
3. No "Edit" or "Delete" buttons visible
4. Try to visit <code>/admin/products/1/edit</code> directly
5. <strong>Expected</strong>: Redirect to <code>/unauthorized</code>
6. <strong>Actual</strong>: ‚úÖ Redirected</p>
<h3 id="advanced-pattern-resource-level-permissions">Advanced Pattern: Resource-Level Permissions</h3>
<p>Sometimes permissions depend on the specific resource:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// lib/permissions.ts</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="p">(</span>
<span class="w">  </span><span class="nx">session</span><span class="o">:</span><span class="w"> </span><span class="kt">Session</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Admins can edit any product</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ADMIN&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Managers can only edit their own products</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;MANAGER&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// In production: check if user created this product</span>
<span class="w">    </span><span class="c1">// const product = await db.product.findUnique({</span>
<span class="w">    </span><span class="c1">//   where: { id: productId },</span>
<span class="w">    </span><span class="c1">//   select: { createdById: true }</span>
<span class="w">    </span><span class="c1">// });</span>
<span class="w">    </span><span class="c1">// return product?.createdById === session.user.id;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// Simplified for demo</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Use in Server Actions:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/actions.ts</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">await</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;You cannot edit this product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Update product</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-user-can-see-ui-elements-they-cant-use">Symptom: User can see UI elements they can't use</h4>
<p><strong>Browser behavior</strong>:
- Edit button visible
- Clicking it shows "Forbidden" error</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/admin/products/123 403 Forbidden
{ error: &quot;Forbidden&quot; }
</code></pre></div>

<p><strong>Root cause</strong>: UI permission check missing or incorrect</p>
<p><strong>Solution</strong>: Check permissions before rendering UI elements:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span><span class="nx">Edit</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">)}</span>
</code></pre></div>

<h4 id="symptom-permission-check-passes-but-action-fails">Symptom: Permission check passes but action fails</h4>
<p><strong>Browser behavior</strong>:
- Button visible and clickable
- Action fails with "Unauthorized"</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Missing</span><span class="w"> </span><span class="n">permission</span><span class="o">:</span><span class="w"> </span><span class="n">products</span><span class="o">:</span><span class="n">delete</span>
</code></pre></div>

<p><strong>Root cause</strong>: UI checks different permission than Server Action</p>
<p><strong>Solution</strong>: Use the same permission constants everywhere:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚úÖ GOOD - Same permission constant</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">canDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="c1">// In Server Action</span>
<span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>
</code></pre></div>

<h4 id="symptom-middleware-allows-access-but-page-denies-it">Symptom: Middleware allows access but page denies it</h4>
<p><strong>Browser behavior</strong>:
- Page loads
- Shows "Unauthorized" message</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>GET /admin/products 200 OK
(Page renders with &quot;Unauthorized&quot; message)
</code></pre></div>

<p><strong>Root cause</strong>: Middleware checks role, page checks specific permission</p>
<p><strong>Solution</strong>: Align middleware and page checks:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts - Check role</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;ADMIN&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// page.tsx - Check specific permission</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:view&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-complete-journey-from-broken-to-secure">The Complete Journey: From Broken to Secure</h3>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Approach</th>
<th>Vulnerability</th>
<th>Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Client-only auth</td>
<td>Everything exposed</td>
<td>Move to server</td>
</tr>
<tr>
<td>1</td>
<td>Server Components</td>
<td>API routes unprotected</td>
<td>Add API validation</td>
</tr>
<tr>
<td>2</td>
<td>Middleware</td>
<td>Server Actions unprotected</td>
<td>Check in every action</td>
</tr>
<tr>
<td>3</td>
<td>Role-based UI</td>
<td>Permissions not enforced</td>
<td>Add permission system</td>
</tr>
<tr>
<td>4</td>
<td>Permission system</td>
<td>UI and server checks misaligned</td>
<td>Use same permission checks</td>
</tr>
<tr>
<td>5</td>
<td>Resource-level (current)</td>
<td>All managers can edit everything</td>
<td>Check resource ownership too</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation-production-ready-auth">Final Implementation: Production-Ready Auth</h3>
<p>Here's the complete, secure implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// middleware.ts - First line of defense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">auth</span><span class="p">((</span><span class="nx">req</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Public routes</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Require authentication</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">loginUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">    </span><span class="nx">loginUrl</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;callbackUrl&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">loginUrl</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Admin routes require admin role</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/admin&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="s1">&#39;ADMIN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;MANAGER&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VIEWER&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">matcher</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/admin/:path*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/api/admin/:path*&#39;</span><span class="p">],</span>
<span class="p">};</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/page.tsx - Second line of defense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasPermission</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">redirect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ProductsPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:view&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canCreate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:create&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canEdit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:edit&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Render UI based on permissions</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">canCreate</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">CreateButton</span><span class="w"> </span><span class="p">/&gt;}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">products</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">product</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ProductCard</span>
<span class="w">          </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
<span class="w">          </span><span class="na">product</span><span class="o">=</span><span class="p">{</span><span class="nx">product</span><span class="p">}</span>
<span class="w">          </span><span class="na">canEdit</span><span class="o">=</span><span class="p">{</span><span class="nx">canEdit</span><span class="p">}</span>
<span class="w">          </span><span class="na">canDelete</span><span class="o">=</span><span class="p">{</span><span class="nx">canDelete</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">))}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/admin/products/actions.ts - Third line of defense</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">requirePermission</span><span class="p">,</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteProduct</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>
<span class="w">  </span><span class="nx">requirePermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Additional resource-level check</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">await</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Cannot delete this product&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Delete product</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="ow">delete</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/admin/products&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// app/api/admin/products/[id]/route.ts - Fourth line of defense</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">auth</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/auth&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasPermission</span><span class="p">,</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/permissions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">auth</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">hasPermission</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;products:delete&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">await</span><span class="w"> </span><span class="nx">canEditProduct</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Forbidden&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="ow">delete</span><span class="p">({</span><span class="w"> </span><span class="nx">where</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">params.id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="decision-framework-when-to-use-which-auth-pattern">Decision Framework: When to Use Which Auth Pattern</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Pattern</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Protect entire route tree</td>
<td>Middleware</td>
<td>Runs before any code executes</td>
</tr>
<tr>
<td>Show/hide UI elements</td>
<td>Client-side permission</td>
<td>Better UX, but not security</td>
</tr>
<tr>
<td>Protect data mutations</td>
<td>Server Action validation</td>
<td>Mutations must always validate</td>
</tr>
<tr>
<td>Protect API endpoints</td>
<td>API route validation</td>
<td>External access requires validation</td>
</tr>
<tr>
<td>Resource-specific permissions</td>
<td>Resource-level checks</td>
<td>Permissions depend on specific data</td>
</tr>
<tr>
<td>Multi-tenant applications</td>
<td>Tenant-scoped queries</td>
<td>Isolate data by tenant ID</td>
</tr>
<tr>
<td>Temporary access (share links)</td>
<td>Time-limited tokens</td>
<td>Token expires after set duration</td>
</tr>
<tr>
<td>Third-party API access</td>
<td>API keys + rate limiting</td>
<td>Different auth mechanism for external</td>
</tr>
<tr>
<td>Audit trail requirements</td>
<td>Log all permission checks</td>
<td>Track who accessed what and when</td>
</tr>
</tbody>
</table>
<h3 id="lessons-learned">Lessons Learned</h3>
<p><strong>1. Defense in depth</strong>: Check permissions at every layer
- Middleware: Protect routes
- Page: Check before rendering
- Server Action: Validate before mutation
- API Route: Validate before data access</p>
<p><strong>2. Client-side checks are UX, not security</strong>: Always validate on the server</p>
<p><strong>3. Use a permission system</strong>: Don't hardcode role checks everywhere</p>
<p><strong>4. Test with different roles</strong>: Create test users for each role</p>
<p><strong>5. Resource-level permissions matter</strong>: Not all admins should access all resources</p>
<p><strong>6. Audit and log</strong>: Track permission checks for security analysis</p>
<p><strong>7. Keep middleware fast</strong>: No database queries or external API calls</p>
<p><strong>8. Align UI and server checks</strong>: Use the same permission constants</p>
<p>The journey from broken client-side auth to production-ready role-based access control is about understanding that security is not a single check‚Äîit's a layered system where each layer validates independently, and the UI is merely a reflection of what the server allows.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 12:33:30 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>