<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18 API Routes and Server Actions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-18-api-routes-and-server-actions">Chapter 18: API Routes and Server Actions</h1>
<h2 id="building-api-endpoints">Building API endpoints</h2>
<h2 id="the-server-side-connection">The Server-Side Connection</h2>
<p>So far, our applications have been primarily self-contained on the client. But real-world applications need to persist data, communicate with databases, and perform secure operations. This requires a backend‚Äîa server-side component that our React components can talk to.</p>
<p>In Next.js, you don't need a separate Express or Node.js server. The framework provides two powerful mechanisms for building your backend logic directly within your project: <strong>API Routes</strong> and <strong>Server Actions</strong>.</p>
<p>This chapter will build a simple "Guestbook" application to explore both approaches. We'll see how each one works, where they shine, and how to handle real-world challenges like form submissions, data validation, and error handling.</p>
<h3 id="phase-1-establish-the-reference-implementation">Phase 1: Establish the Reference Implementation</h3>
<p>Our anchor example is a Guestbook. Users can enter their name and a message, submit it, and see it appear in a list of entries.</p>
<p>Let's start by building the UI components and a mock database.</p>
<p><strong>Project Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">app</span><span class="o">/</span>
‚îÇ<span class="w">   </span>‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">page.tsx</span><span class="w">              </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">list</span>
‚îÇ<span class="w">   </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">layout.tsx</span>
‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">lib</span><span class="o">/</span>
‚îÇ<span class="w">   </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">db.ts</span><span class="w">                 </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">simple</span><span class="w"> </span><span class="kr">in</span><span class="o">-</span><span class="n">memory</span><span class="w"> </span><span class="s">&quot;database&quot;</span>
‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">components</span><span class="o">/</span>
<span class="w">    </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">GuestbookForm.tsx</span><span class="w">     </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">component</span>
</code></pre></div>

<p>First, our mock database. This will just be an in-memory array to keep things simple. In a real app, this would connect to a service like Postgres, MongoDB, or Supabase.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/db.ts</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">GuestbookEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// In-memory array to act as our database</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="o">:</span><span class="w"> </span><span class="kt">GuestbookEntry</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Ada Lovelace&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;The Analytical Engine has no pretensions whatever to originate anything.&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">];</span>

<span class="c1">// Simulate database operations</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">getEntries</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">GuestbookEntry</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Sort by most recent</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[...</span><span class="nx">entries</span><span class="p">].</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">addEntry</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">(</span><span class="nx">entry</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">GuestbookEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newEntry</span><span class="o">:</span><span class="w"> </span><span class="kt">GuestbookEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span>
<span class="w">      </span><span class="p">...</span><span class="nx">entry</span><span class="p">,</span>
<span class="w">      </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newEntry</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newEntry</span><span class="p">;</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>

<p>Next, the main page component, which will fetch and display the entries. We'll make this a Server Component to fetch data directly.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/page.tsx</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">GuestbookEntry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/GuestbookForm&#39;</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookEntriesList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">getEntries</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-8 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-2xl font-semibold&quot;</span><span class="p">&gt;</span><span class="nx">Entries</span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">entries</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-4 border rounded-lg bg-gray-50&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold&quot;</span><span class="p">&gt;{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-700&quot;</span><span class="p">&gt;{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">message</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xs text-gray-400 mt-2&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">entry</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">()}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">))}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">main</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-8&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-4xl font-bold&quot;</span><span class="p">&gt;</span><span class="nx">Guestbook</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-gray-600 mt-2&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="nx">Leave</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">future</span><span class="w"> </span><span class="nx">visitors</span><span class="p">.</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">GuestbookForm</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">GuestbookEntriesList</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Finally, our form component. This must be a Client Component (<code>"use client"</code>) because it uses <code>useState</code> and handles user interaction. For now, its <code>onSubmit</code> handler will just log the form data to the console. This is our starting point‚Äîa UI with no backend connection.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">FormEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">setName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Form submitted with:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="c1">// How do we send this to the server?</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Name</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span>
<span class="w">          </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setName</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500&quot;</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Message</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">message</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500&quot;</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="nx">Sign</span><span class="w"> </span><span class="nx">Guestbook</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-1-connecting-the-form-with-an-api-route">Iteration 1: Connecting the Form with an API Route</h3>
<p>Our form is isolated on the client. It collects data, but has no way to send it to the server to be saved in our "database". This is the classic use case for an API endpoint.</p>
<p>In Next.js App Router, you create API endpoints by creating a <code>route.ts</code> (or <code>.js</code>) file inside a folder within the <code>app</code> directory. The folder path determines the URL. For a <code>/api/guestbook</code> endpoint, we create <code>app/api/guestbook/route.ts</code>.</p>
<p>Inside this file, you export named functions corresponding to HTTP methods: <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>, etc.</p>
<p>Let's create a <code>POST</code> handler to receive our guestbook data.</p>
<p><strong>Project Structure Update</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="w">    </span>‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="w">    </span>‚îÇ<span class="w">   </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">guestbook</span><span class="o">/</span>
<span class="w">    </span>‚îÇ<span class="w">       </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">route.ts</span><span class="w">      </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">endpoint</span>
<span class="w">    </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">page.tsx</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/guestbook/route.ts</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Parse the incoming request body</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Basic validation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Name and message are required&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. Add the entry to the database</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">addEntry</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// 3. Return a success response</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">newEntry</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">201</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to create guestbook entry:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Internal Server Error&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now we have a server endpoint waiting for requests at <code>POST /api/guestbook</code>. Let's update our <code>GuestbookForm</code> to send its data there using the <code>fetch</code> API.</p>
<p>We also need a way to tell the <code>GuestbookEntriesList</code> to refresh after a new entry is added. A simple way is to use <code>router.refresh()</code> from <code>next/navigation</code>, which re-fetches data for the current route (in our case, re-running the Server Component that calls <code>db.getEntries()</code>).</p>
<p><strong>Before</strong> (Iteration 0):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (snippet)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Form submitted with:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="c1">// How do we send this to the server?</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>After</strong> (Iteration 1):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (updated)</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">FormEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRouter</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">setName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/guestbook&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">errorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">errorData</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Something went wrong&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Clear form</span>
<span class="w">      </span><span class="nx">setName</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setMessage</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Refresh the page to show the new entry</span>
<span class="w">      </span><span class="nx">router</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setError</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;An unknown error occurred&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... form inputs ... */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;...&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="w"> </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setName</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="p">&gt;...&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">message</span><span class="p">}</span><span class="w"> </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span>
<span class="w">        </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isLoading</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isLoading</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sign Guestbook&#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-red-500 mt-2&quot;</span><span class="p">&gt;{</span><span class="nx">error</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-checking-the-network">Verification: Checking the Network</h3>
<p>Let's run the app and submit the form.</p>
<p><strong>Browser Behavior</strong>:
The user fills out the form, clicks "Sign Guestbook". The button text changes to "Submitting...". After a moment, the form clears, the button becomes active again, and the new entry appears at the top of the list without a full page reload.</p>
<p><strong>Browser DevTools - Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="n">URL</span><span class="p">:</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">3000</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">guestbook</span>
<span class="o">-</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="n">Method</span><span class="p">:</span><span class="w"> </span><span class="n">POST</span>
<span class="o">-</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">Code</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span><span class="w"> </span><span class="n">Created</span>
<span class="o">-</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="n">Payload</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Charlie&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">}</span>
<span class="o">-</span><span class="w"> </span><span class="n">Response</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Charlie&quot;</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">}</span>
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:
1.  <strong>What the user experiences</strong>: A smooth, interactive form submission. The UI provides feedback (loading state) and updates automatically.
2.  <strong>What the network reveals</strong>: Our client-side <code>fetch</code> call correctly sent a <code>POST</code> request to our API route. The server processed it and returned a <code>201 Created</code> status, confirming success.
3.  <strong>Root cause identified</strong>: We have successfully bridged the client-server gap. The client component captures user input, and the API route provides a server-side handler to process and persist that data.</p>
<p>This is the traditional, battle-tested way of handling data mutations in web applications. It's explicit, follows standard REST principles, and works well. However, notice the amount of client-side boilerplate we had to write: <code>useState</code> for loading and error states, the <code>fetch</code> call with its headers and body, JSON stringification, and response parsing.</p>
<p><strong>Limitation preview</strong>: This works, but it's a lot of manual work on the client. Could we simplify this? What if we could just call a server function directly from our component, without all the <code>fetch</code> ceremony?</p>
<h2 id="server-actions-mutations-without-api-routes">Server Actions: mutations without API routes</h2>
<h2 id="a-more-direct-approach">A More Direct Approach</h2>
<p>The API Route approach works, but it creates a separation. You have client-side logic for <em>calling</em> the API and server-side logic for <em>implementing</em> the API. This often leads to boilerplate code on the client to manage the state of the request (loading, error, success).</p>
<p>Server Actions, introduced with the App Router, offer a more integrated model. They allow you to define a function on the server that can be called directly from your client components as if it were a regular JavaScript function. Next.js handles the underlying network request for you.</p>
<h3 id="iteration-2-refactoring-to-a-server-action">Iteration 2: Refactoring to a Server Action</h3>
<p>Let's refactor our Guestbook to use a Server Action instead of an API Route.</p>
<p><strong>Step 1: Define the Action</strong></p>
<p>Server Actions are asynchronous functions defined with the <code>"use server";</code> directive at the top of the function body or the top of the file. It's common practice to keep them in a separate <code>actions.ts</code> file.</p>
<p><strong>Project Structure Update</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">app</span><span class="o">/</span>
‚îÇ<span class="w">   </span>‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">actions.ts</span><span class="w">            </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Action</span><span class="w"> </span><span class="n">file</span>
‚îÇ<span class="w">   </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">page.tsx</span>
‚îú‚îÄ‚îÄ<span class="w"> </span><span class="n">lib</span><span class="o">/</span>
‚îÇ<span class="w">   </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">db.ts</span>
‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">components</span><span class="o">/</span>
<span class="w">    </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">GuestbookForm.tsx</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions.ts</span>

<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Basic validation</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Name and message are required&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">addEntry</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// Revalidate the page to show the new entry</span>
<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>A few key things to note here:
1.  <code>'use server';</code>: This directive marks this function (and all others in the file) as code that should only ever run on the server.
2.  <code>data: FormData</code>: Server Actions invoked from a <code>&lt;form&gt;</code> naturally receive a <code>FormData</code> object, which is a standard web API for representing form data.
3.  <code>revalidatePath('/')</code>: This is the Server Action equivalent of <code>router.refresh()</code>. It tells Next.js to purge the cache for the specified path (<code>/</code>), forcing a re-fetch of the data for that page on the next visit. This is how our list of entries will update.</p>
<p><strong>Step 2: Update the Form Component</strong></p>
<p>Now, we can dramatically simplify our <code>GuestbookForm</code> component. We no longer need <code>useState</code> for loading/error, <code>fetch</code>, or <code>useRouter</code>. We can just pass our server action directly to the <code>&lt;form&gt;</code>'s <code>action</code> prop.</p>
<p><strong>Before</strong> (Iteration 1 - API Route):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (API Route version)</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">FormEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRouter</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">setName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">setMessage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/guestbook&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... fetch options ... */</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="c1">// ... error handling, router.refresh(), etc. ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ... catch block ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* ... inputs and button with disabled state ... */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>After</strong> (Iteration 2 - Server Action):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (Server Action version)</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addEntry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
<span class="w">        </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">      </span><span class="p">}}</span>
<span class="w">      </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Name</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="na">The</span><span class="w"> </span><span class="err">&#39;</span><span class="na">name</span><span class="err">&#39;</span><span class="w"> </span><span class="na">attribute</span><span class="w"> </span><span class="na">is</span><span class="w"> </span><span class="na">crucial</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="na">FormData</span>
<span class="w">          </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500&quot;</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Message</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="na">The</span><span class="w"> </span><span class="err">&#39;</span><span class="na">name</span><span class="err">&#39;</span><span class="w"> </span><span class="na">attribute</span><span class="w"> </span><span class="na">is</span><span class="w"> </span><span class="na">crucial</span><span class="w"> </span><span class="na">for</span><span class="w"> </span><span class="na">FormData</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500&quot;</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="nx">Sign</span><span class="w"> </span><span class="nx">Guestbook</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="analysis-what-just-happened">Analysis: What Just Happened?</h3>
<p>The client component is now incredibly simple.
- No <code>useState</code> for name/message (uncontrolled component).
- No <code>useState</code> for loading/error.
- No <code>useEffect</code> or <code>useRouter</code>.
- No <code>fetch</code> call.</p>
<p>We pass the server function <code>addEntry</code> to the <code>action</code> prop of the form. When the form is submitted, Next.js:
1.  Intercepts the form submission.
2.  Serializes the form data.
3.  Sends a <code>POST</code> request to a special, auto-generated endpoint on the server.
4.  Invokes our <code>addEntry</code> Server Action with the form data.
5.  Handles the pending UI state automatically (more on this later).</p>
<p><strong>Verification</strong>:
Run the app. The form works identically to the user. But if you inspect the network tab, you'll see a <code>POST</code> request, not to <code>/api/guestbook</code>, but to the current page URL (<code>/</code>). The request payload is no longer JSON but <code>FormData</code>. Next.js is managing this RPC (Remote Procedure Call) for us.</p>
<p><strong>Improvement</strong>:
The amount of client-side code has been reduced by over 50%. We've removed manual state management for the request lifecycle and eliminated the need to create and maintain a separate API route file. The logic for mutating data is now co-located with the data fetching (<code>revalidatePath</code>) in a single server-side function.</p>
<p><strong>Limitation preview</strong>: Our form is sleek and simple, but it relies entirely on client-side JavaScript to function. What happens if a user has JavaScript disabled or is on a very slow network where the JS hasn't loaded yet?</p>
<h2 id="form-handling-with-progressive-enhancement">Form handling with progressive enhancement</h2>
<h2 id="the-power-of-the-platform">The Power of the Platform</h2>
<p>One of the most significant advantages of Server Actions is their ability to work seamlessly with the fundamentals of the web platform, specifically HTML forms. This enables <strong>progressive enhancement</strong>: building a baseline experience that works without JavaScript, which is then enhanced when JavaScript becomes available.</p>
<h3 id="iteration-3-demonstrating-the-failure">Iteration 3: Demonstrating the Failure</h3>
<p>Let's see what happens to our current Server Action implementation if JavaScript is disabled.</p>
<p><strong>How to Simulate</strong>:
1.  Open your browser's Developer Tools.
2.  In Chrome/Edge, press <code>Ctrl+Shift+P</code> (or <code>Cmd+Shift+P</code> on Mac) to open the Command Menu.
3.  Type "Disable JavaScript" and press Enter.
4.  Refresh the page.</p>
<p>Now, try to submit the guestbook form.</p>
<h3 id="diagnostic-analysis-reading-the-failure">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>Browser Behavior</strong>:
You fill out the form and click "Sign Guestbook". Absolutely nothing happens. The form remains filled, the button does nothing. It's completely broken.</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>(empty - no JavaScript is running to log anything)
</code></pre></div>

<p><strong>Network Tab Analysis</strong>:</p>
<div class="codehilite"><pre><span></span><code>(empty - no request is made when the button is clicked)
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li><strong>What the user experiences</strong>: A dead form. It looks interactive but is non-functional.</li>
<li><strong>What the console reveals</strong>: Nothing, which is the key clue. Our event handlers aren't firing.</li>
<li><strong>Root cause identified</strong>: Our <code>&lt;form action={...}&gt;</code> relies on a client-side JavaScript wrapper to intercept the submit event and trigger the Server Action RPC call. Without JavaScript, the form has no default submission behavior and does nothing.</li>
<li><strong>Why the current approach can't solve this</strong>: It's fundamentally a JS-driven solution.</li>
<li><strong>What we need</strong>: A way to tell the browser where to send the form data using standard HTML, so it works even without client-side scripting.</li>
</ol>
<h3 id="iteration-4-achieving-progressive-enhancement">Iteration 4: Achieving Progressive Enhancement</h3>
<p>The fix is surprisingly simple. Instead of passing an async function to the <code>action</code> prop, we just pass the Server Action <em>itself</em>.</p>
<p><strong>Before</strong> (Iteration 2 - JS-dependent action):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (snippet)</span>

<span class="c1">// ...</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="p">&lt;</span><span class="nt">form</span>
<span class="w">    </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span>
<span class="w">    </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
<span class="w">      </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span><span class="w"> </span><span class="c1">// This part requires JS</span>
<span class="w">    </span><span class="p">}}</span>
<span class="w">    </span><span class="err">//</span><span class="w"> </span><span class="na">...</span>
<span class="w">  </span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div>

<p><strong>After</strong> (Iteration 3 - Progressively Enhanced):</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (updated)</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="c1">// We no longer need useRef for this basic version</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addEntry</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Note: We lose the ability to reset the form on the client</span>
<span class="w">  </span><span class="c1">// without JS. We will address state handling in the next section.</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">addEntry</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;</span><span class="nx">Name</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="p">&gt;</span><span class="nx">Message</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span><span class="nx">Sign</span><span class="w"> </span><span class="nx">Guestbook</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-it-just-works">Verification: It Just Works</h3>
<p>With JavaScript still disabled, refresh the page and submit the form again.</p>
<p><strong>Browser Behavior (JS Disabled)</strong>:
The page performs a full refresh. After reloading, the new guestbook entry is visible at the top of the list. The form has successfully submitted.</p>
<p><strong>Browser Behavior (JS Enabled)</strong>:
Now, re-enable JavaScript and submit the form. The behavior is identical to before: a smooth, client-side update without a full page refresh.</p>
<p><strong>What's happening under the hood?</strong></p>
<p>When you pass a Server Action directly to <code>&lt;form action={...}&gt;</code>, Next.js does two things:
1.  <strong>For non-JS clients</strong>: It renders a standard HTML <code>&lt;form&gt;</code> with the <code>action</code> attribute pointing to a special Next.js endpoint. The browser handles the submission as a normal form post, leading to a full page reload.
2.  <strong>For JS clients</strong>: It still renders the standard HTML form, but it also "hydrates" it with a client-side script. This script intercepts the <code>submit</code> event, prevents the full page reload, and performs the RPC call in the background, providing the smooth SPA-like experience.</p>
<p>This is the essence of progressive enhancement. The form is functional at its core using platform primitives and is then enhanced for a better user experience when JavaScript is available.</p>
<p><strong>Limitation preview</strong>: This is great, but we've lost our loading and error states. If the submission takes time, the user gets no feedback. And if the user submits invalid data (e.g., an empty name), the form just reloads with no indication of what went wrong. We need to handle server-side validation and communicate the form's state back to the user.</p>
<h2 id="error-handling-and-validation">Error handling and validation</h2>
<h2 id="building-resilient-forms">Building Resilient Forms</h2>
<p>A form without validation is a bug waiting to happen. We need to ensure that the data submitted by the user meets our requirements before we save it to the database. This validation must happen on the server, as client-side validation can be easily bypassed.</p>
<p>We also need a way to communicate the results‚Äîsuccess or failure‚Äîback to the user.</p>
<h3 id="the-problem-handling-invalid-data">The Problem: Handling Invalid Data</h3>
<p>Let's modify our Server Action to throw an error if the message is too short.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions.ts (updated)</span>

<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Name and message are required&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Message must be at least 5 characters long.&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// New validation</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">addEntry</span><span class="p">({</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Now, run the application and try to submit a message with fewer than 5 characters, like "hi".</p>
<h3 id="diagnostic-analysis-reading-the-failure_1">Diagnostic Analysis: Reading the Failure</h3>
<p><strong>Browser Behavior</strong>:
The application crashes. The user is shown the Next.js error overlay with the message "Error: Message must be at least 5 characters long." This is a terrible user experience. We should never show raw error pages for simple validation failures.</p>
<p><strong>Terminal Output (Next.js Server)</strong>:</p>
<div class="codehilite"><pre><span></span><code>-<span class="w"> </span>error<span class="w"> </span>src/app/actions.ts<span class="w"> </span><span class="o">(</span><span class="m">14</span>:10<span class="o">)</span><span class="w"> </span>@<span class="w"> </span>addEntry
-<span class="w"> </span>error<span class="w"> </span>Error:<span class="w"> </span>Message<span class="w"> </span>must<span class="w"> </span>be<span class="w"> </span>at<span class="w"> </span>least<span class="w"> </span><span class="m">5</span><span class="w"> </span>characters<span class="w"> </span>long.
<span class="w">    </span>at<span class="w"> </span>addEntry<span class="w"> </span><span class="o">(</span>./src/app/actions.ts:18:11<span class="o">)</span>
<span class="w">    </span>...
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:
1.  <strong>What the user experiences</strong>: A full-page crash. They lose their input and are confused.
2.  <strong>What the server reveals</strong>: The <code>throw new Error(...)</code> call in our action resulted in an unhandled promise rejection, which Next.js treats as a fatal error for that request.
3.  <strong>Root cause identified</strong>: We are using exceptions (<code>throw</code>) for control flow. Errors should be reserved for unexpected server failures, not for predictable user input validation.
4.  <strong>What we need</strong>: A way for our Server Action to return structured data, including validation errors, that our component can use to render helpful feedback to the user without crashing the application.</p>
<h3 id="iteration-4-returning-structured-state-from-server-actions">Iteration 4: Returning Structured State from Server Actions</h3>
<p>Instead of throwing an error, a Server Action can return a JSON-serializable object. We can use this to communicate the form's state. Let's define a state shape and use a validation library like <code>zod</code> for more robust validation.</p>
<p>First, install zod: <code>npm install zod</code>.</p>
<p><strong>Project Structure Update</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="w">    </span>‚îî‚îÄ‚îÄ<span class="w"> </span><span class="n">validations.ts</span><span class="w">      </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="kr">for</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">Zod</span><span class="w"> </span><span class="n">schema</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/validations.ts</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">GuestbookSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Name cannot be empty.&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message must be at least 5 characters.&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="p">});</span>
</code></pre></div>

<p>Now, let's update our action to use this schema and return a structured state object.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions.ts (updated)</span>

<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GuestbookSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/validations&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">FormState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">errors</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">message?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prevState</span><span class="o">:</span><span class="w"> </span><span class="kt">FormState</span><span class="p">,</span>
<span class="w">  </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">FormState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 1. Validate the form data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">validatedFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GuestbookSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// 2. If validation fails, return the errors</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validatedFields</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Validation failed.&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="kt">validatedFields.error.flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 3. If validation succeeds, update the database</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">validatedFields</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Entry added successfully!&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to add entry.&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Notice the function signature has changed to <code>(prevState, formData)</code>. This is the signature required by the <code>useFormState</code> hook.</p>
<h3 id="the-useformstate-hook">The <code>useFormState</code> Hook</h3>
<p>React provides a hook, <code>useFormState</code>, specifically for managing form state with Server Actions. It takes the action and an initial state as arguments and returns the current state and a new action to pass to the form.</p>
<p>Let's create our final, robust <code>GuestbookForm</code> component.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx (final version)</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">,</span><span class="w"> </span><span class="nx">FormState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">initialState</span><span class="o">:</span><span class="w"> </span><span class="kt">FormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">};</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">      </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span>
<span class="w">      </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">      </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50&quot;</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sign Guestbook&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">(</span><span class="nx">addEntry</span><span class="p">,</span><span class="w"> </span><span class="nx">initialState</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span><span class="nx">Name</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full ...&quot;</span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-red-500 mt-1&quot;</span><span class="p">&gt;{</span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;block text-sm font-medium text-gray-700&quot;</span><span class="p">&gt;</span><span class="nx">Message</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-1 block w-full ...&quot;</span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-red-500 mt-1&quot;</span><span class="p">&gt;{</span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;text-green-500&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text-red-500&#39;</span><span class="p">}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="analysis-of-the-final-form">Analysis of the Final Form</h3>
<ol>
<li><strong><code>useFormState(addEntry, initialState)</code></strong>: This hook wires up our component to the server action. <code>state</code> will hold the return value of the last action execution. <code>formAction</code> is a new function that we pass to our <code>&lt;form&gt;</code>.</li>
<li><strong><code>useFormStatus()</code></strong>: This hook provides the pending status of the form submission. It <em>must</em> be used in a component that is a child of the <code>&lt;form&gt;</code>. This is why we created a separate <code>SubmitButton</code> component. It allows us to disable the button during submission without any manual <code>useState</code>.</li>
<li><strong>Displaying Errors</strong>: We can now read <code>state.errors</code> and display validation messages directly below the corresponding fields.</li>
<li><strong>Success/Failure Messages</strong>: We also display a general message from <code>state.message</code>, styled differently based on the <code>state.success</code> flag.</li>
</ol>
<p>This final version is robust, provides excellent user feedback, and maintains progressive enhancement. If JavaScript is disabled, the form will still submit, the page will reload, and the server can render the page with the validation messages included in the initial HTML.</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-server-action-doesnt-update-the-ui">Symptom: Server Action doesn't update the UI</h4>
<p><strong>Browser behavior</strong>: You submit the form, the network request succeeds, and you can see the data in the database if you check, but the list of entries on the page doesn't update.
<strong>Network Tab</strong>: A <code>POST</code> request to the page URL is successful (200 OK).
<strong>Root cause</strong>: You forgot to call <code>revalidatePath('/')</code> or <code>revalidateTag(...)</code> at the end of your successful Server Action. Next.js doesn't know it needs to refetch the data for the page.
<strong>Solution</strong>: Add <code>revalidatePath('/')</code> after the database operation in your action.</p>
<h4 id="symptom-useformstatus-returns-pending-false-always">Symptom: <code>useFormStatus</code> returns <code>pending: false</code> always</h4>
<p><strong>Browser behavior</strong>: The submit button is never disabled.
<strong>DevTools clues</strong>: Check your component tree.
<strong>Root cause</strong>: The component calling <code>useFormStatus</code> is not a descendant of the <code>&lt;form&gt;</code> element it's supposed to be tracking. It might be a sibling or a parent.
<strong>Solution</strong>: Extract the button (or any component using <code>useFormStatus</code>) into its own component and render it <em>inside</em> the <code>&lt;form&gt;</code>.</p>
<h4 id="symptom-type-error-property-x-does-not-exist-on-type-formdataentryvalue-null">Symptom: Type error <code>Property 'X' does not exist on type 'FormDataEntryValue | null'</code></h4>
<p><strong>Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>error<span class="w"> </span>TS2339:<span class="w"> </span>Property<span class="w"> </span><span class="s1">&#39;length&#39;</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>exist<span class="w"> </span>on<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s1">&#39;string | File | null&#39;</span>.
</code></pre></div>

<p><strong>Root cause</strong>: You are getting a value from <code>FormData</code> using <code>formData.get('fieldName')</code> and assuming it's a string. It could also be a <code>File</code> (for file inputs) or <code>null</code>.
<strong>Solution</strong>: Type-cast it or perform a type check before using string methods: <code>const message = formData.get('message') as string;</code> or <code>if (typeof message === 'string') { ... }</code>.</p>
<h2 id="synthesis-the-complete-journey">Synthesis: The Complete Journey</h2>
<h2 id="the-journey-from-problem-to-solution">The Journey: From Problem to Solution</h2>
<p>We've traveled from a disconnected client-side form to a robust, progressively enhanced solution. Let's recap the evolution.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Iteration</th>
<th style="text-align: left;">Approach</th>
<th style="text-align: left;">Failure Mode / Limitation</th>
<th style="text-align: left;">Technique Applied</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">0</td>
<td style="text-align: left;">Client-Side Only</td>
<td style="text-align: left;">No server communication; data cannot be saved.</td>
<td style="text-align: left;">None</td>
<td style="text-align: left;">A non-functional UI.</td>
</tr>
<tr>
<td style="text-align: left;">1</td>
<td style="text-align: left;">API Route + <code>fetch</code></td>
<td style="text-align: left;">Client-side boilerplate for state management.</td>
<td style="text-align: left;">API Routes, <code>fetch</code></td>
<td style="text-align: left;">Functional, but verbose client code.</td>
</tr>
<tr>
<td style="text-align: left;">2</td>
<td style="text-align: left;">Basic Server Action</td>
<td style="text-align: left;">Relies on JavaScript; fails without it.</td>
<td style="text-align: left;"><code>action={async () =&gt; {}}</code></td>
<td style="text-align: left;">Simpler client code, but lacks progressive enhancement.</td>
</tr>
<tr>
<td style="text-align: left;">3</td>
<td style="text-align: left;">Enhanced Server Action</td>
<td style="text-align: left;">No feedback for loading, errors, or validation.</td>
<td style="text-align: left;"><code>action={serverAction}</code></td>
<td style="text-align: left;">Works without JS, but has a poor UX for validation.</td>
</tr>
<tr>
<td style="text-align: left;">4</td>
<td style="text-align: left;">Action with <code>useFormState</code></td>
<td style="text-align: left;">N/A (Final Form)</td>
<td style="text-align: left;"><code>useFormState</code>, <code>zod</code></td>
<td style="text-align: left;">Robust, progressively enhanced form with validation and feedback.</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation">Final Implementation</h3>
<p>Here is the complete, production-ready code for our Guestbook feature, integrating all the best practices we've learned.</p>
<p><strong>Server Action</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions.ts</span>

<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">GuestbookSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Name cannot be empty.&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Message must be at least 5 characters.&#39;</span><span class="w"> </span><span class="p">}),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">FormState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">errors?</span><span class="o">:</span><span class="w"> </span><span class="kt">z.ZodIssue</span><span class="p">[];</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">prevState</span><span class="o">:</span><span class="w"> </span><span class="kt">FormState</span><span class="p">,</span><span class="w"> </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">FormState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">validatedFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">GuestbookSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">entries</span><span class="p">()));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validatedFields</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Validation failed.&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="kt">validatedFields.error.issues</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">addEntry</span><span class="p">(</span><span class="nx">validatedFields</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Entry added successfully!&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Database error: Failed to add entry.&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Form Component</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/GuestbookForm.tsx</span>

<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">addEntry</span><span class="p">,</span><span class="w"> </span><span class="nx">FormState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">initialState</span><span class="o">:</span><span class="w"> </span><span class="kt">FormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">};</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;...&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sign Guestbook&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GuestbookForm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">use_form_state</span><span class="p">(</span><span class="nx">addEntry</span><span class="p">,</span><span class="w"> </span><span class="nx">initialState</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="p">]);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">getErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fieldName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="o">?</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">issue</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">issue</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">fieldName</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">issue</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">issue</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-6 space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="p">&gt;</span><span class="nx">Name</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">getErrors</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">error</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-red-500 mt-1&quot;</span><span class="p">&gt;{</span><span class="nx">error</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="p">&gt;</span><span class="nx">Message</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;message&quot;</span><span class="w"> </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">3</span><span class="p">}</span><span class="w"> </span><span class="na">required</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">getErrors</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">error</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-red-500 mt-1&quot;</span><span class="p">&gt;{</span><span class="nx">error</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">errors</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;text-green-500&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text-red-500&#39;</span><span class="p">}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="decision-framework-api-routes-vs-server-actions">Decision Framework: API Routes vs. Server Actions</h3>
<p>When should you reach for an API Route versus a Server Action?</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Use Case</th>
<th style="text-align: left;">Recommended Approach</th>
<th style="text-align: left;">Why?</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Form submissions from React components</strong></td>
<td style="text-align: left;"><strong>Server Action</strong></td>
<td style="text-align: left;">Drastically reduces client-side boilerplate, enables progressive enhancement, and integrates tightly with React hooks like <code>useFormState</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Exposing an endpoint for a third-party service (e.g., webhooks)</strong></td>
<td style="text-align: left;"><strong>API Route</strong></td>
<td style="text-align: left;">Provides a standard, stable REST or GraphQL endpoint that external services can call. Server Actions are not designed for this.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Fetching data from a non-React client (e.g., mobile app, another backend)</strong></td>
<td style="text-align: left;"><strong>API Route</strong></td>
<td style="text-align: left;">API Routes are framework-agnostic. Anyone who can make an HTTP request can consume them.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Simple RPC-style calls from client components (e.g., clicking a "like" button)</strong></td>
<td style="text-align: left;"><strong>Server Action</strong></td>
<td style="text-align: left;">It's simpler than setting up a <code>fetch</code> call. You can invoke an action without a <code>&lt;form&gt;</code> by calling it directly in an event handler.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Implementing a full REST API</strong></td>
<td style="text-align: left;"><strong>API Route</strong></td>
<td style="text-align: left;">The file-based routing and explicit HTTP method handlers (<code>GET</code>, <code>POST</code>, <code>PUT</code>) map perfectly to REST principles.</td>
</tr>
</tbody>
</table>
<p><strong>General Rule of Thumb</strong>:
*   For any <strong>mutation (create, update, delete) triggered by your Next.js UI</strong>, prefer <strong>Server Actions</strong>.
*   For any endpoint that needs to be <strong>consumed by something other than your Next.js UI</strong>, use <strong>API Routes</strong>.</p>
        </div>
        <div class="footer">
            Generated on 2025-11-25 13:41:00 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>