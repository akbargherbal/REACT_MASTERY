<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18 API Routes and Server Actions</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">05 Next.js ‚Äî Server-Side React</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-18-api-routes-and-server-actions">Chapter 18: API Routes and Server Actions</h1>
<h2 id="building-api-endpoints">Building API endpoints</h2>
<h2 id="the-problem-client-side-form-submission-limitations">The Problem: Client-Side Form Submission Limitations</h2>
<p>Before we dive into API routes, let's understand why we need them. In Chapter 17, we built our e-commerce product catalog with Server Components fetching data. But what happens when users need to <strong>modify</strong> data‚Äîadding products to a cart, submitting reviews, or updating their profile?</p>
<p>Let's start with a naive approach: handling everything client-side.</p>
<h3 id="reference-implementation-product-review-system">Reference Implementation: Product Review System</h3>
<p>We'll build a product review submission system that evolves through this chapter. Users can submit reviews with ratings and text. This seemingly simple feature will expose multiple failure modes that drive us toward better solutions.</p>
<p><strong>Project Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="n">page</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">ReviewForm</span><span class="p">.</span><span class="n">tsx</span><span class="w">    </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Our</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="n">implementation</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">reviews</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">          </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">endpoint</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="err">&#39;</span><span class="n">ll</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">this</span><span class="p">)</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">ts</span><span class="w">                     </span><span class="err">‚Üê</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">utilities</span>
</code></pre></div>

<p>Here's our initial client-side approach:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">setRating</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">comment</span><span class="p">,</span><span class="w"> </span><span class="nx">setComment</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isSubmitting</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsSubmitting</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setIsSubmitting</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Directly calling an external API from the client</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/reviews&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">          </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">          </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;sk_live_abc123xyz&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// üö® EXPOSED SECRET!</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Failed to submit review&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Review submitted!&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setRating</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setComment</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Error submitting review&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsSubmitting</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">rating</span><span class="p">}</span><span class="w"> </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setRating</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">))}&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span><span class="nx">Comment</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">comment</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setComment</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isSubmitting</span><span class="p">}&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isSubmitting</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-failure-security-and-architecture-problems">The Failure: Security and Architecture Problems</h3>
<p>Let's run this code and examine what happens.</p>
<p><strong>Browser Behavior</strong>:
The form appears to work‚Äîusers can submit reviews, and they see a success message. But open the browser's DevTools Network tab.</p>
<p><strong>Browser DevTools - Network Tab</strong>:
- Filter: Fetch/XHR
- Request to: <code>https://api.example.com/reviews</code>
- Request Headers visible in DevTools
- Request Payload visible: <code>{ "productId": "123", "rating": 5, "comment": "Great!", "apiKey": "sk_live_abc123xyz" }</code></p>
<p><strong>Security Console (Hypothetical)</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">SECURITY</span><span class="w"> </span><span class="n">ALERT</span><span class="p">]</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="err">&#39;</span><span class="n">sk_live_abc123xyz</span><span class="err">&#39;</span><span class="w"> </span><span class="n">exposed</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">client</span><span class="o">-</span><span class="n">side</span><span class="w"> </span><span class="n">code</span>
<span class="p">[</span><span class="n">SECURITY</span><span class="w"> </span><span class="n">ALERT</span><span class="p">]</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="n">unauthorized</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">leaked</span><span class="w"> </span><span class="n">key</span>
<span class="p">[</span><span class="n">SECURITY</span><span class="w"> </span><span class="n">ALERT</span><span class="p">]</span><span class="w"> </span><span class="n">$2</span><span class="p">,</span><span class="mi">847</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">fraudulent</span><span class="w"> </span><span class="n">charges</span>
</code></pre></div>

<p><strong>Let's parse this evidence</strong>:</p>
<ol>
<li>
<p><strong>What the user experiences</strong>: The form works perfectly from their perspective.</p>
</li>
<li>
<p><strong>What DevTools reveals</strong>: Every piece of data sent to the server is visible in the Network tab, including the API key embedded in the request body.</p>
</li>
<li>
<p><strong>What actually happened</strong>: </p>
</li>
<li>The API key is bundled into the client JavaScript</li>
<li>Anyone can view the source code and extract it</li>
<li>Malicious actors can use the key to make unlimited requests</li>
<li>
<p>There's no rate limiting or authentication</p>
</li>
<li>
<p><strong>Root cause identified</strong>: <strong>Secrets cannot live in client-side code</strong>. Anything sent to the browser is public information.</p>
</li>
<li>
<p><strong>Why the current approach can't solve this</strong>: Client-side JavaScript is inherently public. No amount of obfuscation or "hiding" can protect secrets in client code.</p>
</li>
<li>
<p><strong>What we need</strong>: A server-side layer that holds secrets and validates requests before forwarding them to external services.</p>
</li>
</ol>
<h3 id="the-solution-api-routes">The Solution: API Routes</h3>
<p>Next.js API Routes provide server-side endpoints that run in a Node.js environment. They can:
- Hold secrets securely
- Validate and sanitize input
- Authenticate users
- Rate limit requests
- Transform data before sending to external services</p>
<p>Let's build our first API route.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/reviews/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="c1">// This runs on the server - secrets are safe here</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">API_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EXTERNAL_API_KEY</span><span class="o">!</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Parse the incoming request body</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Server-side validation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">productId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">comment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Missing required fields&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rating</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Call external API with secret key (never exposed to client)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.example.com/reviews&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="sb">`Bearer </span><span class="si">${</span><span class="nx">API_KEY</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="c1">// Secret stays on server</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">        </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="p">}),</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;External API request failed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">reviewId</span><span class="o">:</span><span class="w"> </span><span class="kt">data.id</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">201</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to submit review&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now update the client component to use our API route:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">setRating</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">comment</span><span class="p">,</span><span class="w"> </span><span class="nx">setComment</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isSubmitting</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsSubmitting</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FormEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setIsSubmitting</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Call OUR API route, not external API directly</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/reviews&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">          </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">          </span><span class="c1">// No API key needed - server handles it</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Failed to submit review&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Review submitted successfully!&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setRating</span><span class="p">(</span><span class="mf">5</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setComment</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setError</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;An error occurred&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsSubmitting</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">rating</span><span class="p">}</span><span class="w"> </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setRating</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">))}&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span><span class="nx">Comment</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">comment</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setComment</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isSubmitting</span><span class="p">}&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isSubmitting</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Environment Setup</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env.local (never commit this file!)</span>
<span class="nv">EXTERNAL_API_KEY</span><span class="o">=</span>sk_live_abc123xyz
</code></pre></div>

<h3 id="verification-security-restored">Verification: Security Restored</h3>
<p><strong>Browser DevTools - Network Tab</strong>:
- Request to: <code>/api/reviews</code> (our domain, not external API)
- Request Payload: <code>{ "productId": "123", "rating": 5, "comment": "Great!" }</code>
- <strong>No API key visible anywhere</strong></p>
<p><strong>Browser DevTools - Sources Tab</strong>:
- Search for "sk_live" in all JavaScript files
- <strong>Result</strong>: Not found (key never sent to client)</p>
<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews 201 in 234ms
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: API key exposed in client bundle, visible in Network tab
- <strong>After</strong>: API key stays on server, never sent to client
- <strong>Security</strong>: Secrets protected, rate limiting possible, validation enforced</p>
<h3 id="api-route-anatomy">API Route Anatomy</h3>
<p>Let's break down the structure:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/reviews/route.ts</span>

<span class="c1">// 1. Import Next.js types</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="c1">// 2. Export named functions for HTTP methods</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle GET requests</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle POST requests</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">PUT</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle PUT requests</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Handle DELETE requests</span>
<span class="p">}</span>

<span class="c1">// 3. Access request data</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// URL parameters</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Request body</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Headers</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;authorization&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Cookies</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Return response</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;value&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dynamic-route-parameters">Dynamic Route Parameters</h3>
<p>API routes support dynamic segments just like page routes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/reviews/[id]/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="c1">// GET /api/reviews/123</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">reviewId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Fetch specific review</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchReviewById</span><span class="p">(</span><span class="nx">reviewId</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">review</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Review not found&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">404</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">review</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// DELETE /api/reviews/123</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">DELETE</span><span class="p">(</span>
<span class="w">  </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">,</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">reviewId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Verify user owns this review (authentication check)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getUserIdFromRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetchReviewById</span><span class="p">(</span><span class="nx">reviewId</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">review</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">403</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">deleteReview</span><span class="p">(</span><span class="nx">reviewId</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Helper functions (implementation details)</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchReviewById</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Database query</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Great!&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getUserIdFromRequest</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Extract from session/JWT</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteReview</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Database deletion</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-1-adding-database-integration">Iteration 1: Adding Database Integration</h3>
<p>Our API route currently calls an external API. In most real applications, you'll store data in your own database. Let's add that.</p>
<p><strong>Current limitation</strong>: We're proxying to an external service, adding latency and dependency on third-party availability.</p>
<p><strong>New scenario</strong>: What if we want to store reviews in our own database for faster access and better control?</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/db.ts</span>
<span class="c1">// Simple in-memory database for demonstration</span>
<span class="c1">// In production, use Prisma, Drizzle, or your preferred ORM</span>

<span class="kr">type</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">reviews</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">reviews</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">Omit</span><span class="o">&lt;</span><span class="nx">Review</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;createdAt&#39;</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">data</span><span class="p">,</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mf">7</span><span class="p">),</span>
<span class="w">        </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">review</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">review</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nx">findByProductId</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">(</span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">productId</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">productId</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nx">findById</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nx">delete</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">reviews</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>

<p>Now update the API route to use our database:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/reviews/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Validation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">productId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">comment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Missing required fields&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rating</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Get user ID from session (we&#39;ll implement auth in Chapter 20)</span>
<span class="w">    </span><span class="c1">// For now, use a placeholder</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Store in database</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">201</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to submit review&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// GET /api/reviews?productId=123</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">searchParams</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;productId&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">productId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;productId is required&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">reviews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">findByProductId</span><span class="p">(</span><span class="nx">productId</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">reviews</span><span class="w"> </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-database-integration-working">Verification: Database Integration Working</h3>
<p><strong>Browser DevTools - Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews
Status: 201 Created
Response: {
  &quot;success&quot;: true,
  &quot;review&quot;: {
    &quot;id&quot;: &quot;a7b3c9d&quot;,
    &quot;productId&quot;: &quot;123&quot;,
    &quot;userId&quot;: &quot;user123&quot;,
    &quot;rating&quot;: 5,
    &quot;comment&quot;: &quot;Excellent product!&quot;,
    &quot;createdAt&quot;: &quot;2025-01-15T10:30:00.000Z&quot;
  }
}
</code></pre></div>

<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews 201 in 12ms
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: Proxying to external API (200-500ms latency)
- <strong>After</strong>: Direct database access (10-20ms latency)
- <strong>Performance</strong>: 10-20x faster response time
- <strong>Control</strong>: Full ownership of data, no third-party dependency</p>
<h3 id="limitation-preview">Limitation Preview</h3>
<p>This works well, but we still have a problem: <strong>the client must handle all the submission logic</strong>. If JavaScript fails to load or is disabled, the form doesn't work at all. We also need to manually manage loading states, error states, and success states.</p>
<p>In the next section, we'll see how Server Actions eliminate this boilerplate while providing progressive enhancement.</p>
<h2 id="server-actions-mutations-without-api-routes">Server Actions: mutations without API routes</h2>
<h2 id="the-problem-api-routes-require-client-side-orchestration">The Problem: API Routes Require Client-Side Orchestration</h2>
<p>Our API route works, but look at all the client-side code required:</p>
<ol>
<li>Event handler to prevent default form submission</li>
<li>Manual state management for loading/error states</li>
<li>Fetch call with proper headers and error handling</li>
<li>Response parsing and validation</li>
<li>UI updates based on response</li>
</ol>
<p><strong>The failure</strong>: If JavaScript fails to load (slow network, JS disabled, error in bundle), the form is completely non-functional. Users see a form but can't submit it.</p>
<p><strong>Diagnostic Analysis: Simulating JavaScript Failure</strong>:</p>
<p><strong>Browser DevTools - Network Tab</strong>:
- Throttle to "Slow 3G"
- Disable JavaScript in DevTools Settings
- Try to submit form</p>
<p><strong>Browser Behavior</strong>:
- Form appears normal
- Click submit button
- <strong>Nothing happens</strong>
- No feedback, no error message
- Form is a dead UI element</p>
<p><strong>Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>(No output - JavaScript never executed)
</code></pre></div>

<p><strong>Root cause identified</strong>: The form depends entirely on JavaScript for functionality. Without JS, it's just HTML with no behavior.</p>
<p><strong>What we need</strong>: A way to handle form submissions that works with or without JavaScript, while still providing enhanced UX when JS is available.</p>
<h3 id="server-actions-the-modern-solution">Server Actions: The Modern Solution</h3>
<p>Server Actions are functions that run on the server but can be called directly from Client Components or Server Components. They provide:</p>
<ol>
<li><strong>Progressive enhancement</strong>: Forms work without JavaScript</li>
<li><strong>Type safety</strong>: Full TypeScript support from client to server</li>
<li><strong>Automatic serialization</strong>: No manual JSON parsing</li>
<li><strong>Built-in error handling</strong>: Structured error responses</li>
<li><strong>Optimistic updates</strong>: Easy to implement</li>
</ol>
<p>Let's refactor our review form to use Server Actions.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions/reviews.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>

<span class="c1">// Server Action - runs on server, callable from client</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">(</span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Extract form data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;productId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Validation</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">productId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">comment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Missing required fields&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rating</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">comment</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get user ID from session (placeholder for now)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Store in database</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Revalidate the product page to show new review</span>
<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">review</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to submit review&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now update the form component to use the Server Action:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="c1">// Separate component for submit button to access form status</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">(</span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Hidden field for productId */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="nx">Review</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">successfully</span><span class="o">!</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">defaultValue</span><span class="o">=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">required</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="p">&gt;</span><span class="nx">Comment</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-progressive-enhancement-working">Verification: Progressive Enhancement Working</h3>
<p><strong>Test 1: With JavaScript Enabled</strong></p>
<p><strong>Browser Behavior</strong>:
- Fill out form
- Click submit
- Button shows "Submitting..." immediately
- Success message appears
- Form stays on same page (no full reload)</p>
<p><strong>Browser DevTools - Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123
Status: 200 OK
Type: document (Server Action request)
</code></pre></div>

<p><strong>React DevTools - Components Tab</strong>:
- <code>ReviewForm</code> component selected
- State: <code>{ success: true, error: null }</code>
- No full page reload occurred</p>
<p><strong>Test 2: With JavaScript Disabled</strong></p>
<p><strong>Browser DevTools</strong>:
- Settings ‚Üí Disable JavaScript
- Refresh page</p>
<p><strong>Browser Behavior</strong>:
- Fill out form
- Click submit
- <strong>Page reloads</strong> (full navigation)
- Success message appears on reloaded page
- Form still works!</p>
<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (Server Action: submitReview)
Review created: a7b3c9d
Revalidating path: /products/123
200 OK in 15ms
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: Form completely broken without JavaScript
- <strong>After</strong>: Form works with or without JavaScript
- <strong>With JS</strong>: Enhanced UX (no page reload, instant feedback)
- <strong>Without JS</strong>: Graceful degradation (full page reload, still functional)
- <strong>Code reduction</strong>: ~40 lines of client code ‚Üí ~20 lines</p>
<h3 id="how-server-actions-work">How Server Actions Work</h3>
<p>Let's understand the mechanism:</p>
<ol>
<li><strong>With JavaScript</strong>: </li>
<li>Form submission intercepted by React</li>
<li>Server Action called via fetch (automatic)</li>
<li>Response updates component state</li>
<li>
<p>No page reload</p>
</li>
<li>
<p><strong>Without JavaScript</strong>:</p>
</li>
<li>Form submits as standard HTML form</li>
<li>Browser performs full POST request</li>
<li>Server processes action</li>
<li>Server returns new HTML</li>
<li>Page reloads with result</li>
</ol>
<p>The same server function handles both cases!</p>
<h3 id="iteration-2-type-safe-server-actions">Iteration 2: Type-Safe Server Actions</h3>
<p>The FormData approach works but lacks type safety. Let's add proper TypeScript types.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions/reviews.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>

<span class="c1">// Define validation schema</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Product ID is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="p">),</span>
<span class="p">});</span>

<span class="c1">// Type-safe return type</span>
<span class="kr">type</span><span class="w"> </span><span class="nx">ReviewActionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"> </span><span class="nx">review</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">fieldErrors?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prevState</span><span class="o">:</span><span class="w"> </span><span class="kt">ReviewActionResult</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ReviewActionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Parse and validate form data</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;productId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)),</span>
<span class="w">    </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">rawData</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validation</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fieldErrors</span><span class="o">:</span><span class="w"> </span><span class="kt">validation.error.flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Placeholder</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">review</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">review.id</span><span class="p">,</span>
<span class="w">        </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">review.rating</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">review.comment</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to submit review. Please try again.&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Update the form to display field-specific errors:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">(</span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="nx">Review</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">successfully</span><span class="o">!</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">defaultValue</span><span class="o">=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">required</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="p">&gt;</span><span class="nx">Comment</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">comment</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-type-safe-validation">Verification: Type-Safe Validation</h3>
<p><strong>Test: Submit Invalid Data</strong></p>
<p><strong>Browser Behavior</strong>:
- Enter rating: 5
- Enter comment: "Bad" (too short)
- Click submit</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>(No errors - validation handled server-side)
</code></pre></div>

<p><strong>UI Display</strong>:</p>
<div class="codehilite"><pre><span></span><code>Comment must be at least 10 characters
</code></pre></div>

<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (Server Action: submitReview)
Validation failed: comment too short
200 OK in 3ms
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: Generic error messages, no field-specific feedback
- <strong>After</strong>: Precise error messages per field
- <strong>Type safety</strong>: Full TypeScript inference from server to client
- <strong>Validation</strong>: Centralized on server, can't be bypassed</p>
<h3 id="iteration-3-optimistic-updates">Iteration 3: Optimistic Updates</h3>
<p>Server Actions make optimistic updates trivial. Let's show the review immediately while the server processes it.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useOptimistic</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="kr">type</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">pending?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span>
<span class="w">  </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">  </span><span class="nx">existingReviews</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[],</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">existingReviews?</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="p">[];</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">(</span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">optimisticReviews</span><span class="p">,</span><span class="w"> </span><span class="nx">addOptimisticReview</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useOptimistic</span><span class="p">(</span>
<span class="w">    </span><span class="nx">existingReviews</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">newReview</span><span class="o">:</span><span class="w"> </span><span class="kt">Review</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">newReview</span><span class="p">]</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleSubmit</span><span class="p">(</span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Add optimistic review immediately</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rating</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">    </span><span class="nx">addOptimisticReview</span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;temp-&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">      </span><span class="nx">pending</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Submit to server</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">formAction</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Display reviews with optimistic updates */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span><span class="nx">Reviews</span><span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">optimisticReviews</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">review</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">            </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">review</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid #ddd&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.5rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">opacity</span><span class="o">:</span><span class="w"> </span><span class="kt">review.pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">0.6</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">review</span><span class="p">.</span><span class="nx">rating</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;{</span><span class="nx">review</span><span class="p">.</span><span class="nx">comment</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">review</span><span class="p">.</span><span class="nx">pending</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">                </span><span class="nx">Submitting</span><span class="p">...</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">)}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span><span class="nx">Rating</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span><span class="na">defaultValue</span><span class="o">=</span><span class="s">&quot;5&quot;</span><span class="w"> </span><span class="na">required</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">))}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="p">&gt;</span><span class="nx">Comment</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">            </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">            </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">            </span><span class="na">required</span>
<span class="w">            </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">          </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-optimistic-updates-working">Verification: Optimistic Updates Working</h3>
<p><strong>Browser Behavior</strong>:
- Fill out form with rating 5 and comment "Excellent product!"
- Click submit
- <strong>Review appears immediately</strong> with "Submitting..." label
- After server responds (~100ms), "Submitting..." disappears
- Review remains visible</p>
<p><strong>React DevTools - Components Tab</strong>:
- <code>ReviewForm</code> component selected
- State shows optimistic review in array
- After server response, optimistic review replaced with real one</p>
<p><strong>Browser DevTools - Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123
Status: 200 OK
Time: 98ms
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: User waits for server response to see their review
- <strong>After</strong>: Review appears instantly, confirmed by server
- <strong>Perceived performance</strong>: Feels instant (0ms) vs. actual (100ms)
- <strong>UX</strong>: User can continue browsing immediately</p>
<h3 id="when-to-use-server-actions-vs-api-routes">When to Use Server Actions vs. API Routes</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Use Server Actions</th>
<th>Use API Routes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Form submissions</td>
<td>‚úÖ Yes</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Mutations from UI</td>
<td>‚úÖ Yes</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>Progressive enhancement needed</td>
<td>‚úÖ Yes</td>
<td>‚ùå No</td>
</tr>
<tr>
<td>External API consumption</td>
<td>‚ùå No</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td>Webhooks from third parties</td>
<td>‚ùå No</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td>Public API for mobile apps</td>
<td>‚ùå No</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td>Complex request/response headers</td>
<td>‚ùå No</td>
<td>‚úÖ Yes</td>
</tr>
<tr>
<td>File uploads</td>
<td>‚úÖ Yes (with FormData)</td>
<td>‚úÖ Yes (both work)</td>
</tr>
</tbody>
</table>
<p><strong>Decision Framework</strong>:</p>
<ol>
<li><strong>Is this triggered by a user action in your UI?</strong> ‚Üí Server Action</li>
<li><strong>Does it need to work without JavaScript?</strong> ‚Üí Server Action</li>
<li><strong>Is it called by external systems?</strong> ‚Üí API Route</li>
<li><strong>Do you need custom HTTP headers/status codes?</strong> ‚Üí API Route</li>
<li><strong>Is it a simple mutation?</strong> ‚Üí Server Action</li>
<li><strong>Is it a complex multi-step process?</strong> ‚Üí API Route</li>
</ol>
<h3 id="limitation-preview_1">Limitation Preview</h3>
<p>Server Actions are powerful, but they still require careful error handling and validation. In the next section, we'll explore how to handle errors gracefully and validate data comprehensively.</p>
<h2 id="form-handling-with-progressive-enhancement">Form handling with progressive enhancement</h2>
<h2 id="the-problem-forms-that-break-gracefully">The Problem: Forms That Break Gracefully</h2>
<p>We've built a form with Server Actions, but there are still edge cases where things can go wrong:</p>
<ol>
<li><strong>Network failures</strong>: What if the request times out?</li>
<li><strong>Validation errors</strong>: How do we preserve user input?</li>
<li><strong>Concurrent submissions</strong>: What if the user clicks submit twice?</li>
<li><strong>Accessibility</strong>: Is the form usable with keyboard and screen readers?</li>
</ol>
<p>Let's build a production-ready form that handles all these cases.</p>
<h3 id="iteration-4-comprehensive-form-handling">Iteration 4: Comprehensive Form Handling</h3>
<p><strong>Current limitation</strong>: Our form loses user input on validation errors, doesn't prevent double submissions, and lacks proper accessibility attributes.</p>
<p><strong>New scenario</strong>: What happens when validation fails or the network is slow?</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions/reviews.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Product ID is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">z.coerce.number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Comment must not exceed 500 characters&#39;</span><span class="p">),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fieldErrors</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">comment?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="c1">// Preserve user input on error</span>
<span class="w">  </span><span class="nx">values</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prevState</span><span class="o">:</span><span class="w"> </span><span class="kt">ReviewFormState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ReviewFormState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Simulate network delay for testing</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">));</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;productId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">rawData</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validation</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fieldErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Please correct the errors below&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">fieldErrors</span><span class="p">,</span>
<span class="w">      </span><span class="c1">// Preserve user input</span>
<span class="w">      </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">rawData</span><span class="p">.</span><span class="nx">rating</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">rawData.comment</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">      </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Failed to submit review. Please try again.&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">values</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Now build a comprehensive form component:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span>
<span class="w">      </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span>
<span class="w">      </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">      </span><span class="na">aria-disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">&lt;</span><span class="nt">ReviewFormState</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span>
<span class="w">    </span><span class="nx">submitReview</span><span class="p">,</span>
<span class="w">    </span><span class="kc">null</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">commentRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Reset form on successful submission</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// Focus on comment field for next review</span>
<span class="w">      </span><span class="nx">commentRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">]);</span>

<span class="w">  </span><span class="c1">// Focus on first error field</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">firstErrorField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating&#39;</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">namedItem</span><span class="p">(</span><span class="nx">firstErrorField</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">HTMLElement</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">element</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}</span>
<span class="w">      </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;form-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Global error message */</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;form-error&quot;</span>
<span class="w">          </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid red&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fee&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Success message */</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">          </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;status&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid green&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#efe&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Review</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">successfully</span><span class="o">!</span><span class="w"> </span><span class="nx">Thank</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">feedback</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Rating field */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Rating</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Comment field */</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Comment</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">commentRef</span><span class="p">}</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">          </span><span class="na">maxLength</span><span class="o">=</span><span class="p">{</span><span class="mf">500</span><span class="p">}</span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;comment-error comment-hint&#39;</span><span class="w"> </span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment-hint&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;100%&#39;</span><span class="w"> </span><span class="p">}}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-hint&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Minimum</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="nx">characters</span><span class="p">,</span><span class="w"> </span><span class="nx">maximum</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="nx">characters</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">comment</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-comprehensive-error-handling">Verification: Comprehensive Error Handling</h3>
<p><strong>Test 1: Validation Error</strong></p>
<p><strong>Browser Behavior</strong>:
- Enter rating: 5
- Enter comment: "Bad" (too short)
- Click submit
- Wait 1 second (simulated delay)
- Error message appears: "Please correct the errors below"
- Field-specific error: "Comment must be at least 10 characters"
- <strong>User input preserved</strong>: "Bad" still in textarea
- <strong>Focus moved to comment field</strong> automatically</p>
<p><strong>Browser Console Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>(No errors - handled gracefully)
</code></pre></div>

<p><strong>Accessibility Test (Screen Reader)</strong>:</p>
<div class="codehilite"><pre><span></span><code>&quot;Alert: Please correct the errors below&quot;
&quot;Comment, required, invalid, edit text&quot;
&quot;Alert: Comment must be at least 10 characters&quot;
</code></pre></div>

<p><strong>Test 2: Network Failure Simulation</strong></p>
<p><strong>Browser DevTools - Network Tab</strong>:
- Throttle to "Offline"
- Fill out form correctly
- Click submit</p>
<p><strong>Browser Behavior</strong>:
- Button shows "Submitting..."
- After timeout (~30 seconds), error appears
- User input preserved
- Can retry submission</p>
<p><strong>Test 3: Double Submission Prevention</strong></p>
<p><strong>Browser Behavior</strong>:
- Fill out form
- Click submit button rapidly 5 times
- Button becomes disabled after first click
- Only one request sent</p>
<p><strong>Browser DevTools - Network Tab</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (only one request)
Status: 200 OK
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: Lost user input on error, no accessibility, double submissions possible
- <strong>After</strong>: Input preserved, fully accessible, double submission prevented
- <strong>Accessibility</strong>: WCAG 2.1 AA compliant
- <strong>UX</strong>: Clear error messages, automatic focus management</p>
<h3 id="progressive-enhancement-in-action">Progressive Enhancement in Action</h3>
<p>Let's verify the form works without JavaScript:</p>
<p><strong>Test: JavaScript Disabled</strong></p>
<p><strong>Browser DevTools</strong>:
- Settings ‚Üí Disable JavaScript
- Refresh page</p>
<p><strong>Browser Behavior</strong>:
- Fill out form with invalid data (comment too short)
- Click submit
- <strong>Page reloads</strong> (full navigation)
- Error message appears on reloaded page
- <strong>User input preserved</strong> in form fields
- Can correct and resubmit</p>
<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (Server Action: submitReview)
Validation failed: comment too short
Returning HTML with form state
200 OK in 15ms
</code></pre></div>

<p><strong>How it works</strong>:
1. Form submits as standard HTML POST
2. Server processes Server Action
3. Server returns new HTML with error state
4. Browser displays reloaded page with errors
5. Form fields populated with previous values</p>
<p>This is <strong>progressive enhancement</strong>: the form works without JavaScript, but provides a better experience with it.</p>
<h3 id="iteration-5-client-side-validation-for-instant-feedback">Iteration 5: Client-Side Validation for Instant Feedback</h3>
<p>While server-side validation is essential for security, we can add client-side validation for better UX.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span>
<span class="w">      </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span>
<span class="w">      </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">      </span><span class="na">aria-disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">&lt;</span><span class="nt">ReviewFormState</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span>
<span class="w">    </span><span class="nx">submitReview</span><span class="p">,</span>
<span class="w">    </span><span class="kc">null</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">commentRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Client-side validation state</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">commentError</span><span class="p">,</span><span class="w"> </span><span class="nx">setCommentError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">commentLength</span><span class="p">,</span><span class="w"> </span><span class="nx">setCommentLength</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">      </span><span class="nx">commentRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setCommentLength</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">setCommentError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">]);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">firstErrorField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating&#39;</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">namedItem</span><span class="p">(</span><span class="nx">firstErrorField</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">HTMLElement</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">element</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">]);</span>

<span class="w">  </span><span class="c1">// Client-side validation on blur</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleCommentBlur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.FocusEvent</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setCommentError</span><span class="p">(</span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setCommentError</span><span class="p">(</span><span class="s1">&#39;Comment must not exceed 500 characters&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setCommentError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleCommentChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ChangeEvent</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setCommentLength</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Clear error as user types</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">commentError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setCommentError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// Use server error if present, otherwise client error</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">displayCommentError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">commentError</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}</span>
<span class="w">      </span><span class="na">noValidate</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="na">Disable</span><span class="w"> </span><span class="na">browser</span><span class="w"> </span><span class="na">validation</span><span class="err">,</span><span class="w"> </span><span class="na">use</span><span class="w"> </span><span class="na">our</span><span class="w"> </span><span class="na">own</span>
<span class="w">      </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;form-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;form-error&quot;</span>
<span class="w">          </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid red&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fee&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">          </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;status&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid green&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#efe&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Review</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">successfully</span><span class="o">!</span><span class="w"> </span><span class="nx">Thank</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">feedback</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Rating</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Comment</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">commentRef</span><span class="p">}</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">          </span><span class="na">maxLength</span><span class="o">=</span><span class="p">{</span><span class="mf">500</span><span class="p">}</span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="w">          </span><span class="na">onBlur</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCommentBlur</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCommentChange</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">displayCommentError</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayCommentError</span><span class="w"> </span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;comment-error comment-hint&#39;</span><span class="w"> </span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment-hint&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;100%&#39;</span><span class="w"> </span><span class="p">}}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">          </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;flex&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">          </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;space-between&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-hint&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="nx">Minimum</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="nx">characters</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">commentLength</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">commentLength</span><span class="p">}</span><span class="o">/</span><span class="mf">500</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">displayCommentError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">displayCommentError</span><span class="p">}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-client-side-validation">Verification: Client-Side Validation</h3>
<p><strong>Browser Behavior</strong>:
- Start typing in comment field: "Bad"
- Tab out of field (blur event)
- <strong>Instant feedback</strong>: "Comment must be at least 10 characters"
- Continue typing: "Bad product"
- Error disappears as soon as 10 characters reached
- Character counter updates in real-time: "11/500"</p>
<p><strong>React DevTools - Components Tab</strong>:
- <code>ReviewForm</code> component selected
- State: <code>{ commentError: null, commentLength: 11 }</code></p>
<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: No feedback until form submission
- <strong>After</strong>: Instant feedback on blur, real-time character count
- <strong>UX</strong>: User knows requirements before submitting
- <strong>Validation</strong>: Client-side for UX, server-side for security</p>
<h3 id="when-to-apply-form-validation-strategy">When to Apply: Form Validation Strategy</h3>
<p><strong>Client-Side Validation</strong>:
- <strong>What it optimizes for</strong>: Instant user feedback, reduced server load
- <strong>What it sacrifices</strong>: Can be bypassed, requires duplicate logic
- <strong>When to use</strong>: Always, as a UX enhancement
- <strong>When to avoid</strong>: Never rely on it alone for security</p>
<p><strong>Server-Side Validation</strong>:
- <strong>What it optimizes for</strong>: Security, data integrity
- <strong>What it sacrifices</strong>: Slower feedback (network round-trip)
- <strong>When to use</strong>: Always, as the source of truth
- <strong>When to avoid</strong>: Never skip it</p>
<p><strong>Decision Framework</strong>:
1. <strong>Always validate on server</strong> (security requirement)
2. <strong>Add client validation for common errors</strong> (UX enhancement)
3. <strong>Keep validation logic in sync</strong> (use shared schemas when possible)
4. <strong>Provide clear error messages</strong> (tell users how to fix)
5. <strong>Preserve user input on error</strong> (don't make them retype)</p>
<h2 id="error-handling-and-validation">Error handling and validation</h2>
<h2 id="the-problem-production-grade-error-handling">The Problem: Production-Grade Error Handling</h2>
<p>Our form handles basic validation, but production applications need to handle:</p>
<ol>
<li><strong>Network errors</strong>: Timeouts, connection failures</li>
<li><strong>Server errors</strong>: Database failures, external API issues</li>
<li><strong>Rate limiting</strong>: Preventing abuse</li>
<li><strong>Concurrent requests</strong>: Handling race conditions</li>
<li><strong>Logging and monitoring</strong>: Tracking errors for debugging</li>
</ol>
<p>Let's build a production-ready error handling system.</p>
<h3 id="iteration-6-comprehensive-error-handling">Iteration 6: Comprehensive Error Handling</h3>
<p><strong>Current limitation</strong>: Generic error messages don't help users understand what went wrong or how to fix it.</p>
<p><strong>New scenario</strong>: What happens when the database is down, or the user is rate-limited?</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/errors.ts</span>
<span class="c1">// Centralized error handling utilities</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">statusCode</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span>
<span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">userMessage?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;AppError&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ValidationError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="nx">fieldErrors?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;VALIDATION_ERROR&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">400</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Please correct the errors below&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RateLimitError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span>
<span class="w">      </span><span class="s1">&#39;Rate limit exceeded&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;RATE_LIMIT_EXCEEDED&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="mf">429</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Too many requests. Please try again in a few minutes.&#39;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DatabaseError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">originalError</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span>
<span class="w">      </span><span class="nx">originalError</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;DATABASE_ERROR&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="mf">500</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;We encountered a technical issue. Please try again later.&#39;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">AppError</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">AppError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Log unexpected errors for monitoring</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Unexpected error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span>
<span class="w">      </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;INTERNAL_ERROR&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="mf">500</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;An unexpected error occurred. Please try again.&#39;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Unknown error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AppError</span><span class="p">(</span>
<span class="w">    </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;UNKNOWN_ERROR&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="mf">500</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;An unexpected error occurred. Please try again.&#39;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Add rate limiting:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/rate-limit.ts</span>
<span class="c1">// Simple in-memory rate limiter</span>
<span class="c1">// In production, use Redis or a dedicated service</span>

<span class="kr">type</span><span class="w"> </span><span class="nx">RateLimitEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">resetAt</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">rateLimits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">RateLimitEntry</span><span class="o">&gt;</span><span class="p">();</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkRateLimit</span><span class="p">(</span>
<span class="w">  </span><span class="nx">identifier</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">maxRequests</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">  </span><span class="nx">windowMs</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60000</span><span class="w"> </span><span class="c1">// 1 minute</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rateLimits</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">entry</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">resetAt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// First request or window expired</span>
<span class="w">    </span><span class="nx">rateLimits</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">identifier</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">count</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">      </span><span class="nx">resetAt</span><span class="o">:</span><span class="w"> </span><span class="kt">now</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">windowMs</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">entry</span><span class="p">.</span><span class="nx">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">maxRequests</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Rate limit exceeded</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Increment count</span>
<span class="w">  </span><span class="nx">entry</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getRateLimitInfo</span><span class="p">(</span><span class="nx">identifier</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">remaining</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">resetAt</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rateLimits</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">entry</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">remaining</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.max</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">entry</span><span class="p">.</span><span class="nx">count</span><span class="p">),</span>
<span class="w">    </span><span class="nx">resetAt</span><span class="o">:</span><span class="w"> </span><span class="kt">entry.resetAt</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p>Update the Server Action with comprehensive error handling:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/actions/reviews.ts</span>
<span class="s1">&#39;use server&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/db&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">revalidatePath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/cache&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">ValidationError</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">RateLimitError</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">DatabaseError</span><span class="p">,</span>
<span class="w">  </span><span class="nx">handleError</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/errors&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">checkRateLimit</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/rate-limit&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Product ID is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">z.coerce.number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Rating must be between 1 and 5&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Comment must be at least 10 characters&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Comment must not exceed 500 characters&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">refine</span><span class="p">(</span>
<span class="w">      </span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">val</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;spam&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="s1">&#39;Comment contains prohibited content&#39;</span>
<span class="w">    </span><span class="p">),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">errorCode?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fieldErrors</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">comment?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">values</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">retryAfter?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="c1">// For rate limiting</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">(</span>
<span class="w">  </span><span class="nx">prevState</span><span class="o">:</span><span class="w"> </span><span class="kt">ReviewFormState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nx">formData</span><span class="o">:</span><span class="w"> </span><span class="kt">FormData</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ReviewFormState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Rate limiting</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// In production, get from session</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rateLimitKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`review:</span><span class="si">${</span><span class="nx">userId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">checkRateLimit</span><span class="p">(</span><span class="nx">rateLimitKey</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">60000</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RateLimitError</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. Parse form data</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;productId&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">      </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 3. Validate</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">reviewSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">rawData</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validation</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">fieldErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">;</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ValidationError</span><span class="p">(</span><span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fieldErrors</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="p">,</span><span class="w"> </span><span class="nx">rating</span><span class="p">,</span><span class="w"> </span><span class="nx">comment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 4. Database operation with error handling</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">review</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">        </span><span class="nx">productId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">userId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">rating</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DatabaseError</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="ne">Error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 5. Revalidate cache</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">revalidatePath</span><span class="p">(</span><span class="sb">`/products/</span><span class="si">${</span><span class="nx">productId</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Log but don&#39;t fail - cache revalidation is not critical</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Cache revalidation failed:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 6. Success response</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Centralized error handling</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">appError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">ReviewFormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">appError.userMessage</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">appError</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">errorCode</span><span class="o">:</span><span class="w"> </span><span class="kt">appError.code</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Add field errors for validation errors</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">ValidationError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">response</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">;</span>
<span class="w">      </span><span class="nx">response</span><span class="p">.</span><span class="nx">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">Number</span><span class="p">(</span><span class="nx">formData</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">        </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">formData.get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Add retry info for rate limit errors</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">RateLimitError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">response</span><span class="p">.</span><span class="nx">retryAfter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">60</span><span class="p">;</span><span class="w"> </span><span class="c1">// seconds</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Log error for monitoring (in production, send to error tracking service)</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Review submission error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">appError.code</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">appError.message</span><span class="p">,</span>
<span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;user123&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Update the form to handle different error types:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/products/[id]/ReviewForm.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">,</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useRef</span><span class="p">,</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">submitReview</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/app/actions/reviews&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">SubmitButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormStatus</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span>
<span class="w">      </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="w"> </span>
<span class="w">      </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">      </span><span class="na">aria-disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">pending</span><span class="p">}</span>
<span class="w">      </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span>
<span class="w">        </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.5rem 1rem&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="kt">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;#ccc&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#007bff&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cursor</span><span class="o">:</span><span class="w"> </span><span class="kt">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;not-allowed&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pointer&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="nx">pending</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Submitting...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Submit Review&#39;</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">ErrorMessage</span><span class="p">({</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="kt">ReviewFormState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Different styling based on error type</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isRateLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;RATE_LIMIT_EXCEEDED&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">errorCode</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;VALIDATION_ERROR&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">      </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;form-error&quot;</span>
<span class="w">      </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">      </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">        </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">isRateLimit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;#856404&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="sb">`1px solid </span><span class="si">${</span><span class="nx">isRateLimit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;#ffc107&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">        </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="kt">isRateLimit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;#fff3cd&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#fee&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">}}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;{</span><span class="nx">isRateLimit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Rate Limit Exceeded&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Error&#39;</span><span class="p">}</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;{</span><span class="s1">&#39; &#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">retryAfter</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.5rem&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="nx">Please</span><span class="w"> </span><span class="nx">wait</span><span class="w"> </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">retryAfter</span><span class="p">}</span><span class="w"> </span><span class="nx">seconds</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="nx">trying</span><span class="w"> </span><span class="nx">again</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ReviewForm</span><span class="p">({</span><span class="w"> </span><span class="nx">productId</span><span class="w"> </span><span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">formAction</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFormState</span><span class="p">&lt;</span><span class="nt">ReviewFormState</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span>
<span class="w">    </span><span class="nx">submitReview</span><span class="p">,</span>
<span class="w">    </span><span class="kc">null</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">formRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLFormElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">commentRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">commentLength</span><span class="p">,</span><span class="w"> </span><span class="nx">setCommentLength</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">      </span><span class="nx">commentRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setCommentLength</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="p">]);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">firstErrorField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating&#39;</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">formRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">elements</span><span class="p">.</span><span class="nx">namedItem</span><span class="p">(</span><span class="nx">firstErrorField</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">HTMLElement</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">element</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">]);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleCommentChange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ChangeEvent</span><span class="p">&lt;</span><span class="nt">HTMLTextAreaElement</span><span class="p">&gt;)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setCommentLength</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">form</span><span class="w"> </span>
<span class="w">      </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">formRef</span><span class="p">}</span>
<span class="w">      </span><span class="na">action</span><span class="o">=</span><span class="p">{</span><span class="nx">formAction</span><span class="p">}</span>
<span class="w">      </span><span class="na">noValidate</span>
<span class="w">      </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;form-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">}</span>
<span class="w">    </span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span><span class="w"> </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;productId&quot;</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">productId</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">ErrorMessage</span><span class="w"> </span><span class="na">state</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="p">}</span><span class="w"> </span><span class="p">/&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span>
<span class="w">          </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;status&quot;</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.75rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid green&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">backgroundColor</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#efe&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="err">‚úì</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="nx">submitted</span><span class="w"> </span><span class="nx">successfully</span><span class="o">!</span><span class="w"> </span><span class="nx">Thank</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">feedback</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Rating</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">select</span><span class="w"> </span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;rating&quot;</span><span class="w"> </span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">5</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;rating-error&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">marginLeft</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.5rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{[</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="mf">5</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">option</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">n</span><span class="p">}&gt;{</span><span class="nx">n</span><span class="p">}</span><span class="w"> </span><span class="nx">stars</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">))}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">rating</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;rating-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">rating</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">label</span><span class="w"> </span><span class="na">htmlFor</span><span class="o">=</span><span class="s">&quot;comment&quot;</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">marginBottom</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="w"> </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="nx">Comment</span><span class="o">:</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;required&quot;</span><span class="p">&gt;</span><span class="o">*</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">textarea</span>
<span class="w">          </span><span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">commentRef</span><span class="p">}</span>
<span class="w">          </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">name</span><span class="o">=</span><span class="s">&quot;comment&quot;</span>
<span class="w">          </span><span class="na">rows</span><span class="o">=</span><span class="p">{</span><span class="mf">4</span><span class="p">}</span>
<span class="w">          </span><span class="na">required</span>
<span class="w">          </span><span class="na">minLength</span><span class="o">=</span><span class="p">{</span><span class="mf">10</span><span class="p">}</span>
<span class="w">          </span><span class="na">maxLength</span><span class="o">=</span><span class="p">{</span><span class="mf">500</span><span class="p">}</span>
<span class="w">          </span><span class="na">defaultValue</span><span class="o">=</span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCommentChange</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
<span class="w">          </span><span class="na">aria-invalid</span><span class="o">=</span><span class="p">{</span><span class="o">!!</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="p">}</span>
<span class="w">          </span><span class="na">aria-describedby</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;comment-error comment-hint&#39;</span><span class="w"> </span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;comment-hint&#39;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;100%&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">padding</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.5rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">border</span><span class="o">:</span><span class="w"> </span><span class="kt">state?.fieldErrors?.comment</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;2px solid red&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1px solid #ccc&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">borderRadius</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4px&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">          </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;flex&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">          </span><span class="nx">justifyContent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;space-between&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">}}&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-hint&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="nx">Minimum</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="nx">characters</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="kt">commentLength</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;#666&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="p">}}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">commentLength</span><span class="p">}</span><span class="o">/</span><span class="mf">500</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">state</span><span class="o">?</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="o">?</span><span class="p">.</span><span class="nx">comment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span>
<span class="w">            </span><span class="na">id</span><span class="o">=</span><span class="s">&quot;comment-error&quot;</span>
<span class="w">            </span><span class="na">role</span><span class="o">=</span><span class="s">&quot;alert&quot;</span>
<span class="w">            </span><span class="na">style</span><span class="o">=</span><span class="p">{{</span><span class="w"> </span>
<span class="w">              </span><span class="nx">color</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="nx">fontSize</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.875rem&#39;</span><span class="p">,</span>
<span class="w">              </span><span class="nx">marginTop</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;0.25rem&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}}</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">state</span><span class="p">.</span><span class="nx">fieldErrors</span><span class="p">.</span><span class="nx">comment</span><span class="p">[</span><span class="mf">0</span><span class="p">]}</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">)}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">SubmitButton</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="verification-production-grade-error-handling">Verification: Production-Grade Error Handling</h3>
<p><strong>Test 1: Rate Limiting</strong></p>
<p><strong>Browser Behavior</strong>:
- Submit 5 reviews rapidly
- On 6th submission, see error:
  "Too many requests. Please wait 60 seconds before trying again."
- Error styled differently (yellow warning vs. red error)</p>
<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (submitReview) 201 OK in 12ms
POST /products/123 (submitReview) 201 OK in 11ms
POST /products/123 (submitReview) 201 OK in 13ms
POST /products/123 (submitReview) 201 OK in 12ms
POST /products/123 (submitReview) 201 OK in 14ms
POST /products/123 (submitReview) 429 Rate Limit Exceeded
Review submission error: {
  code: &#39;RATE_LIMIT_EXCEEDED&#39;,
  message: &#39;Rate limit exceeded&#39;,
  userId: &#39;user123&#39;,
  timestamp: &#39;2025-01-15T10:35:00.000Z&#39;
}
</code></pre></div>

<p><strong>Test 2: Validation Error</strong></p>
<p><strong>Browser Behavior</strong>:
- Enter comment: "spam spam spam"
- Submit form
- Error: "Comment contains prohibited content"
- Field highlighted in red
- User input preserved</p>
<p><strong>Test 3: Database Error Simulation</strong></p>
<p>Temporarily break the database:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/db.ts - Simulate database failure</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">reviews</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">create</span><span class="o">:</span><span class="w"> </span><span class="kt">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Database connection failed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Browser Behavior</strong>:
- Submit valid review
- Error: "We encountered a technical issue. Please try again later."
- Generic message (doesn't expose internal details)</p>
<p><strong>Server Terminal Output</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /products/123 (submitReview)
Unexpected error: Error: Database connection failed
Review submission error: {
  code: &#39;DATABASE_ERROR&#39;,
  message: &#39;Database connection failed&#39;,
  userId: &#39;user123&#39;,
  timestamp: &#39;2025-01-15T10:36:00.000Z&#39;
}
500 Internal Server Error
</code></pre></div>

<p><strong>Expected vs. Actual Improvement</strong>:
- <strong>Before</strong>: Generic "error occurred" message for all failures
- <strong>After</strong>: Specific, actionable error messages
- <strong>Security</strong>: Internal errors don't leak implementation details
- <strong>Monitoring</strong>: All errors logged with context for debugging
- <strong>UX</strong>: Users know what went wrong and how to fix it</p>
<h3 id="common-failure-modes-and-their-signatures">Common Failure Modes and Their Signatures</h3>
<h4 id="symptom-too-many-requests-error">Symptom: "Too many requests" error</h4>
<p><strong>Browser behavior</strong>: Yellow warning box with retry timer</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews 429 Too Many Requests
</code></pre></div>

<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code>Review submission error: { code: &#39;RATE_LIMIT_EXCEEDED&#39;, ... }
</code></pre></div>

<p><strong>Root cause</strong>: User exceeded rate limit (5 requests per minute)</p>
<p><strong>Solution</strong>: Wait for rate limit window to expire, or increase limit for authenticated users</p>
<h4 id="symptom-validation-failed-with-field-specific-errors">Symptom: "Validation failed" with field-specific errors</h4>
<p><strong>Browser behavior</strong>: Red error box, specific fields highlighted</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews 400 Bad Request
</code></pre></div>

<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code>Review submission error: { code: &#39;VALIDATION_ERROR&#39;, fieldErrors: {...} }
</code></pre></div>

<p><strong>Root cause</strong>: User input doesn't meet validation requirements</p>
<p><strong>Solution</strong>: Fix the specific field errors shown</p>
<h4 id="symptom-technical-issue-generic-error">Symptom: "Technical issue" generic error</h4>
<p><strong>Browser behavior</strong>: Red error box with generic message</p>
<p><strong>Console pattern</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST /api/reviews 500 Internal Server Error
</code></pre></div>

<p><strong>Server logs</strong>:</p>
<div class="codehilite"><pre><span></span><code>Unexpected error: Error: Database connection failed
Review submission error: { code: &#39;DATABASE_ERROR&#39;, ... }
</code></pre></div>

<p><strong>Root cause</strong>: Server-side failure (database, external API, etc.)</p>
<p><strong>Solution</strong>: Check server logs, verify database connection, retry request</p>
<h3 id="when-to-apply-error-handling-strategy">When to Apply: Error Handling Strategy</h3>
<p><strong>Client-Side Error Handling</strong>:
- <strong>What it optimizes for</strong>: Instant feedback, reduced server load
- <strong>What it sacrifices</strong>: Can't catch server-side errors
- <strong>When to use</strong>: Input validation, format checking
- <strong>When to avoid</strong>: Security-critical validation, business logic</p>
<p><strong>Server-Side Error Handling</strong>:
- <strong>What it optimizes for</strong>: Security, data integrity, comprehensive error tracking
- <strong>What it sacrifices</strong>: Slower feedback (network round-trip)
- <strong>When to use</strong>: Always, as the authoritative error handler
- <strong>When to avoid</strong>: Never skip it</p>
<p><strong>Error Logging</strong>:
- <strong>What it optimizes for</strong>: Debugging, monitoring, alerting
- <strong>What it sacrifices</strong>: Performance overhead, storage costs
- <strong>When to use</strong>: Production environments, unexpected errors
- <strong>When to avoid</strong>: Sensitive data (passwords, tokens)</p>
<p><strong>Decision Framework</strong>:</p>
<ol>
<li><strong>Validate on client for UX</strong> (instant feedback)</li>
<li><strong>Validate on server for security</strong> (authoritative)</li>
<li><strong>Use specific error types</strong> (ValidationError, RateLimitError, etc.)</li>
<li><strong>Log errors with context</strong> (user ID, timestamp, error code)</li>
<li><strong>Show user-friendly messages</strong> (hide implementation details)</li>
<li><strong>Provide actionable guidance</strong> (tell users how to fix)</li>
<li><strong>Monitor error rates</strong> (alert on spikes)</li>
</ol>
<h2 id="the-complete-journey-chapter-18-synthesis">The Complete Journey - Chapter 18 Synthesis</h2>
<h2 id="the-journey-from-insecure-client-code-to-production-ready-server-actions">The Journey: From Insecure Client Code to Production-Ready Server Actions</h2>
<p>Let's trace the evolution of our review submission system through each iteration:</p>
<table>
<thead>
<tr>
<th>Iteration</th>
<th>Failure Mode</th>
<th>Technique Applied</th>
<th>Result</th>
<th>Key Improvement</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>API key exposed in client code</td>
<td>None</td>
<td>Security breach</td>
<td>Baseline (insecure)</td>
</tr>
<tr>
<td>1</td>
<td>Secrets in client bundle</td>
<td>API Routes</td>
<td>Secrets protected</td>
<td>Server-side security</td>
</tr>
<tr>
<td>2</td>
<td>External API dependency</td>
<td>Database integration</td>
<td>Faster, more control</td>
<td>10-20x performance</td>
</tr>
<tr>
<td>3</td>
<td>Form broken without JS</td>
<td>Server Actions</td>
<td>Progressive enhancement</td>
<td>Works without JS</td>
</tr>
<tr>
<td>4</td>
<td>Lost input on error</td>
<td>Form state preservation</td>
<td>Better UX</td>
<td>Input preserved</td>
</tr>
<tr>
<td>5</td>
<td>No instant feedback</td>
<td>Client-side validation</td>
<td>Faster feedback</td>
<td>Real-time validation</td>
</tr>
<tr>
<td>6</td>
<td>Generic error messages</td>
<td>Comprehensive error handling</td>
<td>Clear guidance</td>
<td>Production-ready</td>
</tr>
</tbody>
</table>
<h3 id="final-implementation-production-ready-review-system">Final Implementation: Production-Ready Review System</h3>
<p>Here's the complete, production-ready implementation with all improvements integrated:</p>
<p><strong>Project Structure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">app</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">products</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="n">tsx</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">ReviewForm</span><span class="p">.</span><span class="n">tsx</span><span class="w">       </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Final</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="n">component</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">reviews</span><span class="p">.</span><span class="n">ts</span><span class="w">               </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Actions</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">api</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">       </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">reviews</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">           </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="o">[</span><span class="n">id</span><span class="o">]/</span>
<span class="err">‚îÇ</span><span class="w">               </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">ts</span><span class="w">         </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">routes</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">external</span><span class="w"> </span><span class="n">access</span>
<span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">db</span><span class="p">.</span><span class="n">ts</span><span class="w">                        </span><span class="err">‚Üê</span><span class="w"> </span><span class="k">Database</span><span class="w"> </span><span class="n">utilities</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îú‚îÄ‚îÄ</span><span class="w"> </span><span class="n">errors</span><span class="p">.</span><span class="n">ts</span><span class="w">                    </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="n">handling</span>
<span class="err">‚îÇ</span><span class="w">   </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">rate</span><span class="o">-</span><span class="k">limit</span><span class="p">.</span><span class="n">ts</span><span class="w">                </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="n">limiting</span>
<span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">types</span><span class="o">/</span>
<span class="w">    </span><span class="err">‚îî‚îÄ‚îÄ</span><span class="w"> </span><span class="n">review</span><span class="p">.</span><span class="n">ts</span><span class="w">                    </span><span class="err">‚Üê</span><span class="w"> </span><span class="n">Shared</span><span class="w"> </span><span class="n">types</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/types/review.ts</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">Review</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">productId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ReviewFormState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">errorCode?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fieldErrors</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">comment?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">values</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rating</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">comment</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">retryAfter?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
        </div>
        <div class="footer">
            Generated on 2025-12-03 12:33:29 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>