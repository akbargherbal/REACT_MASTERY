<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26 Going to Production</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-code: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --accent: #06b6d4;
            --success: #10b981;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.7; 
            color: var(--text-primary); 
            background: var(--bg-main);
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .home-btn { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--accent);
            color: white; 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-decoration: none; 
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn:hover { 
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
        }
        
        .breadcrumb { 
            background: var(--bg-card);
            padding: 12px 0; 
            margin-bottom: 24px; 
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .breadcrumb a { 
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover { 
            color: var(--primary);
            text-decoration: underline;
        }
        
        .content { 
            background: var(--bg-card);
            padding: 3rem; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
        }
        
        .file-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin: 2rem 0; 
        }
        
        .file-item { 
            padding: 1.5rem; 
            border: 1px solid var(--border);
            border-radius: 12px; 
            background: var(--bg-main);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }
        
        .file-item:hover::before {
            opacity: 1;
        }
        
        .file-item a { 
            color: var(--text-primary);
            text-decoration: none; 
            font-weight: 600; 
            display: block;
            font-size: 1.1rem;
        }
        
        .file-item a:hover { 
            color: var(--primary);
        }
        
        .file-type { 
            font-size: 13px; 
            color: var(--text-secondary);
            margin-top: 8px; 
            font-weight: 500;
        }
        
        /* Code Blocks */
        pre { 
            background: var(--bg-code);
            padding: 1.5rem; 
            border-radius: 12px; 
            overflow-x: auto;
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        pre code { 
            background: none;
            padding: 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* Copy Button */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-btn:hover {
            opacity: 1;
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .copy-btn.copied {
            background: var(--success);
        }
        
        pre:hover .copy-btn {
            opacity: 1;
        }
        
        /* Inline Code */
        code { 
            background: var(--bg-code);
            color: #8b5cf6;
            padding: 3px 8px; 
            border-radius: 6px; 
            font-size: 1.1em;
            font-family: 'Fira Code', 'Consolas', monospace;
            border: 1px solid var(--border);
        }
        
        /* Headings */
        h1, h2, h3, h4, h5, h6 { 
            color: var(--text-primary);
            margin: 2rem 0 1rem 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        h1 { 
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 12px;
            margin-bottom: 1.5rem;
        }
        
        h2 { 
            font-size: 2rem;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }
        
        h3 { 
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* Links */
        a { 
            color: var(--accent);
            transition: color 0.2s;
        }
        
        a:hover { 
            color: var(--primary);
        }
        
        /* Paragraphs */
        p {
            margin: 1rem 0;
            color: var(--text-secondary);
        }
        
        /* Lists */
        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }
        
        li {
            margin: 0.5rem 0;
        }
        
        /* Tables */
        table { 
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        th, td { 
            border: 1px solid var(--border);
            padding: 12px 16px;
            text-align: left;
        }
        
        th { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: var(--bg-card);
        }
        
        /* Blockquotes */
        blockquote {
            border-left: 4px solid var(--primary);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg-main);
            border-radius: 0 8px 8px 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Horizontal Rule */
        hr {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
        
        .footer { 
            text-align: center; 
            padding: 2rem; 
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            margin-top: 3rem; 
            font-size: 14px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .file-list { grid-template-columns: 1fr; }
            .content { padding: 1.5rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-btn">üè†</a>
    <div class="container">
        <div class="breadcrumb">
            <div style="padding: 0 20px;">
                <a href="../index.html">üè† Home</a> <span style="color: #64748b;">/</span> <a href="index.html">06 Production-Ready Patterns</a>
            </div>
        </div>
        <div class="content">
            <h1 id="chapter-26-going-to-production">Chapter 26: Going to Production</h1>
<h2 id="environment-configuration">Environment configuration</h2>
<h2 id="the-production-environment-problem">The Production Environment Problem</h2>
<p>You've built a feature-complete application. It works perfectly on your laptop. You run <code>npm run build</code>, deploy to production, and... nothing works. The API calls fail. The authentication breaks. The analytics don't fire. The feature flags are stuck in development mode.</p>
<p><strong>This is the environment configuration problem</strong>: Your application needs different settings in different environments, but you've hardcoded everything for local development.</p>
<p>Let's see this failure in action, then build a robust environment configuration system.</p>
<h3 id="phase-1-the-reference-implementation-hardcoded-configuration">Phase 1: The Reference Implementation - Hardcoded Configuration</h3>
<p>We'll build a production-ready e-commerce checkout flow that needs different configurations across environments:</p>
<ul>
<li><strong>Development</strong>: Local API, test payment keys, verbose logging</li>
<li><strong>Staging</strong>: Staging API, test payment keys, moderate logging</li>
<li><strong>Production</strong>: Production API, live payment keys, minimal logging</li>
</ul>
<p>Here's the naive approach that will fail in production:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsProcessing</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleCheckout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Hardcoded configuration - works in development</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;http://localhost:3001/api/checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;X-API-Key&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;dev_test_key_12345&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;prod_1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="w"> </span><span class="p">}],</span>
<span class="w">          </span><span class="nx">paymentMethod</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;test_card_4242&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Checkout failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checkout successful:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Hardcoded analytics</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="o">?</span><span class="p">.(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;purchase&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">transaction_id</span><span class="o">:</span><span class="w"> </span><span class="kt">data.orderId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">data.total</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setError</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Checkout error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCheckout</span><span class="p">}</span>
<span class="w">        </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isProcessing</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isProcessing</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Processing...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Complete Purchase&#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-0-the-production-deployment-failure">Iteration 0: The Production Deployment Failure</h3>
<p>You deploy this to production. Let's see what happens:</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code>POST https://your-app.com/checkout net::ERR_FAILED
Checkout error: TypeError: Failed to fetch
</code></pre></div>

<p><strong>Network Tab</strong>:
- Request to <code>http://localhost:3001/api/checkout</code>
- Status: (failed) net::ERR_CONNECTION_REFUSED
- No response received</p>
<p><strong>User Experience</strong>:
- Button shows "Processing..." briefly
- Error message appears: "Checkout failed"
- No purchase is completed
- No analytics event fires</p>
<h3 id="diagnostic-analysis-reading-the-production-failure">Diagnostic Analysis: Reading the Production Failure</h3>
<p><strong>What the user experiences</strong>:
- Expected: Successful checkout with confirmation
- Actual: Immediate error, no purchase processed</p>
<p><strong>What the console reveals</strong>:
- Key indicator: <code>net::ERR_FAILED</code> on fetch to localhost
- Error location: The hardcoded <code>http://localhost:3001</code> URL
- Root cause: Trying to connect to localhost from production server</p>
<p><strong>What the Network tab shows</strong>:
- Request pattern: Single failed request to localhost
- No retry attempts
- Browser can't resolve localhost in production context</p>
<p><strong>Root cause identified</strong>: Hardcoded development URLs and API keys don't work in production.</p>
<p><strong>Why the current approach can't solve this</strong>: You can't change the code for each environment. You need configuration that changes automatically based on where the app is running.</p>
<p><strong>What we need</strong>: Environment-specific configuration that's:
1. Secure (no secrets in client code)
2. Type-safe (catch configuration errors at build time)
3. Environment-aware (automatically uses correct values)
4. Validated (fails fast if misconfigured)</p>
<h2 id="building-a-robust-environment-configuration-system">Building a Robust Environment Configuration System</h2>
<h3 id="the-environment-variable-foundation">The Environment Variable Foundation</h3>
<p>Next.js provides built-in environment variable support with important security distinctions:</p>
<p><strong>Server-side variables</strong> (private):
- Available only in Server Components and API Routes
- Never sent to the browser
- Perfect for API keys, database URLs, secrets</p>
<p><strong>Client-side variables</strong> (public):
- Must be prefixed with <code>NEXT_PUBLIC_</code>
- Bundled into the client JavaScript
- Visible to anyone who inspects your code
- Use only for non-sensitive configuration</p>
<p>Let's build our configuration system:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env.local (for local development - never commit this)</span>
<span class="c1"># This file is gitignored by default</span>

<span class="c1"># Server-side only (secure)</span>
<span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span>sk_test_51abc123...
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://localhost:5432/myapp
<span class="nv">API_SECRET_KEY</span><span class="o">=</span>dev_secret_key_12345

<span class="c1"># Client-side (public - will be in browser bundle)</span>
<span class="nv">NEXT_PUBLIC_API_URL</span><span class="o">=</span>http://localhost:3001
<span class="nv">NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span>pk_test_51abc123...
<span class="nv">NEXT_PUBLIC_ANALYTICS_ID</span><span class="o">=</span>G-XXXXXXXXXX
<span class="nv">NEXT_PUBLIC_ENVIRONMENT</span><span class="o">=</span>development
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># .env.production (committed to repo - production defaults)</span>
<span class="c1"># These are overridden by actual secrets in deployment platform</span>

<span class="c1"># Server-side placeholders (real values set in Vercel/deployment platform)</span>
<span class="nv">STRIPE_SECRET_KEY</span><span class="o">=</span>sk_live_placeholder
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://placeholder
<span class="nv">API_SECRET_KEY</span><span class="o">=</span>placeholder

<span class="c1"># Client-side production values (safe to commit)</span>
<span class="nv">NEXT_PUBLIC_API_URL</span><span class="o">=</span>https://api.yourapp.com
<span class="nv">NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="o">=</span>pk_live_placeholder
<span class="nv">NEXT_PUBLIC_ANALYTICS_ID</span><span class="o">=</span>G-PRODUCTION123
<span class="nv">NEXT_PUBLIC_ENVIRONMENT</span><span class="o">=</span>production
</code></pre></div>

<h3 id="type-safe-environment-configuration">Type-Safe Environment Configuration</h3>
<p>Raw <code>process.env</code> access is error-prone. Let's create a type-safe configuration layer:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/config/env.ts</span>
<span class="c1">// Type-safe environment variable access with validation</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Schema for server-side environment variables</span>
<span class="cm"> * These are NEVER exposed to the client</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">serverEnvSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">STRIPE_SECRET_KEY</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Stripe secret key is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">DATABASE_URL</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;Database URL must be valid&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">API_SECRET_KEY</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;API secret key is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">NODE_ENV</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;development&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">),</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Schema for client-side environment variables</span>
<span class="cm"> * These ARE exposed to the client (must be prefixed with NEXT_PUBLIC_)</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">clientEnvSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">NEXT_PUBLIC_API_URL</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;API URL must be valid&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Stripe publishable key is required&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">NEXT_PUBLIC_ANALYTICS_ID</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;development&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">),</span>
<span class="p">});</span>

<span class="cm">/**</span>
<span class="cm"> * Validate and parse server environment variables</span>
<span class="cm"> * Call this in Server Components or API Routes only</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serverEnvSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;‚ùå Invalid server environment variables:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">);</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Invalid server environment configuration&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Validate and parse client environment variables</span>
<span class="cm"> * Safe to call anywhere (client or server)</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getClientEnv</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientEnvSchema</span><span class="p">.</span><span class="nx">safeParse</span><span class="p">({</span>
<span class="w">    </span><span class="nx">NEXT_PUBLIC_API_URL</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NEXT_PUBLIC_API_URL</span><span class="p">,</span>
<span class="w">    </span><span class="nx">NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="p">,</span>
<span class="w">    </span><span class="nx">NEXT_PUBLIC_ANALYTICS_ID</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NEXT_PUBLIC_ANALYTICS_ID</span><span class="p">,</span>
<span class="w">    </span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NEXT_PUBLIC_ENVIRONMENT</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;‚ùå Invalid client environment variables:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">flatten</span><span class="p">().</span><span class="nx">fieldErrors</span><span class="p">);</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Invalid client environment configuration&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">parsed</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Type-safe client environment access</span>
<span class="cm"> * Use this in Client Components</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">clientEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getClientEnv</span><span class="p">();</span>

<span class="cm">/**</span>
<span class="cm"> * Helper to check current environment</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">isDevelopment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">isStaging</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="p">;</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">isProduction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">;</span>
</code></pre></div>

<h3 id="iteration-1-environment-aware-checkout">Iteration 1: Environment-Aware Checkout</h3>
<p>Now let's refactor our checkout to use environment configuration:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">,</span><span class="w"> </span><span class="nx">isProduction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsProcessing</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="w"> </span><span class="err">|</span><span class="w"> </span><span class="na">null</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleCheckout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setError</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Environment-aware API URL</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_API_URL</span><span class="si">}</span><span class="sb">/api/checkout`</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">          </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;prod_1&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="w"> </span><span class="p">}],</span>
<span class="w">          </span><span class="c1">// Use environment-specific payment key</span>
<span class="w">          </span><span class="nx">stripeKey</span><span class="o">:</span><span class="w"> </span><span class="kt">clientEnv.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span><span class="p">,</span>
<span class="w">        </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Checkout failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// Conditional logging based on environment</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isProduction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checkout successful:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Environment-aware analytics</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ANALYTICS_ID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;purchase&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">transaction_id</span><span class="o">:</span><span class="w"> </span><span class="kt">data.orderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">data.total</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setError</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Detailed error logging in non-production</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isProduction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Checkout error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">{</span><span class="cm">/* Development-only environment indicator */</span><span class="p">}</span>
<span class="w">      </span><span class="p">{</span><span class="o">!</span><span class="nx">isProduction</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded mb-4 text-sm&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">Environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">API</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_API_URL</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">{</span><span class="nx">error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">error</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">)}</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">        </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCheckout</span><span class="p">}</span>
<span class="w">        </span><span class="na">disabled</span><span class="o">=</span><span class="p">{</span><span class="nx">isProcessing</span><span class="p">}</span>
<span class="w">        </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-blue-600 text-white px-6 py-3 rounded-lg disabled:opacity-50&quot;</span>
<span class="w">      </span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">isProcessing</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Processing...&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Complete Purchase&#39;</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Verification</strong>: Deploy to production with proper environment variables set:</p>
<p><strong>Browser Console</strong> (production):</p>
<div class="codehilite"><pre><span></span><code>(No checkout logs - production mode)
</code></pre></div>

<p><strong>Network Tab</strong>:
- Request to <code>https://api.yourapp.com/api/checkout</code>
- Status: 200 OK
- Response received successfully</p>
<p><strong>User Experience</strong>:
- Button processes correctly
- Success state shown
- Analytics event fires
- No environment indicator visible</p>
<p><strong>Expected vs. Actual improvement</strong>:
- Before: 100% failure rate in production (localhost connection refused)
- After: Successful API calls using correct production URL
- Before: Test API keys exposed in production
- After: Environment-specific keys used correctly
- Before: Verbose logging in production
- After: Minimal logging, detailed only in development</p>
<h3 id="server-side-environment-configuration">Server-Side Environment Configuration</h3>
<p>For API routes and Server Components, we need secure access to server-side variables:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/checkout/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Stripe</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;stripe&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Initialize Stripe with server-side secret key</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Stripe</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">STRIPE_SECRET_KEY</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2023-10-16&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Create payment intent with secret key</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">paymentIntents</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">2000</span><span class="p">,</span>
<span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;usd&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="kt">env.NODE_ENV</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Log only in development</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Payment intent created:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentIntent</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">orderId</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.amount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">clientSecret</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentIntent.client_secret</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Checkout error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Checkout failed&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="build-time-environment-validation">Build-Time Environment Validation</h3>
<p>Catch configuration errors before deployment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/config/validate-env.ts</span>
<span class="c1">// Run this during build to catch configuration errors early</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getClientEnv</span><span class="p">,</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./env&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Validate environment configuration at build time</span>
<span class="cm"> * Add this to your build script: &quot;build&quot;: &quot;node -r ./src/config/validate-env.ts next build&quot;</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">validateEnvironment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;üîç Validating environment configuration...&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Validate client environment (always available)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">clientEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getClientEnv</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;‚úÖ Client environment valid&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   Environment: </span><span class="si">${</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   API URL: </span><span class="si">${</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_API_URL</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Validate server environment (only in Node.js context)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">serverEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;‚úÖ Server environment valid&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`   Node environment: </span><span class="si">${</span><span class="nx">serverEnv</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;‚úÖ Environment configuration validated successfully\n&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;‚ùå Environment validation failed:&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Run validation if this file is executed directly</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">main</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">module</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">validateEnvironment</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// package.json</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;scripts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;dev&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next dev&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;build&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node -r ./src/config/validate-env.ts &amp;&amp; next build&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;next start&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;validate-env&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;node -r ./src/config/validate-env.ts&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-mode-missing-environment-variables">Common Failure Mode: Missing Environment Variables</h3>
<p><strong>Symptom</strong>: Build succeeds but app crashes at runtime</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">configuration</span>
<span class="w">  </span><span class="n">at</span><span class="w"> </span><span class="n">getClientEnv</span><span class="w"> </span><span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">ts</span><span class="o">:</span><span class="mi">45</span><span class="o">)</span>
</code></pre></div>

<p><strong>Terminal Output</strong> (during build):</p>
<div class="codehilite"><pre><span></span><code><span class="err">‚ùå</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NEXT_PUBLIC_API_URL</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Required&#39;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Root cause</strong>: Environment variable not set in deployment platform</p>
<p><strong>Solution</strong>: 
1. Check deployment platform environment variables
2. Ensure all required variables are set
3. Verify variable names match exactly (including <code>NEXT_PUBLIC_</code> prefix)
4. Redeploy after adding missing variables</p>
<h3 id="when-to-apply-this-solution">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Security (secrets never in client code)
- Type safety (catch errors at build time)
- Environment flexibility (same code, different configs)
- Developer experience (autocomplete, validation)</p>
<p><strong>What it sacrifices</strong>:
- Initial setup complexity
- Additional validation code
- Build-time overhead (minimal)</p>
<p><strong>When to choose this approach</strong>:
- Any production application
- Multiple deployment environments
- Team collaboration (prevents configuration drift)
- Applications with secrets or API keys</p>
<p><strong>When to avoid this approach</strong>:
- Simple static sites with no backend
- Prototypes with no deployment plans
- Single-environment applications (rare)</p>
<p><strong>Code characteristics</strong>:
- Setup: ~100 lines of configuration code
- Maintenance: Low (add variables as needed)
- Performance: Zero runtime impact (build-time validation)</p>
<h2 id="feature-flags-with-simple-patterns">Feature flags with simple patterns</h2>
<h2 id="the-feature-flag-problem">The Feature Flag Problem</h2>
<p>You've built a new checkout flow. It's ready for testing, but you don't want to deploy it to all users yet. You want to:</p>
<ol>
<li>Test it with internal users first</li>
<li>Gradually roll it out to 10%, then 50%, then 100% of users</li>
<li>Instantly disable it if something goes wrong</li>
<li>A/B test it against the old flow</li>
</ol>
<p><strong>Without feature flags</strong>, you'd need to:
- Maintain separate branches for each feature
- Deploy different code to different environments
- Manually revert deployments when issues arise
- Can't test in production without affecting all users</p>
<p>Let's build a simple, effective feature flag system.</p>
<h3 id="phase-1-the-hardcoded-feature-toggle">Phase 1: The Hardcoded Feature Toggle</h3>
<p>Here's the naive approach - a boolean constant:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="c1">// Hardcoded feature flag</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">USE_NEW_CHECKOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">USE_NEW_CHECKOUT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">NewCheckoutFlow</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">OldCheckoutFlow</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">NewCheckoutFlow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">New</span><span class="w"> </span><span class="nx">Checkout</span><span class="w"> </span><span class="p">(</span><span class="nx">Beta</span><span class="p">)&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Improved</span><span class="w"> </span><span class="nx">checkout</span><span class="w"> </span><span class="nx">experience</span><span class="w"> </span><span class="kd">with</span><span class="w"> </span><span class="nx">one</span><span class="o">-</span><span class="nx">click</span><span class="w"> </span><span class="nx">payment</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">OldCheckoutFlow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Standard</span><span class="w"> </span><span class="nx">checkout</span><span class="w"> </span><span class="nx">flow</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-deployment-problem">The Deployment Problem</h3>
<p>You want to enable the new checkout for internal testing. Your options:</p>
<ol>
<li><strong>Change the constant and deploy</strong>: Now ALL users see it (too risky)</li>
<li><strong>Use environment variables</strong>: Can't change without redeploying</li>
<li><strong>Maintain separate branches</strong>: Merge conflicts, deployment complexity</li>
</ol>
<p><strong>What we need</strong>: Feature flags that can be:
- Changed without redeploying
- Targeted to specific users or percentages
- Instantly toggled on/off
- Tracked and audited</p>
<h2 id="building-a-simple-feature-flag-system">Building a Simple Feature Flag System</h2>
<p>We'll build a pragmatic system that doesn't require external services for basic use cases.</p>
<h3 id="the-feature-flag-configuration">The Feature Flag Configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/config/features.ts</span>
<span class="c1">// Simple feature flag system with multiple strategies</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">FeatureFlagStrategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;percentage&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">rollout</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// 0-100</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;userList&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">allowedUsers</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;environment&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">environments</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[]</span><span class="w"> </span><span class="p">};</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">FeatureFlag</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlagStrategy</span><span class="p">;</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Feature flag configuration</span>
<span class="cm"> * In production, this would come from a database or API</span>
<span class="cm"> * For now, we&#39;ll use a simple in-memory configuration</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">featureFlags</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">FeatureFlag</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;new-checkout&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;new-checkout&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;New Checkout Flow&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Improved one-click checkout experience&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;percentage&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">rollout</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// 10% of users</span>
<span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-15T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-15T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="s1">&#39;express-shipping&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;express-shipping&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Express Shipping Option&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Same-day delivery for eligible items&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;environment&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">environments</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;development&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;staging&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-10T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-10T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="s1">&#39;admin-dashboard&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;admin-dashboard&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;New Admin Dashboard&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Redesigned admin interface&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;userList&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="nx">allowedUsers</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;admin@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dev@example.com&#39;</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-01T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2024-01-01T10:00:00Z&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Get a feature flag by key</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getFeatureFlag</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">FeatureFlag</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">featureFlags</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Update a feature flag (in production, this would update the database)</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateFeatureFlag</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">updates</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">FeatureFlag</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">featureFlags</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">featureFlags</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">flag</span><span class="p">,</span>
<span class="w">      </span><span class="p">...</span><span class="nx">updates</span><span class="p">,</span>
<span class="w">      </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-feature-flag-evaluation-engine">The Feature Flag Evaluation Engine</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/feature-flags.ts</span>
<span class="c1">// Feature flag evaluation logic</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getFeatureFlag</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">FeatureFlagStrategy</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/features&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clientEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Context for evaluating feature flags</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">FeatureFlagContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">userId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">userEmail?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">environment?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Generate a consistent hash for percentage-based rollouts</span>
<span class="cm"> * Same user always gets same result for same feature</span>
<span class="cm"> */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">hashString</span><span class="p">(</span><span class="nx">str</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="kr">char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">    </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="nx">hash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">hash</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kr">char</span><span class="p">;</span>
<span class="w">    </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">hash</span><span class="p">;</span><span class="w"> </span><span class="c1">// Convert to 32-bit integer</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">hash</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Evaluate a feature flag strategy</span>
<span class="cm"> */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">evaluateStrategy</span><span class="p">(</span>
<span class="w">  </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlagStrategy</span><span class="p">,</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlagContext</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">strategy</span><span class="p">.</span><span class="kr">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="o">:</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">enabled</span><span class="p">;</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;percentage&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Need a user identifier for consistent rollout</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">userId</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">identifier</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// Can&#39;t do percentage rollout without user ID</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Generate consistent hash and convert to percentage</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hashString</span><span class="p">(</span><span class="nx">identifier</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">userPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hash</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">userPercentage</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">rollout</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;userList&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">userEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">userEmail</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">userEmail</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">allowedUsers</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">userEmail</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;environment&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">environment</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ENVIRONMENT</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">environments</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">environment</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">default</span><span class="o">:</span>
<span class="w">      </span><span class="kt">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Check if a feature flag is enabled for the given context</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">isFeatureEnabled</span><span class="p">(</span>
<span class="w">  </span><span class="nx">flagKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlagContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getFeatureFlag</span><span class="p">(</span><span class="nx">flagKey</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">flag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Flag doesn&#39;t exist - default to disabled</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Feature flag &quot;</span><span class="si">${</span><span class="nx">flagKey</span><span class="si">}</span><span class="sb">&quot; not found`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">evaluateStrategy</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nx">strategy</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * React hook for feature flags</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useFeatureFlag</span><span class="p">(</span>
<span class="w">  </span><span class="nx">flagKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlagContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In a real app, this would subscribe to flag updates</span>
<span class="w">  </span><span class="c1">// For now, we evaluate once</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">isFeatureEnabled</span><span class="p">(</span><span class="nx">flagKey</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="iteration-1-feature-flagged-checkout">Iteration 1: Feature-Flagged Checkout</h3>
<p>Now let's use feature flags in our checkout:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useFeatureFlag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/feature-flags&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/hooks/useUser&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Assume this exists</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useUser</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Evaluate feature flag with user context</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">useNewCheckout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFeatureFlag</span><span class="p">(</span><span class="s1">&#39;new-checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">user?.id</span><span class="p">,</span>
<span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">user?.email</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useNewCheckout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">NewCheckoutFlow</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">OldCheckoutFlow</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">NewCheckoutFlow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-blue-50 border border-blue-200 text-blue-800 px-4 py-2 rounded mb-4 text-sm&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="err">‚ú®</span><span class="w"> </span><span class="nx">You</span><span class="err">&#39;</span><span class="nx">re</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">checkout</span><span class="w"> </span><span class="nx">experience</span><span class="o">!</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Express</span><span class="w"> </span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">One</span><span class="o">-</span><span class="nx">click</span><span class="w"> </span><span class="nx">payment</span><span class="w"> </span><span class="kd">with</span><span class="w"> </span><span class="nx">saved</span><span class="w"> </span><span class="nx">cards</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* New checkout implementation */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">OldCheckoutFlow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-2xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="nx">Standard</span><span class="w"> </span><span class="nx">checkout</span><span class="w"> </span><span class="nx">flow</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">{</span><span class="cm">/* Original checkout implementation */</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Verification</strong>: With 10% rollout configured:</p>
<p><strong>User A</strong> (userId: "user_123"):
- Hash of "user_123" % 100 = 23
- 23 &lt; 10? No
- Sees: Old checkout flow</p>
<p><strong>User B</strong> (userId: "user_456"):
- Hash of "user_456" % 100 = 7
- 7 &lt; 10? Yes
- Sees: New checkout flow (with blue banner)</p>
<p><strong>Expected vs. Actual improvement</strong>:
- Before: All users see same version (can't test in production)
- After: 10% of users see new version (gradual rollout)
- Before: Need to redeploy to change rollout
- After: Can update percentage in config (still need redeploy for now)
- Before: No way to target specific users
- After: Can use userList strategy for internal testing</p>
<h3 id="server-side-feature-flag-api">Server-Side Feature Flag API</h3>
<p>For dynamic flag updates without redeployment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/feature-flags/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">featureFlags</span><span class="p">,</span><span class="w"> </span><span class="nx">updateFeatureFlag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/features&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * GET /api/feature-flags</span>
<span class="cm"> * List all feature flags</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In production, verify admin authentication</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-api-key&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">API_SECRET_KEY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">flags</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.values</span><span class="p">(</span><span class="nx">featureFlags</span><span class="p">),</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * PATCH /api/feature-flags/[key]</span>
<span class="cm"> * Update a feature flag</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">PATCH</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-api-key&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">apiKey</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nx">API_SECRET_KEY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unauthorized&#39;</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">401</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">strategy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Missing required fields&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">updateFeatureFlag</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">flag</span><span class="o">:</span><span class="w"> </span><span class="kt">featureFlags</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Invalid request&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">400</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="dynamic-flag-updates">Dynamic Flag Updates</h3>
<p>Now you can update flags without redeploying:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Increase rollout to 50%</span>
curl<span class="w"> </span>-X<span class="w"> </span>PATCH<span class="w"> </span>https://your-app.com/api/feature-flags<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;x-api-key: your_secret_key&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;key&quot;: &quot;new-checkout&quot;,</span>
<span class="s1">    &quot;strategy&quot;: { &quot;type&quot;: &quot;percentage&quot;, &quot;rollout&quot;: 50 }</span>
<span class="s1">  }&#39;</span>

<span class="c1"># Enable for all users</span>
curl<span class="w"> </span>-X<span class="w"> </span>PATCH<span class="w"> </span>https://your-app.com/api/feature-flags<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;x-api-key: your_secret_key&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;key&quot;: &quot;new-checkout&quot;,</span>
<span class="s1">    &quot;strategy&quot;: { &quot;type&quot;: &quot;boolean&quot;, &quot;enabled&quot;: true }</span>
<span class="s1">  }&#39;</span>

<span class="c1"># Emergency disable</span>
curl<span class="w"> </span>-X<span class="w"> </span>PATCH<span class="w"> </span>https://your-app.com/api/feature-flags<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;x-api-key: your_secret_key&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;key&quot;: &quot;new-checkout&quot;,</span>
<span class="s1">    &quot;strategy&quot;: { &quot;type&quot;: &quot;boolean&quot;, &quot;enabled&quot;: false }</span>
<span class="s1">  }&#39;</span>
</code></pre></div>

<h3 id="feature-flag-admin-ui">Feature Flag Admin UI</h3>
<p>A simple admin interface for managing flags:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/admin/feature-flags/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FeatureFlag</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/features&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">FeatureFlagsAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">flags</span><span class="p">,</span><span class="w"> </span><span class="nx">setFlags</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">&lt;</span><span class="nt">FeatureFlag</span><span class="err">[]</span><span class="p">&gt;([]);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isLoading</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsLoading</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">loadFlags</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">loadFlags</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/feature-flags&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;x-api-key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ADMIN_KEY</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">      </span><span class="nx">setFlags</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">flags</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to load flags:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsLoading</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateFlag</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/feature-flags&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="s1">&#39;x-api-key&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ADMIN_KEY</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">loadFlags</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Failed to update flag:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isLoading</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;p-6&quot;</span><span class="p">&gt;</span><span class="nx">Loading</span><span class="p">...&lt;/</span><span class="nt">div</span><span class="p">&gt;;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-6xl mx-auto p-6&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">h1</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-3xl font-bold mb-6&quot;</span><span class="p">&gt;</span><span class="nx">Feature</span><span class="w"> </span><span class="nx">Flags</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;space-y-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">flags</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">flag</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">flag</span><span class="p">.</span><span class="nx">key</span><span class="p">}</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;border rounded-lg p-4&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-start justify-between mb-2&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">h3</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;font-semibold text-lg&quot;</span><span class="p">&gt;{</span><span class="nx">flag</span><span class="p">.</span><span class="nx">name</span><span class="p">}&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-gray-600&quot;</span><span class="p">&gt;{</span><span class="nx">flag</span><span class="p">.</span><span class="nx">description</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xs text-gray-500 mt-1&quot;</span><span class="p">&gt;</span><span class="nx">Key</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">flag</span><span class="p">.</span><span class="nx">key</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">              </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-right&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-gray-600&quot;</span><span class="p">&gt;</span>
<span class="w">                  </span><span class="nx">Updated</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">).</span><span class="nx">toLocaleDateString</span><span class="p">()}</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;mt-4&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="p">&lt;</span><span class="nt">StrategyEditor</span>
<span class="w">                </span><span class="na">flag</span><span class="o">=</span><span class="p">{</span><span class="nx">flag</span><span class="p">}</span>
<span class="w">                </span><span class="na">onUpdate</span><span class="o">=</span><span class="p">{(</span><span class="nx">strategy</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">updateFlag</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="p">)}</span>
<span class="w">              </span><span class="p">/&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">))}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">StrategyEditor</span><span class="p">({</span><span class="w"> </span>
<span class="w">  </span><span class="nx">flag</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">onUpdate</span><span class="w"> </span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">flag</span><span class="o">:</span><span class="w"> </span><span class="kt">FeatureFlag</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="nx">onUpdate</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">strategy</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">flag</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">strategy</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm font-medium&quot;</span><span class="p">&gt;</span><span class="nx">Status</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">          </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">onUpdate</span><span class="p">({</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;boolean&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="o">!</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="p">})}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`px-4 py-2 rounded </span><span class="si">${</span>
<span class="w">            </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span>
<span class="w">              </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;bg-green-600 text-white&#39;</span><span class="w"> </span>
<span class="w">              </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;bg-gray-300 text-gray-700&#39;</span>
<span class="w">          </span><span class="si">}</span><span class="sb">`</span><span class="p">}</span>
<span class="w">        </span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;Enabled&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Disabled&#39;</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">strategy</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;percentage&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex items-center gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm font-medium&quot;</span><span class="p">&gt;</span><span class="nx">Rollout</span><span class="o">:</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">input</span>
<span class="w">          </span><span class="na">type</span><span class="o">=</span><span class="s">&quot;range&quot;</span>
<span class="w">          </span><span class="na">min</span><span class="o">=</span><span class="s">&quot;0&quot;</span>
<span class="w">          </span><span class="na">max</span><span class="o">=</span><span class="s">&quot;100&quot;</span>
<span class="w">          </span><span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">rollout</span><span class="p">}</span>
<span class="w">          </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">onUpdate</span><span class="p">({</span><span class="w"> </span>
<span class="w">            </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;percentage&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">rollout</span><span class="o">:</span><span class="w"> </span><span class="kt">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span>
<span class="w">          </span><span class="p">})}</span>
<span class="w">          </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex-1&quot;</span>
<span class="w">        </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">span</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm font-semibold w-12&quot;</span><span class="p">&gt;{</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">rollout</span><span class="p">}</span><span class="o">%</span><span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm text-gray-600&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="nx">Strategy</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">strategy</span><span class="p">.</span><span class="kr">type</span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-mode-inconsistent-flag-evaluation">Common Failure Mode: Inconsistent Flag Evaluation</h3>
<p><strong>Symptom</strong>: User sees different versions on different page loads</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Warning</span><span class="o">:</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="s2">&quot;new-checkout&quot;</span><span class="w"> </span><span class="n">evaluated</span><span class="w"> </span><span class="n">differently</span>
<span class="w">  </span><span class="n">First</span><span class="w"> </span><span class="n">render</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">Second</span><span class="w"> </span><span class="n">render</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
</code></pre></div>

<p><strong>Root cause</strong>: Feature flag evaluated without stable user context</p>
<p><strong>Solution</strong>: Always provide consistent user context:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚ùå Bad: No user context (random results)</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFeatureFlag</span><span class="p">(</span><span class="s1">&#39;new-checkout&#39;</span><span class="p">);</span>

<span class="c1">// ‚úÖ Good: Stable user context</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useUser</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useFeatureFlag</span><span class="p">(</span><span class="s1">&#39;new-checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">user?.id</span><span class="p">,</span>
<span class="w">  </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="kt">user?.email</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="when-to-apply-this-solution_1">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Safe production testing (gradual rollouts)
- Instant feature toggles (no redeployment)
- A/B testing capability
- Emergency kill switches</p>
<p><strong>What it sacrifices</strong>:
- Additional code complexity
- Flag management overhead
- Potential for flag debt (old flags not cleaned up)</p>
<p><strong>When to choose this approach</strong>:
- Production applications with active development
- Features that need gradual rollout
- A/B testing requirements
- High-risk features that need kill switches</p>
<p><strong>When to avoid this approach</strong>:
- Simple applications with infrequent releases
- Features that don't need gradual rollout
- Prototypes or MVPs</p>
<p><strong>Code characteristics</strong>:
- Setup: ~200 lines for basic system
- Maintenance: Medium (need to clean up old flags)
- Performance: Minimal (evaluation is fast)</p>
<h3 id="limitation-preview">Limitation Preview</h3>
<p>This simple system works well for basic use cases, but has limitations:</p>
<ul>
<li><strong>No real-time updates</strong>: Flags cached until page reload</li>
<li><strong>No analytics</strong>: Can't track flag performance</li>
<li><strong>No audit log</strong>: Can't see who changed what when</li>
<li><strong>No advanced targeting</strong>: Can't target by location, device, etc.</li>
</ul>
<p>For advanced needs, consider services like LaunchDarkly, Split.io, or Flagsmith. But for most applications, this simple system is sufficient.</p>
<h2 id="analytics-integration">Analytics integration</h2>
<h2 id="the-analytics-problem">The Analytics Problem</h2>
<p>Your application is live. Users are clicking buttons, completing purchases, encountering errors. But you have no idea:</p>
<ul>
<li>Which features are actually being used</li>
<li>Where users are getting stuck</li>
<li>What errors are happening in production</li>
<li>How performance varies across users</li>
</ul>
<p><strong>Without analytics</strong>, you're flying blind. Let's build a comprehensive analytics system.</p>
<h3 id="phase-1-the-naive-analytics-implementation">Phase 1: The Naive Analytics Implementation</h3>
<p>Here's the common mistake - directly calling analytics APIs everywhere:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsProcessing</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleCheckout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Direct analytics call</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="o">?</span><span class="p">.(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkout_started&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="p">,</span>
<span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Checkout failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Another direct analytics call</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="o">?</span><span class="p">.(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;purchase&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">transaction_id</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;txn_123&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="p">,</span>
<span class="w">        </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Yet another direct analytics call</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="o">?</span><span class="p">.(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkout_error&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">error_message</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCheckout</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="nx">Complete</span><span class="w"> </span><span class="nx">Purchase</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-problems-with-direct-analytics-calls">The Problems with Direct Analytics Calls</h3>
<ol>
<li><strong>Vendor lock-in</strong>: Switching from Google Analytics to another service requires changing code everywhere</li>
<li><strong>No type safety</strong>: Easy to send wrong event names or properties</li>
<li><strong>Inconsistent tracking</strong>: Different developers track events differently</li>
<li><strong>No testing</strong>: Can't test analytics without actually sending events</li>
<li><strong>No debugging</strong>: Hard to see what events are being sent</li>
<li><strong>Privacy concerns</strong>: No easy way to respect user consent</li>
</ol>
<p>Let's build a better system.</p>
<h2 id="building-a-robust-analytics-system">Building a Robust Analytics System</h2>
<h3 id="the-analytics-abstraction-layer">The Analytics Abstraction Layer</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/analytics/types.ts</span>
<span class="c1">// Type-safe analytics event definitions</span>

<span class="cm">/**</span>
<span class="cm"> * Standard e-commerce events</span>
<span class="cm"> * Based on Google Analytics 4 recommended events</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="c1">// Page views</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;page_view&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page_path</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">page_title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// E-commerce events</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;view_item&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">item_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">item_name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;add_to_cart&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">item_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">item_name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;begin_checkout&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;purchase&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">transaction_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="p">}}</span>

<span class="w">  </span><span class="c1">// User actions</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;sign_up&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;login&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;search&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">search_term</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Errors</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error_message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="nx">error_location</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">error_type</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}}</span>

<span class="w">  </span><span class="c1">// Custom events</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;feature_used&#39;</span><span class="p">;</span><span class="w"> </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">feature_name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">context?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * User properties for analytics</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">AnalyticsUser</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">email?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">plan</span><span class="o">?:</span><span class="w"> </span><span class="s1">&#39;free&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;pro&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;enterprise&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">signupDate?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Analytics provider interface</span>
<span class="cm"> * Implement this for each analytics service</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="nx">identifyUser</span><span class="p">(</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsUser</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/analytics/providers/google-analytics.ts</span>
<span class="c1">// Google Analytics 4 provider implementation</span>

<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clientEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">GoogleAnalyticsProvider</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Google Analytics&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">measurementId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">measurementId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">measurementId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">measurementId</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Load Google Analytics script</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">script</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`https://www.googletagmanager.com/gtag/js?id=</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">measurementId</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="nx">script</span><span class="p">.</span><span class="k">async</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Initialize gtag</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">dataLayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">dataLayer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">gtag</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">dataLayer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">());</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">measurementId</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">send_page_view</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// We&#39;ll handle page views manually</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">properties</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">identifyUser</span><span class="p">(</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsUser</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">gtag</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user_properties&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">user_id</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">plan</span><span class="o">:</span><span class="w"> </span><span class="kt">user.plan</span><span class="p">,</span>
<span class="w">      </span><span class="nx">signup_date</span><span class="o">:</span><span class="w"> </span><span class="kt">user.signupDate</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Google Analytics doesn&#39;t have a built-in reset</span>
<span class="w">    </span><span class="c1">// In practice, you&#39;d clear cookies and reload</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Type augmentation for window.gtag</span>
<span class="kr">declare</span><span class="w"> </span><span class="nb">global</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Window</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dataLayer</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">gtag</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">...args</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">[])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/analytics/providers/console.ts</span>
<span class="c1">// Console provider for development/debugging</span>

<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../types&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ConsoleAnalyticsProvider</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Console&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;üìä Analytics initialized (Console provider)&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;üìä Analytics Event:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">event.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="kt">event.properties</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">identifyUser</span><span class="p">(</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsUser</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;üìä Analytics User:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">reset</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;üìä Analytics reset&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-analytics-manager">The Analytics Manager</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/analytics/index.ts</span>
<span class="c1">// Central analytics manager</span>

<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AnalyticsProvider</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">GoogleAnalyticsProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./providers/google-analytics&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ConsoleAnalyticsProvider</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./providers/console&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">,</span><span class="w"> </span><span class="nx">isProduction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">AnalyticsManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">providers</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsProvider</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">consentGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">eventQueue</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Initialize analytics with configured providers</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">initialize</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Always use console provider in development</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isProduction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">ConsoleAnalyticsProvider</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Add Google Analytics in production (if configured)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ANALYTICS_ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">GoogleAnalyticsProvider</span><span class="p">(</span><span class="nx">clientEnv</span><span class="p">.</span><span class="nx">NEXT_PUBLIC_ANALYTICS_ID</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Initialize all providers</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Failed to initialize </span><span class="si">${</span><span class="nx">provider</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Check for stored consent</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">checkConsent</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Check if user has given analytics consent</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">checkConsent</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nb">window</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;undefined&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">consent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;analytics_consent&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">consent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;granted&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">grantConsent</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Grant analytics consent and flush queued events</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">grantConsent</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">consentGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;analytics_consent&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;granted&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Flush queued events</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">event</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">));</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Revoke analytics consent</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">revokeConsent</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">consentGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">&#39;analytics_consent&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="c1">// Reset all providers</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Failed to reset </span><span class="si">${</span><span class="nx">provider</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Track an analytics event</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Analytics not initialized&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Queue events if consent not given (except in development)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">consentGiven</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isProduction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Send to all providers</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Failed to track event with </span><span class="si">${</span><span class="nx">provider</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Identify the current user</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">identifyUser</span><span class="p">(</span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsUser</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isInitialized</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">consentGiven</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">isProduction</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">provider</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">provider</span><span class="p">.</span><span class="nx">identifyUser</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Failed to identify user with </span><span class="si">${</span><span class="nx">provider</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Track a page view</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="nx">trackPageView</span><span class="p">(</span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;page_view&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">page_path</span><span class="o">:</span><span class="w"> </span><span class="kt">path</span><span class="p">,</span><span class="w"> </span><span class="nx">page_title</span><span class="o">:</span><span class="w"> </span><span class="kt">title</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Export singleton instance</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">analytics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AnalyticsManager</span><span class="p">();</span>

<span class="c1">// Export types for consumers</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="p">,</span><span class="w"> </span><span class="nx">AnalyticsUser</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./types&#39;</span><span class="p">;</span>
</code></pre></div>

<h3 id="iteration-1-type-safe-analytics-in-components">Iteration 1: Type-Safe Analytics in Components</h3>
<p>Now let's use our analytics system in the checkout:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/checkout/page.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">analytics</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/analytics&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span><span class="w"> </span><span class="nx">setIsProcessing</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleCheckout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Type-safe analytics event</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;begin_checkout&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="p">,</span>
<span class="w">        </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Checkout failed&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">      </span><span class="c1">// Track successful purchase</span>
<span class="w">      </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;purchase&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">transaction_id</span><span class="o">:</span><span class="w"> </span><span class="kt">data.orderId</span><span class="p">,</span>
<span class="w">          </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="p">,</span>
<span class="w">          </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Track error</span>
<span class="w">      </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">({</span>
<span class="w">        </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">error_message</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">error_location</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">error_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;checkout_failed&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCheckout</span><span class="p">}&gt;</span>
<span class="w">      </span><span class="nx">Complete</span><span class="w"> </span><span class="nx">Purchase</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Verification</strong>: In development, check the console:</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code>üìä Analytics initialized (Console provider)
üìä Analytics Event: {
  name: &#39;begin_checkout&#39;,
  properties: { value: 99.99, currency: &#39;USD&#39;, items: 1 },
  timestamp: &#39;2024-01-15T10:30:00.000Z&#39;
}
üìä Analytics Event: {
  name: &#39;purchase&#39;,
  properties: { 
    transaction_id: &#39;ord_abc123&#39;, 
    value: 99.99, 
    currency: &#39;USD&#39;,
    items: 1
  },
  timestamp: &#39;2024-01-15T10:30:02.000Z&#39;
}
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- Before: Direct gtag calls, no type safety
- After: Type-safe events, autocomplete in IDE
- Before: Vendor lock-in to Google Analytics
- After: Can switch providers without changing component code
- Before: No development visibility
- After: Console logging in development</p>
<h3 id="analytics-initialization">Analytics Initialization</h3>
<p>Initialize analytics when your app loads:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">analytics</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/analytics&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Initialize analytics on mount</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="automatic-page-view-tracking">Automatic Page View Tracking</h3>
<p>Track page views automatically with Next.js navigation:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/AnalyticsPageView.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">usePathname</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/navigation&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">analytics</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/analytics&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">AnalyticsPageView</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pathname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">usePathname</span><span class="p">();</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackPageView</span><span class="p">(</span><span class="nx">pathname</span><span class="p">,</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">pathname</span><span class="p">]);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">AnalyticsPageView</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/AnalyticsPageView&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">AnalyticsPageView</span><span class="w"> </span><span class="p">/&gt;</span>
<span class="w">        </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="user-consent-management">User Consent Management</h3>
<p>Implement GDPR-compliant consent:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/CookieConsent.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">analytics</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/analytics&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CookieConsent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">showBanner</span><span class="p">,</span><span class="w"> </span><span class="nx">setShowBanner</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Check if user has already made a choice</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">consent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;analytics_consent&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">consent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setShowBanner</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleAccept</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">grantConsent</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setShowBanner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleDecline</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">revokeConsent</span><span class="p">();</span>
<span class="w">    </span><span class="nx">setShowBanner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">showBanner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 shadow-lg z-50&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-6xl mx-auto flex items-center justify-between gap-4&quot;</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-sm&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="nx">We</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">improve</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">experience</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">analyze</span><span class="w"> </span><span class="nx">site</span><span class="w"> </span><span class="nx">usage</span><span class="p">.</span><span class="w"> </span>
<span class="w">          </span><span class="nx">By</span><span class="w"> </span><span class="nx">clicking</span><span class="w"> </span><span class="s2">&quot;Accept&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">consent</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">cookies</span><span class="p">.</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;flex gap-2 shrink-0&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">            </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleDecline</span><span class="p">}</span>
<span class="w">            </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 text-sm border border-gray-600 rounded hover:bg-gray-800&quot;</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="nx">Decline</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">            </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleAccept</span><span class="p">}</span>
<span class="w">            </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;px-4 py-2 text-sm bg-blue-600 rounded hover:bg-blue-700&quot;</span>
<span class="w">          </span><span class="p">&gt;</span>
<span class="w">            </span><span class="nx">Accept</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="custom-analytics-hooks">Custom Analytics Hooks</h3>
<p>Create reusable hooks for common tracking patterns:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/hooks/useAnalytics.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useEffect</span><span class="p">,</span><span class="w"> </span><span class="nx">useCallback</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">analytics</span><span class="p">,</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">AnalyticsEvent</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/analytics&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Track an event when component mounts</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useTrackMount</span><span class="p">(</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span><span class="w"> </span><span class="c1">// eslint-disable-line react-hooks/exhaustive-deps</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get a callback to track an event</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useTrackEvent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">((</span><span class="nx">event</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalyticsEvent</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">analytics</span><span class="p">.</span><span class="nx">trackEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Track feature usage</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useTrackFeature</span><span class="p">(</span><span class="nx">featureName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">context?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">trackEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useTrackEvent</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">useCallback</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">trackEvent</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;feature_used&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">properties</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">feature_name</span><span class="o">:</span><span class="w"> </span><span class="kt">featureName</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="nx">trackEvent</span><span class="p">,</span><span class="w"> </span><span class="nx">featureName</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// Usage example</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useTrackFeature</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/hooks/useAnalytics&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">SearchBar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">trackSearch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useTrackFeature</span><span class="p">(</span><span class="s1">&#39;search_bar&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;header&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleSearch</span><span class="p">(</span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">trackSearch</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// ... perform search</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">input</span><span class="w"> </span><span class="na">onChange</span><span class="o">=</span><span class="p">{(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">handleSearch</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span><span class="w"> </span><span class="p">/&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="common-failure-mode-analytics-not-loading">Common Failure Mode: Analytics Not Loading</h3>
<p><strong>Symptom</strong>: No analytics events in production</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code>(No analytics logs - silent failure)
</code></pre></div>

<p><strong>Network Tab</strong>:
- No requests to Google Analytics
- No gtag.js script loaded</p>
<p><strong>Root cause</strong>: Ad blocker or privacy extension blocking analytics</p>
<p><strong>Solution</strong>: 
1. Accept that some users will block analytics (respect their choice)
2. Use server-side analytics for critical metrics
3. Don't rely on analytics for core functionality
4. Test with ad blockers enabled</p>
<h3 id="when-to-apply-this-solution_2">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Type safety (catch errors at compile time)
- Vendor flexibility (easy to switch providers)
- Privacy compliance (consent management)
- Development experience (console logging)</p>
<p><strong>What it sacrifices</strong>:
- Initial setup complexity
- Additional abstraction layer
- Slightly more code per event</p>
<p><strong>When to choose this approach</strong>:
- Production applications
- Multiple analytics providers
- GDPR/privacy compliance required
- Team collaboration (consistent tracking)</p>
<p><strong>When to avoid this approach</strong>:
- Simple prototypes
- Single analytics provider that won't change
- No privacy compliance requirements</p>
<p><strong>Code characteristics</strong>:
- Setup: ~300 lines for complete system
- Maintenance: Low (add events as needed)
- Performance: Minimal overhead</p>
<h2 id="monitoring-and-alerting">Monitoring and alerting</h2>
<h2 id="the-monitoring-problem">The Monitoring Problem</h2>
<p>Your application is in production. Everything seems fine. Then you check your error tracking service and discover:</p>
<ul>
<li>500 users hit a critical error in the last hour</li>
<li>Your API response time increased 10x</li>
<li>Memory usage is climbing steadily</li>
<li>A deployment broke authentication for mobile users</li>
</ul>
<p><strong>Without monitoring</strong>, you only learn about problems when users complain. Let's build a comprehensive monitoring system.</p>
<h3 id="phase-1-the-silent-failure">Phase 1: The Silent Failure</h3>
<p>Here's what happens without monitoring:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/checkout/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// This might fail silently</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">processPayment</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Error logged to console (which you&#39;re not watching)</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Checkout error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Checkout failed&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processPayment</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Simulated payment processing</span>
<span class="w">  </span><span class="c1">// What if this throws an error?</span>
<span class="w">  </span><span class="c1">// What if it&#39;s slow?</span>
<span class="w">  </span><span class="c1">// What if it fails for specific users?</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Payment gateway timeout&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="the-production-failure">The Production Failure</h3>
<p><strong>User Experience</strong>:
- Checkout button shows "Processing..."
- After 30 seconds, shows "Checkout failed"
- User tries again, same result
- User abandons cart</p>
<p><strong>Your Visibility</strong>:
- No alert
- No notification
- No dashboard showing the problem
- You only find out when checking logs manually (if at all)</p>
<p><strong>Business Impact</strong>:
- Lost revenue
- Frustrated users
- Damaged reputation
- No data to diagnose the issue</p>
<h3 id="diagnostic-analysis-what-were-missing">Diagnostic Analysis: What We're Missing</h3>
<p><strong>What we need to know</strong>:
1. <strong>Errors</strong>: What errors are happening and how often?
2. <strong>Performance</strong>: How fast are our APIs responding?
3. <strong>Availability</strong>: Is the service up and accessible?
4. <strong>User Impact</strong>: How many users are affected?
5. <strong>Context</strong>: What were they doing when it failed?</p>
<p><strong>What we need to do</strong>:
1. <strong>Capture</strong>: Collect error data with full context
2. <strong>Aggregate</strong>: Group similar errors together
3. <strong>Alert</strong>: Notify team when thresholds are exceeded
4. <strong>Visualize</strong>: Dashboard showing system health
5. <strong>Debug</strong>: Provide enough context to fix issues</p>
<h2 id="building-a-production-monitoring-system">Building a Production Monitoring System</h2>
<p>We'll integrate Sentry for error tracking and build custom performance monitoring.</p>
<h3 id="setting-up-sentry">Setting Up Sentry</h3>
<p>First, install and configure Sentry:</p>
<div class="codehilite"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>@sentry/nextjs
npx<span class="w"> </span>@sentry/wizard@latest<span class="w"> </span>-i<span class="w"> </span>nextjs
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// sentry.client.config.ts</span>
<span class="c1">// Client-side Sentry configuration</span>

<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Sentry</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@sentry/nextjs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">clientEnv</span><span class="p">,</span><span class="w"> </span><span class="nx">isProduction</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="nx">Sentry</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
<span class="w">  </span><span class="nx">dsn</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.NEXT_PUBLIC_SENTRY_DSN</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Only send errors in production</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">isProduction</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Set environment</span>
<span class="w">  </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="kt">clientEnv.NEXT_PUBLIC_ENVIRONMENT</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Sample rate for performance monitoring</span>
<span class="w">  </span><span class="nx">tracesSampleRate</span><span class="o">:</span><span class="w"> </span><span class="kt">isProduction</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">0.1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">1.0</span><span class="p">,</span><span class="w"> </span><span class="c1">// 10% in prod, 100% in dev</span>

<span class="w">  </span><span class="c1">// Sample rate for session replay</span>
<span class="w">  </span><span class="nx">replaysSessionSampleRate</span><span class="o">:</span><span class="w"> </span><span class="kt">0.1</span><span class="p">,</span><span class="w"> </span><span class="c1">// 10% of sessions</span>
<span class="w">  </span><span class="nx">replaysOnErrorSampleRate</span><span class="o">:</span><span class="w"> </span><span class="kt">1.0</span><span class="p">,</span><span class="w"> </span><span class="c1">// 100% of sessions with errors</span>

<span class="w">  </span><span class="c1">// Integrations</span>
<span class="w">  </span><span class="nx">integrations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">BrowserTracing</span><span class="p">({</span>
<span class="w">      </span><span class="c1">// Track navigation performance</span>
<span class="w">      </span><span class="nx">tracePropagationTargets</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="sr">/^https:\/\/yourapp\.com/</span><span class="p">],</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">Replay</span><span class="p">({</span>
<span class="w">      </span><span class="c1">// Mask sensitive data</span>
<span class="w">      </span><span class="nx">maskAllText</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">blockAllMedia</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">  </span><span class="p">],</span>

<span class="w">  </span><span class="c1">// Filter out known noise</span>
<span class="w">  </span><span class="nx">beforeSend</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">hint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Don&#39;t send errors from browser extensions</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">exception</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span><span class="p">.[</span><span class="mf">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">stacktrace</span><span class="o">?</span><span class="p">.</span><span class="nx">frames</span><span class="o">?</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span>
<span class="w">      </span><span class="nx">frame</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">frame</span><span class="p">.</span><span class="nx">filename</span><span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;extension://&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">event</span><span class="p">;</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">});</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// sentry.server.config.ts</span>
<span class="c1">// Server-side Sentry configuration</span>

<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Sentry</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@sentry/nextjs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>

<span class="nx">Sentry</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span>
<span class="w">  </span><span class="nx">dsn</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.SENTRY_DSN</span><span class="p">,</span>

<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">env.NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="kt">env.NODE_ENV</span><span class="p">,</span>

<span class="w">  </span><span class="nx">tracesSampleRate</span><span class="o">:</span><span class="w"> </span><span class="kt">0.1</span><span class="p">,</span>

<span class="w">  </span><span class="c1">// Server-specific options</span>
<span class="w">  </span><span class="nx">integrations</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="ow">new</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">Integrations</span><span class="p">.</span><span class="nx">Http</span><span class="p">({</span><span class="w"> </span><span class="nx">tracing</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">}),</span>
<span class="w">  </span><span class="p">],</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="iteration-1-monitored-api-routes">Iteration 1: Monitored API Routes</h3>
<p>Add comprehensive error tracking to API routes:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/checkout/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Sentry</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@sentry/nextjs&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">POST</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Start a Sentry transaction for performance monitoring</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">startTransaction</span><span class="p">({</span>
<span class="w">    </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;http.server&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST /api/checkout&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Add context to Sentry</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">setContext</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">body.amount</span><span class="p">,</span>
<span class="w">      </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">body.items?.length</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// Add user context if available</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;x-user-id&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">setUser</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">userId</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Track payment processing span</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">paymentSpan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">startChild</span><span class="p">({</span>
<span class="w">      </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;payment.process&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Process payment&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">processPayment</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>

<span class="w">    </span><span class="nx">paymentSpan</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Track successful checkout</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">addBreadcrumb</span><span class="p">({</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Checkout completed successfully&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">orderId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.orderId</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Capture error with full context</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">captureException</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">endpoint</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/checkout&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">contexts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="kt">request.url</span><span class="p">,</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="kt">request.method</span><span class="p">,</span>
<span class="w">          </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="kt">Object.fromEntries</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">),</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="s1">&#39;internal_error&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Log for local debugging</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Checkout error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Checkout failed&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Don&#39;t expose internal error details to client</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processPayment</span><span class="p">(</span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Simulated payment processing with detailed error</span>
<span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Payment gateway timeout after 30s&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Verification</strong>: When the error occurs, Sentry captures:</p>
<p><strong>Sentry Dashboard</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="nl">Error</span><span class="p">:</span><span class="w"> </span><span class="n">Payment</span><span class="w"> </span><span class="n">gateway</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="mi">30</span><span class="n">s</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">processPayment</span><span class="w"> </span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="nl">ts</span><span class="p">:</span><span class="mi">45</span><span class="p">)</span>
<span class="w">  </span><span class="k">at</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="nl">ts</span><span class="p">:</span><span class="mi">28</span><span class="p">)</span>

<span class="nl">Context</span><span class="p">:</span>
<span class="w">  </span><span class="nl">checkout</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">amount</span><span class="p">:</span><span class="w"> </span><span class="mf">99.99</span><span class="p">,</span><span class="w"> </span><span class="nl">items</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">}</span>
<span class="w">  </span><span class="k">user</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">id</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;user_123&quot;</span><span class="w"> </span><span class="err">}</span>
<span class="w">  </span><span class="nl">request</span><span class="p">:</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="nl">url</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;/api/checkout&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">method</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;POST&quot;</span><span class="w"> </span><span class="err">}</span>

<span class="nl">Breadcrumbs</span><span class="p">:</span>
<span class="w">  </span><span class="o">[</span><span class="n">info</span><span class="o">]</span><span class="w"> </span><span class="nl">checkout</span><span class="p">:</span><span class="w"> </span><span class="n">Checkout</span><span class="w"> </span><span class="n">started</span>
<span class="w">  </span><span class="o">[</span><span class="n">error</span><span class="o">]</span><span class="w"> </span><span class="nl">checkout</span><span class="p">:</span><span class="w"> </span><span class="n">Payment</span><span class="w"> </span><span class="n">gateway</span><span class="w"> </span><span class="n">timeout</span>

<span class="nl">Tags</span><span class="p">:</span>
<span class="w">  </span><span class="nl">endpoint</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">checkout</span>
<span class="w">  </span><span class="k">method</span><span class="err">:</span><span class="w"> </span><span class="n">POST</span>
<span class="w">  </span><span class="nl">environment</span><span class="p">:</span><span class="w"> </span><span class="n">production</span>
</code></pre></div>

<p><strong>Expected vs. Actual improvement</strong>:
- Before: Silent failure, no visibility
- After: Immediate error notification with full context
- Before: No way to know how many users affected
- After: Sentry shows error frequency and user impact
- Before: No debugging context
- After: Full request context, user info, breadcrumbs</p>
<h3 id="client-side-error-boundaries-with-sentry">Client-Side Error Boundaries with Sentry</h3>
<p>Catch React errors and send to Sentry:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/components/ErrorBoundary.tsx</span>
<span class="s1">&#39;use client&#39;</span><span class="p">;</span>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Sentry</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@sentry/nextjs&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">Props</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="w">  </span><span class="nx">fallback?</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ErrorBoundary</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="p">&lt;</span><span class="nt">Props</span><span class="err">,</span><span class="w"> </span><span class="na">State</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">props</span><span class="o">:</span><span class="w"> </span><span class="kt">Props</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="nx">getDerivedStateFromError</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">componentDidCatch</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">,</span><span class="w"> </span><span class="nx">errorInfo</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ErrorInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Send to Sentry with React-specific context</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">captureException</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">contexts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">react</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">componentStack</span><span class="o">:</span><span class="w"> </span><span class="kt">errorInfo.componentStack</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">hasError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">fallback</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;min-h-screen flex items-center justify-center p-6&quot;</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;</span><span class="nt">div</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;max-w-md w-full bg-red-50 border border-red-200 rounded-lg p-6&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">h2</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-xl font-semibold text-red-900 mb-2&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">Something</span><span class="w"> </span><span class="nx">went</span><span class="w"> </span><span class="nx">wrong</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">p</span><span class="w"> </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;text-red-700 mb-4&quot;</span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">We</span><span class="err">&#39;</span><span class="nx">ve</span><span class="w"> </span><span class="nx">been</span><span class="w"> </span><span class="nx">notified</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">working</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">fix</span><span class="p">.</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">button</span>
<span class="w">              </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">()}</span>
<span class="w">              </span><span class="na">className</span><span class="o">=</span><span class="s">&quot;bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700&quot;</span>
<span class="w">            </span><span class="p">&gt;</span>
<span class="w">              </span><span class="nx">Reload</span><span class="w"> </span><span class="nx">page</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ErrorBoundary</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/components/ErrorBoundary&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">RootLayout</span><span class="p">({</span>
<span class="w">  </span><span class="nx">children</span><span class="p">,</span>
<span class="p">}</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="kt">React.ReactNode</span><span class="p">;</span>
<span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">html</span><span class="w"> </span><span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ErrorBoundary</span><span class="p">&gt;</span>
<span class="w">          </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ErrorBoundary</span><span class="p">&gt;</span>
<span class="w">      </span><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="custom-performance-monitoring">Custom Performance Monitoring</h3>
<p>Track custom performance metrics:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/lib/monitoring/performance.ts</span>
<span class="c1">// Custom performance monitoring</span>

<span class="k">import</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Sentry</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@sentry/nextjs&#39;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Track API call performance</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">trackApiCall</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">fn</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">startTransaction</span><span class="p">({</span>
<span class="w">    </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api.call&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fn</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Track successful call</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">addBreadcrumb</span><span class="p">({</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb"> completed`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Track failed call</span>
<span class="w">    </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">captureException</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">api_call</span><span class="o">:</span><span class="w"> </span><span class="kt">name</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">contexts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">performance</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="s1">&#39;internal_error&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>

<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Track component render performance</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">trackRender</span><span class="p">(</span><span class="nx">componentName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">transaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">startTransaction</span><span class="p">({</span>
<span class="w">    </span><span class="nx">op</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;react.render&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">componentName</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">finish</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">transaction</span><span class="p">.</span><span class="nx">finish</span><span class="p">(),</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Track custom metrics</span>
<span class="cm"> */</span>
<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">trackMetric</span><span class="p">(</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">unit</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ms&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Sentry</span><span class="p">.</span><span class="nx">addBreadcrumb</span><span class="p">({</span>
<span class="w">    </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;metric&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">value</span><span class="si">}${</span><span class="nx">unit</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">level</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;info&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">unit</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// Usage in components</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">trackApiCall</span><span class="p">,</span><span class="w"> </span><span class="nx">trackMetric</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/lib/monitoring/performance&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">CheckoutPage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleCheckout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Track API call performance</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">trackApiCall</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;/api/checkout&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span><span class="w"> </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="w"> </span><span class="p">}),</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="c1">// Track custom metric</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">totalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">;</span>
<span class="w">      </span><span class="nx">trackMetric</span><span class="p">(</span><span class="s1">&#39;checkout_total_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">totalTime</span><span class="p">);</span>

<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Error already tracked by trackApiCall</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleCheckout</span><span class="p">}&gt;</span><span class="nx">Checkout</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="alerting-configuration">Alerting Configuration</h3>
<p>Set up alerts in Sentry for critical issues:</p>
<p><strong>Sentry Alert Rules</strong> (configured in Sentry dashboard):</p>
<ol>
<li><strong>High Error Rate</strong>:</li>
<li>Condition: More than 50 errors in 1 hour</li>
<li>Action: Send email + Slack notification</li>
<li>
<p>Priority: High</p>
</li>
<li>
<p><strong>Critical API Failure</strong>:</p>
</li>
<li>Condition: Any error in <code>/api/checkout</code></li>
<li>Action: Send PagerDuty alert</li>
<li>
<p>Priority: Critical</p>
</li>
<li>
<p><strong>Performance Degradation</strong>:</p>
</li>
<li>Condition: P95 response time &gt; 2 seconds</li>
<li>Action: Send Slack notification</li>
<li>
<p>Priority: Medium</p>
</li>
<li>
<p><strong>New Error Type</strong>:</p>
</li>
<li>Condition: First occurrence of new error</li>
<li>Action: Send email</li>
<li>Priority: Low</li>
</ol>
<h3 id="health-check-endpoint">Health Check Endpoint</h3>
<p>Create a health check for uptime monitoring:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/api/health/route.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">GET</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">health</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;healthy&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="kt">env.NODE_ENV</span><span class="p">,</span>
<span class="w">    </span><span class="nx">checks</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">database</span><span class="o">:</span><span class="w"> </span><span class="kt">await</span><span class="w"> </span><span class="nx">checkDatabase</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">redis</span><span class="o">:</span><span class="w"> </span><span class="kt">await</span><span class="w"> </span><span class="nx">checkRedis</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">externalApi</span><span class="o">:</span><span class="w"> </span><span class="kt">await</span><span class="w"> </span><span class="nx">checkExternalApi</span><span class="p">(),</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// If any check fails, return 503</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">isHealthy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">health</span><span class="p">.</span><span class="nx">checks</span><span class="p">).</span><span class="nx">every</span><span class="p">(</span><span class="nx">check</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">check</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">health</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">isHealthy</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">200</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">503</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Attempt database query</span>
<span class="w">    </span><span class="c1">// await db.query(&#39;SELECT 1&#39;);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">latency</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Database connection failed&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkRedis</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Attempt Redis ping</span>
<span class="w">    </span><span class="c1">// await redis.ping();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">latency</span><span class="o">:</span><span class="w"> </span><span class="kt">2</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Redis connection failed&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkExternalApi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Check external API availability</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;https://api.stripe.com/v1/health&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">AbortSignal.timeout</span><span class="p">(</span><span class="mf">5000</span><span class="p">),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">response.ok</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;ok&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;degraded&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">latency</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;External API unreachable&#39;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="uptime-monitoring">Uptime Monitoring</h3>
<p>Use a service like UptimeRobot or Pingdom to monitor your health endpoint:</p>
<p><strong>Configuration</strong>:
- URL: <code>https://your-app.com/api/health</code>
- Interval: Every 5 minutes
- Alert: If status code is not 200
- Notification: Email + SMS for critical alerts</p>
<h3 id="common-failure-mode-alert-fatigue">Common Failure Mode: Alert Fatigue</h3>
<p><strong>Symptom</strong>: Too many alerts, team starts ignoring them</p>
<p><strong>Root cause</strong>: Alerts not properly tuned</p>
<p><strong>Solution</strong>:
1. <strong>Set appropriate thresholds</strong>: Don't alert on every error
2. <strong>Group similar errors</strong>: One alert for 100 similar errors, not 100 alerts
3. <strong>Use severity levels</strong>: Critical vs. warning vs. info
4. <strong>Implement rate limiting</strong>: Max 1 alert per hour for same issue
5. <strong>Regular review</strong>: Adjust thresholds based on actual patterns</p>
<h3 id="when-to-apply-this-solution_3">When to Apply This Solution</h3>
<p><strong>What it optimizes for</strong>:
- Visibility into production issues
- Fast incident response
- Debugging context
- Performance tracking</p>
<p><strong>What it sacrifices</strong>:
- Additional service costs (Sentry, uptime monitoring)
- Setup complexity
- Potential privacy concerns (error data collection)</p>
<p><strong>When to choose this approach</strong>:
- Any production application
- Applications with paying customers
- Team-maintained applications
- High-availability requirements</p>
<p><strong>When to avoid this approach</strong>:
- Simple prototypes
- Personal projects with no users
- Applications with no uptime requirements</p>
<p><strong>Code characteristics</strong>:
- Setup: ~500 lines including configuration
- Maintenance: Low (mostly configuration)
- Performance: Minimal overhead (sampling)</p>
<h2 id="the-deployment-checklist">The deployment checklist</h2>
<h2 id="the-complete-pre-deployment-checklist">The Complete Pre-Deployment Checklist</h2>
<p>You've built your application. You've tested it locally. You're ready to deploy. But are you <em>really</em> ready?</p>
<p>This checklist covers everything you need to verify before deploying to production. Each item includes verification steps and common failure modes.</p>
<h3 id="phase-1-environment-configuration">Phase 1: Environment &amp; Configuration</h3>
<h4 id="environment-variables">‚úÖ Environment Variables</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run environment validation</span>
npm<span class="w"> </span>run<span class="w"> </span>validate-env

<span class="c1"># Expected output:</span>
<span class="c1"># üîç Validating environment configuration...</span>
<span class="c1"># ‚úÖ Client environment valid</span>
<span class="c1">#    Environment: production</span>
<span class="c1">#    API URL: https://api.yourapp.com</span>
<span class="c1"># ‚úÖ Server environment valid</span>
<span class="c1">#    Node environment: production</span>
<span class="c1"># ‚úÖ Environment configuration validated successfully</span>
</code></pre></div>

<p><strong>Common Failure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="err">‚ùå</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NEXT_PUBLIC_API_URL</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;Required&#39;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Fix</strong>: Set missing environment variables in deployment platform (Vercel, AWS, etc.)</p>
<h4 id="build-success">‚úÖ Build Success</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run production build locally</span>
npm<span class="w"> </span>run<span class="w"> </span>build

<span class="c1"># Expected output:</span>
<span class="c1"># ‚úì Compiled successfully</span>
<span class="c1"># ‚úì Linting and checking validity of types</span>
<span class="c1"># ‚úì Collecting page data</span>
<span class="c1"># ‚úì Generating static pages (10/10)</span>
<span class="c1"># ‚úì Finalizing page optimization</span>
</code></pre></div>

<p><strong>Common Failures</strong>:</p>
<ol>
<li><strong>TypeScript errors</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nx">Type</span><span class="w"> </span><span class="nx">error</span><span class="p">:</span><span class="w"> </span><span class="nx">Property</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="w"> </span><span class="nx">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">exist</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">User</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">undefined</span><span class="err">&#39;</span>
</code></pre></div>

<p><strong>Fix</strong>: Add proper type guards or optional chaining</p>
<ol>
<li><strong>Missing dependencies</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">Module</span><span class="w"> </span><span class="nn">not</span><span class="w"> </span><span class="n">found</span><span class="p">:</span><span class="w"> </span><span class="n">Can</span><span class="c">&#39;t resolve &#39;@/lib/utils&#39;</span>
</code></pre></div>

<p><strong>Fix</strong>: Check import paths and installed packages</p>
<ol>
<li><strong>Environment variable access</strong>:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">ReferenceError</span><span class="o">:</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">defined</span>
</code></pre></div>

<p><strong>Fix</strong>: Use <code>NEXT_PUBLIC_</code> prefix for client-side variables</p>
<h4 id="bundle-size">‚úÖ Bundle Size</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Analyze bundle size</span>
npm<span class="w"> </span>run<span class="w"> </span>build
npx<span class="w"> </span>@next/bundle-analyzer

<span class="c1"># Check output:</span>
<span class="c1"># First Load JS shared by all: 85 kB</span>
<span class="c1"># ‚îú chunks/framework.js: 45 kB</span>
<span class="c1"># ‚îú chunks/main.js: 30 kB</span>
<span class="c1"># ‚îî chunks/webpack.js: 10 kB</span>
</code></pre></div>

<p><strong>Warning Signs</strong>:
- First Load JS &gt; 200 kB (slow initial load)
- Individual page &gt; 100 kB (consider code splitting)
- Duplicate dependencies (check bundle analyzer)</p>
<p><strong>Fix</strong>: Use dynamic imports, optimize images, remove unused dependencies</p>
<h3 id="phase-2-security">Phase 2: Security</h3>
<h4 id="secrets-not-in-code">‚úÖ Secrets Not in Code</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Search for potential secrets in code</span>
git<span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;api_key\|secret\|password\|token&quot;</span><span class="w"> </span>src/

<span class="c1"># Should return ONLY references to environment variables:</span>
<span class="c1"># src/config/env.ts:  STRIPE_SECRET_KEY: z.string()</span>
<span class="c1"># src/lib/api.ts:  apiKey: process.env.STRIPE_SECRET_KEY</span>
</code></pre></div>

<p><strong>Common Failure</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stripe</span><span class="o">.</span><span class="n">ts</span><span class="p">:</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sk_live_abc123...&#39;</span>
</code></pre></div>

<p><strong>Fix</strong>: Move to environment variables immediately, rotate the exposed secret</p>
<h4 id="cors-configuration">‚úÖ CORS Configuration</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/middleware.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">NextRequest</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/server&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">middleware</span><span class="p">(</span><span class="nx">request</span><span class="o">:</span><span class="w"> </span><span class="kt">NextRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Verify CORS headers are set correctly</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NextResponse</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// Only allow your domains</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">allowedOrigins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;https://yourapp.com&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;https://www.yourapp.com&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">origin</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">allowedOrigins</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">origin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">origin</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Common Failure</strong>: Allowing all origins (<code>*</code>) in production</p>
<p><strong>Fix</strong>: Explicitly list allowed origins</p>
<h4 id="authentication-authorization">‚úÖ Authentication &amp; Authorization</h4>
<p><strong>Verify</strong>:
- [ ] Protected routes require authentication
- [ ] API routes verify user permissions
- [ ] Session tokens have expiration
- [ ] Refresh token rotation implemented
- [ ] CSRF protection enabled</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Try accessing protected route without auth</span>
curl<span class="w"> </span>https://your-app.com/api/admin/users

<span class="c1"># Expected: 401 Unauthorized</span>
<span class="c1"># Actual: 200 OK with data ‚Üê SECURITY ISSUE</span>
</code></pre></div>

<h3 id="phase-3-performance">Phase 3: Performance</h3>
<h4 id="core-web-vitals">‚úÖ Core Web Vitals</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run Lighthouse audit</span>
npx<span class="w"> </span>lighthouse<span class="w"> </span>https://your-app.com<span class="w"> </span>--view

<span class="c1"># Target scores:</span>
<span class="c1"># Performance: &gt; 90</span>
<span class="c1"># Accessibility: &gt; 90</span>
<span class="c1"># Best Practices: &gt; 90</span>
<span class="c1"># SEO: &gt; 90</span>

<span class="c1"># Core Web Vitals:</span>
<span class="c1"># LCP (Largest Contentful Paint): &lt; 2.5s</span>
<span class="c1"># FID (First Input Delay): &lt; 100ms</span>
<span class="c1"># CLS (Cumulative Layout Shift): &lt; 0.1</span>
</code></pre></div>

<p><strong>Common Failures</strong>:</p>
<ol>
<li><strong>High LCP</strong> (slow loading):</li>
<li>Unoptimized images</li>
<li>Blocking JavaScript</li>
<li>
<p>Slow server response</p>
</li>
<li>
<p><strong>High CLS</strong> (layout shift):</p>
</li>
<li>Images without dimensions</li>
<li>Dynamic content insertion</li>
<li>Web fonts loading</li>
</ol>
<p><strong>Fix</strong>: Use <code>next/image</code>, add dimensions, optimize fonts</p>
<h4 id="image-optimization">‚úÖ Image Optimization</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ‚úÖ Good: Using next/image</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Image</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next/image&#39;</span><span class="p">;</span>

<span class="p">&lt;</span><span class="nt">Image</span>
<span class="w">  </span><span class="na">src</span><span class="o">=</span><span class="s">&quot;/hero.jpg&quot;</span>
<span class="w">  </span><span class="na">alt</span><span class="o">=</span><span class="s">&quot;Hero image&quot;</span>
<span class="w">  </span><span class="na">width</span><span class="o">=</span><span class="p">{</span><span class="mf">1200</span><span class="p">}</span>
<span class="w">  </span><span class="na">height</span><span class="o">=</span><span class="p">{</span><span class="mf">600</span><span class="p">}</span>
<span class="w">  </span><span class="na">priority</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="na">For</span><span class="w"> </span><span class="na">above</span><span class="err">-</span><span class="na">the</span><span class="err">-</span><span class="na">fold</span><span class="w"> </span><span class="na">images</span>
<span class="p">/&gt;</span>

<span class="c1">// ‚ùå Bad: Regular img tag</span>
<span class="p">&lt;</span><span class="nt">img</span><span class="w"> </span><span class="na">src</span><span class="o">=</span><span class="s">&quot;/hero.jpg&quot;</span><span class="w"> </span><span class="na">alt</span><span class="o">=</span><span class="s">&quot;Hero image&quot;</span><span class="w"> </span><span class="p">/&gt;</span>
</code></pre></div>

<p><strong>Check</strong>:
- [ ] All images use <code>next/image</code>
- [ ] Images have explicit width/height
- [ ] Above-the-fold images have <code>priority</code>
- [ ] Images are in modern formats (WebP, AVIF)</p>
<h4 id="database-query-performance">‚úÖ Database Query Performance</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Add query logging in development</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@/config/env&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getServerEnv</span><span class="p">();</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;development&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Log slow queries</span>
<span class="w">  </span><span class="nx">db</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="sb">`Slow query (</span><span class="si">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">duration</span><span class="si">}</span><span class="sb">ms):`</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Warning Signs</strong>:
- Queries taking &gt; 100ms
- N+1 query problems
- Missing database indexes
- Full table scans</p>
<p><strong>Fix</strong>: Add indexes, use query optimization, implement caching</p>
<h3 id="phase-4-monitoring-observability">Phase 4: Monitoring &amp; Observability</h3>
<h4 id="error-tracking">‚úÖ Error Tracking</h4>
<p><strong>Verify</strong>:
- [ ] Sentry (or similar) configured
- [ ] Error boundaries in place
- [ ] API routes capture exceptions
- [ ] Source maps uploaded for production</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Trigger a test error</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">TestErrorButton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nt">button</span><span class="w"> </span><span class="na">onClick</span><span class="o">=</span><span class="p">{()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Test error - please ignore&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}}&gt;</span>
<span class="w">      </span><span class="nx">Test</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="nx">Tracking</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Expected</strong>: Error appears in Sentry dashboard within 1 minute</p>
<h4 id="analytics">‚úÖ Analytics</h4>
<p><strong>Verify</strong>:
- [ ] Analytics initialized
- [ ] Page views tracked
- [ ] Key events tracked (signup, purchase, etc.)
- [ ] User consent implemented (GDPR)</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check analytics in browser console (development)</span>
<span class="c1"># Should see: üìä Analytics Event: { name: &#39;page_view&#39;, ... }</span>

<span class="c1"># Check production analytics dashboard</span>
<span class="c1"># Should see: Real-time users, page views, events</span>
</code></pre></div>

<h4 id="logging">‚úÖ Logging</h4>
<p><strong>Verify</strong>:
- [ ] Structured logging implemented
- [ ] Log levels configured (error, warn, info, debug)
- [ ] Sensitive data not logged
- [ ] Logs aggregated (CloudWatch, Datadog, etc.)</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// Good logging example</span>
<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;User checkout started&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<span class="w">  </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">99.99</span><span class="p">,</span>
<span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">3</span><span class="p">,</span>
<span class="w">  </span><span class="c1">// Don&#39;t log: credit card numbers, passwords, tokens</span>
<span class="p">});</span>

<span class="c1">// Bad logging example</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Checkout:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">checkoutData</span><span class="p">));</span><span class="w"> </span><span class="c1">// May contain sensitive data</span>
</code></pre></div>

<h3 id="phase-5-user-experience">Phase 5: User Experience</h3>
<h4 id="loading-states">‚úÖ Loading States</h4>
<p><strong>Verify</strong>:
- [ ] All async operations show loading state
- [ ] Skeleton screens for content loading
- [ ] Optimistic updates where appropriate
- [ ] Error states with retry options</p>
<p><strong>Test</strong>: Throttle network to "Slow 3G" in DevTools</p>
<p><strong>Expected</strong>: User sees loading indicators, not blank screens</p>
<h4 id="error-handling">‚úÖ Error Handling</h4>
<p><strong>Verify</strong>:
- [ ] User-friendly error messages
- [ ] Error boundaries catch React errors
- [ ] API errors handled gracefully
- [ ] Network errors show retry option</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Simulate API error</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://your-app.com/api/checkout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;invalid&quot;: &quot;data&quot;}&#39;</span>

<span class="c1"># Expected: User sees friendly error message</span>
<span class="c1"># Not: Raw error stack trace</span>
</code></pre></div>

<h4 id="accessibility">‚úÖ Accessibility</h4>
<p><strong>Verify</strong>:
- [ ] Keyboard navigation works
- [ ] Screen reader tested
- [ ] Color contrast meets WCAG AA
- [ ] Focus indicators visible
- [ ] ARIA labels on interactive elements</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run accessibility audit</span>
npx<span class="w"> </span>lighthouse<span class="w"> </span>https://your-app.com<span class="w"> </span>--only-categories<span class="o">=</span>accessibility

<span class="c1"># Target: Score &gt; 90</span>

<span class="c1"># Manual test: Navigate entire app using only keyboard</span>
<span class="c1"># Tab, Enter, Space, Arrow keys should work</span>
</code></pre></div>

<h3 id="phase-6-seo-social">Phase 6: SEO &amp; Social</h3>
<h4 id="meta-tags">‚úÖ Meta Tags</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/layout.tsx</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Metadata</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">Metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your App Name&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your app description&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">openGraph</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your App Name&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your app description&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/og-image.jpg&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">twitter</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">card</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;summary_large_image&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your App Name&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Your app description&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">images</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/og-image.jpg&#39;</span><span class="p">],</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Check meta tags</span>
curl<span class="w"> </span>-s<span class="w"> </span>https://your-app.com<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span><span class="s2">&quot;meta&quot;</span>

<span class="c1"># Test social sharing</span>
<span class="c1"># Use: https://www.opengraph.xyz/</span>
<span class="c1"># Or: https://cards-dev.twitter.com/validator</span>
</code></pre></div>

<h4 id="sitemap-robotstxt">‚úÖ Sitemap &amp; Robots.txt</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/sitemap.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">MetadataRoute</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sitemap</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">MetadataRoute</span><span class="p">.</span><span class="nx">Sitemap</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://yourapp.com&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">lastModified</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">changeFrequency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="kt">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://yourapp.com/about&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">lastModified</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">changeFrequency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="kt">0.8</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// ... more pages</span>
<span class="w">  </span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// src/app/robots.ts</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">MetadataRoute</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;next&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">robots</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">MetadataRoute</span><span class="p">.</span><span class="nx">Robots</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rules</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userAgent</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">allow</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">disallow</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;/admin/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/api/&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">sitemap</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;https://yourapp.com/sitemap.xml&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">https://your-app.com/sitemap.xml</span>
<span class="n">https://your-app.com/robots.txt</span>
</code></pre></div>

<h3 id="phase-7-deployment-platform">Phase 7: Deployment Platform</h3>
<h4 id="vercel-configuration">‚úÖ Vercel Configuration</h4>
<p><strong>Verify</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// vercel.json</span>
<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;buildCommand&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm run build&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;devCommand&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm run dev&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;installCommand&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;npm install&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;framework&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nextjs&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;regions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;iad1&quot;</span><span class="p">],</span><span class="w"> </span><span class="c1">// Choose closest to users</span>
<span class="w">  </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;NEXT_PUBLIC_API_URL&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://api.yourapp.com&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Check</strong>:
- [ ] Environment variables set in Vercel dashboard
- [ ] Production domain configured
- [ ] SSL certificate active
- [ ] Preview deployments enabled
- [ ] Build cache enabled</p>
<h4 id="database-migrations">‚úÖ Database Migrations</h4>
<p><strong>Verify</strong>:
- [ ] Migration scripts tested
- [ ] Rollback plan documented
- [ ] Database backup created
- [ ] Migration runs before deployment</p>
<p><strong>Test</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run migrations in staging first</span>
npm<span class="w"> </span>run<span class="w"> </span>db:migrate

<span class="c1"># Verify schema</span>
npm<span class="w"> </span>run<span class="w"> </span>db:verify

<span class="c1"># Create backup</span>
npm<span class="w"> </span>run<span class="w"> </span>db:backup
</code></pre></div>

<h3 id="phase-8-post-deployment">Phase 8: Post-Deployment</h3>
<h4 id="smoke-tests">‚úÖ Smoke Tests</h4>
<p><strong>Immediately after deployment</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. Health check</span>
curl<span class="w"> </span>https://your-app.com/api/health
<span class="c1"># Expected: {&quot;status&quot;:&quot;healthy&quot;}</span>

<span class="c1"># 2. Homepage loads</span>
curl<span class="w"> </span>-I<span class="w"> </span>https://your-app.com
<span class="c1"># Expected: 200 OK</span>

<span class="c1"># 3. Authentication works</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://your-app.com/api/auth/login<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;email&quot;:&quot;test@example.com&quot;,&quot;password&quot;:&quot;test123&quot;}&#39;</span>
<span class="c1"># Expected: 200 OK with token</span>

<span class="c1"># 4. Critical API endpoint</span>
curl<span class="w"> </span>https://your-app.com/api/products
<span class="c1"># Expected: 200 OK with data</span>
</code></pre></div>

<h4 id="monitor-for-1-hour">‚úÖ Monitor for 1 Hour</h4>
<p><strong>Watch</strong>:
- [ ] Error rate in Sentry (should be &lt; 1%)
- [ ] Response times (should be &lt; 500ms p95)
- [ ] User analytics (users can complete key flows)
- [ ] Server logs (no unexpected errors)</p>
<p><strong>Alert Thresholds</strong>:
- Error rate &gt; 5%: Investigate immediately
- Response time &gt; 2s: Check performance
- Zero traffic: Check DNS/routing</p>
<h3 id="the-final-checklist">The Final Checklist</h3>
<p>Print this and check off before every production deployment:</p>
<p><strong>Environment &amp; Configuration</strong>
- [ ] Environment variables validated
- [ ] Production build succeeds
- [ ] Bundle size acceptable (&lt; 200 KB first load)</p>
<p><strong>Security</strong>
- [ ] No secrets in code
- [ ] CORS configured correctly
- [ ] Authentication tested
- [ ] Authorization verified</p>
<p><strong>Performance</strong>
- [ ] Lighthouse score &gt; 90
- [ ] Core Web Vitals pass
- [ ] Images optimized
- [ ] Database queries optimized</p>
<p><strong>Monitoring</strong>
- [ ] Error tracking active
- [ ] Analytics configured
- [ ] Logging implemented
- [ ] Alerts configured</p>
<p><strong>User Experience</strong>
- [ ] Loading states present
- [ ] Error handling graceful
- [ ] Accessibility tested
- [ ] Mobile responsive</p>
<p><strong>SEO &amp; Social</strong>
- [ ] Meta tags configured
- [ ] Sitemap generated
- [ ] Robots.txt present
- [ ] Social sharing tested</p>
<p><strong>Deployment</strong>
- [ ] Platform configured
- [ ] Database migrations ready
- [ ] Rollback plan documented
- [ ] Team notified</p>
<p><strong>Post-Deployment</strong>
- [ ] Smoke tests pass
- [ ] Monitoring active
- [ ] No critical errors
- [ ] Users can complete key flows</p>
<h3 id="common-production-failures-and-their-signatures">Common Production Failures and Their Signatures</h3>
<h4 id="failure-environment-variable-missing">Failure: Environment Variable Missing</h4>
<p><strong>Symptom</strong>: App crashes immediately after deployment</p>
<p><strong>Browser Console</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">Invalid</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">configuration</span>
</code></pre></div>

<p><strong>Fix</strong>: Add missing variable in deployment platform, redeploy</p>
<h4 id="failure-database-connection">Failure: Database Connection</h4>
<p><strong>Symptom</strong>: All API requests return 500</p>
<p><strong>Server Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">connect</span><span class="w"> </span><span class="n">ECONNREFUSED</span>
<span class="w">  </span><span class="n">at</span><span class="w"> </span><span class="n">TCPConnectWrap</span><span class="o">.</span><span class="na">afterConnect</span>
</code></pre></div>

<p><strong>Fix</strong>: Check database URL, verify network access, check credentials</p>
<h4 id="failure-memory-leak">Failure: Memory Leak</h4>
<p><strong>Symptom</strong>: App slows down over time, eventually crashes</p>
<p><strong>Monitoring</strong>:
- Memory usage climbing steadily
- Response times increasing
- Eventually: Out of memory errors</p>
<p><strong>Fix</strong>: Check for unclosed connections, event listeners, large object retention</p>
<h4 id="failure-rate-limiting">Failure: Rate Limiting</h4>
<p><strong>Symptom</strong>: Some users can't access app</p>
<p><strong>Server Logs</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="mf">429</span><span class="w"> </span><span class="kr">To</span><span class="n">o</span><span class="w"> </span><span class="n">Many</span><span class="w"> </span><span class="n">Requests</span>
</code></pre></div>

<p><strong>Fix</strong>: Implement proper rate limiting, add user feedback, increase limits if legitimate</p>
<h3 id="the-professional-react-developers-mental-model">The Professional React Developer's Mental Model</h3>
<p><strong>Before Deployment</strong>:
1. Test in production-like environment
2. Verify all checklist items
3. Have rollback plan ready
4. Schedule during low-traffic period</p>
<p><strong>During Deployment</strong>:
1. Monitor error rates
2. Watch response times
3. Check user analytics
4. Be ready to rollback</p>
<p><strong>After Deployment</strong>:
1. Verify smoke tests pass
2. Monitor for 1 hour minimum
3. Check user feedback
4. Document any issues</p>
<p><strong>If Something Goes Wrong</strong>:
1. Don't panic
2. Check monitoring dashboards
3. Review recent changes
4. Rollback if critical
5. Fix and redeploy</p>
<p>Remember: Every production deployment is a learning opportunity. Document what went wrong, update your checklist, and improve your process.</p>
        </div>
        <div class="footer">
            Generated on 2025-12-03 12:42:37 | Made with ‚ù§Ô∏è by GitHub Pages Generator
        </div>
    </div>
    <script>
        // Syntax highlighting for code blocks
        document.addEventListener('DOMContentLoaded', (event) => {
            // Highlight code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            // Add copy buttons to code blocks
            document.querySelectorAll('pre').forEach((pre) => {
                const button = document.createElement('button');
                button.className = 'copy-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const code = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        button.textContent = 'Copied!';
                        button.classList.add('copied');
                        setTimeout(() => {
                            button.textContent = 'Copy';
                            button.classList.remove('copied');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        button.textContent = 'Error';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>